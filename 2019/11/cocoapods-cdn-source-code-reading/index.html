<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Cocoapods 新增 CDN 支持的源码解读 | icyleaf</title><link rel=prev href=https://icyleaf.com/2019/05/create-macos-nswindow-without-storyboard/><link rel=canonical href=https://icyleaf.com/2019/11/cocoapods-cdn-source-code-reading/><link rel=apple-touch-icon sizes=180x180 href=https://icyleaf.com/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/favicon-16x16.png><link rel=manifest href=https://icyleaf.com/site.webmanifest><link rel=mask-icon href=https://icyleaf.com/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#000000"><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.css><meta name=title content="Cocoapods 新增 CDN 支持的源码解读 | icyleaf"><meta name=author content="icyleaf"><meta name=description content="日常写代码热爱户外的梦想家"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/icyleaf.com\/"},"articleSection":"posts","name":"Cocoapods 新增 CDN 支持的源码解读","headline":"Cocoapods 新增 CDN 支持的源码解读","description":"Cocoapods 1.7.2 版本开始增加 CDN 支持但默认没有启用，1.8 版本的发布舍弃了原始完整克隆的 Specs 仓库改用 CDN 服务。CDN 利用的是免费且强大的 jsDelivr CDN 服务，该 CDN 网络在国","inLanguage":"zh-cn","author":"icyleaf","creator":"icyleaf","publisher":"icyleaf","accountablePerson":"icyleaf","copyrightHolder":"icyleaf","copyrightYear":"2019","datePublished":"2019-11-15 19:10:07 \u002b0800 \u002b0800","dateModified":"2019-11-15 19:10:07 \u002b0800 \u002b0800","url":"https:\/\/icyleaf.com\/2019\/11\/cocoapods-cdn-source-code-reading\/","wordCount":"1409","keywords":["Ruby","iOS","icyleaf"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-back2home-logo"><span class=logo_mark>>$</span>
<a href=https://icyleaf.com/><span class=logo_text>cd /home/</span>
<span class=logo_cursor></span></a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/posts title>Posts</a>
<a class=menu-item href=https://icyleaf.com/categories title>Categories</a>
<a class=menu-item href=https://icyleaf.com/tags title>Tags</a>
<a class=menu-item href=https://icyleaf.com/about title>About</a>
<span class=divide></span><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/posts title><h3>Posts</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/categories title><h3>Categories</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/tags title><h3>Tags</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/about title><h3>About</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">Cocoapods 新增 CDN 支持的源码解读</h1><div class=post-meta>Written by <a itemprop=name href=https://icyleaf.com/ rel=author>icyleaf</a> with ♥
<span class=post-time>on <time datetime=2019-11-15 itemprop=datePublished>November 15, 2019</time></span>
in
<i class="iconfont icon-folder"></i>
<span class=post-category><a href=https://icyleaf.com/categories/technology/>Technology,</a></span>
<span class=post-word-count>1409 words</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#老的机制>老的机制</a></li><li><a href=#新的机制>新的机制</a></li><li><a href=#结语>结语</a></li></ul></li></ul></nav></div></div><div class=post-content><p>Cocoapods <a href=https://blog.cocoapods.org/CocoaPods-1.7.2/>1.7.2</a> 版本开始增加 CDN 支持但默认没有启用，<a href=http://blog.cocoapods.org/CocoaPods-1.8.0-beta/>1.8</a> 版本的发布舍弃了原始完整克隆的 Specs 仓库改用 CDN 服务。CDN 利用的是免费且强大的 <a href=https://www.jsdelivr.com/>jsDelivr</a> CDN 服务，该 CDN 网络在国内是有备案因此速度和稳定性都会有很好的保证。该提案其实在去年已经有人使用 Cocoapods Plugin 的方式实现并向社区<a href=https://github.com/CocoaPods/CocoaPods/issues/8268>贡献 PR</a>。</p><p>那么 CDN 支持相比之前的机制有啥优势呢？难道是把 Pods 的仓库和源码都托管到 CDN 网络了吗，其实并不是的。</p><blockquote><p>友情提醒：本文只重点分析 Pods 下载的机制，不展开其他方面，以下只是 <code>pod install</code> 执行顺序中的一部分，如果你想了解 Cocoapods 都干了什么可以前往<a href=https://www.jianshu.com/p/84936d9344ff>这篇文章</a>查阅。</p></blockquote><h3 id=老的机制>老的机制</h3><p>第一步先检查本地 <code>~/.cocoapods/repo/master</code> 目录是否存在，没有直接克隆 <code>https://github.com/Cocoapods/Specs.git</code> 仓库，这步在国内来说特别费时间正常下载下来目录应该是 2G+，如果有其他 source 源（比如私有源）会重复刚才的操作。</p><p>第二步安装 Podfile 每个 Pod 去在各个源中寻找对应的版本，从版本的 .podspec 文件解析获取组件的地址，这个可能是 http、git、svn、hg 中的<a href=https://guides.cocoapods.org/syntax/podspec.html#source>任意一个</a>，获取到之后开始下载（默认是在 <code>~/Library/Caches/CocoaPods</code> 做缓存目录）</p><h3 id=新的机制>新的机制</h3><p>第一步分析 Podfile 里面的 source ，如果没有走默认 Cocoapods 的配置（1.8 以上是 <a href=https://cdn.cocoapods.org>https://cdn.cocoapods.org</a> ，之前的还是 Cocoapods/Spec），
如果本地不存在官方 cdn 的 repo 名字是 trunk 的保留字，自己无法创建。如果有自定义的 source 会追加上去 sources 列表。</p><div class=highlight><pre class=chroma><code class=language-txt data-lang=txt><span class=ln> 1</span>$ http HEAD https://cdn.cocoapods.org/all_pods.txt
<span class=ln> 2</span>HTTP/1.1 200 OK
<span class=ln> 3</span>Accept-Ranges: bytes
<span class=ln> 4</span>Age: 0
<span class=ln> 5</span>Cache-Control: public, max-age=0, must-revalidate
<span class=ln> 6</span>Connection: keep-alive
<span class=ln> 7</span>Content-Length: 924280
<span class=ln> 8</span>Content-Type: text/plain; charset=UTF-8
<span class=ln> 9</span>Date: Sat, 09 Nov 2019 07:06:15 GMT
<span class=ln>10</span>Etag: &#34;acf0d284f3a8e82e0d66ba1a91cd30b9-ssl&#34;
<span class=ln>11</span>Server: Netlify
<span class=ln>12</span>Strict-Transport-Security: max-age=31536000
<span class=ln>13</span>X-NF-Request-ID: 50b466cd-ce9e-4326-b5bb-0d29a193ae4b-7809449
</code></pre></div><p>第二步检查或下载每个 source，每个 source 会检查是否是 cdn 类型（使用 HEAD 请求检查是否包含 /all_pods.txt）文件：</p><ul><li>cdn 类型，下面详细解释</li><li>其他类型，走原来的老的逻辑，不再赘述</li></ul><p>第三步，下载 <code>Cocoapods-version.yml</code> 并缓存 etag，下载 <code>/Cocoapods-version.yml</code> 并取 headers 的第一个 etag 的值存为 <code>/Cocoapods-version.yml.etag</code>，如果存在 etag 会比对一样就不需要下载， 链接支持根目录和其他目录，支持 301 跳转。</p><p>Cocoapods-version.yml</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=ln>1</span><span class=nn>---</span><span class=w>
</span><span class=ln>2</span><span class=w></span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class=m>1.0.0</span><span class=w>
</span><span class=ln>3</span><span class=w></span><span class=nt>last</span><span class=p>:</span><span class=w> </span><span class=m>1.8.4</span><span class=w>
</span><span class=ln>4</span><span class=w></span><span class=nt>prefix_lengths</span><span class=p>:</span><span class=w>
</span><span class=ln>5</span><span class=w></span>- <span class=m>1</span><span class=w>
</span><span class=ln>6</span><span class=w></span>- <span class=m>1</span><span class=w>
</span><span class=ln>7</span><span class=w></span>- <span class=m>1</span><span class=w>
</span></code></pre></div><p>第四步，分析 Pod 并获取 pod 的版本信息，比如 Podfile 我增加了一个 <code>pod "AFNetworking"</code>，把 pod 名字做 MD5 后的值取 Cocoapods-version.yml 的 prefiex_length 数组长度的值单字母拆分用下划线分割按照规则拼成文件名 <code>all_pods_versions(_{fragment}).txt</code> (如果prefix_length 为 0 则只会去下载 <code>/all_pods_versions.txt</code>)</p><p>比如：prefix_lengths 数组大小为 3，AFNetworking MD5 后 <code>a75d452377f396bdc4b623a5df25820</code> 则匹配前三位 a75 拆分后 a_7_5
后查找 cdn url 路径的 <code>/all_pods_versions_a_7_5.txt</code> 下载下来后的内容：</p><div class=highlight><pre class=chroma><code class=language-txt data-lang=txt><span class=ln>1</span>Fuse/0.1.0/0.2.0/1.0.0/1.1.0/1.2.0
<span class=ln>2</span>GXFlowView/1.0.0
<span class=ln>3</span>JFCountryPicker/0.0.1/0.0.2
<span class=ln>4</span>JVEmptyElement/0.1.0
</code></pre></div><p>第五步，下载 pod 的所有版本的 .podspec 文件，从上面的文件按照每行寻找第一段的名字，把后面的所有版本按照上面获取到的 prefix_lengths 的值（例如 AFNetworking 是 a, 7 , 5） <code>/Specs/a/7/5/AFNetworking/{version}/AFNetworking.podspec.json</code> 一次下载，并保存 etag 为 <code>/Specs/a/7/5/AFNetworking/{version}/AFNetworking.podspec.json.etag</code>，这个 etag 作用上面已经讲过，如果没有找到的话就会直接报错。</p><div class=highlight><pre class=chroma><code class=language-txt data-lang=txt><span class=ln>1</span>Adding spec repo `trunk` with CDN `https://cdn.cocoapods.org/`
<span class=ln>2</span>  CDN: trunk Relative path downloaded: CocoaPods-version.yml, save ETag: &#34;031c25b97a0aca21900087e355dcf663-ssl&#34;
<span class=ln>3</span>  CDN: trunk Relative path: CocoaPods-version.yml exists! Returning local because checking is only perfomed in repo update
<span class=ln>4</span>  CDN: trunk Relative path downloaded: all_pods_versions_a_7_5.txt, save ETag: &#34;5b32718ecbe82b0ae71ab3c77120213f-ssl&#34;
<span class=ln>5</span>  CDN: trunk Redirecting from https://cdn.cocoapods.org/Specs/a/7/5/AFNetworking/0.10.0/AFNetworking.podspec.json to https://raw.githubusercontent.com/CocoaPods/Specs/master/Specs/a/7/5/AFNetworking/0.10.0/AFNetworking.podspec.json
<span class=ln>6</span>  CDN: trunk Relative path downloaded: Specs/a/7/5/AFNetworking/0.10.0/AFNetworking.podspec.json, save ETag: W/&#34;a5f00eb1fdfdcab00b89e96bb81d48c110f09220063fdcf0b269290bffc18cf5&#34;
</code></pre></div><p>Cocoapods trunk 源的目录结构：</p><div class=highlight><pre class=chroma><code class=language-txt data-lang=txt><span class=ln>1</span>.cocoapods
<span class=ln>2</span>  repo
<span class=ln>3</span>    trunk
<span class=ln>4</span>      .url   #=&gt; https://cdn.cocoapods.org/
<span class=ln>5</span>      Cocoapods-version.yml  # =&gt; 从 https://cdn.cocoapods.org/CocoaPods-version.yml 下载的文件
<span class=ln>6</span>      Cocoapods-version.yml.etag  # 上一个请求的第一个 etag 值存下来
<span class=ln>7</span>      all_pods_versions_a_7_5.txt  # 参考上面的备注
<span class=ln>8</span>      all_pods_versions_a_7_5.txt.etag # 上一个请求的第一个 etag 值存下来
</code></pre></div><p>第六步和老的机制第二步一样同样最终还是会寻找 podspec 里面下载地址去下载，
也就是说<strong>真正 CDN 缓存加速的只有原有 Specs 必要的 podspec 文件，而不会加速 Pod 真正源地址</strong>，改机制只是减轻了本地更新官方 Specs 源的麻烦以及维护一个巨大的本地文件存储，这也是中心化机制的一个心结。</p><h3 id=结语>结语</h3><p>这个机制大大减少了本地需要占一个较大存储的问题，尤其是初次 <code>pod install</code> 时间长的情况，但 Pod 库本身还是各自的
地址本质上无法解决安装 Pod 消耗时间过长的问题。</p></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>icyleaf</span></p><p class=copyright-item><span>Link:</span>
<a href=https://icyleaf.com/2019/11/cocoapods-cdn-source-code-reading/>https://icyleaf.com/2019/11/cocoapods-cdn-source-code-reading/</a></p></div><div class=post-tags><section><i class="iconfont icon-tag"></i>Tag(s):
<span class=tag><a href=https://icyleaf.com/tags/ruby/>#Ruby</a></span>
<span class=tag><a href=https://icyleaf.com/tags/ios/>#iOS</a></span></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://icyleaf.com/>home</a></span></section></div><div class=post-nav><a href=https://icyleaf.com/2019/05/create-macos-nswindow-without-storyboard/ class=prev rel=prev title="创建无 Storyboard（xib） 的 macOS NSWindow"><i class="iconfont icon-left"></i>&nbsp;创建无 Storyboard（xib） 的 macOS NSWindow</a></div><div class=post-social><div class=social-links><style type=text/css>@font-face{font-family:iconfont;src:url(//at.alicdn.com/t/font_1910062_4213q7gpkpy.eot);src:url(//at.alicdn.com/t/font_1910062_4213q7gpkpy.eot?#iefix)format('embedded-opentype'),url(//at.alicdn.com/t/font_1910062_4213q7gpkpy.woff2)format('woff2'),url(//at.alicdn.com/t/font_1910062_4213q7gpkpy.woff)format('woff'),url(//at.alicdn.com/t/font_1910062_4213q7gpkpy.ttf)format('truetype'),url(//at.alicdn.com/t/font_1910062_4213q7gpkpy.svg#iconfont)format('svg')}</style><a class=bloglogo href=https://github.com/icyleaf target=_blank rel="me noopener"><i class="iconfont icon-github" alt=github></i></a>
<a class=bloglogo href=https://twitter.com/icyleaf target=_blank rel="me noopener"><i class="iconfont icon-twitter" alt=twitter></i></a>
<a class=bloglogo href=https://www.facebook.com/icyleaf target=_blank rel="me noopener"><i class="iconfont icon-facebook" alt=facebook></i></a>
<a class=bloglogo href=https://www.linkedin.com/in/icyleaf target=_blank rel="me noopener"><i class="iconfont icon-linkedin" alt=linkedin></i></a>
<a class=bloglogo href=https://www.instagram.com/icyleaf/ target=_blank rel="me noopener"><i class="iconfont icon-instagram" alt=instagram></i></a>
<a class=bloglogo href=https://www.douban.com/people/icyleaf target=_blank rel="me noopener"><i class="iconfont icon-douban" alt=douban></i></a></div></div><div class=post-comment><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//icyleaf.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2021</span>
<span>🍺</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span>
| <span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/icyleaf/hugo-theme-nicesima target=_blank rel="external nofollow">nicesima</a></span></div></footer><script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script><script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script>pangu.spacingPage()</script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-2570916-5','auto'),ga('send','pageview')</script></div></body></html>