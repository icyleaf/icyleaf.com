<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>DockerDeployRails on icyleaf</title><link>https://icyleaf.com/series/dockerdeployrails/</link><description>Recent content in DockerDeployRails on icyleaf</description><language>zh</language><lastBuildDate>Thu, 15 Sep 2022 13:58:31 +0800</lastBuildDate><atom:link href="https://icyleaf.com/series/dockerdeployrails/index.xml" rel="self" type="application/rss+xml"/><item><title>Rails é¡¹ç›®æ„å»º Docker é•œåƒå®‰å…¨å¤„ç†åŠ å¯†å‡­è¯ Credentials</title><link>https://icyleaf.com/2022/09/rails-build-docker-image-handle-encrypted-credentials-securely/</link><pubDate>Thu, 15 Sep 2022 13:58:31 +0800</pubDate><guid>https://icyleaf.com/2022/09/rails-build-docker-image-handle-encrypted-credentials-securely/</guid><description>
å¦‚ä½•æ­£ç¡®å¤„ç† Rails ä¸­çš„ master key å’Œ credentials.yml.enc</description><content:encoded><![CDATA[<p>æœ€è¿‘åœ¨åšä¸€ä¸ªå°çš„ Side Project ä½œä¸ºå…¬å…±æœåŠ¡é¦–è¦æ˜¯éœ€è¦ä¿è¯ç”¨æˆ·æ•°æ®çš„ç»å¯¹å®‰å…¨ï¼Œè¿™å°±éœ€è¦å¯¹æ•°æ®åº“æ•°æ®åšåŠ å¯†å¤„ç†ã€‚</p>
<p>Rails <a href="https://qiita.com/NaokiIshimura/items/2a179f2ab910992c4d39">5.2</a> å¼€å§‹æ”¯æŒ <code>credentials.yml.enc</code> åŠ å¯†å‡­è¯ï¼Œ
<a href="https://blog.saeloun.com/2019/10/10/rails-6-adds-support-for-multi-environment-credentials.html">6.0</a> æ”¯æŒå¤šç¯å¢ƒçš„ credentials åŠ å¯†å‡­è¯ï¼Œ
<a href="https://blog.saeloun.com/2021/06/09/rails-7-add-encryption-to-active-record.html">7.0</a> æ”¯æŒå¯¹ model æ•°æ®åº“è¡¨å­—æ®µåŠ å¯†å¤„ç†ï¼Œä½†æˆ‘ä» 5.1 æ”¯æŒ <code>secrets.yml</code> å¼€å§‹å°±æ²¡ä½¿ç”¨è¿‡ã€‚
æœ€è¿‘ä¸€å‘¨å¼€å‘åŠ æ‘¸ç´¢ä¸‹æ¥ï¼Œæ€»ç»“ä¸€å¥è¯ï¼š<strong>ä¸€ç›´åŠ å¯†ä¸€ç›´çˆ½ï¼Œå®¹å™¨åŒ–å¥”èµ´ç«è‘¬åœºã€‚</strong></p>
<h2 id="æœºåˆ¶åŸç†">æœºåˆ¶åŸç†</h2>
<p>åˆå§‹åŒ–ä¸€ä¸ª Rails 5.2+ é¡¹ç›®ä¼šåœ¨é¡¹ç›®æ ¹ç›®å½• <code>config</code> ç”Ÿæˆ <code>master.key</code> å’Œ <code>credentials.yml.enc</code> ä¸¤ä¸ªæ–‡ä»¶ï¼Œå‰è€…å¯ä»¥ç†è§£ä¸ºæ ¸å¿ƒå¯†é’¥ï¼Œåè€…æ˜¯ç”¨æ ¸å¿ƒå¯†é’¥é€šè¿‡
<a href="https://github.com/rails/rails/blob/7-0-stable/activesupport/lib/active_support/encrypted_configuration.rb">ActiveSupport::EncryptedConfiguration</a> åŠ å¯†ç±»ç”Ÿæˆçš„åŠ å¯†åçš„æ•°æ®æ–‡ä»¶ã€‚</p>
<p>åªéœ€è¦ä¿è¯ <code>master.key</code> ä¸ä¼šæ³„éœ²ï¼Œé€šè¿‡ <code>rails credentials:edit</code> é…ç½®æœåŠ¡æ‰€éœ€çš„å„è‡ªç§å¯† tokenã€secret key ä¹‹ç±»ä¹Ÿå¯ä»¥å®‰å…¨çš„æäº¤åˆ° Git ä»“åº“ä¸­ã€‚</p>
<h3 id="å­˜å‚¨è·¯å¾„">å­˜å‚¨è·¯å¾„</h3>
<p>å¯†é’¥å’ŒåŠ å¯†åçš„æ–‡ä»¶ä¼šå­˜åœ¨å¦‚ä¸‹ç›®å½•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># ç¼ºçœ</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">config/master.key
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">config/credentials.yml.enc
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"># Rails ç”Ÿäº§ç¯å¢ƒå†³å®š (6.0 å¼€å§‹æ”¯æŒ)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"># å¦‚ä¸‹åˆ†åˆ«å¯¹åº” development å’Œ production ç¯å¢ƒ</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">config/credentials/development.key
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">config/credentials/development.yml.enc
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">config/credentials/production.key
</span></span><span class="line"><span class="ln">11</span><span class="cl">config/credentials/production.yml.enc
</span></span></code></pre></div><h3 id="è§¦å‘æœºåˆ¶">è§¦å‘æœºåˆ¶</h3>
<p>åªè¦è¿è¡Œçš„ä»£ç ä¼šæ¶‰åŠ <code>config/environment.rb</code> æ–‡ä»¶è§£å¯†æµç¨‹å°±ä¼šè‡ªåŠ¨è¢«è§¦å‘ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><code>rails server</code></li>
<li><code>rails console</code></li>
<li><code>Rakefile</code> é™„åŠ  <code>:environment</code> å‚æ•°çš„æ‰€æœ‰ tasks</li>
</ul>
<h3 id="å¸¸è§åŠ è§£å¯†æŠ¥é”™">å¸¸è§åŠ è§£å¯†æŠ¥é”™</h3>
<p>è§£å¯†æœºåˆ¶è¢«è§¦å‘çš„é‚£ä¸€åˆ»ï¼Œå®ƒä¼šä»å­˜å‚¨è·¯å¾„ä»ç¼ºçœåˆ°å½“å‰ç”Ÿäº§ç¯å¢ƒå»å¯»æ‰¾å¯¹åº”çš„æ–‡ä»¶ï¼Œmaster key ä¼šä¼˜å…ˆè¯»å– <code>RAILS_MASTER_KEY</code> ç¯å¢ƒå˜é‡çš„å€¼ï¼Œæ²¡æœ‰æ‰ä¼šå»å­˜å‚¨æ–‡ä»¶è¯»å–ï¼Œéƒ½æ²¡æœ‰æ‰¾åˆ°å°±æŠ¥é”™ <code>MissingKeyError</code> é”™è¯¯ã€‚</p>
<p>master key åœ¨ Rails 5.2 ~ 7 ç‰ˆæœ¬å¯†é’¥çš„é•¿åº¦å¿…é¡»ç¬¦åˆ aes-128-gcm ä¹Ÿå°±æ˜¯ 32 å­—èŠ‚ï¼Œè®¾ç½®é”™è¯¯ä¼šå¾—åˆ° <code>InvalidKeyLengthError</code> é”™è¯¯ã€‚</p>
<p><code>*.enc</code> æ–‡ä»¶ä¸å­˜åœ¨ä¼šè§¦å‘ <code>MissingContentError</code> é”™è¯¯ã€‚</p>
<p>å…¶ä»–çš„é”™è¯¯è¿˜æœ‰å¯èƒ½æ˜¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># é€šå¸¸æ˜¯ credentials.yml.enc æ–‡ä»¶ç¼ºå¤±æˆ–æœªè®¾ç½® secret_key_base (SECRET_KEY_BASE) çš„å€¼</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">ArgumentError: Missing <span class="sb">`</span>secret_key_base<span class="sb">`</span> <span class="k">for</span> <span class="s1">&#39;production&#39;</span> environment, <span class="nb">set</span> this string with <span class="sb">`</span>bin/rails credentials:edit<span class="sb">`</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># master key å¯†é’¥ä¸æ­£ç¡®æ— æ³•è§£å¯†</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">Unable to load application: ActiveSupport::MessageEncryptor::InvalidMessage: ActiveSupport::MessageEncryptor::InvalidMessage
</span></span><span class="line"><span class="ln">6</span><span class="cl">
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="c1"># é”™è¯¯åŒä¸Š</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">OpenSSL::Cipher::CipherError
</span></span></code></pre></div><p>æˆå°±å¤§ä½“éƒ½åˆ—å‡ºæ¥äº†ï¼Œè‡³äºä½ èƒ½åˆ°å“ªæ­¥å°±çœ‹ä½ çš„é€ åŒ–äº†ï¼ˆå¼€ç©ç¬‘ï¼‰ã€‚</p>
<h2 id="æ•°æ®åº“å­—æ®µåŠ å¯†">æ•°æ®åº“å­—æ®µåŠ å¯†</h2>
<p>Rails é»˜è®¤å¹¶ä¸ä¼šå¯¹æ•°æ®åº“å­—æ®µåŠ å¯†ï¼Œåœ¨ 7.0 å¼€å§‹å…è®¸å¼€å‘è€…å®šä¹‰åŠ å¯†å­—æ®µä¹Ÿå…è®¸è‡ªå®šä¹‰åŠ è§£å¯†æ–¹æ³•ã€‚è¿™ä¸ªä¸æ˜¯æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ä¸å†å±•å¼€ã€‚</p>
<p>åˆå§‹åŒ–éœ€è¦é€šè¿‡å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆä¸€ä¸ªéšæœºçš„ Keysï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">$ rails db:encryption:init
</span></span><span class="line"><span class="ln">2</span><span class="cl">Add this entry to the credentials of the target environment:
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl">active_record_encryption:
</span></span><span class="line"><span class="ln">5</span><span class="cl">  primary_key: KMw07GoiPScVwtmoNxlBv7YibFCnB4dU
</span></span><span class="line"><span class="ln">6</span><span class="cl">  deterministic_key: CTttlez04KZcy3MCMFtZ8FUEopSAmJOr
</span></span><span class="line"><span class="ln">7</span><span class="cl">  key_derivation_salt: FwUgrDWHX3wN7kKw5gYSsYEgzxRnYBWh
</span></span></code></pre></div><p>åœ¨é€šè¿‡ <code>rails credentials:edit</code> æŠŠä¸Šç«¯åŠ å¯†ä¸²åŠ åˆ° credentials é‡Œé¢ä¿å­˜å³å¯ï¼Œ<strong>ä¸åŒçš„åŠ å¯†ä¸²æ˜¯æ— æ³•è§£å¯†å·²ç»å­˜åœ¨æ•°æ®åº“ä¸­çš„æ•°æ®çš„ï¼Œåˆ‡è®°ï¼åˆ‡è®°ï¼åˆ‡è®°ï¼</strong>
å¦åˆ™ä½ ä¼šå†è·å¾—ä¸€ä¸ªæˆå°± <code>ActiveRecord::Encryption::Errors::Decryption</code> æŠ¥é”™ã€‚</p>
<h2 id="é•œåƒæ„å»ºå¤„ç†">é•œåƒæ„å»ºå¤„ç†</h2>
<blockquote>
<p>æ­å–œä½ ï¼Œä»ç°åœ¨å¼€å§‹ä½ æœ¬åº”å½“ç›´é¢ææƒ§ï¼Œå¯æƒœä½ å‘ç°äº†æˆ‘è¿™ç¯‡æ–‡ç« ç¼ºå°‘äº†ç‚¹æ‚²æƒ¨çš„ç»å†ã€‚</p>
</blockquote>
<p>åˆ¶ä½œ Docker é•œåƒæ— è®ºä»€ä¹ˆæƒ…å†µéƒ½è¦ä¿è¯ä¸ä¼šåŒ…å«ä»»ä½•ç§å¯†æ•°æ®ï¼ŒRails ç»•ä¸å¼€çš„ç‚¹ä¸»è¦æ˜¯ <code>rails assets:complie</code>ã€‚
ä¸Šé¢æˆ‘ä¹Ÿè¯´äº†åªè¦æ¶‰åŠ <code>:environment</code> å‚æ•°çš„æ‰€æœ‰ tasks éƒ½ä¼šèµ°è§£å¯†æµç¨‹ï¼Œå®ƒä¹Ÿä¸ä¾‹å¤–ã€‚</p>
<p>æ„å»ºæ–¹é¢æˆ‘é€šè¿‡ä¸‰ç§æ–¹å¼æ¥è§£æå¦‚æœä»ä¸å®‰å…¨åˆ°å®‰å…¨çš„æ„å»ºè¿‡ç¨‹ï¼š</p>
<h3 id="-æœ€ä¸å®‰å…¨çš„æ–¹å¼">ğŸš« æœ€ä¸å®‰å…¨çš„æ–¹å¼</h3>
<p>é•œåƒæ„å»ºå…è®¸è®¾ç½® <a href="https://docs.docker.com/engine/reference/commandline/build/#set-build-time-variables---build-arg">build-arg</a> ä¼ é€’ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">FROM</span><span class="s"> ruby:3.0.3</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="err"></span><span class="k">ARG</span> master_key<span class="err">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="err"></span><span class="k">ENV</span> <span class="nv">RAILS_MASTER_KEY</span><span class="o">=</span><span class="nv">$master_key</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="err"></span><span class="k">ENV</span> <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c"># çœç•¥</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="err"></span>...<span class="err">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="err"></span><span class="k">RUN</span> bin/rails assets:complie<span class="err">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="err"></span><span class="c"># æˆ–è€…</span><span class="err">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nv">RAILS_MASTER_KEY</span><span class="o">=</span><span class="nv">$master_key</span> bin/rails assets:complie<span class="err">
</span></span></span></code></pre></div><p>æ‰§è¡Œæ„å»ºå‘½ä»¤ <code>docker build -t app --build-arg master_key=[32bits-length-key] .</code> æ„å»ºåè™½ç„¶å¯ä»¥è·å¾—é•œåƒï¼Œä½†æ„å»ºæ—¶è®¾ç½®çš„å€¼ä¹Ÿè¢«å°è£…åœ¨äº†å®¹å™¨ä¸­ï¼Œå°±ç®—æ²¡æœ‰å°è£…åˆ°å®¹å™¨ä¸­ä½¿ç”¨ <code>docker history</code> ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå› æ­¤è¿™ç§æ–¹å¼æ˜¯ç»å¯¹ä¸å¯å–çš„ã€‚</p>
<h3 id="-æ”¹è¿›ç‰ˆ">â­•ï¸ æ”¹è¿›ç‰ˆ</h3>
<p>ä½ å¯èƒ½ä¼šçœ‹åˆ°æœ‰äº›é•œåƒçš„ Dockerfile é‡Œé¢ä¼šåŒ…å«å¤šä¸ª <code>FROM</code> çš„<a href="https://docs.docker.com/develop/develop-images/multistage-build/">å¤šé˜¶æ®µæ„å»º</a>ã€‚è¿™ä¸ªæ˜¯ä¸ºäº†åˆ©ç”¨éš”ç¦»èµ„æºï¼Œé‡å¤åˆ©ç”¨ç¼“å­˜æœºåˆ¶çš„æ–¹å¼ä½¿å¾—æœ€ç»ˆçš„å®¹å™¨æå¯èƒ½çš„å°å’Œå®‰å…¨ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæŠŠç§å¯†æ•°æ®éš”ç¦»åœ¨å‰é¢çš„ä¸´æ—¶é•œåƒä¸­ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">FROM</span><span class="s"> ruby:3.0.3 as builder</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="err"></span><span class="k">ARG</span> <span class="nv">workspace</span><span class="o">=</span>/app<span class="err">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="err"></span><span class="k">ARG</span> master_key<span class="err">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="err"></span><span class="k">ENV</span> <span class="nv">RAILS_MASTER_KEY</span><span class="o">=</span><span class="nv">$master_key</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="err"></span><span class="k">ENV</span> <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="c"># çœç•¥</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="err"></span>...<span class="err">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> $workspace</span><span class="err">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="err"></span><span class="k">RUN</span> bin/rails assets:complie<span class="err">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="err"></span><span class="c"># çœç•¥</span><span class="err">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="err"></span>...<span class="err">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> ruby:3.0.3-slim</span><span class="err">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="err"></span><span class="c"># çœç•¥</span><span class="err">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="err"></span>...<span class="err">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder <span class="nv">$workspace</span> <span class="nv">$workspace</span><span class="err">
</span></span></span></code></pre></div><p>é•œåƒå­˜åœ¨ <code>builder</code> å’Œä¸€ä¸ªç¼ºçœåå­—ï¼ˆé€šå¸¸æ˜¯ <code>stage-N</code>, N æ˜¯æ•°å­—ä» 1 å¼€å§‹ï¼‰ä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µæ˜¯æœ€ä¸å®‰å…¨æ–¹å¼çš„å®ç°æ–¹å¼ï¼Œè¿™é‡Œåœ¨æœ€åä¸€ä¸ªé˜¶æ®µé€šè¿‡ä¸€ä¸ªå¹²å‡€å®‰å…¨çš„é•œåƒæŠŠä¸Šä¸€ä¸ªé˜¶æ®µçš„ç»“æœæ–‡ä»¶å¤åˆ¶è¿‡æ¥å°±è¾¾æˆäº†ç¬¬ä¸€ä¸ªé˜¶æ®µä¸­ç§å¯†æ•°æ®æ³„éœ²çš„é—®é¢˜ã€‚</p>
<p>è¿™ç§æ–¹å¼ä¹Ÿæ˜¯å½“å‰å¤§å¤šæ•°äººä¼šåº”ç”¨çš„æ–¹å¼ï¼Œå°¤å…¶åˆ©ç”¨ Github Action çš„ <a href="https://docs.github.com/en/actions/security-guides/encrypted-secrets">Encrypted secrets</a> åŠŸèƒ½ä»æŸç§ç¨‹åº¦ä¸Šæœç»äº†éšç§æ•°æ®çš„æ³„éœ²ã€‚</p>
<h3 id="-åŠ å¼ºç‰ˆ">âœ… åŠ å¼ºç‰ˆ</h3>
<p><a href="https://docs.docker.com/develop/develop-images/build_enhancements/">Buildkit</a> æ˜¯ Docker æ–°ä¸€ä»£é•œåƒæ„å»ºå·¥å…·ï¼Œå¯ç”¨å¯ä»¥é€šè¿‡é…ç½®ç¯å¢ƒå˜é‡ <code>DOCKER_BUILDKIT=1</code> æˆ–åœ¨ Docker é…ç½®æ–‡ä»¶çš„ features å­—å…¸å¢åŠ  <code>&quot;buildkit&quot; : &quot;true&quot;</code>ã€‚</p>
<p>ç”±äºé‡‡ç”¨æ–°çš„æ„å»ºå·¥å…·ï¼Œé¢å¤–è¿˜éœ€è¦åœ¨ Dockerfile å¤´éƒ¨æ˜¾æ€§å£°æ˜æ–°çš„è¯­æ³•ï¼š<code>syntax = docker/dockerfile:1.2</code> é…åˆ
<a href="https://docs.docker.com/develop/develop-images/build_enhancements/#new-docker-build-secret-information">æ–°çš„æ„å»º secret </a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c"># syntax = docker/dockerfile:1.2</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> ruby:3.0.3</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="err"></span><span class="k">ARG</span> <span class="nv">workspace</span><span class="o">=</span>/app<span class="err">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> $workspace</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="err"></span><span class="c"># çœç•¥</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="err"></span>...<span class="err">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="err"></span><span class="k">RUN</span> --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>secret,id<span class="o">=</span>master_key,target<span class="o">=</span>config/master.key,required<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="se"></span>    bin/rails assets:precompile<span class="err">
</span></span></span></code></pre></div><p>æ„å»ºå‘½ä»¤æ‰§è¡Œéœ€è¦é€šè¿‡ <a href="https://docs.docker.com/build/buildx/install/">buildx</a> CLI å­å‘½ä»¤æ¥å®Œæˆï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">$ docker buildx build <span class="se">\
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="se"></span>  --secret <span class="nv">id</span><span class="o">=</span>master_key,src<span class="o">=</span>config/master.key <span class="se">\
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="se"></span>  -t app .
</span></span></code></pre></div><p>ç»“åˆ <a href="https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/reference.md#run---mounttypesecret">&ndash;mount-type=secret</a> æ”¯æŒçš„å‚æ•°:</p>
<table>
<thead>
<tr>
<th>å‚æ•°å</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>å¯†é’¥çš„å”¯ä¸€ idï¼Œé»˜è®¤æ˜¯ target å‚æ•°çš„å€¼çš„æ–‡ä»¶å</td>
</tr>
<tr>
<td>target</td>
<td>é•œåƒå†…æŒ‚è½½çš„è·¯å¾„ï¼Œé»˜è®¤æ˜¯ <code>/run/secrets/</code> + <code>id</code></td>
</tr>
<tr>
<td>required</td>
<td>è®¾ç½® <code>true</code> å½“å¯†é’¥ä¸å­˜åœ¨æ—¶æŠ¥é”™ï¼Œé»˜è®¤æ˜¯ <code>false</code></td>
</tr>
<tr>
<td>mode</td>
<td>æŒ‚è½½åçš„æ–‡ä»¶æƒé™ï¼Œé»˜è®¤æ˜¯ <code>0400</code></td>
</tr>
<tr>
<td>uid</td>
<td>è®¾ç½®å¯†é’¥æ–‡ä»¶çš„ç”¨æˆ· IDï¼Œé»˜è®¤æ˜¯ <code>0</code></td>
</tr>
<tr>
<td>gid</td>
<td>è®¾ç½®å¯†é’¥æ–‡ä»¶çš„ç”¨æˆ·ç»„ IDï¼Œé»˜è®¤æ˜¯ <code>0</code></td>
</tr>
</tbody>
</table>
<p><code>id</code> å…³è” CLI ä¼ å‚å’Œæ„å»ºé•œåƒä¸­æ‰§è¡Œæ­¥éª¤ï¼ŒCLI å…¥å‚è®¾ç½® secret çš„è¾“å…¥æ–‡ä»¶ï¼Œæ„å»ºé•œåƒåˆ™éœ€è¦æŠŠ secret å¯¼å‡ºåˆ°é•œåƒä¸­å…·ä½“çš„è·¯å¾„ï¼Œå…¶å®å°±æ˜¯è¿™ä¹ˆç®€å•ã€‚æå°‘æ•°æ”¯æŒ Docker
éƒ¨ç½²çš„äº‘æœåŠ¡ï¼Œæ¯”å¦‚ <a href="https://render.com/docs/docker-secrets">Render</a> æ”¯æŒè¿™ç§æ–¹å¼ã€‚éƒ¨ç½²åˆ°äº‘æœåŠ¡ä¸Šè¿˜éœ€è¦é‡æ–°è€ƒé‡ä¸‹ã€‚</p>
<h2 id="æœ¬ç¯‡å°ç»“">æœ¬ç¯‡å°ç»“</h2>
<p>æŠ˜è…¾ä¸€åœˆç»ˆäºè·å¾—äº†ä¸€ä¸ªå¹²å‡€ã€å®‰å…¨çš„é•œåƒï¼Œç­‰åˆ°éƒ¨ç½²æ—¶åˆå‚»çœ¼äº†ã€‚é¢å‘æŠ€æœ¯äººå‘˜æˆ–å…¬å¸çš„é¡¹ç›®å€’è¿˜å¥½ï¼Œåˆå§‹åŒ–æ—¶é€šè¿‡å‘½ä»¤ä¸€é€šæ“ä½œé…ç½®å®Œä¹Ÿä¸éœ€è¦å¤„ç† master key ä¸åŒ¹é…çš„æƒ…å†µã€‚
æ— è®ºä½¿ç”¨ä¸Šé¢æ”¹è¿›ç‰ˆè¿˜æ˜¯åŠ å¼ºç‰ˆéƒ½èƒ½è¿‡é¡ºåˆ©è·‘èµ·æ¥ã€‚å¦‚æœ Docker é•œåƒæ˜¯è¦é¢å‘å®¢æˆ·çš„è¯ï¼Œæ€ä¹ˆè®©ä»–ä»¬åˆå§‹åŒ–ä¸€ä¸ªå±äºä»–ä»¬è‡ªå·±çš„ master key å’ŒåŠ å¯†æ•°æ®å‘¢ï¼Ÿå¼€å§‹æŒ å¤´äº†å§ã€‚</p>
<p>æœªå®Œå¾…ç»­&hellip;</p>
<h2 id="å‚è€ƒèµ„æº">å‚è€ƒèµ„æº</h2>
<ul>
<li><a href="https://techblog.lclco.com/entry/2021/07/27/110000">Railsã®credentials.yml.encã¨master keyã‚’Dockerã§å®‰å…¨ã«æ‰±ã†</a></li>
<li><a href="https://pythonspeed.com/articles/docker-build-secrets/">Donâ€™t leak your Docker imageâ€™s build secrets</a></li>
</ul>
]]></content:encoded></item></channel></rss>