<!DOCTYPE html>
<html lang="en-us">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <meta property="og:title" content=" Puma 替换 Unicorn 跑 Gitlab &middot;  icyleaf" />
    <meta property="og:site_name" content="icyleaf" />
    <meta property="og:url" content="/2014/01/moving-unicorn-to-puma-on-gitlab/" />

    
    <meta property="og:type" content="article" />

    <meta property="og:article:published_time" content="2014-01-26T12:34:56&#43;08:00" />

    
    <meta property="og:article:tag" content="Ruby" />
    
    <meta property="og:article:tag" content="Git" />
    
    <meta property="og:article:tag" content="Gitlab" />
    
    <meta property="og:article:tag" content="Puma" />
    
    <meta property="og:article:tag" content="Unicorn" />
    
    

    <title>
         Puma 替换 Unicorn 跑 Gitlab &middot;  icyleaf
    </title>

    <meta name="description" content="热爱户外的码农、下厨初心者" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="http://icyleaf.com/images/favicon.ico">
    <link rel="apple-touch-icon" href="http://icyleaf.com/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="http://icyleaf.com/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="http://icyleaf.com/css/nav.css" />

    
        <link rel="stylesheet" href="http://icyleaf.com/css/highlight/tomorrow-night.css">
        <script src="http://icyleaf.com/js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    

    
        
            <link href="http://icyleaf.com/index.xml" rel="alternate" type="application/rss+xml" title="icyleaf" />
        
        
    
    <meta name="generator" content="Hugo 0.47.1" />

    <link rel="canonical" href="http://icyleaf.com/2014/01/moving-unicorn-to-puma-on-gitlab/" />

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-2570916-5', 'auto');
        ga('send', 'pageview');
    </script>
    

    
</head>
<body class="nav-closed">
    <div class="nav">
  <h3 class="nav-title">Menu</h3>
  <a href="#" class="nav-close">
    <span class="hidden">Close</span>
  </a>
  <ul>
    

    
      
      <li class="nav-opened" role="presentation">
      	<a href="http://icyleaf.com/">Home</a>
      </li>
    
      
      <li class="nav-opened" role="presentation">
      	<a href="http://icyleaf.com/categories/technology">Technology</a>
      </li>
    
      
      <li class="nav-opened" role="presentation">
      	<a href="http://icyleaf.com/tags">Tags</a>
      </li>
    
      
      <li class="nav-opened" role="presentation">
      	<a href="http://icyleaf.com/about">About</a>
      </li>
    
  </ul>

  
    <a class="subscribe-button icon-feed" href="http://icyleaf.com/2014/01/moving-unicorn-to-puma-on-gitlab/">Subscribe</a>
  
</div>
<span class="nav-cover"></span>

 <div class="site-wrapper">


  <header class="main-header post-head no-cover">


  <nav class="main-nav overlay clearfix">
  
    <a class="blog-logo" href="http://icyleaf.com/"><img src="http://icyleaf.com/images/icyleaf-icon.png" alt="Blog Logo" /></a>
  

  
    <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
  
</nav>

  
</header>

<main class="content" role="main">
  <article class="post post">
    <header class="post-header">
      <h1 class="post-title">Puma 替换 Unicorn 跑 Gitlab</h1>
      <small></small>

      <section class="post-meta">
      
      
        <time class="post-date" datetime="2014-01-26T12:34:56&#43;08:00">
          Jan 26, 2014
        </time>
      
       
        <span class="post-tag small"><a href="http://icyleaf.com/tags/ruby/">#Ruby</a></span>
       
        <span class="post-tag small"><a href="http://icyleaf.com/tags/git/">#Git</a></span>
       
        <span class="post-tag small"><a href="http://icyleaf.com/tags/gitlab/">#Gitlab</a></span>
       
        <span class="post-tag small"><a href="http://icyleaf.com/tags/puma/">#Puma</a></span>
       
        <span class="post-tag small"><a href="http://icyleaf.com/tags/unicorn/">#Unicorn</a></span>
       
      </section>
    </header>

    <section class="post-content">
      

<p>前篇介绍到如何在《<a href="http://icyleaf.com/2013/09/how-to-install-gitlab-on-centos/">CentoOS 上面安装 Gitlab</a>》一文，gitlab 默认使用的是 <code>unicorn</code> 作为内部的 app server，再用 <code>nginx</code> 做代理转发。之前是在公司内部搭建了一个平台，用着还算可以。有打算在 <a href="https://www.linode.com/?r=66b0730eca572d3e45f083e29b1b3f8781b2a009">Linode 购买的 VPS</a> 上面，使用 <code>unicorn</code> 跑服务的时候 <code>ruby</code> 的进程居然占了 400-500M 左右，对于 Linode 刚刚免费升级之后才有 1G 内存的环境上，我还真有点放弃安装它的欲望。于是在想是否可以使用 <code>puma</code> 替换掉原先的。</p>

<h2 id="puma">puma</h2>

<p>简单介绍下 <a href="http://puma.io/"><code>puma</code></a>，它是一个由 ruby 编写的转为 <a href="http://rack.github.io/"><code>rack</code></a> 设计的 app server，在性能和资源占有上却有极大的优势（下表数据来自官方）</p>

<pre><code>PUMA - 78 Mb
RAINBOWS! (1X16) - 120 Mb
UNICORN - 1076 Mb
RAINBOWS! (16X32) - 1138 Mb
</code></pre>

<p>而且集成也非常的简单，若使用 rails 或者 sinatra（及 padrino）都已经支持，直接 <code>gem install puma</code>，然后跑默认的 <code>rails/padrino server</code> 会自动加载。</p>

<h2 id="教程">教程</h2>

<p>Okay，经过一番查找，官方在收集的 <a href="https://gitlab.com/gitlab-org/gitlab-recipes/tree/master">repices</a> 里面有关于 <code>puma</code> 的一些配置。他们也是收集的非官方资料，里面的资料只有借鉴意义，真正拿来用的时候各种问题，所以才有了本篇文字。</p>

<p>首先是关闭启动的 <code>gitlab</code> 服务</p>

<pre><code>$ (sudo) service gitlab stop
</code></pre>

<p>关闭之后，添加 puma gem，打开 <code>Gemfile</code></p>

<pre><code>group :unicorn do
  gem 'unicorn', '~&gt; 4.6.3'
	gem 'unicorn-worker-killer'
end
</code></pre>

<p>找到上面的这段 group 替换成：</p>

<pre><code>gem 'puma'
</code></pre>

<p>再者修改 <code>config.ru</code>，把下面这段代码做下替换，删除 unicorn 的代码，加载 puma：</p>

<pre><code>unless defined?(PhusionPassenger)
  require 'unicorn'
  # Unicorn self-process killer
  require 'unicorn/worker_killer'
  # Max memory size (RSS) per worker
  use Unicorn::WorkerKiller::Oom, (200 * (1 &lt;&lt; 20)), (250 * (1 &lt;&lt; 20))
end
</code></pre>

<p>更新成</p>

<pre><code>unless defined?(PhusionPassenger)
  require 'puma'
end
</code></pre>

<p>替换完毕更新 <code>gem</code></p>

<pre><code># mysql 数据库
bundle install --without development test postgres --path vendor/bundle --no-deployment
# postgres 数据库
bundle install --without development test mysql --path vendor/bundle --no-deployment 	
</code></pre>

<p>最后还有两处需要修改，添加 <code>config/puma.rb</code>（替代 <code>config/unicorn.rb</code>） 以及替换 <code>/etc/init.d/gitlab</code> 服务脚本代码。</p>

<p><code>config/puma.rb</code>的代码在<a href="https://gitlab.com/gitlab-org/gitlab-recipes/blob/master/app-server/puma/puma.rb">这里可以下载</a>，无需做任何的修改。</p>

<p><code>/etc/init.d/gitlab</code> 服务脚本：<a href="https://gitlab.com/gitlab-org/gitlab-recipes/tree/master/init/sysvinit/centos">CentOS</a> | <a href="https://gitlab.com/gitlab-org/gitlab-recipes/tree/master/init/sysvinit/debian">Debian(Ubuntu)</a></p>

<blockquote>
<p>服务脚本需要设置下执行权限： chmod +x /etc/init.d/gitlab</p>
</blockquote>

<p>最后开启服务应该就完美了</p>

<pre><code>$ (sudo) service gitlab start
</code></pre>

<h2 id="我想用-apache-怎么办">我想用 Apache 怎么办？</h2>

<p>嗯，我没尝试过，官方有提供收集的资料，<a href="https://gitlab.com/gitlab-org/gitlab-recipes/tree/master/web-server">自己查看下吧</a>，记得要活学活用，直接套肯定会出问题的。</p>

    </section>

  <footer class="post-footer">
    
    <figure class="author-image">
        <a class="img" href="http://icyleaf.com/" style="background-image: url(/images/icyleaf-icon.png)"><span class="hidden">icyleaf's Picture</span></a>
    </figure>
    

    





<section class="author">
  <h4><a href="http://icyleaf.com/">icyleaf</a></h4>
  
  <p>热爱户外的码农、下厨初心者</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Beijing, China</span>
    <span class="author-link icon-link"><a href="http://icyleaf.com">http://icyleaf.com</a></span>
  </div>
</section>



    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" href="https://twitter.com/share?text=Puma%20%e6%9b%bf%e6%8d%a2%20Unicorn%20%e8%b7%91%20Gitlab&nbsp;-&nbsp;icyleaf&amp;url=%2f2014%2f01%2fmoving-unicorn-to-puma-on-gitlab%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=%2f2014%2f01%2fmoving-unicorn-to-puma-on-gitlab%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-weibo"href="http://service.weibo.com/share/share.php?url=%2f2014%2f01%2fmoving-unicorn-to-puma-on-gitlab%2f&amp;title=Puma%20%e6%9b%bf%e6%8d%a2%20Unicorn%20%e8%b7%91%20Gitlab&nbsp;-&nbsp;icyleaf"
      onclick="window.open(this.href, 'weibo-share','width=580,height=296');return false;">
      <span class="hidden">新浪微博</span>
  </a>
  <a class="icon-douban" href="javascript:void(function(){var d=document,e=encodeURIComponent,s1=window.getSelection,s2=d.getSelection,s3=d.selection,s=s1?s1():s2?s2():s3?s3.createRange().text:'',r='https://www.douban.com/recommend/?url='+e(d.location.href)+'&title='+e(d.title)+'&sel='+e(s)+'&v=1',w=450,h=330,x=function(){if(!window.open(r,'douban','toolbar=0,resizable=1,scrollbars=yes,status=1,width='+w+',height='+h+',left='+(screen.width-w)/2+',top='+(screen.height-h)/2))location.href=r+'&r=1'};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})()">
      <span class="hidden">豆瓣</span>
  </a>
</section>



    

<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'icyleaf';
  var disqus_url = '\/2014\/01\/moving-unicorn-to-puma-on-gitlab\/';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




  </footer>
</article>

</main>


  <aside class="read-next">
  
      <a class="read-next-story" style="no-cover" href="http://icyleaf.com/2015/01/speed-up-cocoapods/">
          <section class="post">
              <h2>极速化 CocoaPods</h2>
              
          </section>
      </a>
  
  
      <a class="read-next-story prev" style="no-cover" href="http://icyleaf.com/2014/01/homebrew-hidden-commands/">
          <section class="post">
              <h2>Homebrew 隐藏命令</h2>
          </section>
      </a>
  
</aside>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">icyleaf</a> All rights reserved - 2007</section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        
    </footer>
  </div>
  <script type="text/javascript" src="http://icyleaf.com/js/jquery.js"></script>
  <script type="text/javascript" src="http://icyleaf.com/js/jquery.fitvids.js"></script>
  <script type="text/javascript" src="http://icyleaf.com/js/index.js"></script>
  
</body>
</html>

