<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Puma 替换 Unicorn 跑 Gitlab | icyleaf</title><link rel=prev href=https://icyleaf.com/2014/01/homebrew-hidden-commands/><link rel=next href=https://icyleaf.com/2015/01/speed-up-cocoapods/><link rel=canonical href=https://icyleaf.com/2014/01/moving-unicorn-to-puma-on-gitlab/><link rel=apple-touch-icon sizes=180x180 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.css><meta name=title content="Puma 替换 Unicorn 跑 Gitlab | icyleaf"><meta name=author content="icyleaf"><meta name=description content="日常写代码热爱户外的梦想家"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/icyleaf.com\/"},"articleSection":"posts","name":"Puma 替换 Unicorn 跑 Gitlab","headline":"Puma 替换 Unicorn 跑 Gitlab","description":"前篇介绍到如何在《CentoOS 上面安装 Gitlab》一文，gitlab 默认使用的是 unicorn 作为内部的 app server，再用 nginx 做代理转发。之前是在公","inLanguage":"zh","author":"icyleaf","creator":"icyleaf","publisher":"icyleaf","accountablePerson":"icyleaf","copyrightHolder":"icyleaf","copyrightYear":"2014","datePublished":"2014-01-26 12:34:56 \u002b0800 \u002b0800","dateModified":"2014-01-26 12:34:56 \u002b0800 \u002b0800","url":"https:\/\/icyleaf.com\/2014\/01\/moving-unicorn-to-puma-on-gitlab\/","wordCount":"767","keywords":["Ruby","Git","Gitlab","Puma","Unicorn","icyleaf"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/about title>About</a>
<a class=menu-item href=https://icyleaf.com/projects title>Projects</a>
<a class=menu-item href=https://icyleaf.com/index.xml title>Feed</a>
<span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/about title><h3>About</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>Projects</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/index.xml title><h3>Feed</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">Puma 替换 Unicorn 跑 Gitlab</h1><div class=post-meta><time datetime=2014-01-26 itemprop=datePublished>January 26, 2014</time>
·
<span class=tags>Ruby, Git, Gitlab, Puma, Unicorn</span>
·
<span class=post-word-count>767 words · 3 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#puma>puma</a></li><li><a href=#教程>教程</a></li><li><a href=#我想用-apache-怎么办>我想用 Apache 怎么办？</a></li></ul></nav></div></div><div class=post-content><div id=post-gallery><p>前篇介绍到如何在《<a href=http://icyleaf.com/2013/09/how-to-install-gitlab-on-centos/>CentoOS 上面安装 Gitlab</a>》一文，gitlab 默认使用的是 <code>unicorn</code> 作为内部的 app server，再用 <code>nginx</code> 做代理转发。之前是在公司内部搭建了一个平台，用着还算可以。有打算在 <a href="https://www.linode.com/?r=66b0730eca572d3e45f083e29b1b3f8781b2a009">Linode 购买的 VPS</a> 上面，使用 <code>unicorn</code> 跑服务的时候 <code>ruby</code> 的进程居然占了 400-500M 左右，对于 Linode 刚刚免费升级之后才有 1G 内存的环境上，我还真有点放弃安装它的欲望。于是在想是否可以使用 <code>puma</code> 替换掉原先的。</p><h2 id=puma>puma</h2><p>简单介绍下 <a href=http://puma.io/><code>puma</code></a>，它是一个由 ruby 编写的转为 <a href=http://rack.github.io/><code>rack</code></a> 设计的 app server，在性能和资源占有上却有极大的优势（下表数据来自官方）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=ln>1</span><span class=cl>PUMA - 78 Mb
</span></span><span class=line><span class=ln>2</span><span class=cl>RAINBOWS! (1X16) - 120 Mb
</span></span><span class=line><span class=ln>3</span><span class=cl>UNICORN - 1076 Mb
</span></span><span class=line><span class=ln>4</span><span class=cl>RAINBOWS! (16X32) - 1138 Mb
</span></span></code></pre></div><p>而且集成也非常的简单，若使用 rails 或者 sinatra（及 padrino）都已经支持，直接 <code>gem install puma</code>，然后跑默认的 <code>rails/padrino server</code> 会自动加载。</p><h2 id=教程>教程</h2><p>Okay，经过一番查找，官方在收集的 <a href=https://gitlab.com/gitlab-org/gitlab-recipes/tree/master>repices</a> 里面有关于 <code>puma</code> 的一些配置。他们也是收集的非官方资料，里面的资料只有借鉴意义，真正拿来用的时候各种问题，所以才有了本篇文字。</p><p>首先是关闭启动的 <code>gitlab</code> 服务</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>$ <span class=o>(</span>sudo<span class=o>)</span> service gitlab stop
</span></span></code></pre></div><p>关闭之后，添加 puma gem，打开 <code>Gemfile</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln>1</span><span class=cl><span class=n>group</span> <span class=ss>:unicorn</span> <span class=k>do</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>  <span class=n>gem</span> <span class=s1>&#39;unicorn&#39;</span><span class=p>,</span> <span class=s1>&#39;~&gt; 4.6.3&#39;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>	<span class=n>gem</span> <span class=s1>&#39;unicorn-worker-killer&#39;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>找到上面的这段 group 替换成：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln>1</span><span class=cl><span class=n>gem</span> <span class=s1>&#39;puma&#39;</span>
</span></span></code></pre></div><p>再者修改 <code>config.ru</code>，把下面这段代码做下替换，删除 unicorn 的代码，加载 puma：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln>1</span><span class=cl><span class=k>unless</span> <span class=n>defined?</span><span class=p>(</span><span class=no>PhusionPassenger</span><span class=p>)</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>  <span class=nb>require</span> <span class=s1>&#39;unicorn&#39;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>  <span class=c1># Unicorn self-process killer</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>  <span class=nb>require</span> <span class=s1>&#39;unicorn/worker_killer&#39;</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>  <span class=c1># Max memory size (RSS) per worker</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>  <span class=n>use</span> <span class=no>Unicorn</span><span class=o>::</span><span class=no>WorkerKiller</span><span class=o>::</span><span class=no>Oom</span><span class=p>,</span> <span class=p>(</span><span class=mi>200</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>20</span><span class=p>)),</span> <span class=p>(</span><span class=mi>250</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>20</span><span class=p>))</span>
</span></span><span class=line><span class=ln>7</span><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>更新成</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln>1</span><span class=cl><span class=k>unless</span> <span class=n>defined?</span><span class=p>(</span><span class=no>PhusionPassenger</span><span class=p>)</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>  <span class=nb>require</span> <span class=s1>&#39;puma&#39;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>替换完毕更新 <code>gem</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># mysql 数据库</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>bundle install --without development <span class=nb>test</span> postgres --path vendor/bundle --no-deployment
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=c1># postgres 数据库</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>bundle install --without development <span class=nb>test</span> mysql --path vendor/bundle --no-deployment
</span></span></code></pre></div><p>最后还有两处需要修改，添加 <code>config/puma.rb</code>（替代 <code>config/unicorn.rb</code>） 以及替换 <code>/etc/init.d/gitlab</code> 服务脚本代码。</p><p><code>config/puma.rb</code>的代码在<a href=https://gitlab.com/gitlab-org/gitlab-recipes/blob/master/app-server/puma/puma.rb>这里可以下载</a>，无需做任何的修改。</p><p><code>/etc/init.d/gitlab</code> 服务脚本：<a href=https://gitlab.com/gitlab-org/gitlab-recipes/tree/master/init/sysvinit/centos>CentOS</a> | <a href=https://gitlab.com/gitlab-org/gitlab-recipes/tree/master/init/sysvinit/debian>Debian(Ubuntu)</a></p><blockquote><p>服务脚本需要设置下执行权限： chmod +x /etc/init.d/gitlab</p></blockquote><p>最后开启服务应该就完美了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>$ <span class=o>(</span>sudo<span class=o>)</span> service gitlab start
</span></span></code></pre></div><h2 id=我想用-apache-怎么办>我想用 Apache 怎么办？</h2><p>嗯，我没尝试过，官方有提供收集的资料，<a href=https://gitlab.com/gitlab-org/gitlab-recipes/tree/master/web-server>自己查看下吧</a>，记得要活学活用，直接套肯定会出问题的。</p></div></div><div class=post-nav><a href=https://icyleaf.com/2014/01/homebrew-hidden-commands/ class=prev rel=prev title="Homebrew 隐藏命令"><i class="iconfont icon-left"></i>&nbsp;Homebrew 隐藏命令</a>
<a href=https://icyleaf.com/2015/01/speed-up-cocoapods/ class=next rel=next title="极速化 CocoaPods">极速化 CocoaPods&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//icyleaf.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2022</span>
<span>🍺</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script src=https://fastly.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js crossorigin=anonymous></script>
<script defer src=https://icyleaf.com/js/vendor_main.min.js></script>
<script src=https://fastly.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script>
<script>pangu.spacingPage()</script><script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: '\/photoswipe\/photoswipe.esm.js',
  });
  lightbox.init();
</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TKQBZ7R259"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TKQBZ7R259")</script></div></body></html>