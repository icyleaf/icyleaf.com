<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>你虐我千百遍，我待你如初恋，直到我遇到 match | icyleaf</title><link rel=prev href=https://icyleaf.com/2017/03/how-to-get-temporary-car-license-in-beijing/><link rel=next href=https://icyleaf.com/2017/04/sidekiq-works-in-ruby-togethor-with-crystal/><link rel=canonical href=https://icyleaf.com/2017/03/fastlane-match-in-action/><link rel=apple-touch-icon sizes=180x180 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.css><meta name=title content="你虐我千百遍，我待你如初恋，直到我遇到 match | icyleaf"><meta name=author content="icyleaf"><meta name=description content="日常写代码热爱户外的梦想家"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/icyleaf.com\/"},"articleSection":"posts","name":"你虐我千百遍，我待你如初恋，直到我遇到 match","headline":"你虐我千百遍，我待你如初恋，直到我遇到 match","description":"系列目录 Fastlane - iOS 和 Android 的自动化构建工具 深入浅出 Fastlane 一看你就懂 你虐我千百遍，我待你如初恋，直到我遇到 match 前言 通过前两篇的文章大家已经对 fastlane 的概念和基本使","inLanguage":"zh","author":"icyleaf","creator":"icyleaf","publisher":"icyleaf","accountablePerson":"icyleaf","copyrightHolder":"icyleaf","copyrightYear":"2017","datePublished":"2017-03-28 20:12:07 \u002b0800 \u002b0800","dateModified":"2017-03-28 20:12:07 \u002b0800 \u002b0800","url":"https:\/\/icyleaf.com\/2017\/03\/fastlane-match-in-action\/","wordCount":"1830","keywords":["iOS","Android","CI","CD","Ruby","Fastlane","match","icyleaf"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/about title>About</a>
<a class=menu-item href=https://icyleaf.com/index.xml title>Feed</a>
<span class=divide></span><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/about title><h3>About</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/index.xml title><h3>Feed</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=post-cover><img src=https://github.com/fastlane/fastlane/raw/master/match/assets/match.png></div><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">你虐我千百遍，我待你如初恋，直到我遇到 match</h1><div class=post-meta><time datetime=2017-03-28 itemprop=datePublished>March 28, 2017</time>
·
<span class=tags>iOS, Android, CI, CD, Ruby, Fastlane, match</span>
·
<span class=post-word-count>1830 words · 8 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#系列目录>系列目录</a></li><li><a href=#前言>前言</a></li><li><a href=#功能特性>功能特性</a></li><li><a href=#原理>原理</a></li><li><a href=#使用>使用</a></li><li><a href=#生成和同步证书>生成和同步证书</a></li><li><a href=#修改密钥>修改密钥</a></li><li><a href=#重新生成>重新生成</a></li><li><a href=#资料参考>资料参考</a></li></ul></nav></div></div><div class=post-content><h2 id=系列目录>系列目录</h2><ol><li><a href=https://icyleaf.com/2016/07/intro-fastlane-automation-for-ios-and-android/>Fastlane - iOS 和 Android 的自动化构建工具</a></li><li><a href=http://icyleaf.com/2016/07/fastlane-in-action/>深入浅出 Fastlane 一看你就懂</a></li><li><a href=https://icyleaf.com/2017/03/fastlane-match-in-action/>你虐我千百遍，我待你如初恋，直到我遇到 match</a></li></ol><h2 id=前言>前言</h2><p>通过前两篇的文章大家已经对 fastlane 的概念和基本使用已经有了初步的掌握，在第二篇中也有提到 fastlane 实现的各种功能其实都是基于独立封装设计的各个工具实现。它们即可以单独成为一个体系同时也会被吸纳到 fastlane 的 action 系统之中。<code>match</code> 是在 iOS 开发和持续测试和构建中最重中之重的环节，它维护和管理着 iOS 的各种证书和 profile 的创建、更新工作。想必很多用户听到 iOS 证书和 profile 都会头大脑涨，恨不得要手撕鬼子的技能点来对付他们（如图）</p><p><img src=https://codesigning.guide/assets/img/cs-the-problem.png alt=code-signing-problem loading=lazy></p><p>上图来源于作者专门整理的网站 <a href=https://codesigning.guide/>https://codesigning.guide/</a>，对于 iOS App 签名原理感兴趣的可以参见 JSPatch 作者的分析：http://blog.cnbang.net/tech/3386/</p><h2 id=功能特性>功能特性</h2><ol><li>主动/被动创建、更新、Xcode 所需的各种证书和打包所需的 Profiles</li><li>托管 Xcode 所需的各种证书和打包所需的 Profiles</li><li>统一并共享团队成员统一使用</li><li>证书具有密码加密保护（openssl）</li><li>支持多团队（账户）</li><li>支持单 App 多 Target(identifier)</li><li>内测支持企业账户（v0.11.0 还在测试可用，并没有正式支持）</li></ol><h2 id=原理>原理</h2><p>match 其实是在 fastlane 基础包 cert、sign、spaceship、credentials_manager 之上把 iOS 开发者证书流程化的工具。为了实现团队内共享项目的开发者证书，它使用 git 仓库对证书进行托管，首先需要进行初始化，配置 git 仓库、项目的 iDP 信息之后，下载 Development、AppStore、AdHoc 的开发者证书和项目的 Profile files，并通过 openssl 的方式进行安全加密后提交并推送到 git 仓库，其他成员（或自动化构建系统）使用时需要输入密钥后才能把证书解密并导入到 keychain 和 Profiles 目录。</p><p>如果对于证书加密策略感兴趣的可以在本文底部资料参考的第一个链接查看详情。</p><h2 id=使用>使用</h2><blockquote><p>最新 fastlane 已经包含了所有的子模块，独立的 match 不在更新，请直接安装 fastlane，使用 fastlane match 代替 match 命令。</p></blockquote><p>安装就很简单通过 <code>gem install fastlane</code> 会把它的全家桶一并下载安装，首先可以看下帮助：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln> 1</span>$ fastlane match --help
<span class=ln> 2</span>
<span class=ln> 3</span>  match
<span class=ln> 4</span>
<span class=ln> 5</span>  Easily sync your certificates and profiles across your team using git
<span class=ln> 6</span>
<span class=ln> 7</span>  Commands:
<span class=ln> 8</span>    adhoc             Run match <span class=k>for</span> a adhoc provisioning profile
<span class=ln> 9</span>    appstore          Run match <span class=k>for</span> a appstore provisioning profile
<span class=ln>10</span>    change_password   Re-encrypt all files with a different password
<span class=ln>11</span>    decrypt           Decrypts the repository and keeps it on the filesystem
<span class=ln>12</span>    development       Run match <span class=k>for</span> a development provisioning profile
<span class=ln>13</span>    <span class=nb>help</span>              Display global or <span class=o>[</span>command<span class=o>]</span> <span class=nb>help</span> documentation
<span class=ln>14</span>    init              Create the Matchfile <span class=k>for</span> you
<span class=ln>15</span>    nuke              Delete all certificates and provisioning profiles from the Apple Dev Portal
<span class=ln>16</span>    nuke development  Delete all certificates and provisioning profiles from the Apple Dev Portal of the <span class=nb>type</span> development
<span class=ln>17</span>    nuke distribution Delete all certificates and provisioning profiles from the Apple Dev Portal of the <span class=nb>type</span> distribution
<span class=ln>18</span>    run               Easily sync your certificates and profiles across your team using git
<span class=ln>19</span>
<span class=ln>20</span>  Global Options:
<span class=ln>21</span>    --verbose
<span class=ln>22</span>    -r, --git_url STRING URL to the git repo containing all the certificates <span class=o>(</span>MATCH_GIT_URL<span class=o>)</span>
<span class=ln>23</span>    --git_branch STRING  Specific git branch to use <span class=o>(</span>MATCH_GIT_BRANCH<span class=o>)</span>
<span class=ln>24</span>    -y, --type STRING    Create a development certificate instead of a distribution one <span class=o>(</span>MATCH_TYPE<span class=o>)</span>
<span class=ln>25</span>    -a, --app_identifier <span class=o>[</span>VALUE<span class=o>]</span> The bundle identifier<span class=o>(</span>s<span class=o>)</span> of your app <span class=o>(</span>comma-separated<span class=o>)</span> <span class=o>(</span>MATCH_APP_IDENTIFIER<span class=o>)</span>
<span class=ln>26</span>    -u, --username STRING Your Apple ID Username <span class=o>(</span>MATCH_USERNAME<span class=o>)</span>
<span class=ln>27</span>    -s, --keychain_name STRING Keychain the items should be imported to <span class=o>(</span>MATCH_KEYCHAIN_NAME<span class=o>)</span>
<span class=ln>28</span>    -p, --keychain_password STRING This might be required the first <span class=nb>time</span> you access certificates on a new mac. For the login/default keychain this is your account password <span class=o>(</span>MATCH_KEYCHAIN_PASSWORD<span class=o>)</span>
<span class=ln>29</span>    --readonly <span class=o>[</span>VALUE<span class=o>]</span>   Only fetch existing certificates and profiles, don<span class=s1>&#39;t generate new ones (MATCH_READONLY)
</span><span class=ln>30</span><span class=s1>    -b, --team_id STRING The ID of your Developer Portal team if you&#39;</span>re in multiple teams <span class=o>(</span>FASTLANE_TEAM_ID<span class=o>)</span>
<span class=ln>31</span>    -l, --team_name STRING The name of your Developer Portal team <span class=k>if</span> you<span class=err>&#39;</span>re in multiple teams <span class=o>(</span>FASTLANE_TEAM_NAME<span class=o>)</span>
<span class=ln>32</span>    --verbose <span class=o>[</span>VALUE<span class=o>]</span>    Print out extra information and all commands <span class=o>(</span>MATCH_VERBOSE<span class=o>)</span>
<span class=ln>33</span>    --force <span class=o>[</span>VALUE<span class=o>]</span>      Renew the provisioning profiles every <span class=nb>time</span> you run match <span class=o>(</span>MATCH_FORCE<span class=o>)</span>
<span class=ln>34</span>    --skip_confirmation <span class=o>[</span>VALUE<span class=o>]</span> Disables confirmation prompts during nuke, answering them with yes <span class=o>(</span>MATCH_SKIP_CONFIRMATION<span class=o>)</span>
<span class=ln>35</span>    --shallow_clone <span class=o>[</span>VALUE<span class=o>]</span> Make a shallow clone of the repository <span class=o>(</span>truncate the <span class=nb>history</span> to <span class=m>1</span> revision<span class=o>)</span> <span class=o>(</span>MATCH_SHALLOW_CLONE<span class=o>)</span>
<span class=ln>36</span>    --force_for_new_devices <span class=o>[</span>VALUE<span class=o>]</span> Renew the provisioning profiles <span class=k>if</span> the device count on the developer portal has changed <span class=o>(</span>MATCH_FORCE_FOR_NEW_DEVICES<span class=o>)</span>
<span class=ln>37</span>    --skip_docs <span class=o>[</span>VALUE<span class=o>]</span>  Skip generation of a README.md <span class=k>for</span> the created git repository <span class=o>(</span>MATCH_SKIP_DOCS<span class=o>)</span>
<span class=ln>38</span>    -h, --help           Display <span class=nb>help</span> documentation
<span class=ln>39</span>    -v, --version        Display version information
</code></pre></div><p>建议大家在项目中创建并配置 <code>fastlane/Matchfile</code> 文件可以把命令需要的参数省略：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>$ fastlane match init
</code></pre></div><p>设置好 git_url(git 仓库地址）、type（默认同步证书类型）、app_identifier、username（iDP 的账户名）即可。</p><h2 id=生成和同步证书>生成和同步证书</h2><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span><span class=c1># 开发环境证书</span>
<span class=ln>2</span>$ fastlane match development
<span class=ln>3</span><span class=c1># 产品环境证书</span>
<span class=ln>4</span>$ fastlane match appstore
<span class=ln>5</span><span class=c1># 内测环境证书</span>
<span class=ln>6</span>$ fastlane match adhoc
</code></pre></div><p>初次使用的时候会提示需要输入 iDP 的账户密码，校验成功后可以保存到 keychain 中后续可以不在重复输入（好贴心）密码（也可通过设置变量 FASTLANE_PASSWORD），该密码就是上面提到的证书加密的密钥，请妥善保存。</p><blockquote><p>提示：如果担心密码泄露可设置 FASTLANE_DONT_STORE_PASSWORD = true 不进行密码保存至 keychain，在 keychain 可通过关键词 &ldquo;deliver.&rdquo; 检索。</p></blockquote><p>有的童鞋说我们有 299 的企业证书，为什么不做支持呢？起初作者并没有打算进行支持是担心滥用以及代码结构需要较大的变更，随着开发者呼声太高，其实还是做了支持，只不过并没有正式的纳入，需要通过配置环境变量支持：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span><span class=c1># 企业环境证书</span>
<span class=ln>2</span>$ ENV<span class=o>[</span><span class=s1>&#39;MATCH_FORCE_ENTERPRISE&#39;</span><span class=o>]</span> <span class=o>=</span> <span class=s1>&#39;1&#39;</span> <span class=o>&amp;&amp;</span> fastlane match enterprise
</code></pre></div><h2 id=修改密钥>修改密钥</h2><p>建议密码定期更换或再人员发生变更之后进行密码变更：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>$ fastlane match change_password
</code></pre></div><h2 id=重新生成>重新生成</h2><p><strong>慎用</strong>：match 提供一个命令允许把当前的证书撤销后并全新的重新生成一份，这个事项是会把证书和 Profiles 全部包含在内，如果单纯的想只重设 Profles 并同步是不支持的。我想这也是为什么该命名叫做 <code>nuke</code></p><p>我这里可给大家提供一种只同步 profile 的方法：首先在 git 仓库中找到你要重设的 profile 文件，并把它从仓库中删除提交，然后在执行该类型的命令即可，命令发现没有 profile 会自动再生成一个 profile 并下载同步至 git 仓库。</p><h2 id=资料参考>资料参考</h2><ul><li><a href=http://macoscope.com/blog/simplify-your-life-with-fastlane-match/>http://macoscope.com/blog/simplify-your-life-with-fastlane-match/</a></li><li><a href=https://github.com/fastlane/fastlane/issues/2007>https://github.com/fastlane/fastlane/issues/2007</a></li></ul></div><div class=post-nav><a href=https://icyleaf.com/2017/03/how-to-get-temporary-car-license-in-beijing/ class=prev rel=prev title=北京上临时牌照流程><i class="iconfont icon-left"></i>&nbsp;北京上临时牌照流程</a>
<a href=https://icyleaf.com/2017/04/sidekiq-works-in-ruby-togethor-with-crystal/ class=next rel=next title="打通 Sidekiq 的任督二脉 Ruby 和 Crystal">打通 Sidekiq 的任督二脉 Ruby 和 Crystal&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2021</span>
<span>🍺</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script><script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script>pangu.spacingPage()</script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-2570916-5','auto'),ga('send','pageview')</script></div></body></html>