<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>æ‰“é€š Sidekiq çš„ä»»ç£äºŒè„‰ Ruby å’Œ Crystal | icyleaf</title><link rel=prev href=https://icyleaf.com/2017/03/fastlane-match-in-action/><link rel=next href=https://icyleaf.com/2017/05/fast-crystal/><link rel=canonical href=https://icyleaf.com/2017/04/sidekiq-works-in-ruby-togethor-with-crystal/><link rel=apple-touch-icon sizes=180x180 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.css><meta name=title content="æ‰“é€š Sidekiq çš„ä»»ç£äºŒè„‰ Ruby å’Œ Crystal | icyleaf"><meta name=author content="icyleaf"><meta name=description content="æ—¥å¸¸å†™ä»£ç çƒ­çˆ±æˆ·å¤–çš„æ¢¦æƒ³å®¶"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/icyleaf.com\/"},"articleSection":"posts","name":"æ‰“é€š Sidekiq çš„ä»»ç£äºŒè„‰ Ruby å’Œ Crystal","headline":"æ‰“é€š Sidekiq çš„ä»»ç£äºŒè„‰ Ruby å’Œ Crystal","description":"è‡ªä»å¼€å§‹ç ”ç©¶ Crystal è¿™é—¨è¯­è¨€ï¼ˆä¹‹å‰ä¹Ÿæœ‰ä»‹ç»è¿‡ï¼‰ï¼ŒåŸºæœ¬ä¸Šæ¯éš”ä¸€æ®µæ—¶é—´éƒ½ä¼šçœ‹çœ‹å®ƒçš„è¿‘å†µï¼Œå»å¹´ sidekiq çš„ä½œè€…ç”¨è¯¥è¯­è¨€é‡æ–°å®ç°äº† sidekiq é¡¹ç›®è€Œä¸”ç»™å‡ºäº†ç‰¹åˆ«ç«Ÿç„¶çš„å¯¹æ¯”æ•°","inLanguage":"zh","author":"icyleaf","creator":"icyleaf","publisher":"icyleaf","accountablePerson":"icyleaf","copyrightHolder":"icyleaf","copyrightYear":"2017","datePublished":"2017-04-26 16:00:49 \u002b0000 UTC","dateModified":"2017-04-26 16:00:49 \u002b0000 UTC","url":"https:\/\/icyleaf.com\/2017\/04\/sidekiq-works-in-ruby-togethor-with-crystal\/","wordCount":"2703","keywords":["Ruby","Crystal","Sidekiq","icyleaf"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/about title>About</a>
<a class=menu-item href=https://icyleaf.com/index.xml title>Feed</a>
<span class=divide></span><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/about title><h3>About</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/index.xml title><h3>Feed</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=post-cover><img src=https://icyleaf.com//uploads/2017/04/26/sidekiq-web-ui.png></div><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">æ‰“é€š Sidekiq çš„ä»»ç£äºŒè„‰ Ruby å’Œ Crystal</h1><div class=post-meta><time datetime=2017-04-26 itemprop=datePublished>April 26, 2017</time>
Â·
<span class=tags>Ruby, Crystal, Sidekiq</span>
Â·
<span class=post-word-count>2703 words Â· 12 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#é…ç½®-rails-ç¯å¢ƒ>é…ç½® Rails ç¯å¢ƒ</a></li><li><a href=#é…ç½®-crystal-ç¯å¢ƒ>é…ç½® Crystal ç¯å¢ƒ</a></li><li><a href=#ç¼–å†™-workers>ç¼–å†™ Workers</a><ul><li><a href=#ruby-ç‰ˆæœ¬>Ruby ç‰ˆæœ¬</a></li><li><a href=#crystal-ç‰ˆæœ¬>Crystal ç‰ˆæœ¬</a></li></ul></li><li><a href=#ä»»ç£äºŒè„‰>ä»»ç£äºŒè„‰</a><ul><li><a href=#ruby-ç‰ˆæœ¬-1>Ruby ç‰ˆæœ¬</a></li><li><a href=#crystal-ç‰ˆæœ¬-1>Crystal ç‰ˆæœ¬</a></li></ul></li><li><a href=#æ‰“é€šä»»ç£äºŒè„‰>æ‰“é€šä»»ç£äºŒè„‰</a></li><li><a href=#éªŒè¯åŠŸåŠ›æ•ˆæœ>éªŒè¯åŠŸåŠ›æ•ˆæœ</a></li><li><a href=#ç»“è¯­>ç»“è¯­</a></li></ul></nav></div></div><div class=post-content><p>è‡ªä»å¼€å§‹ç ”ç©¶ Crystal è¿™é—¨è¯­è¨€ï¼ˆä¹‹å‰ä¹Ÿæœ‰<a href=http://icyleaf.com/2016/07/gitlab-api-wrapper-for-crystal/>ä»‹ç»</a>è¿‡ï¼‰ï¼ŒåŸºæœ¬ä¸Šæ¯éš”ä¸€æ®µæ—¶é—´éƒ½ä¼šçœ‹çœ‹å®ƒçš„è¿‘å†µï¼Œå»å¹´ sidekiq çš„ä½œè€…ç”¨è¯¥è¯­è¨€é‡æ–°å®ç°äº† sidekiq é¡¹ç›®è€Œä¸”ç»™å‡ºäº†ç‰¹åˆ«ç«Ÿç„¶çš„<a href=http://www.mikeperham.com/2016/05/25/sidekiq-for-crystal/>å¯¹æ¯”æ•°æ®</a>ã€‚</p><p><img src=https://icyleaf.com/uploads/2017/04/26/sidekiq-benchmarks.png alt=IMAGE loading=lazy></p><p>ç›¸å¯¹æ¯” Gitlab é‡‡ç”¨ go è¯­è¨€é‡æ–° gitlab_ci_runner è€Œå­¦ä¹ ä¸€é—¨æ–°çš„è¯­è¨€è¾¾åˆ°é«˜æ•ˆç‡ä½å†…å­˜çš„æ–¹æ³•ä¹‹å¤– Crystal å°±åƒæ˜¯æ–°çš„å¸Œæœ›ã€‚ä½¿ç”¨ Crystal é‡æ–°çš„ sidekiq çš„ä»£ç ä¹Ÿéå¸¸çš„ç®€å•ä½†å·²ç»å®ç°äº†æ ¸å¿ƒåŠŸèƒ½å’Œ Web UIã€‚</p><p>æœ¬ç¯‡å°±ç»™å¤§å®¶ä»‹ç»ä¸‹å¦‚æœåœ¨ Ruby on Rails çš„æ¡†æ¶ä¸‹è°ƒåº¦å’Œæ‰§è¡Œ Crystal å†™çš„ Workersã€‚æµ‹è¯•ç¯å¢ƒæ˜¯åœ¨ macOS ä¸‹ï¼Œå…¶ä»–ç‰ˆæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š</p><ul><li>Ruby 2.0+<ul><li>Rails 5.0</li><li>Sidekiq 5.0</li></ul></li><li>Crystal 0.22.0+<ul><li>Sidekiq.cr 0.7.0</li></ul></li></ul><h2 id=é…ç½®-rails-ç¯å¢ƒ>é…ç½® Rails ç¯å¢ƒ</h2><p>å¦‚ä½•é…ç½® Rubyã€Railsã€Bundlerã€Redis å°±ä¸åœ¨èµ˜è¿°ï¼Œåªè®²æ ¸å¿ƒï¼Œé¦–å…ˆæ–°å»ºä¸€ä¸ªæœ€åŸºç¡€çš„ rails é¡¹ç›®ï¼Œä¸ç”¨é¢å¤–çš„ç¬¬ä¸‰æ–¹è¾…åŠ©å·¥å…·ï¼Œæ•°æ®åº“ç”¨ sqlite å‡å°‘å¤–éƒ¨ä¾èµ–ï¼š</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>$ rails new ruby_on_rails -B -T -S -C -M  -d sqlite3
</code></pre></div><p>è¿›å…¥é¡¹ç›® <code>ruby_on_rails</code> ç¼–è¾‘ <code>Gemfile</code>:</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=ln> 1</span><span class=c1># ä¿®æ”¹æºåœ°å€</span>
<span class=ln> 2</span><span class=n>source</span> <span class=s1>&#39;https://gems.ruby-china.org&#39;</span>
<span class=ln> 3</span>
<span class=ln> 4</span><span class=c1># æ–°å¢ sidekiq çš„æ”¯æŒ</span>
<span class=ln> 5</span><span class=n>gem</span> <span class=s1>&#39;redis-rails&#39;</span>
<span class=ln> 6</span><span class=n>gem</span> <span class=s1>&#39;sidekiq&#39;</span>
<span class=ln> 7</span>
<span class=ln> 8</span><span class=c1># å…¶ä½™çš„ä¸ç”¨ä¿®æ”¹</span>
<span class=ln> 9</span><span class=c1># Bundle edge Rails instead: gem &#39;rails&#39;, github: &#39;rails/rails&#39;</span>
<span class=ln>10</span><span class=n>gem</span> <span class=s1>&#39;rails&#39;</span><span class=p>,</span> <span class=s1>&#39;~&gt; 5.0.2&#39;</span>
<span class=ln>11</span><span class=c1># Use sqlite3 as the database for Active Record</span>
<span class=ln>12</span><span class=n>gem</span> <span class=s1>&#39;sqlite3&#39;</span>
<span class=ln>13</span><span class=c1># Use Puma as the app server</span>
<span class=ln>14</span><span class=n>gem</span> <span class=s1>&#39;puma&#39;</span><span class=p>,</span> <span class=s1>&#39;~&gt; 3.0&#39;</span>
<span class=ln>15</span>
<span class=ln>16</span><span class=n>gem</span> <span class=s1>&#39;redis-rails&#39;</span>
<span class=ln>17</span><span class=n>gem</span> <span class=s1>&#39;sidekiq&#39;</span>
<span class=ln>18</span>
<span class=ln>19</span><span class=n>group</span> <span class=ss>:development</span><span class=p>,</span> <span class=ss>:test</span> <span class=k>do</span>
<span class=ln>20</span>  <span class=c1># Call &#39;byebug&#39; anywhere in the code to stop execution and get a debugger console</span>
<span class=ln>21</span>  <span class=n>gem</span> <span class=s1>&#39;byebug&#39;</span><span class=p>,</span> <span class=ss>platform</span><span class=p>:</span> <span class=ss>:mri</span>
<span class=ln>22</span><span class=k>end</span>
<span class=ln>23</span>
<span class=ln>24</span><span class=n>group</span> <span class=ss>:development</span> <span class=k>do</span>
<span class=ln>25</span>  <span class=c1># Access an IRB console on exception pages or by using &lt;%= console %&gt; anywhere in the code.</span>
<span class=ln>26</span>  <span class=n>gem</span> <span class=s1>&#39;web-console&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;= 3.3.0&#39;</span>
<span class=ln>27</span>  <span class=n>gem</span> <span class=s1>&#39;listen&#39;</span><span class=p>,</span> <span class=s1>&#39;~&gt; 3.0.5&#39;</span>
<span class=ln>28</span>  <span class=c1># Spring speeds up development by keeping your application running in the background. Read more: https://github.com/rails/spring</span>
<span class=ln>29</span>  <span class=n>gem</span> <span class=s1>&#39;spring&#39;</span>
<span class=ln>30</span>  <span class=n>gem</span> <span class=s1>&#39;spring-watcher-listen&#39;</span><span class=p>,</span> <span class=s1>&#39;~&gt; 2.0.0&#39;</span>
<span class=ln>31</span><span class=k>end</span>
<span class=ln>32</span>
<span class=ln>33</span><span class=c1># Windows does not include zoneinfo files, so bundle the tzinfo-data gem</span>
<span class=ln>34</span><span class=n>gem</span> <span class=s1>&#39;tzinfo-data&#39;</span><span class=p>,</span> <span class=ss>platforms</span><span class=p>:</span> <span class=o>[</span><span class=ss>:mingw</span><span class=p>,</span> <span class=ss>:mswin</span><span class=p>,</span> <span class=ss>:x64_mingw</span><span class=p>,</span> <span class=ss>:jruby</span><span class=o>]</span>
</code></pre></div><p>é…ç½®å¥½ä¹‹åæ‰§è¡Œ <code>bundle insall</code> å®‰è£…å¥½ Gem çš„ä¾èµ–ï¼Œå†åˆ›å»ºæ–‡ä»¶ <code>config/initializers/sidekiq.rb</code>:</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=ln>1</span><span class=n>redis_config</span> <span class=o>=</span> <span class=p>{</span> <span class=ss>url</span><span class=p>:</span> <span class=s1>&#39;redis://localhost:6379/8&#39;</span> <span class=p>}</span>
<span class=ln>2</span>
<span class=ln>3</span><span class=no>Sidekiq</span><span class=o>.</span><span class=n>configure_server</span> <span class=k>do</span> <span class=o>|</span><span class=n>config</span><span class=o>|</span>
<span class=ln>4</span>  <span class=n>config</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_config</span>
<span class=ln>5</span><span class=k>end</span>
<span class=ln>6</span>
<span class=ln>7</span><span class=no>Sidekiq</span><span class=o>.</span><span class=n>configure_client</span> <span class=k>do</span> <span class=o>|</span><span class=n>config</span><span class=o>|</span>
<span class=ln>8</span>  <span class=n>config</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis_config</span>
<span class=ln>9</span><span class=k>end</span>
</code></pre></div><p>Sidekiq çš„é…ç½®å°±å®Œäº‹äº†ã€‚</p><h2 id=é…ç½®-crystal-ç¯å¢ƒ>é…ç½® Crystal ç¯å¢ƒ</h2><p>Crystal æ˜¯åŸºäº LLVM å¼€å‘ï¼Œé™¤äº† Windows ä»¥å¤–å…¶ä»–ç»å¤§æ•°ç³»ç»ŸåŸºæœ¬ä¸Šéƒ½æ”¯æŒï¼ˆæœ€æ–°æ”¯æŒçš„ ARM æ¶æ„ï¼Œå¯åœ¨æ ‘è“æ´¾ä¸Šå®‰è£…ï¼‰ï¼Œ<a href=https://crystal-lang.org/docs/installation/>å®‰è£…æ­¥éª¤</a>åŒæ ·ä¸å†èµ˜è¿°ã€‚</p><p>å®‰è£…å¥½ä¹‹åé¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼š</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>$ crystal init app crystal
</code></pre></div><p>è¿›å…¥é¡¹ç›® <code>crystal</code> ç¼–è¾‘ <code>Shard.yml</code> è¿™æ˜¯ä¸€ä¸ªç±»ä¼¼äº Gemfile çš„åŠŸèƒ½ï¼Œä½†å®ç°çš„å»ä¸­å¿ƒåŒ–ï¼Œåœ¨æ–‡ä»¶æœ«å°¾æ–°å¢å¦‚ä¸‹ä¾èµ–ï¼š</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=ln>1</span><span class=nt>dependencies</span><span class=p>:</span><span class=w>
</span><span class=ln>2</span><span class=w>  </span><span class=nt>sidekiq</span><span class=p>:</span><span class=w>
</span><span class=ln>3</span><span class=w>    </span><span class=nt>github</span><span class=p>:</span><span class=w> </span><span class=l>mperham/sidekiq.cr</span><span class=w>
</span><span class=ln>4</span><span class=w>    </span><span class=nt>branch</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w>
</span></code></pre></div><p>æ‰§è¡Œ <code>shards update</code> æˆ– <code>crystal deps</code> å®‰è£…ä¾èµ–å³å¯ã€‚</p><h2 id=ç¼–å†™-workers>ç¼–å†™ Workers</h2><p>Worker çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯åšä¸€ä¸ªç±»ä¼¼ Redis ping çš„åŠŸèƒ½ï¼ŒWorker åœ¨æ—¥å¿—è¾“å‡º PONGã€‚</p><h3 id=ruby-ç‰ˆæœ¬>Ruby ç‰ˆæœ¬</h3><p>å®‰è£… sidekiq åä¼šåœ¨ rails å†…ç½®å‘½ä»¤å¯ç”ŸæˆåŸºç¡€æ¨¡æ¿ï¼Œåˆ‡æ¢åˆ° <code>ruby_on_rails</code> ç›®å½•ï¼š</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>$ rails g sidekiq:worker ping1
<span class=ln>2</span>      create  app/workers/ping1_worker.rb
<span class=ln>3</span>$ rails g sidekiq:worker ping2
<span class=ln>4</span>      create  app/workers/ping2_worker.rb
</code></pre></div><p>worker çš„å†…å®¹ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘åœ¨æ—¥å¿—è¾“å‡ºå¢åŠ äº† <code>[Ruby]</code> ä½œä¸º Ruby ç‰ˆæœ¬çš„æ ‡è¯†ä¾¿äºåé¢çš„è¾¨è¯†</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=ln> 1</span><span class=c1># app/workers/ping1_worker.rb</span>
<span class=ln> 2</span><span class=k>class</span> <span class=nc>Ping1Worker</span>
<span class=ln> 3</span>  <span class=kp>include</span> <span class=no>Sidekiq</span><span class=o>::</span><span class=no>Worker</span>
<span class=ln> 4</span>
<span class=ln> 5</span>  <span class=k>def</span> <span class=nf>perform</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
<span class=ln> 6</span>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span> <span class=s2>&#34;[Ruby] PONG !&#34;</span>
<span class=ln> 7</span>  <span class=k>end</span>
<span class=ln> 8</span><span class=k>end</span>
<span class=ln> 9</span>
<span class=ln>10</span><span class=c1># app/workers/ping2_worker.rb</span>
<span class=ln>11</span><span class=k>class</span> <span class=nc>Ping2Worker</span>
<span class=ln>12</span>  <span class=kp>include</span> <span class=no>Sidekiq</span><span class=o>::</span><span class=no>Worker</span>
<span class=ln>13</span>
<span class=ln>14</span>  <span class=k>def</span> <span class=nf>perform</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
<span class=ln>15</span>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span> <span class=s2>&#34;[Ruby] PONG PONG !!&#34;</span>
<span class=ln>16</span>  <span class=k>end</span>
<span class=ln>17</span><span class=k>end</span>
</code></pre></div><h3 id=crystal-ç‰ˆæœ¬>Crystal ç‰ˆæœ¬</h3><p>åˆ‡æ¢åˆ° <code>crystal</code> ç›®å½•ä¸‹å’Œ Ruby ä¸åŒçš„æ˜¯å®ƒçš„æºç æ˜¯å­˜æ”¾åœ¨ src ç›®å½•ä¸‹é¢ï¼Œæˆ‘ä»¬ç¨å¾®è°ƒæ•´ä¸‹ç»“æ„ï¼š</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln> 1</span>.
<span class=ln> 2</span>â”œâ”€â”€ LICENSE
<span class=ln> 3</span>â”œâ”€â”€ README.md
<span class=ln> 4</span>â”œâ”€â”€ lib
<span class=ln> 5</span>â”œâ”€â”€ shard.lock
<span class=ln> 6</span>â”œâ”€â”€ shard.yml
<span class=ln> 7</span>â”œâ”€â”€ spec
<span class=ln> 8</span>â””â”€â”€ src
<span class=ln> 9</span>    â”œâ”€â”€ crystal_server.cr
<span class=ln>10</span>    â””â”€â”€ workers
<span class=ln>11</span>        â”œâ”€â”€ ping1_worker.cr
<span class=ln>12</span>        â””â”€â”€ ping2_worker.cr
</code></pre></div><p>worker çš„å†…å®¹å¦‚ä¸‹ï¼Œå¹¶è®¾ç½® queue ä¸º <code>crystal</code> ç”¨äºæŒ‡æ´¾ä½¿ç”¨:</p><div class=highlight><pre class=chroma><code class=language-crystal data-lang=crystal><span class=ln> 1</span><span class=c1># src/workers/ping1_worker.cr</span>
<span class=ln> 2</span><span class=k>class</span> <span class=nc>Ping1Worker</span>
<span class=ln> 3</span>  <span class=k>include</span> <span class=n>Sidekiq</span><span class=o>::</span><span class=n>Worker</span>
<span class=ln> 4</span>  <span class=n>sidekiq_options</span> <span class=k>do</span> <span class=o>|</span><span class=n>job</span><span class=o>|</span>
<span class=ln> 5</span>    <span class=n>job</span><span class=o>.</span><span class=n>queue</span> <span class=o>=</span> <span class=s2>&#34;crystal&#34;</span>
<span class=ln> 6</span>  <span class=k>end</span>
<span class=ln> 7</span>
<span class=ln> 8</span>  <span class=k>def</span> <span class=nf>perform</span><span class=p>()</span>
<span class=ln> 9</span>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span> <span class=s2>&#34;[Crystal] PONG !&#34;</span>
<span class=ln>10</span>  <span class=k>end</span>
<span class=ln>11</span><span class=k>end</span>
<span class=ln>12</span>
<span class=ln>13</span><span class=c1># src/workers/ping2_worker.cr</span>
<span class=ln>14</span><span class=k>class</span> <span class=nc>Ping2Worker</span>
<span class=ln>15</span>  <span class=k>include</span> <span class=n>Sidekiq</span><span class=o>::</span><span class=n>Worker</span>
<span class=ln>16</span>  <span class=n>sidekiq_options</span> <span class=k>do</span> <span class=o>|</span><span class=n>job</span><span class=o>|</span>
<span class=ln>17</span>    <span class=n>job</span><span class=o>.</span><span class=n>queue</span> <span class=o>=</span> <span class=s2>&#34;crystal&#34;</span>
<span class=ln>18</span>  <span class=k>end</span>
<span class=ln>19</span>
<span class=ln>20</span>  <span class=k>def</span> <span class=nf>perform</span><span class=p>()</span>
<span class=ln>21</span>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span> <span class=s2>&#34;[Crystal] PONG PONG !!&#34;</span>
<span class=ln>22</span>  <span class=k>end</span>
<span class=ln>23</span><span class=k>end</span>
</code></pre></div><p>é€šè¿‡ä»£ç å¯ä»¥çœ‹å‡º Ruby å’Œ Crystal çš„ä»£ç åŸºæœ¬ä¸Šæ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚</p><h2 id=ä»»ç£äºŒè„‰>ä»»ç£äºŒè„‰</h2><p>å¯¹äºä½¿ç”¨ Sidekiq çš„ç«¥é‹éƒ½çŸ¥é“ï¼Œå¦‚æœæˆ‘æƒ³æ‰§è¡Œä¸€ä¸ªé˜Ÿåˆ—ä»»åŠ¡ï¼Œåªéœ€è¦è°ƒç”¨ä¸‹ Worker æœ¬èº«çš„ <code>perform_*</code> æ–¹æ³•ï¼Œè¿™æ ·çš„è¯æ ¹æœ¬æ— æ³•è°ƒç”¨ä¸€ä¸ªä¸åŒè¯­è¨€ç‰ˆæœ¬çš„ Worker å¦åˆ™ sidekiq ä¼šæŠ¥ç±»ä¼¼å¦‚ä¸‹é”™è¯¯ï¼š</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>2017-04-26T06:19:14.187Z <span class=m>50690</span> TID-ox4qa1k8o WARN: <span class=o>{</span><span class=s2>&#34;context&#34;</span>:<span class=s2>&#34;Job raised exception&#34;</span>,<span class=s2>&#34;job&#34;</span>:<span class=o>{</span><span class=s2>&#34;class&#34;</span>:<span class=s2>&#34;Crystal::Ping1Worker&#34;</span>,<span class=s2>&#34;args&#34;</span>:<span class=o>[]</span>,<span class=s2>&#34;retry&#34;</span>:true,<span class=s2>&#34;queue&#34;</span>:<span class=s2>&#34;default&#34;</span>,<span class=s2>&#34;jid&#34;</span>:<span class=s2>&#34;42ce106d79
</span><span class=ln>2</span><span class=s2>01a274f3db2d54&#34;</span>,<span class=s2>&#34;created_at&#34;</span>:1493187554.181674,<span class=s2>&#34;enqueued_at&#34;</span>:1493187554.1820428<span class=o>}</span>,<span class=s2>&#34;jobstr&#34;</span>:<span class=s2>&#34;{\&#34;class\&#34;:\&#34;Crystal::Ping1Worker\&#34;,\&#34;args\&#34;:[],\&#34;retry\&#34;:true,\&#34;queue\&#34;:\&#34;default\&#34;,\&#34;jid
</span><span class=ln>3</span><span class=s2>\&#34;:\&#34;42ce106d7901a274f3db2d54\&#34;,\&#34;created_at\&#34;:1493187554.181674,\&#34;enqueued_at\&#34;:1493187554.1820428}&#34;</span><span class=o>}</span>
<span class=ln>4</span>2017-04-26T06:19:14.187Z <span class=m>50690</span> TID-ox4qa1k8o WARN: NameError: uninitialized constant Crystal
</code></pre></div><p>æ‰“é€šä»»ç£äºŒè„‰çš„å…³é”®åœ¨äºä¸¤ä¸ªç‰ˆæœ¬éƒ½æä¾›ä¸€ä¸ª low-level çš„ API å¯ç”¨äºå®šåˆ¶åŒ–è°ƒç”¨ï¼š</p><h3 id=ruby-ç‰ˆæœ¬-1>Ruby ç‰ˆæœ¬</h3><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=ln>1</span><span class=n>job_id</span> <span class=o>=</span> <span class=no>Sidekiq</span><span class=o>::</span><span class=no>Client</span><span class=o>.</span><span class=n>push</span><span class=p>(</span>
<span class=ln>2</span>  <span class=s1>&#39;queue&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>  <span class=c1># æŒ‡æ´¾ç‰¹å®šçš„é˜Ÿåˆ—åï¼Œé»˜è®¤æ˜¯ default</span>
<span class=ln>3</span>  <span class=s1>&#39;class&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>  <span class=c1># Worker çš„ç±»åï¼Œå¯ä»¥æ˜¯å®ä¾‹åŒ–ç±»å‹æˆ–å­—ç¬¦ä¸²ç±»å‹</span>
<span class=ln>4</span>  <span class=s1>&#39;args&#39;</span> <span class=o>=&gt;[]</span>     <span class=c1># Worker æ¥æ”¶çš„å‚æ•°ï¼Œä»¥æ•°ç»„å½¢å¼ä¼ é€’</span>
<span class=ln>5</span><span class=p>)</span>
</code></pre></div><h3 id=crystal-ç‰ˆæœ¬-1>Crystal ç‰ˆæœ¬</h3><div class=highlight><pre class=chroma><code class=language-crystal data-lang=crystal><span class=ln>1</span><span class=n>job</span> <span class=o>=</span> <span class=n>Sidekiq</span><span class=o>::</span><span class=n>Job</span><span class=o>.</span><span class=n>new</span>
<span class=ln>2</span><span class=n>job</span><span class=o>.</span><span class=n>queue</span> <span class=o>=</span> <span class=s2>&#34;default&#34;</span>   <span class=c1># æŒ‡æ´¾ç‰¹å®šçš„é˜Ÿåˆ—åï¼Œé»˜è®¤æ˜¯ default</span>
<span class=ln>3</span><span class=n>job</span><span class=o>.</span><span class=n>klass</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>          <span class=c1># Worker çš„ç±»åï¼Œå¯ä»¥æ˜¯å®ä¾‹åŒ–ç±»å‹æˆ–å­—ç¬¦ä¸²ç±»å‹</span>
<span class=ln>4</span><span class=n>job</span><span class=o>.</span><span class=n>args</span> <span class=o>=</span> <span class=o>[].</span><span class=n>to_json</span>   <span class=c1># Worker æ¥æ”¶çš„å‚æ•°ï¼Œä»¥æ•°ç»„å½¢å¼ä¼ é€’</span>
<span class=ln>5</span>
<span class=ln>6</span><span class=n>client</span> <span class=o>=</span> <span class=n>Sidekiq</span><span class=o>::</span><span class=n>Client</span><span class=o>.</span><span class=n>new</span>
<span class=ln>7</span><span class=n>job_id</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=n>job</span><span class=p>)</span>
</code></pre></div><h2 id=æ‰“é€šä»»ç£äºŒè„‰>æ‰“é€šä»»ç£äºŒè„‰</h2><p>å‡†å¤‡å·¥ä½œå°±ç»ªï¼Œæ‰“é€šä»»ç£äºŒè„‰çš„å…³é”®å°±åªå·®ä¸€ä¸ªäº†ï¼é‚£å°±æ˜¯å¯¹äº redis æ•°æ®å…±äº«ï¼Œç»†å¿ƒçš„ç«¥é‹å¯èƒ½ç•™æ„äº†ä¸Šé¢åªé…ç½®äº† Ruby ç‰ˆæœ¬çš„ redis è¿æ¥ï¼Œä½†å¯¹äº Crystal æˆ‘æ•…æ„ç•™ç™½æ²¡æœ‰è¯´æ˜ã€‚å› ä¸ºè¿™ä¸ªæ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œå¯¹äºå½“å‰ sidekiq.cr ç‰ˆæœ¬æ¥è¯´ã€‚</p><p>sidekiq.cr å¯¹äºä½œè€…æ¥è¯´æ˜¯ä¸€æ¬¡è¯•æ°´å¹¶æ²¡æœ‰è¯ç‰¹åˆ«å¤§çš„ç²¾åŠ›ï¼ŒCrystal æœ¬èº«è¿˜å¤„åœ¨å¼€å‘é˜¶æ®µåœ¨æœªåˆ°è¾¾ 1.0 ä¹‹å‰ä¼šæœ‰å„ç§ Break Changesã€‚è€Œä¸”ä½œè€…æ˜¯éå¸¸ç…§é¡¾ Heroku çš„å¼€å‘è€…ï¼Œé»˜è®¤ä»…æ”¯æŒè¯¥æœåŠ¡å¹³å° Redis-to-Go æœåŠ¡ï¼Œå› æ­¤æƒ³è®¾ç½® Redis è¿æ¥ä¿¡æ¯å¿…é¡»é€šè¿‡ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ï¼š</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span><span class=nv>REDISTOGO_URL</span><span class=o>=</span>redis://localhost:6379/8
<span class=ln>2</span><span class=nv>REDIS_PROVIDER</span><span class=o>=</span><span class=nv>$REDISTOGO_URL</span>
</code></pre></div><p>ä¸Šé¢çš„é…ç½®æ˜¯ä¸å¯çœç•¥çš„ï¼Œå› ä¸ºæˆ‘ä¸ªäººä¸æ‡‚ Heroku ç»™ä½œè€…ä¹±æäº† PL è¿˜è¢«ä½œè€…ç‹ æ‰¹äº†ä¸€é¡¿ :(</p><p>å›åˆ°è¯é¢˜æœ¬èº«ï¼Œæˆ‘ä»¬æ¥ç»§ç»­å†™ä¸Š <code>src/crystal_server.cr</code> å…³é”®çš„ä»£ç ï¼š</p><blockquote><p>æ³¨æ„ï¼šredis è¿æ¥ä¿¡æ¯æ— æ¯”ä¿è¯å’Œ rails é…ç½®çš„æ˜¯ä¸€è‡´çš„ï¼</p></blockquote><div class=highlight><pre class=chroma><code class=language-crystal data-lang=crystal><span class=ln> 1</span><span class=k>require</span> <span class=s2>&#34;sidekiq&#34;</span>
<span class=ln> 2</span><span class=k>require</span> <span class=s2>&#34;sidekiq/cli&#34;</span>
<span class=ln> 3</span><span class=k>require</span> <span class=s2>&#34;./workers/*&#34;</span>
<span class=ln> 4</span>
<span class=ln> 5</span><span class=no>ENV</span><span class=o>[</span><span class=s2>&#34;LOCAL_REDIS&#34;</span><span class=o>]</span> <span class=o>=</span> <span class=s2>&#34;redis://localhost:6379/8&#34;</span>
<span class=ln> 6</span><span class=no>ENV</span><span class=o>[</span><span class=s2>&#34;REDIS_PROVIDER&#34;</span><span class=o>]</span> <span class=o>=</span> <span class=s2>&#34;LOCAL_REDIS&#34;</span>
<span class=ln> 7</span>
<span class=ln> 8</span><span class=n>cli</span> <span class=o>=</span> <span class=n>Sidekiq</span><span class=o>::</span><span class=no>CLI</span><span class=o>.</span><span class=n>new</span>
<span class=ln> 9</span><span class=n>server</span> <span class=o>=</span> <span class=n>cli</span><span class=o>.</span><span class=n>configure</span> <span class=k>do</span> <span class=o>|</span><span class=n>config</span><span class=o>|</span>
<span class=ln>10</span>  <span class=c1># æ”¯æŒä¸­é—´ä»¶ï¼Œé»˜è®¤ç•™ç©ºå³å¯</span>
<span class=ln>11</span><span class=k>end</span>
<span class=ln>12</span>
<span class=ln>13</span><span class=n>cli</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>server</span><span class=p>)</span>
</code></pre></div><p>ä»£ç éœ€è¦ç¼–è¯‘æ‰§è¡Œï¼Œå› ä¸ºä¸ç¼–è¯‘æ˜¯æ— æ³•ç»™ sidekiq cli ä¼ é€’å®ƒæ¥å—çš„å‚æ•°ï¼ˆå½“ç„¶ä¹Ÿæœ‰æ–¹æ³•ï¼Œæˆ‘æ”¾åœ¨æœ«å°¾èŒƒä¾‹æºç ä¸­è‡ªå·±å¯»æ‰¾ï¼‰</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>$ crystal build src/crystal_server.cr -o crystal_server
</code></pre></div><p>é€šè¿‡ä¸Šé¢å‘½ä»¤æŠŠæºç ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶åˆ°é¡¹ç›®æ ¹ç›®å½•çš„ <code>crystal_server</code> æ–‡ä»¶ã€‚</p><p>æ‰“å¼€ç»ˆç«¯ä¸€ï¼šå¯åŠ¨ ruby çš„ sidekiq server</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln> 1</span>$ <span class=nb>cd</span> ruby_on_rails
<span class=ln> 2</span>$ sidekiq -q default
<span class=ln> 3</span>2017-04-26T06:47:19.299Z <span class=m>76282</span> TID-owewdljsc INFO: Booting Sidekiq 4.2.10 with redis options <span class=o>{</span>:url<span class=o>=</span>&gt;<span class=s2>&#34;redis://localhost:6379/8&#34;</span><span class=o>}</span>
<span class=ln> 4</span>
<span class=ln> 5</span>
<span class=ln> 6</span>         m,
<span class=ln> 7</span>         <span class=sb>`</span><span class=nv>$b</span>
<span class=ln> 8</span>    .ss,  <span class=nv>$$</span>:         .,d$
<span class=ln> 9</span>    <span class=sb>`</span><span class=nv>$$</span>P,d<span class=nv>$P</span><span class=s1>&#39;    .,md$P&#34;&#39;</span>
<span class=ln>10</span>     ,<span class=nv>$$$$$bmmd$$$P</span>^<span class=s1>&#39;
</span><span class=ln>11</span><span class=s1>   .d$$$$$$$$$$P&#39;</span>
<span class=ln>12</span>   <span class=nv>$$</span>^<span class=s1>&#39; `&#34;^$$$&#39;</span>       ____  _     _      _    _
<span class=ln>13</span>   $:     ,<span class=nv>$$</span>:       / ___<span class=p>|</span><span class=o>(</span>_<span class=o>)</span> __<span class=p>|</span> <span class=p>|</span> ___<span class=p>|</span> <span class=p>|</span> _<span class=o>(</span>_<span class=o>)</span> __ _
<span class=ln>14</span>   <span class=sb>`</span>b     :<span class=nv>$$</span>        <span class=se>\_</span>__ <span class=se>\|</span> <span class=p>|</span>/ _<span class=sb>`</span> <span class=p>|</span>/ _ <span class=se>\ </span><span class=p>|</span>/ / <span class=p>|</span>/ _<span class=sb>`</span> <span class=p>|</span>
<span class=ln>15</span>          <span class=nv>$$</span>:         ___<span class=o>)</span> <span class=p>|</span> <span class=p>|</span> <span class=o>(</span>_<span class=p>|</span> <span class=p>|</span>  __/   &lt;<span class=p>|</span> <span class=p>|</span> <span class=o>(</span>_<span class=p>|</span> <span class=p>|</span>
<span class=ln>16</span>          <span class=nv>$$</span>         <span class=p>|</span>____/<span class=p>|</span>_<span class=p>|</span><span class=se>\_</span>_,_<span class=p>|</span><span class=se>\_</span>__<span class=p>|</span>_<span class=p>|</span><span class=se>\_\_</span><span class=p>|</span><span class=se>\_</span>_, <span class=p>|</span>
<span class=ln>17</span>        .d<span class=nv>$$</span>                                       <span class=p>|</span>_<span class=p>|</span>
<span class=ln>18</span>
<span class=ln>19</span>2017-04-26T06:47:19.433Z <span class=m>76282</span> TID-owewdljsc INFO: Running in ruby 2.4.0p0 <span class=o>(</span>2016-12-24 revision 57164<span class=o>)</span> <span class=o>[</span>x86_64-darwin16<span class=o>]</span>
<span class=ln>20</span>2017-04-26T06:47:19.433Z <span class=m>76282</span> TID-owewdljsc INFO: See LICENSE and the LGPL-3.0 <span class=k>for</span> licensing details.
<span class=ln>21</span>2017-04-26T06:47:19.433Z <span class=m>76282</span> TID-owewdljsc INFO: Upgrade to Sidekiq Pro <span class=k>for</span> more features and support: http://sidekiq.org
<span class=ln>22</span>2017-04-26T06:47:19.442Z <span class=m>76282</span> TID-owewdljsc INFO: Starting processing, hit Ctrl-C to stop
</code></pre></div><p>æ‰“å¼€ç»ˆç«¯äºŒï¼šå¯åŠ¨ crystal çš„ sidekiq server</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln> 1</span>$ <span class=nb>cd</span> crystal
<span class=ln> 2</span>$ ./crystal_server -q crystal
<span class=ln> 3</span>
<span class=ln> 4</span>         m,
<span class=ln> 5</span>         <span class=sb>`</span><span class=nv>$b</span>
<span class=ln> 6</span>    .ss,  <span class=nv>$$</span>:         .,d$
<span class=ln> 7</span>    <span class=sb>`</span><span class=nv>$$</span>P,d<span class=nv>$P</span><span class=s1>&#39;    .,md$P&#34;&#39;</span>
<span class=ln> 8</span>     ,<span class=nv>$$$$$bmmd$$$P</span>^<span class=s1>&#39;
</span><span class=ln> 9</span><span class=s1>   .d$$$$$$$$$$P&#39;</span>
<span class=ln>10</span>   <span class=nv>$$</span>^<span class=s1>&#39; `&#34;^$$$&#39;</span>       ____  _     _      _    _
<span class=ln>11</span>   $:     ,<span class=nv>$$</span>:       / ___<span class=p>|</span><span class=o>(</span>_<span class=o>)</span> __<span class=p>|</span> <span class=p>|</span> ___<span class=p>|</span> <span class=p>|</span> _<span class=o>(</span>_<span class=o>)</span> __ _
<span class=ln>12</span>   <span class=sb>`</span>b     :<span class=nv>$$</span>        <span class=se>\_</span>__ <span class=se>\|</span> <span class=p>|</span>/ _<span class=sb>`</span> <span class=p>|</span>/ _ <span class=se>\ </span><span class=p>|</span>/ / <span class=p>|</span>/ _<span class=sb>`</span> <span class=p>|</span>
<span class=ln>13</span>          <span class=nv>$$</span>:         ___<span class=o>)</span> <span class=p>|</span> <span class=p>|</span> <span class=o>(</span>_<span class=p>|</span> <span class=p>|</span>  __/   &lt;<span class=p>|</span> <span class=p>|</span> <span class=o>(</span>_<span class=p>|</span> <span class=p>|</span>
<span class=ln>14</span>          <span class=nv>$$</span>         <span class=p>|</span>____/<span class=p>|</span>_<span class=p>|</span><span class=se>\_</span>_,_<span class=p>|</span><span class=se>\_</span>__<span class=p>|</span>_<span class=p>|</span><span class=se>\_\_</span><span class=p>|</span><span class=se>\_</span>_, <span class=p>|</span>
<span class=ln>15</span>        .d<span class=nv>$$</span>                                       <span class=p>|</span>_<span class=p>|</span>
<span class=ln>16</span>
<span class=ln>17</span>2017-04-26T06:48:42.755Z <span class=m>83552</span> TID-21ybwjk  INFO: Sidekiq v0.7.0 in Crystal 0.22.0
<span class=ln>18</span>2017-04-26T06:48:42.755Z <span class=m>83552</span> TID-21ybwjk  INFO: Licensed <span class=k>for</span> use under the terms of the GNU LGPL-3.0 license.
<span class=ln>19</span>2017-04-26T06:48:42.755Z <span class=m>83552</span> TID-21ybwjk  INFO: Upgrade to Sidekiq Enterprise <span class=k>for</span> more features and support: http://sidekiq.org
<span class=ln>20</span>2017-04-26T06:48:42.755Z <span class=m>83552</span> TID-21ybwjk  INFO: Starting processing with <span class=m>25</span> workers
<span class=ln>21</span>2017-04-26T06:48:42.756Z <span class=m>83552</span> TID-21ybwjk  INFO: Press Ctrl-C to stop
</code></pre></div><h2 id=éªŒè¯åŠŸåŠ›æ•ˆæœ>éªŒè¯åŠŸåŠ›æ•ˆæœ</h2><p>ä¸¤è¾¹çš„ sidekiq server éƒ½å·²ç»è·‘èµ·æ¥äº†ï¼Œæˆ‘ä»¬å…ˆä» rails å¯åŠ¨ console éªŒè¯ï¼Œæ³¨æ„ç•™æ„ä¸¤ä¸ª sidekiq ç»ˆç«¯æ—¥å¿—çš„è¾“å‡ºï¼š</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>$ rails console
<span class=ln>2</span>Loading development environment <span class=o>(</span>Rails 5.0.2<span class=o>)</span>
<span class=ln>3</span>
<span class=ln>4</span><span class=c1># è°ƒç”¨ rails æœ¬èº«çš„ ping1 å’Œ ping2 worker</span>
<span class=ln>5</span>2.4.0 :001 &gt; Sidekiq::Client.push<span class=o>(</span><span class=s1>&#39;class&#39;</span> <span class=o>=</span>&gt; <span class=s1>&#39;Ping1Worker&#39;</span>, <span class=s1>&#39;args&#39;</span> <span class=o>=</span>&gt;<span class=o>[])</span>
<span class=ln>6</span> <span class=o>=</span>&gt; <span class=s2>&#34;961500753aa127b73ac50851&#34;</span>
<span class=ln>7</span>2.4.0 :002 &gt; Sidekiq::Client.push<span class=o>(</span><span class=s1>&#39;class&#39;</span> <span class=o>=</span>&gt; <span class=s1>&#39;Ping2Worker&#39;</span>, <span class=s1>&#39;args&#39;</span> <span class=o>=</span>&gt;<span class=o>[])</span>
<span class=ln>8</span> <span class=o>=</span>&gt; <span class=s2>&#34;be366d2e5f44adf367853d82&#34;</span>
</code></pre></div><p>å¯¹åº” rails çš„ sidekiq server ä¼šåŒæ—¶è¾“å‡ºï¼š</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>2017-04-26T06:53:01.722Z <span class=m>76282</span> TID-owex58ag8 Ping1Worker JID-961500753aa127b73ac50851 INFO: start
<span class=ln>2</span>2017-04-26T06:53:01.722Z <span class=m>76282</span> TID-owex58ag8 Ping1Worker JID-961500753aa127b73ac50851 INFO: <span class=o>[</span>Ruby<span class=o>]</span> PONG !
<span class=ln>3</span>2017-04-26T06:53:01.722Z <span class=m>76282</span> TID-owex58ag8 Ping1Worker JID-961500753aa127b73ac50851 INFO: <span class=k>done</span>: 0.0 sec
<span class=ln>4</span>2017-04-26T06:53:52.681Z <span class=m>76282</span> TID-owex58bs0 Ping2Worker JID-be366d2e5f44adf367853d82 INFO: start
<span class=ln>5</span>2017-04-26T06:53:52.681Z <span class=m>76282</span> TID-owex58bs0 Ping2Worker JID-be366d2e5f44adf367853d82 INFO: <span class=o>[</span>Ruby<span class=o>]</span> PONG PONG !!
<span class=ln>6</span>2017-04-26T06:53:52.681Z <span class=m>76282</span> TID-owex58bs0 Ping2Worker JID-be366d2e5f44adf367853d82 INFO: <span class=k>done</span>: 0.0 sec
</code></pre></div><p>è‡ªèº«ä¸€è„‰æœ¬æ¥å°±æ˜¯é€šçš„æ²¡ä»€ä¹ˆå¥½ç¨€å¥‡çš„ï¼ŒéªŒè¯å¦å¤–ä¸€è„‰ï¼š</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>$ rails console
<span class=ln>2</span>Loading development environment <span class=o>(</span>Rails 5.0.2<span class=o>)</span>
<span class=ln>3</span>
<span class=ln>4</span><span class=c1># è°ƒç”¨ crystal çš„ ping1 å’Œ ping2 worker</span>
<span class=ln>5</span>2.4.0 :001 &gt; Sidekiq::Client.push<span class=o>(</span><span class=s1>&#39;class&#39;</span> <span class=o>=</span>&gt; <span class=s1>&#39;Ping1Worker&#39;</span>, <span class=s1>&#39;args&#39;</span> <span class=o>=</span>&gt;<span class=o>[]</span>, <span class=s1>&#39;queue&#39;</span> <span class=o>=</span>&gt; <span class=s1>&#39;crystal&#39;</span><span class=o>)</span>
<span class=ln>6</span> <span class=o>=</span>&gt; <span class=s2>&#34;324cf5e07b5e2999b0a45565&#34;</span>
<span class=ln>7</span>2.4.0 :002 &gt; Sidekiq::Client.push<span class=o>(</span><span class=s1>&#39;class&#39;</span> <span class=o>=</span>&gt; <span class=s1>&#39;Ping2Worker&#39;</span>, <span class=s1>&#39;args&#39;</span> <span class=o>=</span>&gt;<span class=o>[]</span>, <span class=s1>&#39;queue&#39;</span> <span class=o>=</span>&gt; <span class=s1>&#39;crystal&#39;</span><span class=o>)</span>
<span class=ln>8</span> <span class=o>=</span>&gt; <span class=s2>&#34;06c60bb9d52d9a31d48d2fdc&#34;</span>
</code></pre></div><p>çœ‹çœ‹ crystal çš„ sidekiq server çš„æ—¥å¿—ï¼š</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>2017-04-26T06:57:11.846Z <span class=m>21253</span> TID-1z8q4cg  <span class=nv>JID</span><span class=o>=</span>324cf5e07b5e2999b0a45565 INFO: Start
<span class=ln>2</span>2017-04-26T06:57:11.846Z <span class=m>21253</span> TID-1z8q4cg  <span class=nv>JID</span><span class=o>=</span>324cf5e07b5e2999b0a45565 INFO: <span class=o>[</span>Crystal<span class=o>]</span> PONG !
<span class=ln>3</span>2017-04-26T06:57:11.846Z <span class=m>21253</span> TID-1z8q4cg  <span class=nv>JID</span><span class=o>=</span>324cf5e07b5e2999b0a45565 INFO: Done: 0.000046 sec
<span class=ln>4</span>2017-04-26T06:57:20.785Z <span class=m>21253</span> TID-1z8q3y8  <span class=nv>JID</span><span class=o>=</span>06c60bb9d52d9a31d48d2fdc INFO: Start
<span class=ln>5</span>2017-04-26T06:57:20.785Z <span class=m>21253</span> TID-1z8q3y8  <span class=nv>JID</span><span class=o>=</span>06c60bb9d52d9a31d48d2fdc INFO: <span class=o>[</span>Crystal<span class=o>]</span> PONG PONG !!
<span class=ln>6</span>2017-04-26T06:57:20.785Z <span class=m>21253</span> TID-1z8q3y8  <span class=nv>JID</span><span class=o>=</span>06c60bb9d52d9a31d48d2fdc INFO: Done: 0.000049 sec
</code></pre></div><p>éªŒè¯é€šè¿‡ï¼æ‰“é€šäº†ï¼</p><p>Crystal è¿™è¾¹å‘ Ruby è°ƒç”¨ä¹Ÿå¯è¡Œï¼Œä½†åªæœ‰é€šè¿‡å¦‚ä¸‹ä»£ç ï¼Œæœ‰ä¸ªåˆ«æ—¶å€™è‡ªèº«è°ƒç”¨ä¹Ÿæ²¡æœ‰æ—¥å¿—è¾“å‡ºï¼Œä¸è¿‡åœ¨ Web UI å´å‘ç°å·²å¤„ç†çš„æ•°å­—å·²æ­£å¸¸æ›´æ–°ï¼Œè¯¥é—®é¢˜æˆ‘å†è°ƒæŸ¥ä¸‹ã€‚</p><div class=highlight><pre class=chroma><code class=language-crystal data-lang=crystal><span class=ln> 1</span><span class=k>require</span> <span class=s2>&#34;sidekiq&#34;</span>
<span class=ln> 2</span>
<span class=ln> 3</span><span class=no>ENV</span><span class=o>[</span><span class=s2>&#34;LOCAL_REDIS&#34;</span><span class=o>]</span> <span class=o>=</span> <span class=s2>&#34;redis://localhost:6379/8&#34;</span>
<span class=ln> 4</span><span class=no>ENV</span><span class=o>[</span><span class=s2>&#34;REDIS_PROVIDER&#34;</span><span class=o>]</span> <span class=o>=</span> <span class=s2>&#34;LOCAL_REDIS&#34;</span>
<span class=ln> 5</span>
<span class=ln> 6</span><span class=n>workers</span> <span class=o>=</span> <span class=sx>%w(Ping1Worker Ping2Worker)</span>
<span class=ln> 7</span><span class=n>workers</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>wk_class</span><span class=o>|</span>
<span class=ln> 8</span>  <span class=n>job</span> <span class=o>=</span> <span class=n>Sidekiq</span><span class=o>::</span><span class=n>Job</span><span class=o>.</span><span class=n>new</span>
<span class=ln> 9</span>  <span class=n>job</span><span class=o>.</span><span class=n>queue</span> <span class=o>=</span> <span class=s2>&#34;default&#34;</span>
<span class=ln>10</span>  <span class=n>job</span><span class=o>.</span><span class=n>klass</span> <span class=o>=</span> <span class=n>wk_class</span>
<span class=ln>11</span>
<span class=ln>12</span>  <span class=n>Sidekiq</span><span class=o>::</span><span class=n>Client</span><span class=o>.</span><span class=n>default_context</span> <span class=o>=</span> <span class=n>Sidekiq</span><span class=o>::</span><span class=n>Client</span><span class=o>::</span><span class=n>Context</span><span class=o>.</span><span class=n>new</span>
<span class=ln>13</span>
<span class=ln>14</span>  <span class=n>client</span> <span class=o>=</span> <span class=n>Sidekiq</span><span class=o>::</span><span class=n>Client</span><span class=o>.</span><span class=n>new</span>
<span class=ln>15</span>  <span class=n>job_id</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=n>job</span><span class=p>)</span>
<span class=ln>16</span>  <span class=nb>puts</span> <span class=s2>&#34;[</span><span class=si>#{</span><span class=n>wk_class</span><span class=si>}</span><span class=s2>] job id: </span><span class=si>#{</span><span class=n>job_id</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=ln>17</span><span class=k>end</span>
</code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>2017-04-26T07:20:58.754Z <span class=m>62256</span> TID-oukzi7jck Ping1Worker JID-1fee81b35052cba1f6525de5 INFO: start
<span class=ln>2</span>2017-04-26T07:20:58.754Z <span class=m>62256</span> TID-oukzi7jck Ping1Worker JID-1fee81b35052cba1f6525de5 INFO: <span class=o>[</span>Ruby<span class=o>]</span> PONG !
<span class=ln>3</span>2017-04-26T07:20:58.755Z <span class=m>62256</span> TID-oukzi7jck Ping1Worker JID-1fee81b35052cba1f6525de5 INFO: <span class=k>done</span>: 0.0 sec
<span class=ln>4</span>2017-04-26T07:20:58.756Z <span class=m>62256</span> TID-oul02vzfw Ping2Worker JID-0bb7eef097447784fb48d943 INFO: start
<span class=ln>5</span>2017-04-26T07:20:58.756Z <span class=m>62256</span> TID-oul02vzfw Ping2Worker JID-0bb7eef097447784fb48d943 INFO: <span class=o>[</span>Ruby<span class=o>]</span> PONG PONG !!
<span class=ln>6</span>2017-04-26T07:20:58.756Z <span class=m>62256</span> TID-oul02vzfw Ping2Worker JID-0bb7eef097447784fb48d943 INFO: <span class=k>done</span>: 0.0 sec
</code></pre></div><h2 id=ç»“è¯­>ç»“è¯­</h2><p>æœ¬ç¯‡åªæ˜¯é€šè¿‡ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­è®©å¤§å®¶çŸ¥é“äº’é€šçš„æ–¹æ³•ï¼Œå®é™…ä½¿ç”¨ä¸­å¯¹äºæ•°æ®äº¤äº’ç­‰è¿˜æœ‰æ›´å¤šéœ€è¦è€ƒè™‘çš„åœ°æ–¹ï¼Œè¿™é‡Œå°±æš‚æ—¶ä¸åšå±•å¼€ã€‚éå¸¸æœŸå¾… Crystal ä»Šå¹´ç«‹çš„ <a href=https://crystal-lang.org/2016/12/29/crystal-new-year-resolutions-for-2017-1-0.html>1.0 çš„ç›®æ ‡</a>ã€‚</p><p>å¯¹äº Crystal è¯­è¨€æœ¬èº«çš„è¯„ä»·ï¼Œå¤§å®¶ä¹Ÿå¯çœ‹ä¸‹ RubyChina ç«™é•¿çš„å¿ƒå¾—<a href=https://ruby-china.org/topics/32771>Crystal è¯´æˆ‘æœ€è¿‘å…³æ³¨ Crystal çš„æ„Ÿå—</a>ï¼Œç¼–è¯‘è¯­è¨€æœ‰ç¼–è¯‘è¯­è¨€çš„å‘ï¼Œå…¥å‘éœ€è°¨æ…ã€‚</p><p>æœ¬æ–‡æ¼”ç¤ºçš„ä»£ç å·²ç»æ•´ç†å¹¶æ”¾åˆ°äº† <a href=https://github.com/icyleaf/sidekiq-with-ruby-and-crystal>Github</a>ï¼Œå¯¹äºä¸æ˜ç™½çš„åœ°æ–¹å¯é…åˆä»£ç æ›´å¥½æœç”¨ã€‚</p></div><div class=post-nav><a href=https://icyleaf.com/2017/03/fastlane-match-in-action/ class=prev rel=prev title="ä½ è™æˆ‘åƒç™¾éï¼Œæˆ‘å¾…ä½ å¦‚åˆæ‹ï¼Œç›´åˆ°æˆ‘é‡åˆ° match"><i class="iconfont icon-left"></i>&nbsp;ä½ è™æˆ‘åƒç™¾éï¼Œæˆ‘å¾…ä½ å¦‚åˆæ‹ï¼Œç›´åˆ°æˆ‘é‡åˆ° match</a>
<a href=https://icyleaf.com/2017/05/fast-crystal/ class=next rel=next title="Fast Crystal">Fast Crystal&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2021</span>
<span>ğŸº</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script><script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script>pangu.spacingPage()</script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-2570916-5','auto'),ga('send','pageview')</script></div></body></html>