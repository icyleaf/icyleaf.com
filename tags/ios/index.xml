<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>IOS on icyleaf</title><link>https://icyleaf.com/tags/ios/</link><description>Recent content in IOS on icyleaf</description><language>zh-cn</language><lastBuildDate>Thu, 10 Nov 2022 15:30:07 +0800</lastBuildDate><atom:link href="https://icyleaf.com/tags/ios/index.xml" rel="self" type="application/rss+xml"/><item><title>Cocoapods CDN 加速新解</title><link>https://icyleaf.com/2022/11/cocoapods-cdn-speed-up-another-solution/</link><pubDate>Thu, 10 Nov 2022 15:30:07 +0800</pubDate><guid>https://icyleaf.com/2022/11/cocoapods-cdn-speed-up-another-solution/</guid><description>官方 CDN 不稳定，Git 源又太大，还要其他解决方案吗？</description><content:encoded><![CDATA[<p>距离 Cocoapods 支持 CDN 源已经 3 年，期间不断有开发者从 CDN 源切回了最初 Git 源的方案，Cocoapods 也没有更多的改进措施。</p>
<p>当初写<a href="https://icyleaf.com/2019/11/cocoapods-cdn-source-code-reading/">CDN 加速镜像源码解读</a>还是用的 jsdelivr 没想到过了 2 个小版本改 Netlify 了。从国内几大 DNS 解析结果来看总会到 cloudflare 上面。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">$ doggo cdn.cocoapods.org CNAME @202.106.0.20
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME          	TYPE	CLASS	TTL 	ADDRESS                       	NAMESERVER
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">cocoapods.org.	SOA 	IN   	303s	betty.ns.cloudflare.com.      	202.106.0.20:53
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">              	    	     	    	dns.cloudflare.com. <span class="m">2280316554</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">              	    	     	    	<span class="m">10000</span> <span class="m">2400</span> <span class="m">604800</span> <span class="m">3600</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">$ doggo cdn.cocoapods.org CNAME @114.114.114.114
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">NAME          	TYPE	CLASS	TTL 	ADDRESS                       	NAMESERVER
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">cocoapods.org.	SOA 	IN   	277s	betty.ns.cloudflare.com.      	114.114.114.114:53
</span></span><span class="line"><span class="ln">10</span><span class="cl">              	    	     	    	dns.cloudflare.com. <span class="m">2280316554</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">              	    	     	    	<span class="m">10000</span> <span class="m">2400</span> <span class="m">604800</span> <span class="m">3600</span>
</span></span></code></pre></div><p>jsdelir 的 CDN 是全球覆盖相对比较广的，中国地区用的是网宿节点，但<a href="https://www.v2ex.com/t/823281">证书问题</a>现在流量都切到了 Fastly</p>













  
  
    
      <figure data-pswp="2270x1316" data-size="800x"><a href="/uploads/2022/11/10/jsdelivr-network.png" class="gallery-item" target="_blank" data-pswp-width="2270" data-pswp-height="1316"><img src="/uploads/2022/11/10/jsdelivr-network_hu6915014520778962123.png"/></a><figcaption>

    <p>jsdelivr network</p></figcaption></figure>

<p>国内 DNS 解析的结果可以看出来：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">$ doggo cdn.jsdelivr.net CNAME @114.114.114.114
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME             	TYPE 	CLASS	TTL  	ADDRESS                 	NAMESERVER
</span></span><span class="line"><span class="ln">3</span><span class="cl">cdn.jsdelivr.net.	CNAME	IN   	1529s	jsdelivr.map.fastly.net.	114.114.114.114:53
</span></span><span class="line"><span class="ln">4</span><span class="cl">
</span></span><span class="line"><span class="ln">5</span><span class="cl">15:38:53 in ~
</span></span><span class="line"><span class="ln">6</span><span class="cl">$ doggo cdn.jsdelivr.net CNAME @202.106.0.20
</span></span><span class="line"><span class="ln">7</span><span class="cl">NAME             	TYPE 	CLASS	TTL  	ADDRESS                 	NAMESERVER
</span></span><span class="line"><span class="ln">8</span><span class="cl">cdn.jsdelivr.net.	CNAME	IN   	1515s	jsdelivr.map.fastly.net.	202.106.0.20:53
</span></span></code></pre></div><p>jsdelivr 支持 Github 仓库代码的 CDN 加速，利用本机制可以把 CDN 源加速到 jsdelivr。</p>
<p>官方 CDN 源的源码仓库是 <a href="https://github.com/CocoaPods/cdn.cocoapods.org">Cocoapods/cdn.cocoapods.org</a>，主分支是同步脚本，<code>gh-pages</code> 分支是源的真实数据。</p>













  
  
    
      <figure data-pswp="1698x582" data-size="800x"><a href="/uploads/2022/11/10/jsdelivr-github-demo.png" class="gallery-item" target="_blank" data-pswp-width="1698" data-pswp-height="582"><img src="/uploads/2022/11/10/jsdelivr-github-demo_hu10365139180803583141.png"/></a><figcaption><p class="source"><a href="https://www.jsdelivr.com/github">生成工具</a>
    </p>

    <p>Cocoapods github 仓库和 jsdelivr CDN 生成结果</p></figcaption></figure>

<p>打开 <code>Podfile</code> 修改或添加新的地址：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="ln">1</span><span class="cl"><span class="gd">- source &#34;https://cdn.cocoapods.org&#34;
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="gd"></span><span class="gi">+ source &#34;https://cdn.jsdelivr.net/gh/CocoaPods/cdn.cocoapods.org@gh-pages&#34;
</span></span></span></code></pre></div><p>也可以手动指定 jsdelivr 不同的 CDN 供应商</p>
<ul>
<li>fastly.jsdelivr.net</li>
<li>testingcf.jsdelivr.net</li>
<li>quantil.jsdelivr.net (目前不可用)</li>
</ul>
<p>利用这个原理可以套到任何支持 Github 仓库作为 CDN 加速的服务。</p>
]]></content:encoded></item><item><title>Cocoapods 新增 CDN 加速镜像源码解读</title><link>https://icyleaf.com/2019/11/cocoapods-cdn-source-code-reading/</link><pubDate>Fri, 15 Nov 2019 19:10:07 +0800</pubDate><guid>https://icyleaf.com/2019/11/cocoapods-cdn-source-code-reading/</guid><description>通过代码剖析对比前后都发生了什么变化</description><content:encoded><![CDATA[<p>Cocoapods <a href="https://blog.cocoapods.org/CocoaPods-1.7.2/">1.7.2</a> 版本开始增加 CDN 支持但默认没有启用，<a href="http://blog.cocoapods.org/CocoaPods-1.8.0-beta/">1.8</a> 版本的发布舍弃了原始完整克隆的 Specs 仓库改用 CDN 服务。CDN 利用的是免费且强大的 <a href="https://github.com/CocoaPods/Core/pull/541">Netlify</a> CDN 服务，<del>该 CDN 网络在国内是有备案因此速度和稳定性都会有很好的保证</del>。类似提案去年有人用 Cocoapods Plugin 实现并向社区<a href="https://github.com/CocoaPods/CocoaPods/issues/8268">贡献 PR</a>。</p>
<p>那么 CDN 支持相比之前的机制有啥优势呢？难道是把 Pods 的仓库和源码都托管到 CDN 网络了吗，其实并不是的。</p>
<blockquote>
<p>友情提醒：本文只重点分析 Pods 下载的机制，不展开其他方面，以下只是 <code>pod install</code> 执行顺序中的一部分，如果你想了解 Cocoapods 都干了什么可以前往<a href="https://www.jianshu.com/p/84936d9344ff">这篇文章</a>查阅。</p>
</blockquote>
<h3 id="老的机制">老的机制</h3>
<p>第一步先检查本地 <code>~/.cocoapods/repo/master</code> 目录是否存在，没有直接克隆 <code>https://github.com/Cocoapods/Specs.git</code> 仓库，这步在国内来说特别费时间正常下载下来目录应该是 2G+，如果有其他 source 源（比如私有源）会重复刚才的操作。</p>
<p>第二步安装 Podfile 每个 Pod 去在各个源中寻找对应的版本，从版本的 .podspec 文件解析获取组件的地址，这个可能是 http、git、svn、hg 中的<a href="https://guides.cocoapods.org/syntax/podspec.html#source">任意一个</a>，获取到之后开始下载（默认是在 <code>~/Library/Caches/CocoaPods</code> 做缓存目录）</p>
<h3 id="新的机制">新的机制</h3>
<p>第一步分析 Podfile 里面的 source ，如果没有走默认 Cocoapods 的配置（1.8 以上是 <a href="https://cdn.cocoapods.org">https://cdn.cocoapods.org</a> ，之前的还是 Cocoapods/Spec），
如果本地不存在官方 cdn 的 repo 名字是 trunk 的保留字，自己无法创建。如果有自定义的 source 会追加上去 sources 列表。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="ln"> 1</span><span class="cl">$ http HEAD https://cdn.cocoapods.org/all_pods.txt
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">HTTP/1.1 200 OK
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Accept-Ranges: bytes
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">Age: 0
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">Cache-Control: public, max-age=0, must-revalidate
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">Connection: keep-alive
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Content-Length: 924280
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Content-Type: text/plain; charset=UTF-8
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Date: Sat, 09 Nov 2019 07:06:15 GMT
</span></span><span class="line"><span class="ln">10</span><span class="cl">Etag: &#34;acf0d284f3a8e82e0d66ba1a91cd30b9-ssl&#34;
</span></span><span class="line"><span class="ln">11</span><span class="cl">Server: Netlify
</span></span><span class="line"><span class="ln">12</span><span class="cl">Strict-Transport-Security: max-age=31536000
</span></span><span class="line"><span class="ln">13</span><span class="cl">X-NF-Request-ID: 50b466cd-ce9e-4326-b5bb-0d29a193ae4b-7809449
</span></span></code></pre></div><p>第二步检查或下载每个 source，每个 source 会检查是否是 cdn 类型（使用 HEAD 请求检查是否包含 /all_pods.txt）文件：</p>
<ul>
<li>cdn 类型，下面详细解释</li>
<li>其他类型，走原来的老的逻辑，不再赘述</li>
</ul>
<p>第三步，下载 <code>Cocoapods-version.yml</code> 并缓存 etag，下载 <code>/Cocoapods-version.yml</code> 并取 headers 的第一个 etag 的值存为 <code>/Cocoapods-version.yml.etag</code>，如果存在 etag 会比对一样就不需要下载， 链接支持根目录和其他目录，支持 301 跳转。</p>
<p>Cocoapods-version.yml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nt">min</span><span class="p">:</span><span class="w"> </span><span class="m">1.0.0</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nt">last</span><span class="p">:</span><span class="w"> </span><span class="m">1.8.4</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="nt">prefix_lengths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span>- <span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span>- <span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span>- <span class="m">1</span><span class="w">
</span></span></span></code></pre></div><p>第四步，分析 Pod 并获取 pod 的版本信息，比如 Podfile 我增加了一个 <code>pod &quot;AFNetworking&quot;</code>，把 pod 名字做 MD5 后的值取 Cocoapods-version.yml 的 prefiex_length 数组长度的值单字母拆分用下划线分割按照规则拼成文件名 <code>all_pods_versions(_{fragment}).txt</code> (如果prefix_length 为 0 则只会去下载 <code>/all_pods_versions.txt</code>)</p>
<p>比如：prefix_lengths 数组大小为 3，AFNetworking MD5 后 <code>a75d452377f396bdc4b623a5df25820</code> 则匹配前三位 a75 拆分后 a_7_5
后查找 cdn url 路径的 <code>/all_pods_versions_a_7_5.txt</code> 下载下来后的内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="ln">1</span><span class="cl">Fuse/0.1.0/0.2.0/1.0.0/1.1.0/1.2.0
</span></span><span class="line"><span class="ln">2</span><span class="cl">GXFlowView/1.0.0
</span></span><span class="line"><span class="ln">3</span><span class="cl">JFCountryPicker/0.0.1/0.0.2
</span></span><span class="line"><span class="ln">4</span><span class="cl">JVEmptyElement/0.1.0
</span></span></code></pre></div><p>第五步，下载 pod 的所有版本的 .podspec 文件，从上面的文件按照每行寻找第一段的名字，把后面的所有版本按照上面获取到的 prefix_lengths 的值（例如 AFNetworking 是 a, 7 , 5） <code>/Specs/a/7/5/AFNetworking/{version}/AFNetworking.podspec.json</code> 一次下载，并保存 etag 为 <code>/Specs/a/7/5/AFNetworking/{version}/AFNetworking.podspec.json.etag</code>，这个 etag 作用上面已经讲过，如果没有找到的话就会直接报错。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="ln">1</span><span class="cl">Adding spec repo `trunk` with CDN `https://cdn.cocoapods.org/`
</span></span><span class="line"><span class="ln">2</span><span class="cl">  CDN: trunk Relative path downloaded: CocoaPods-version.yml, save ETag: &#34;031c25b97a0aca21900087e355dcf663-ssl&#34;
</span></span><span class="line"><span class="ln">3</span><span class="cl">  CDN: trunk Relative path: CocoaPods-version.yml exists! Returning local because checking is only perfomed in repo update
</span></span><span class="line"><span class="ln">4</span><span class="cl">  CDN: trunk Relative path downloaded: all_pods_versions_a_7_5.txt, save ETag: &#34;5b32718ecbe82b0ae71ab3c77120213f-ssl&#34;
</span></span><span class="line"><span class="ln">5</span><span class="cl">  CDN: trunk Redirecting from https://cdn.cocoapods.org/Specs/a/7/5/AFNetworking/0.10.0/AFNetworking.podspec.json to https://raw.githubusercontent.com/CocoaPods/Specs/master/Specs/a/7/5/AFNetworking/0.10.0/AFNetworking.podspec.json
</span></span><span class="line"><span class="ln">6</span><span class="cl">  CDN: trunk Relative path downloaded: Specs/a/7/5/AFNetworking/0.10.0/AFNetworking.podspec.json, save ETag: W/&#34;a5f00eb1fdfdcab00b89e96bb81d48c110f09220063fdcf0b269290bffc18cf5&#34;
</span></span></code></pre></div><p>Cocoapods trunk 源的目录结构：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="ln">1</span><span class="cl">.cocoapods
</span></span><span class="line"><span class="ln">2</span><span class="cl">  repo
</span></span><span class="line"><span class="ln">3</span><span class="cl">    trunk
</span></span><span class="line"><span class="ln">4</span><span class="cl">      .url   #=&gt; https://cdn.cocoapods.org/
</span></span><span class="line"><span class="ln">5</span><span class="cl">      Cocoapods-version.yml  # =&gt; 从 https://cdn.cocoapods.org/CocoaPods-version.yml 下载的文件
</span></span><span class="line"><span class="ln">6</span><span class="cl">      Cocoapods-version.yml.etag  # 上一个请求的第一个 etag 值存下来
</span></span><span class="line"><span class="ln">7</span><span class="cl">      all_pods_versions_a_7_5.txt  # 参考上面的备注
</span></span><span class="line"><span class="ln">8</span><span class="cl">      all_pods_versions_a_7_5.txt.etag # 上一个请求的第一个 etag 值存下来
</span></span></code></pre></div><p>第六步和老的机制第二步一样同样最终还是会寻找 podspec 里面下载地址去下载，
也就是说<strong>真正 CDN 缓存加速的只有原有 Specs 必要的 podspec 文件，而不会加速 Pod 真正源地址</strong>，改机制只是减轻了本地更新官方 Specs 源的麻烦以及维护一个巨大的本地文件存储，这也是中心化机制的一个心结。</p>
<h3 id="结语">结语</h3>
<p>这个机制大大减少了本地需要占一个较大存储的问题，尤其是初次 <code>pod install</code> 时间长的情况，但 Pod 库本身还是各自的
地址本质上无法解决安装 Pod 消耗时间过长的问题。</p>
]]></content:encoded></item><item><title>你虐我千百遍，我待你如初恋，直到我遇到 match</title><link>https://icyleaf.com/2017/03/fastlane-match-in-action/</link><pubDate>Tue, 28 Mar 2017 20:12:07 +0800</pubDate><guid>https://icyleaf.com/2017/03/fastlane-match-in-action/</guid><description>系列文章的第三篇，教你如何使用 match 管理名词都分不清的苹果各自开发者证书</description><content:encoded><![CDATA[<h2 id="前言">前言</h2>
<p>通过前两篇的文章大家已经对 fastlane 的概念和基本使用已经有了初步的掌握，在第二篇中也有提到 fastlane 实现的各种功能其实都是基于独立封装设计的各个工具实现。它们即可以单独成为一个体系同时也会被吸纳到 fastlane 的 action 系统之中。<code>match</code> 是在 iOS 开发和持续测试和构建中最重中之重的环节，它维护和管理着 iOS 的各种证书和 profile 的创建、更新工作。想必很多用户听到 iOS 证书和 profile 都会头大脑涨，恨不得要手撕鬼子的技能点来对付他们（如图）</p>
<p><img loading="lazy" src="https://codesigning.guide/assets/img/cs-the-problem.png"
  
  
  alt="code-signing-problem"></img>
</p>
<p>上图来源于作者专门整理的网站 <a href="https://codesigning.guide/">https://codesigning.guide/</a>，对于 iOS App 签名原理感兴趣的可以参见 JSPatch 作者的分析：http://blog.cnbang.net/tech/3386/</p>
<h2 id="功能特性">功能特性</h2>
<ol>
<li>主动/被动创建、更新、Xcode 所需的各种证书和打包所需的 Profiles</li>
<li>托管 Xcode 所需的各种证书和打包所需的 Profiles</li>
<li>统一并共享团队成员统一使用</li>
<li>证书具有密码加密保护（openssl）</li>
<li>支持多团队（账户）</li>
<li>支持单 App 多 Target(identifier)</li>
<li>内测支持企业账户（v0.11.0 还在测试可用，并没有正式支持）</li>
</ol>
<h2 id="原理">原理</h2>
<p>match 其实是在 fastlane 基础包 cert、sign、spaceship、credentials_manager 之上把 iOS 开发者证书流程化的工具。为了实现团队内共享项目的开发者证书，它使用 git 仓库对证书进行托管，首先需要进行初始化，配置 git 仓库、项目的 iDP 信息之后，下载 Development、AppStore、AdHoc 的开发者证书和项目的 Profile files，并通过 openssl 的方式进行安全加密后提交并推送到 git 仓库，其他成员（或自动化构建系统）使用时需要输入密钥后才能把证书解密并导入到 keychain 和 Profiles 目录。</p>
<p>如果对于证书加密策略感兴趣的可以在本文底部资料参考的第一个链接查看详情。</p>
<h2 id="使用">使用</h2>
<blockquote>
<p>最新 fastlane 已经包含了所有的子模块，独立的 match 不在更新，请直接安装 fastlane，使用 fastlane match 代替 match 命令。</p>
</blockquote>
<p>安装就很简单通过 <code>gem install fastlane</code> 会把它的全家桶一并下载安装，首先可以看下帮助：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">$ fastlane match --help
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">  match
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  Easily sync your certificates and profiles across your team using git
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  Commands:
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    adhoc             Run match <span class="k">for</span> a adhoc provisioning profile
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    appstore          Run match <span class="k">for</span> a appstore provisioning profile
</span></span><span class="line"><span class="ln">10</span><span class="cl">    change_password   Re-encrypt all files with a different password
</span></span><span class="line"><span class="ln">11</span><span class="cl">    decrypt           Decrypts the repository and keeps it on the filesystem
</span></span><span class="line"><span class="ln">12</span><span class="cl">    development       Run match <span class="k">for</span> a development provisioning profile
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="nb">help</span>              Display global or <span class="o">[</span>command<span class="o">]</span> <span class="nb">help</span> documentation
</span></span><span class="line"><span class="ln">14</span><span class="cl">    init              Create the Matchfile <span class="k">for</span> you
</span></span><span class="line"><span class="ln">15</span><span class="cl">    nuke              Delete all certificates and provisioning profiles from the Apple Dev Portal
</span></span><span class="line"><span class="ln">16</span><span class="cl">    nuke development  Delete all certificates and provisioning profiles from the Apple Dev Portal of the <span class="nb">type</span> development
</span></span><span class="line"><span class="ln">17</span><span class="cl">    nuke distribution Delete all certificates and provisioning profiles from the Apple Dev Portal of the <span class="nb">type</span> distribution
</span></span><span class="line"><span class="ln">18</span><span class="cl">    run               Easily sync your certificates and profiles across your team using git
</span></span><span class="line"><span class="ln">19</span><span class="cl">
</span></span><span class="line"><span class="ln">20</span><span class="cl">  Global Options:
</span></span><span class="line"><span class="ln">21</span><span class="cl">    --verbose
</span></span><span class="line"><span class="ln">22</span><span class="cl">    -r, --git_url STRING URL to the git repo containing all the certificates <span class="o">(</span>MATCH_GIT_URL<span class="o">)</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    --git_branch STRING  Specific git branch to use <span class="o">(</span>MATCH_GIT_BRANCH<span class="o">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    -y, --type STRING    Create a development certificate instead of a distribution one <span class="o">(</span>MATCH_TYPE<span class="o">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">    -a, --app_identifier <span class="o">[</span>VALUE<span class="o">]</span> The bundle identifier<span class="o">(</span>s<span class="o">)</span> of your app <span class="o">(</span>comma-separated<span class="o">)</span> <span class="o">(</span>MATCH_APP_IDENTIFIER<span class="o">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    -u, --username STRING Your Apple ID Username <span class="o">(</span>MATCH_USERNAME<span class="o">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    -s, --keychain_name STRING Keychain the items should be imported to <span class="o">(</span>MATCH_KEYCHAIN_NAME<span class="o">)</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">    -p, --keychain_password STRING This might be required the first <span class="nb">time</span> you access certificates on a new mac. For the login/default keychain this is your account password <span class="o">(</span>MATCH_KEYCHAIN_PASSWORD<span class="o">)</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">    --readonly <span class="o">[</span>VALUE<span class="o">]</span>   Only fetch existing certificates and profiles, don<span class="s1">&#39;t generate new ones (MATCH_READONLY)
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="s1">    -b, --team_id STRING The ID of your Developer Portal team if you&#39;</span>re in multiple teams <span class="o">(</span>FASTLANE_TEAM_ID<span class="o">)</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">    -l, --team_name STRING The name of your Developer Portal team <span class="k">if</span> you<span class="err">&#39;</span>re in multiple teams <span class="o">(</span>FASTLANE_TEAM_NAME<span class="o">)</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">    --verbose <span class="o">[</span>VALUE<span class="o">]</span>    Print out extra information and all commands <span class="o">(</span>MATCH_VERBOSE<span class="o">)</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">    --force <span class="o">[</span>VALUE<span class="o">]</span>      Renew the provisioning profiles every <span class="nb">time</span> you run match <span class="o">(</span>MATCH_FORCE<span class="o">)</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">    --skip_confirmation <span class="o">[</span>VALUE<span class="o">]</span> Disables confirmation prompts during nuke, answering them with yes <span class="o">(</span>MATCH_SKIP_CONFIRMATION<span class="o">)</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">    --shallow_clone <span class="o">[</span>VALUE<span class="o">]</span> Make a shallow clone of the repository <span class="o">(</span>truncate the <span class="nb">history</span> to <span class="m">1</span> revision<span class="o">)</span> <span class="o">(</span>MATCH_SHALLOW_CLONE<span class="o">)</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">    --force_for_new_devices <span class="o">[</span>VALUE<span class="o">]</span> Renew the provisioning profiles <span class="k">if</span> the device count on the developer portal has changed <span class="o">(</span>MATCH_FORCE_FOR_NEW_DEVICES<span class="o">)</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">    --skip_docs <span class="o">[</span>VALUE<span class="o">]</span>  Skip generation of a README.md <span class="k">for</span> the created git repository <span class="o">(</span>MATCH_SKIP_DOCS<span class="o">)</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">    -h, --help           Display <span class="nb">help</span> documentation
</span></span><span class="line"><span class="ln">39</span><span class="cl">    -v, --version        Display version information
</span></span></code></pre></div><p>建议大家在项目中创建并配置 <code>fastlane/Matchfile</code> 文件可以把命令需要的参数省略：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">$ fastlane match init
</span></span></code></pre></div><p>设置好 git_url(git 仓库地址）、type（默认同步证书类型）、app_identifier、username（iDP 的账户名）即可。</p>
<h2 id="生成和同步证书">生成和同步证书</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># 开发环境证书</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">$ fastlane match development
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"># 产品环境证书</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">$ fastlane match appstore
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c1"># 内测环境证书</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">$ fastlane match adhoc
</span></span></code></pre></div><p>初次使用的时候会提示需要输入 iDP 的账户密码，校验成功后可以保存到 keychain 中后续可以不在重复输入（好贴心）密码（也可通过设置变量 FASTLANE_PASSWORD），该密码就是上面提到的证书加密的密钥，请妥善保存。</p>
<blockquote>
<p>提示：如果担心密码泄露可设置 FASTLANE_DONT_STORE_PASSWORD = true 不进行密码保存至 keychain，在 keychain 可通过关键词 &ldquo;deliver.&rdquo; 检索。</p>
</blockquote>
<p>有的童鞋说我们有 299 的企业证书，为什么不做支持呢？起初作者并没有打算进行支持是担心滥用以及代码结构需要较大的变更，随着开发者呼声太高，其实还是做了支持，只不过并没有正式的纳入，需要通过配置环境变量支持：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># 企业环境证书</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">$ ENV<span class="o">[</span><span class="s1">&#39;MATCH_FORCE_ENTERPRISE&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span> <span class="o">&amp;&amp;</span> fastlane match enterprise
</span></span></code></pre></div><h2 id="修改密钥">修改密钥</h2>
<p>建议密码定期更换或再人员发生变更之后进行密码变更：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">$ fastlane match change_password
</span></span></code></pre></div><h2 id="重新生成">重新生成</h2>
<p><strong>慎用</strong>：match 提供一个命令允许把当前的证书撤销后并全新的重新生成一份，这个事项是会把证书和 Profiles 全部包含在内，如果单纯的想只重设 Profles 并同步是不支持的。我想这也是为什么该命名叫做 <code>nuke</code></p>
<p>我这里可给大家提供一种只同步 profile 的方法：首先在 git 仓库中找到你要重设的 profile 文件，并把它从仓库中删除提交，然后在执行该类型的命令即可，命令发现没有 profile 会自动再生成一个 profile 并下载同步至 git 仓库。</p>
<h2 id="资料参考">资料参考</h2>
<ul>
<li><a href="http://macoscope.com/blog/simplify-your-life-with-fastlane-match/">http://macoscope.com/blog/simplify-your-life-with-fastlane-match/</a></li>
<li><a href="https://github.com/fastlane/fastlane/issues/2007">https://github.com/fastlane/fastlane/issues/2007</a></li>
</ul>
]]></content:encoded></item><item><title>深入浅出 Fastlane 一看你就懂</title><link>https://icyleaf.com/2016/07/fastlane-in-action/</link><pubDate>Tue, 19 Jul 2016 20:12:07 +0800</pubDate><guid>https://icyleaf.com/2016/07/fastlane-in-action/</guid><description>系列文章的第二篇，带你了解 fastlane 使用流程</description><content:encoded><![CDATA[<p>本篇我想着重介绍 <code>fastlane</code> 本身的基本使用，这里使用 fastlane v1.98.0 作为演示版本。</p>
<h2 id="命令行工具">命令行工具</h2>
<p>安装之后默认会安装一个命令行工具 <code>fastlane</code>，利用它可以初始化、执行任务、查看任务定义、查看可用的动作和动作的详细定义，甚至可以用它来创建自定义的动作、插件以及一些辅助功能。想了解的话可以先看看它的帮助：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">$ fastlane --help
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">  fastlane
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  CLI <span class="k">for</span> <span class="s1">&#39;fastlane&#39;</span> - The easiest way to automate building and releasing your iOS and Android apps
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        Run using <span class="sb">`</span>fastlane <span class="o">[</span>platform<span class="o">]</span> <span class="o">[</span>lane_name<span class="o">]</span><span class="sb">`</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        To pass values to the lanes use <span class="sb">`</span>fastlane <span class="o">[</span>platform<span class="o">]</span> <span class="o">[</span>lane_name<span class="o">]</span> key:value key2:value2<span class="sb">`</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">  Commands:
</span></span><span class="line"><span class="ln">11</span><span class="cl">    action                  Shows more information <span class="k">for</span> a specific <span class="nb">command</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    actions                 Lists all available fastlane actions
</span></span><span class="line"><span class="ln">13</span><span class="cl">    add_plugin              Add a new plugin to your fastlane setup
</span></span><span class="line"><span class="ln">14</span><span class="cl">    disable_crash_reporting Deprecated: fastlane doesn<span class="s1">&#39;t use a crash reporter any more
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="s1">    docs                    Generate a markdown based documentation based on the Fastfile
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="s1">    enable_auto_complete    Enable tab auto completion
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="s1">    enable_crash_reporting  Deprecated: fastlane doesn&#39;</span>t use a crash reporter any more
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="nb">help</span>                    Display global or <span class="o">[</span>command<span class="o">]</span> <span class="nb">help</span> documentation
</span></span><span class="line"><span class="ln">19</span><span class="cl">    init                    Helps you with your initial fastlane setup
</span></span><span class="line"><span class="ln">20</span><span class="cl">    install_plugins         Install all plugins <span class="k">for</span> this project
</span></span><span class="line"><span class="ln">21</span><span class="cl">    lanes                   Lists all available lanes and shows their description
</span></span><span class="line"><span class="ln">22</span><span class="cl">    list                    Lists all available lanes without description
</span></span><span class="line"><span class="ln">23</span><span class="cl">    new_action              Create a new custom action <span class="k">for</span> fastlane.
</span></span><span class="line"><span class="ln">24</span><span class="cl">    new_plugin              Create a new plugin that can be used with fastlane
</span></span><span class="line"><span class="ln">25</span><span class="cl">    run                     Run a fastlane one-off action without a full lane
</span></span><span class="line"><span class="ln">26</span><span class="cl">    search_plugins          Search <span class="k">for</span> plugins, search query is optional
</span></span><span class="line"><span class="ln">27</span><span class="cl">    trigger                 Run a sepcific lane. Pass the lane name and optionally the platform first.
</span></span><span class="line"><span class="ln">28</span><span class="cl">    update_plugins          Update all plugin dependencies
</span></span><span class="line"><span class="ln">29</span><span class="cl">
</span></span><span class="line"><span class="ln">30</span><span class="cl">  Global Options:
</span></span><span class="line"><span class="ln">31</span><span class="cl">    --verbose
</span></span><span class="line"><span class="ln">32</span><span class="cl">    -h, --help           Display <span class="nb">help</span> documentation
</span></span><span class="line"><span class="ln">33</span><span class="cl">    -v, --version        Display version information
</span></span><span class="line"><span class="ln">34</span><span class="cl">
</span></span><span class="line"><span class="ln">35</span><span class="cl">  Author:
</span></span><span class="line"><span class="ln">36</span><span class="cl">    Felix Krause &lt;fastlane@krausefx.com&gt;
</span></span><span class="line"><span class="ln">37</span><span class="cl">
</span></span><span class="line"><span class="ln">38</span><span class="cl">  Website:
</span></span><span class="line"><span class="ln">39</span><span class="cl">    https://fastlane.tools
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl">  GitHub:
</span></span><span class="line"><span class="ln">42</span><span class="cl">    https://github.com/fastlane/fastlane
</span></span></code></pre></div><p>我会随着下面每个概念的解释和展开来配合上面的命令一起讲解。</p>
<h2 id="生命周期">生命周期</h2>
<table>
  <thead>
      <tr>
          <th style="text-align: left">执行顺序</th>
          <th style="text-align: left">方法名</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">1</td>
          <td style="text-align: left">before_all</td>
          <td style="text-align: left">在执行 lane 之前只执行一次</td>
      </tr>
      <tr>
          <td style="text-align: left">2</td>
          <td style="text-align: left">before_each</td>
          <td style="text-align: left">每次执行 lane 之前都会执行一次</td>
      </tr>
      <tr>
          <td style="text-align: left">3</td>
          <td style="text-align: left">lane</td>
          <td style="text-align: left">自定义的任务</td>
      </tr>
      <tr>
          <td style="text-align: left">4</td>
          <td style="text-align: left">after_each</td>
          <td style="text-align: left">每次执行 lane 之后都会执行一次</td>
      </tr>
      <tr>
          <td style="text-align: left">5</td>
          <td style="text-align: left">after_all</td>
          <td style="text-align: left">在执行 lane 成功结束之后执行一次</td>
      </tr>
      <tr>
          <td style="text-align: left">6</td>
          <td style="text-align: left">error</td>
          <td style="text-align: left">在执行上述情况任意环境报错都会中止并执行一次</td>
      </tr>
  </tbody>
</table>
<p>以上的部分大家在上一篇已经见识过了，有些还没接触到，不用着急都会一一说明。</p>
<h2 id="任务lane">任务（lane）</h2>
<p>正常情况下你可能只会是用到一种任务方法 <code>lane</code> 但其实它会包含很多中高级用法。在文章的末尾会详细描述。</p>
<h3 id="任务定义">任务定义</h3>
<p>定义任务的方法类似于 rake 的 task，但使用上缺比前者要好用很多，见下表：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">定义</th>
          <th style="text-align: left">是否必须</th>
          <th style="text-align: left">说明</th>
          <th style="text-align: left">备注</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">desc</td>
          <td style="text-align: left"><code>false</code></td>
          <td style="text-align: left">方法描述</td>
          <td style="text-align: left">可多次使用打到换行的目的</td>
      </tr>
      <tr>
          <td style="text-align: left">name</td>
          <td style="text-align: left"><code>true</code></td>
          <td style="text-align: left">方法名</td>
          <td style="text-align: left">符号化的方法名</td>
      </tr>
      <tr>
          <td style="text-align: left">options</td>
          <td style="text-align: left"><code>false</code></td>
          <td style="text-align: left">方法参数</td>
          <td style="text-align: left">返回 Hash 类型</td>
      </tr>
      <tr>
          <td style="text-align: left">task</td>
          <td style="text-align: left"><code>true</code></td>
          <td style="text-align: left">方法主体</td>
          <td style="text-align: left">参考 ruby 的方法代码且支持 ruby 代码</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">desc</span> <span class="s1">&#39;定义一个 build 方法&#39;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">desc</span> <span class="s1">&#39;参数 adhoc 判断是否为内测版本, 默认为 false&#39;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">desc</span> <span class="s1">&#39;fastlane build&#39;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">desc</span> <span class="s1">&#39;fastlane build adhoc:true&#39;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">lane</span> <span class="ss">:build</span> <span class="k">do</span> <span class="o">|</span><span class="n">options</span><span class="o">|</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="c1"># task to do something</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  <span class="n">adhoc</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:adhoc</span><span class="o">]</span> <span class="o">||</span> <span class="kp">false</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  <span class="nb">puts</span> <span class="s2">&#34;adhoc: </span><span class="si">#{</span><span class="n">adhoc</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">  <span class="n">gym</span><span class="p">(</span><span class="ss">type</span><span class="p">:</span> <span class="n">adhoc</span> <span class="p">?</span> <span class="s1">&#39;adhoc&#39;</span> <span class="p">:</span> <span class="s1">&#39;appstore&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><h3 id="任务执行">任务执行</h3>
<p>一般情况下它需要配合定义好的 lane 才能使用，刚刚我们定义的一个 build 方法，我们这里就试着执行一下吧。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># 默认执行</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">$ fastlane build
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"># 传递参数</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">$ fastlane build adhoc:true
</span></span></code></pre></div><h3 id="任务互调">任务互调</h3>
<p><code>lane</code> 其实可以理解为 <code>def</code> 的别名，因此多个 lane 的话实际上是可以相互调用的，这个其实特别实用，这样其实我就可以把 cocoapods 的执行放到单独的 lane 里面而不是 <code>before_all</code>，这样执行非构建的任务就不会执行不相关的任务或动作，因此 fastlane 而产生了一个私有任务用内部使用 <code>private_lane</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln"> 1</span><span class="cl">
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">default_platform</span> <span class="ss">:ios</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">platform</span> <span class="ss">:ios</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  <span class="n">desc</span> <span class="s1">&#39;构建前的准备工作&#39;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="n">desc</span> <span class="s1">&#39;这是一个私有任务，仅供 Fastfile 内部 lane 调用使用&#39;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  <span class="n">lane</span> <span class="ss">:prepare</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="n">cocoapods</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="n">match</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">  <span class="n">desc</span> <span class="s1">&#39;通用的构建任务&#39;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">  <span class="n">desc</span> <span class="s1">&#39;fastlane build&#39;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">  <span class="n">desc</span> <span class="s1">&#39;fastlane build type:adhoc&#39;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">  <span class="n">lane</span> <span class="ss">:build</span> <span class="k">do</span> <span class="o">|</span><span class="n">options</span><span class="o">|</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="c1"># 调用上面 prepare 私有任务</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="n">prepare</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="k">case</span> <span class="n">options</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="k">when</span> <span class="s1">&#39;adhoc&#39;</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">      <span class="c1"># 调用 下面 adhoc 任务</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">      <span class="n">adhoc</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">      <span class="c1"># 调用下面 appstore 任务</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">      <span class="n">appstore</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl">  <span class="n">desc</span> <span class="s1">&#39;构建 adhoc 任务&#39;</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">  <span class="n">desc</span> <span class="s1">&#39;fastlane adhoc&#39;</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">  <span class="n">lane</span> <span class="ss">:adhoc</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="n">gym</span><span class="p">(</span><span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;adhoc&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">
</span></span><span class="line"><span class="ln">35</span><span class="cl">  <span class="n">desc</span> <span class="s1">&#39;构建 appstore 任务&#39;</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">  <span class="n">desc</span> <span class="s1">&#39;fastlane appstore&#39;</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">  <span class="n">lane</span> <span class="ss">:appstore</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">    <span class="n">gym</span><span class="p">(</span><span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;appstore&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>上面的任务中，<code>build</code>/<code>adhoc</code>/<code>appstore</code> 都可以执行，只有 <code>prepare</code> 是无法通过命令行外部执行，如果执行会直接报错：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">$ fastlane prepare
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="o">[</span>19:17:42<span class="o">]</span>: You can<span class="s1">&#39;t call the private lane &#39;</span>prepare<span class="err">&#39;</span> directly
</span></span></code></pre></div><h3 id="任务返回值">任务返回值</h3>
<p>和 ruby 的方法一致，每个 lane 最后一行会默认作为返回值（无需 <a href="http://learnrubythehardway.org/book/ex21.html">return</a>）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln">1</span><span class="cl">
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">lane</span> <span class="ss">:sum</span> <span class="k">do</span> <span class="o">|</span><span class="n">options</span><span class="o">|</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">  <span class="n">options</span><span class="o">[</span><span class="ss">:a</span><span class="o">]</span> <span class="o">+</span> <span class="n">optiona</span><span class="o">[</span><span class="ss">:b</span><span class="o">]</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="n">lane</span> <span class="ss">:calculate</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">  <span class="n">value</span> <span class="o">=</span> <span class="n">sum</span><span class="p">(</span><span class="ss">a</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">  <span class="nb">puts</span> <span class="n">value</span> <span class="c1">#=&gt; 8</span>
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><h3 id="引入外部任务文件">引入外部任务文件</h3>
<p><code>Fastfile</code> 除了自身以外还能够引入外部其他的 <code>Fastfile</code> 并调用任务，只需要导入外部文件并使用特殊的方法标识即可：</p>
<h4 id="1-import---导入本地文件">1. import - 导入本地文件</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># 导入 lanes 目录的 AndroidFastfile</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">import</span> <span class="s2">&#34;lanes/AndroidFastfile&#34;</span>
</span></span></code></pre></div><h4 id="2-import_from_git---导入-git-仓库文件">2. import_from_git - 导入 git 仓库文件</h4>
<p>可以直接引入 git 仓库的 Fastfile 文件是一个非常赞的功能，通过使用发现其实现原理是先把 git 仓库克隆下来后在引入相对于的文件，因此建议国内在没有网络加速（翻墙）的情况下尽量不用引入比较大的 git 仓库，否则使用会需要漫长的等待&hellip;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># 导入 mozilla/firefox-ios 项目下 fastlane 下面 Fastfile 文件</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">import_from_git</span><span class="p">(</span><span class="ss">url</span><span class="p">:</span> <span class="s1">&#39;https://github.com/mozilla/firefox-ios&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"># 或者</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="n">import_from_git</span><span class="p">(</span><span class="ss">url</span><span class="p">:</span> <span class="s1">&#39;git@github.com:mozilla/firefox-ios.git&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">               <span class="ss">path</span><span class="p">:</span> <span class="s1">&#39;fastlane/Fastfile&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>假若外部引入的 <code>Fastfile</code> 有个方法是 <strong>build</strong>，在命令行工具直接执行即可，如果外部和内部都有相同的任务名，执行会直接报错：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">$ fastlane ios build
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="o">[</span>!<span class="o">]</span> Lane <span class="s1">&#39;gradle&#39;</span> was defined multiple times!
</span></span></code></pre></div><p>如果发生这样的事情且你希望在主体 <code>Fastfile</code> 也调用的话需要使用特殊的方法定义：<code>override_lane</code></p>
<blockquote>
<p>注意：此方法只会覆盖外部的相同方法名的代码执行，目前暂时无法使用类似 ruby 的 <code>super</code> 继承原由方法！</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">override_lane</span> <span class="ss">:build</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><h3 id="任务查看">任务查看</h3>
<p>只需执行下面这行命令就可以看到非私有任务的可用列表信息</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">$ fastlane lanes
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">--------- ios---------
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">----- fastlane ios build
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">通用的构建任务
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">fastlane build
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">fastlane build type:adhoc
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">----- fastlane ios adhoc
</span></span><span class="line"><span class="ln">10</span><span class="cl">构建 adhoc 任务
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">----- fastlane ios appstore
</span></span><span class="line"><span class="ln">13</span><span class="cl">构建 appstore 任务
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">Execute using <span class="sb">`</span>fastlane <span class="o">[</span>lane_name<span class="o">]</span><span class="sb">`</span>
</span></span></code></pre></div><h2 id="扩展action">扩展（Action）</h2>
<p>扩展是 fastlane 的杀手锏，重在集成了众多非常优秀好用的方法供 lane 内部使用，截至 fastlane v<code>1.98.0</code> 版本以包含 175 个扩展，这个数量还在陆续增加中。扩展初期是由发起人一个人完成，后续的大部分都是社区共享，如果你发现没有你想要的扩展，可以先去 <a href="https://github.com/fastlane/fastlane/issues?q=is%3Aopen+is%3Aissue+label%3Aaction">issues</a> 搜索下没有要么自己动手提交要么只有等待了.</p>
<h3 id="扩展列表">扩展列表</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">$ fastlane actions
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">+--------------------+-------------------------------------------------------------+------------------+
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="p">|</span>                                   Available fastlane actions                                        <span class="p">|</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">+--------------------+-------------------------------------------------------------+------------------+
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="p">|</span> Action             <span class="p">|</span> Description                                                 <span class="p">|</span> Author           <span class="p">|</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">+--------------------+-------------------------------------------------------------+------------------+
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">|</span> adb                <span class="p">|</span> Run ADB Actions                                             <span class="p">|</span> hjanuschka       <span class="p">|</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">|</span> adb_devices        <span class="p">|</span> Get an Array of Connected android device serials            <span class="p">|</span> hjanuschka       <span class="p">|</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="p">|</span> add_git_tag        <span class="p">|</span> This will add an annotated git tag to the current branch    <span class="p">|</span> Multiple         <span class="p">|</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">...
</span></span><span class="line"><span class="ln">11</span><span class="cl">+--------------------+-------------------------------------------------------------+------------------+
</span></span><span class="line"><span class="ln">12</span><span class="cl">  Total of <span class="m">175</span> actions
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">Get more information <span class="k">for</span> one specific action using <span class="sb">`</span>fastlane action <span class="o">[</span>name<span class="o">]</span><span class="sb">`</span>
</span></span></code></pre></div><h3 id="扩展使用帮助">扩展使用帮助</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># 查看 adb 扩展的使用帮助</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">$ fastlane action adb
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Loading documentation <span class="k">for</span> adb:
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">+---------------------------------+
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="p">|</span>               adb               <span class="p">|</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">+---------------------------------+
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">|</span> Run ADB Actions                 <span class="p">|</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="p">|</span>                                 <span class="p">|</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="p">|</span> see adb --help <span class="k">for</span> more details <span class="p">|</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">|</span>                                 <span class="p">|</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="p">|</span> Created by hjanuschka           <span class="p">|</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">+---------------------------------+
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">+----------+----------------------------------------------------------------------+-------------------+---------+
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="p">|</span>                                                  adb Options                                                  <span class="p">|</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">+----------+----------------------------------------------------------------------+-------------------+---------+
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="p">|</span> Key      <span class="p">|</span> Description                                                          <span class="p">|</span> Env Var           <span class="p">|</span> Default <span class="p">|</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">+----------+----------------------------------------------------------------------+-------------------+---------+
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="p">|</span> serial   <span class="p">|</span> Android serial, which device should be used <span class="k">for</span> this <span class="nb">command</span>         <span class="p">|</span> FL_ANDROID_SERIAL <span class="p">|</span>         <span class="p">|</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="p">|</span> <span class="nb">command</span>  <span class="p">|</span> All commands you want to pass to the adb command, e.g. <span class="sb">`</span>kill-server<span class="sb">`</span> <span class="p">|</span> FL_ADB_COMMAND    <span class="p">|</span>         <span class="p">|</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="p">|</span> adb_path <span class="p">|</span> The path to your <span class="sb">`</span>adb<span class="sb">`</span> binary                                        <span class="p">|</span> FL_ADB_PATH       <span class="p">|</span> adb     <span class="p">|</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">+----------+----------------------------------------------------------------------+-------------------+---------+
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">+-------------------------------+
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="p">|</span>       adb Return Value        <span class="p">|</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">+-------------------------------+
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="p">|</span> The output of the adb <span class="nb">command</span> <span class="p">|</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">+-------------------------------+
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl">More information can be found on https://github.com/fastlane/fastlane/blob/master/fastlane/docs/Actions.md
</span></span></code></pre></div><h3 id="创建自定义扩展">创建自定义扩展</h3>
<p>通过内置的命令创建你需要的扩展，扩展名必须是全部小写且只能使用下划线分割词组，生成好的扩展文件会在 <code>fastlane/actions</code> 目录找到:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">$ fastlane new_action
</span></span><span class="line"><span class="ln">2</span><span class="cl">Must be lower <span class="k">case</span>, and use a <span class="s1">&#39;_&#39;</span> between words. Do not use <span class="s1">&#39;.&#39;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">examples: <span class="s1">&#39;testflight&#39;</span>, <span class="s1">&#39;upload_to_s3&#39;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">Name of your action: hello
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="o">[</span>15:33:15<span class="o">]</span>: Created new action file <span class="s1">&#39;./fastlane/actions/hello.rb&#39;</span>. Edit it to implement your custom action.
</span></span></code></pre></div><p>这块会占比较大的篇幅，尽情期待后续的展开。</p>
<h3 id="引入外部扩展">引入外部扩展</h3>
<p>这块其实也有两种方法可以引入，文件引入是官方教程提供的方法，第二种是我个人尝试出来的，第三种是最近版本才官方支持的。</p>
<h4 id="1-本地文件引入">1. 本地文件引入</h4>
<p>自定义的扩展其实也算是本地文件引入的一种形式，当然位于其他路径的通过指定方法也能做到</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># 引入项目根目录 script/share_actions 路径</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">actions_path</span> <span class="s1">&#39;../script/share_actions&#39;</span>
</span></span></code></pre></div><h4 id="2-rubygem-引入">2. rubygem 引入</h4>
<blockquote>
<p>不再建议使用本方法，请看第三种插件引入。</p>
</blockquote>
<p>我在团队内部创建了一个自定义的扩展，仅限于团队内部使用而无法贡献社区，我只能采取封装成 ruby gem 包，通过 ruby 的 <code>require</code> 方式引入，最终可以完美支持，目前已在项目中使用大半年之久。最重要的是我是开源的：<a href="https://github.com/icyleaf/fastlane-qyer">fastlane-qyer</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># 首先安装需要的 rubygem: gem install fastlane-qyer</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nb">require</span> <span class="s1">&#39;fastlane-qyer&#39;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="n">lane</span> <span class="ss">:upload</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">  <span class="n">qyer</span><span class="p">(</span><span class="ss">api_key</span><span class="p">:</span> <span class="s1">&#39;[token]&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>注意，使用 rubygem 引入的无法在 fastlane actions 中显示出来，也无法使用 fastlane action [name] 查看使用帮助。我猜想一是官方没有这样提供思路，二是就算你引入了 gem 也不是特别好判断里面的文件结构。</p>
<h4 id="3-插件引入">3. 插件引入</h4>
<p>我注意到 <a href="https://github.com/fastlane/fastlane/releases/tag/1.93.0">1.93.0</a> 增加了插件机制，很好的解决第二种出现的一些问题。大概看了一下主要是采用 <code>Gemfile</code> 的方式使用 <code>Pluginfile</code> 维护了引入第三方插件列表。实现原理还是属于第二种方法。</p>
<p>通过 <code>fastlane search_plugins</code> 查看当前支持的插件，并使用 <code>fastlane add_plugins [name]</code> 引入。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">$ fastlane search_plugins
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="o">[</span>16:04:33<span class="o">]</span>: Listing all available fastlane plugins
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">+--------------------------+---------------------------------------------------+-----------+
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="p">|</span>                                Available fastlane plugins                                <span class="p">|</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">+--------------------------+---------------------------------------------------+-----------+
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">|</span> Name                     <span class="p">|</span> Description                                       <span class="p">|</span> Downloads <span class="p">|</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">+--------------------------+---------------------------------------------------+-----------+
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="p">|</span> ruby                     <span class="p">|</span> Useful fastlane actions <span class="k">for</span> Ruby projects         <span class="p">|</span> <span class="m">782</span>       <span class="p">|</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="p">|</span> versioning               <span class="p">|</span> Allows to work set/get app version directly       <span class="p">|</span> <span class="m">758</span>       <span class="p">|</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">|</span>                          <span class="p">|</span> to/from Info.plist                                <span class="p">|</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="p">|</span> branding                 <span class="p">|</span> Add some branding to your fastlane output         <span class="p">|</span> <span class="m">716</span>       <span class="p">|</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="p">|</span> instrumented_tests       <span class="p">|</span> New action to run instrumented tests <span class="k">for</span> android. <span class="p">|</span> <span class="m">590</span>       <span class="p">|</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="p">|</span>                          <span class="p">|</span> This basically creates and boots an emulator      <span class="p">|</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="p">|</span>                          <span class="p">|</span> before running an gradle commands so that you can <span class="p">|</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="p">|</span>                          <span class="p">|</span> run instrumented tests against that emulator.     <span class="p">|</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="p">|</span>                          <span class="p">|</span> After the gradle <span class="nb">command</span> is executed, the avd     <span class="p">|</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="p">|</span>                          <span class="p">|</span> gets shut down and deleted. This is really        <span class="p">|</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="p">|</span>                          <span class="p">|</span> helpful on CI services, keeping them clean and    <span class="p">|</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="p">|</span>                          <span class="p">|</span> always having a fresh avd <span class="k">for</span> testing.            <span class="p">|</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="p">|</span> xamarin_build            <span class="p">|</span> Build xamarin android<span class="se">\i</span>os projects                <span class="p">|</span> <span class="m">582</span>       <span class="p">|</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="p">|</span> appicon                  <span class="p">|</span> Generate required icon sizes and iconset from a   <span class="p">|</span> <span class="m">509</span>       <span class="p">|</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="p">|</span>                          <span class="p">|</span> master application icon.                          <span class="p">|</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">...
</span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="p">|</span> download_file            <span class="p">|</span> This action downloads a file from an HTTP/HTTPS   <span class="p">|</span> <span class="m">171</span>       <span class="p">|</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="p">|</span>                          <span class="p">|</span> url <span class="o">(</span>e.g. ZIP file<span class="o">)</span> and puts it in a destination  <span class="p">|</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="p">|</span>                          <span class="p">|</span> path                                              <span class="p">|</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">+--------------------------+---------------------------------------------------+-----------+
</span></span><span class="line"><span class="ln">29</span><span class="cl">
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="c1"># 添加 sentry 插件</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">$ fastlane add_plugin sentry
</span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="o">[</span>16:16:23<span class="o">]</span>: Plugin <span class="s1">&#39;fastlane-plugin-sentry&#39;</span> was added to <span class="s1">&#39;./fastlane/Pluginfile&#39;</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="o">[</span>16:16:23<span class="o">]</span>: It looks like fastlane plugins are not yet <span class="nb">set</span> up <span class="k">for</span> this project.
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="o">[</span>16:16:23<span class="o">]</span>: fastlane will create a new Gemfile at path <span class="s1">&#39;Gemfile&#39;</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="o">[</span>16:16:23<span class="o">]</span>: This change is neccessary <span class="k">for</span> fastlane plugins to work
</span></span><span class="line"><span class="ln">36</span><span class="cl">Should fastlane modify the Gemfile at path <span class="s1">&#39;Gemfile&#39;</span> <span class="k">for</span> you? <span class="o">(</span>y/n<span class="o">)</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">y
</span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="o">[</span>16:16:29<span class="o">]</span>: Successfully modified <span class="s1">&#39;Gemfile&#39;</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="o">[</span>16:16:29<span class="o">]</span>: Make sure to commit your Gemfile, Gemfile.lock and Pluginfile to version control
</span></span><span class="line"><span class="ln">40</span><span class="cl">Installing plugin dependencies...
</span></span><span class="line"><span class="ln">41</span><span class="cl">Successfully installed plugins
</span></span><span class="line"><span class="ln">42</span><span class="cl">
</span></span><span class="line"><span class="ln">43</span><span class="cl">$ cat fastlane/Pluginfile
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="c1"># Autogenerated by fastlane</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="c1"># Ensure this file is checked in to source control!</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">
</span></span><span class="line"><span class="ln">48</span><span class="cl">gem <span class="s1">&#39;fastlane-plugin-sentry&#39;</span>
</span></span></code></pre></div><p>更详细的继续期待后续报道，我要挖坑无数。</p>
<h3 id="扩展的命令行调用">扩展的命令行调用</h3>
<p>社区的力量果然是很强大的，陆续添加了那么多功能，早期用户表示不开心！嗯，由于社区的呼声和贡献目前可以通过命令调用扩展：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># 使用 notification 扩展发送一个通知消息</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">$ fastlane run notification message:<span class="s2">&#34;Hi macOS&#34;</span> title:<span class="s2">&#34;Fastlane Notification&#34;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="o">[</span>15:58:05<span class="o">]</span>: --------------------------
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="o">[</span>15:58:05<span class="o">]</span>: --- Step: notification ---
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="o">[</span>15:58:05<span class="o">]</span>: --------------------------
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="o">[</span>15:58:05<span class="o">]</span>: Result: <span class="nb">true</span>
</span></span></code></pre></div><h2 id="辅助功能">辅助功能</h2>
<h3 id="自动更新">自动更新</h3>
<p>fastlane 提供一个方法 <code>update_fastlane</code> 用于对于自身的版本检查和更新，这个第一篇文章我也有提到过。它其实一个是一个扩展，使用 <code>fastlane action update_fastlane</code> 能够看到使用帮助。它有一个参数是可以指定检查特定的 fastlane 工具并进行更新，但其实它是使用 rubygems 进行对 gem 的更新，因此这块其实可以传入任何需要检查并更新的 gem：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">update_fastlane</span><span class="p">(</span><span class="ss">tools</span><span class="p">:</span><span class="s1">&#39;fastlane,gym,match,cocoapods,rest-client&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="环境变量">环境变量</h3>
<p>从 fastlane 的设计体系上在各个地方都加入了环境变量的支持，每个扩展的参数、以及扩展需要共享给其他扩展和任务读取的数据都是通过环境变量获取，如下是我收集的比较常用的列表：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">环境变量</th>
          <th style="text-align: left">来源</th>
          <th style="text-align: left">说明</th>
          <th style="text-align: left">备注</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">FASTLANE_USER</td>
          <td style="text-align: left">credentials_manager</td>
          <td style="text-align: left">Apple 开发者账户名</td>
          <td style="text-align: left">验证通过后会保存 Keychain</td>
      </tr>
      <tr>
          <td style="text-align: left">FASTLANE_PASSWORD</td>
          <td style="text-align: left">credentials_manager</td>
          <td style="text-align: left">Apple 开发者账户密码</td>
          <td style="text-align: left">验证通过后会保存 Keychain</td>
      </tr>
      <tr>
          <td style="text-align: left">FASTLANE_TEAM_ID<!-- raw HTML omitted -->CERT_TEAM_ID</td>
          <td style="text-align: left">produce<!-- raw HTML omitted -->sigh</td>
          <td style="text-align: left">Apple 团队 ID</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">DELIVER_USER&lt;br &gt;PRODUCE_USERNAME</td>
          <td style="text-align: left">deliver<!-- raw HTML omitted -->produce</td>
          <td style="text-align: left">iTunesConnect 账户名</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">DELIVER_PASSWORD</td>
          <td style="text-align: left">deliver</td>
          <td style="text-align: left">iTunesConnect 账户密码</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">MATCH_PASSWORD</td>
          <td style="text-align: left">match</td>
          <td style="text-align: left">证书加/解密密码</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">FASTLANE_XCODE_LIST_TIMEOUT</td>
          <td style="text-align: left">fastlane_core</td>
          <td style="text-align: left">获取 iOS Scheme 的超时时间</td>
          <td style="text-align: left">默认 10s</td>
      </tr>
  </tbody>
</table>
]]></content:encoded></item><item><title>Fastlane - iOS 和 Android 的自动化构建工具</title><link>https://icyleaf.com/2016/07/intro-fastlane-automation-for-ios-and-android/</link><pubDate>Mon, 11 Jul 2016 12:36:07 +0800</pubDate><guid>https://icyleaf.com/2016/07/intro-fastlane-automation-for-ios-and-android/</guid><description>使用 fastlane 提升构建移动应用的效率</description><content:encoded><![CDATA[<h2 id="前言">前言</h2>
<p>这篇文章整理了很久，发现在一篇文章里无法一一讲述和全面的覆盖，初步打算是把这个做成一个系列，想到哪里就写到哪里，如果恰好有读者爱戴并有一些建议反馈，我也会根据大家的需要调整内容的方向和深度。论美剧的编剧的重要性(笑)。</p>
<h2 id="初次邂逅">初次邂逅</h2>
<p>初时 fastlane 的时候是去年的 11 月份，看到大就感觉遇到了神器一般的惊喜。它一个针对于 iOS 和 Android（后来才支持的）全方位自动化流程的工具，请看下图</p>
<p><img loading="lazy" src="https://fastlane.tools/assets/img/intro-fastlane-tree.png"
  
  
  alt="fastlane-flow"></img>
</p>
<p>流程图中每个环节都是独立的工具，每个工具只干一件事情，分工非常的明确。以下是我在团队项目中用到的：</p>
<ul>
<li><a href="https://github.com/fastlane/fastlane/tree/master/scan">scan</a> 自动化测试工具，很好的封装了 Unit Test</li>
<li><a href="https://github.com/fastlane/fastlane/tree/master/sigh">sigh</a> 针对于 iOS 项目开发证书和 Provision file 的下载工具</li>
<li><a href="https://github.com/fastlane/fastlane/tree/master/match">match</a> 同步团队每个人的证书和 Provision file 的超赞工具，规范<a href="https://codesigning.guide/">代码签名</a>（虽然里面有些设定比较损）</li>
<li><a href="https://github.com/fastlane/fastlane/tree/master/gym">gym</a> 针对于 iOS 打包和签名的自动化工具，完爆 <code>xctool</code>，而 <code>shenzhen</code> 也放弃维护</li>
<li><a href="https://github.com/icyleaf/fastlane-qyer">qyer</a> 团队定制的工具，用于检测包和上传到自己的内部分发平台</li>
<li><a href="https://github.com/fastlane/fastlane">fastlane</a> 简单理解就是控制整体流程和实现的框架容器</li>
</ul>
<p>利用目前支持的工具可以做所有包含自动化和可持续化构建的每个环节，比如单元测试、截图、分发渠道、上传元数据和 ipa 包提交审核等等。看到这这些是不是很兴奋？
反正我看到之后就像黑夜看到了光明，果断抛弃自己维护的脚本。</p>
<h2 id="基本构成">基本构成</h2>
<p>Fastlane 提供的流程的众多工具都是可以独立存在和使用（提供 cli 命令），也可以统一由 fastlane 来控制。它在使用中提出了两个概念：</p>
<ul>
<li><code>action</code>: Fastlane 的插件，截至当前内置 165 个至多，不过每个动作的颗粒度大小不一。<a href="https://github.com/fastlane/fastlane/blob/master/fastlane/docs/Actions.md">查看详情</a></li>
<li><code>lane</code>: Fastlane 的任务（或者可以理解为命令），一个可以包含多个 lanes，通过 <code>fastlane</code> cli 传入制定的 lane 来执行。</li>
</ul>
<p>光说不干假把式，看法宝：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">lane</span> <span class="ss">:adhoc</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">  <span class="c1"># build version 自动加一</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">  <span class="n">increment_build_number</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  <span class="c1"># 执行 pod install</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  <span class="n">cocoapods</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="c1"># 调用 facebook 的 xctool 进行单元测试</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  <span class="n">xctool</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  <span class="c1"># 对模拟器运行的 App 进行截图</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  <span class="n">snapshot</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">  <span class="c1"># 安装团队证书和 profiles</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">  <span class="n">match</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">  <span class="c1"># 上传 App 元数据和签名的 ipa 到 iTunes Conneects</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">  <span class="n">deliver</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">  <span class="c1"># 把截图套进一个设备外壳</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">  <span class="n">frameit</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">  <span class="c1"># 允许自定义的脚本文件</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">  <span class="n">sh</span> <span class="s2">&#34;./customScript.sh&#34;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">  <span class="c1"># 发消息到 slack</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">  <span class="n">slack</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><h2 id="安装">安装</h2>
<p>工具的起源本身是专门针对 iOS 项目，因此目前依赖于 macOS 10.9 以上系统，Ruby 是一个众所周知的轮子发明者，很多知名的工具都是它开发的，fastlane 也不例外。以下是依赖环境：</p>
<ul>
<li>macOS 10.9+</li>
<li>Ruby 2.0+ (推荐 rvm 或 rbenv 安装)</li>
<li>Xcode + command line tools</li>
</ul>
<p>以上依赖配置好之后就可以通过 rubygem 进行安装：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">$ <span class="o">[</span>sudo<span class="o">]</span> gem install fastlane
</span></span></code></pre></div><p>fastlane 默认会把核心工具都会进行安装，需要大家耐心等待一会&hellip;</p>
<h2 id="初始化">初始化</h2>
<p>有两种方法可以初始化，一种是通过命令，一种是自己创建指定的（至少包含一个）约束文件 <code>Fastfile</code>。首先我先介绍大家使用命令初始化:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># 切换只你开发的 iOS 项目根目录</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">$ <span class="nb">cd</span> to/your/ios/project
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">$ fastlane init
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="o">[</span>11:46:34<span class="o">]</span>: Detected iOS/Mac project in current directory...
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="o">[</span>11:46:34<span class="o">]</span>: This setup will <span class="nb">help</span> you get up and running in no time.
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="o">[</span>11:46:34<span class="o">]</span>: fastlane will check what tools you<span class="s1">&#39;re already using and set up
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="s1">[11:46:34]: the tool automatically for you. Have fun!
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="s1">[11:46:34]: Created new folder &#39;</span>./fastlane<span class="s1">&#39;.
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="s1">...
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="s1">Your Apple ID (e.g. fastlane@krausefx.com): xxx@gmail.com
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="s1">[11:46:59]: Verifying if app is available on the Apple Developer Portal and iTunes Connect...
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="s1">[11:46:59]: Starting login with user &#39;</span>xxx@gmail.com<span class="s1">&#39;
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="s1">Multiple teams found on the Developer Portal, please enter the number of the team you want to use:
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="s1">1) XXXXXXXXXX &#34;XXXXXXXXXX&#34; (In-House)
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="s1">2) YYYYYYYYYY &#34;YYYYYYYYYY&#34; (Company/Organization)
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="s1">+----------------+----------------------------------------------------------------------------+
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="s1">|                                       Detected Values                                       |
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="s1">+----------------+----------------------------------------------------------------------------+
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="s1">| Apple ID       | xxx@gmail.com                                                              |
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="s1">| App Name       | Hello Fastlane                                                             |
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="s1">| App Identifier | com.icyleaf.demo.HelloFastlane                                             |
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="s1">| Workspace      | /Users/icyleaf/Development/iOS/HelloFastlane.xcworkspace                   |
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="s1">+----------------+----------------------------------------------------------------------------+
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="s1">[11:48:36]: This app identifier doesn&#39;</span>t exist on iTunes Connect yet, it will be created <span class="k">for</span> you
</span></span><span class="line"><span class="ln">26</span><span class="cl">Please confirm the above values <span class="o">(</span>y/n<span class="o">)</span> n
</span></span><span class="line"><span class="ln">27</span><span class="cl">App Identifier <span class="o">(</span>com.krausefx.app<span class="o">)</span>: com.icyleaf.demo.HelloFastlane
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="o">[</span>11:50:04<span class="o">]</span>: Created new file <span class="s1">&#39;./fastlane/Appfile&#39;</span>. Edit it to manage your preferred app metadata information.
</span></span><span class="line"><span class="ln">29</span><span class="cl">Optional: The scheme name of your app <span class="o">(</span>If you don<span class="s1">&#39;t need one, just hit Enter): AppDemo
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="s1">[11:50:40]: &#39;</span>snapshot<span class="s1">&#39; not enabled.
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="s1">[11:50:40]: &#39;</span>cocoapods<span class="s1">&#39; enabled.
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="s1">[11:50:40]: &#39;</span>carthage<span class="s1">&#39; not enabled.
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="s1">[11:50:40]: Created new file &#39;</span>./fastlane/Fastfile<span class="err">&#39;</span>. Edit it to manage your own deployment lanes.
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="o">[</span>11:50:40<span class="o">]</span>: fastlane will send the number of errors <span class="k">for</span> each action to
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="o">[</span>11:50:40<span class="o">]</span>: https://github.com/fastlane/enhancer to detect integration issues
</span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="o">[</span>11:50:40<span class="o">]</span>: No sensitive/private information will be uploaded
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="o">[</span>11:50:40<span class="o">]</span>: Successfully finished setting up fastlane
</span></span></code></pre></div><p>这部分会进行联网，并提示输入你的 Apple ID 来验证你的应用是否存在（没有也会帮你自动创建）并获取相应的关键信息，通过一系列的流程下来把获取的信息会创建一个 <code>fastlane</code> 目录
并并写入相应的文件（如果某些信息没有填写会忽略某些文件的生成）：</p>
<ul>
<li><code>Fastfile</code>: 核心文件，主要用于 cli 调用和处理具体的流程，<a href="https://github.com/fastlane/fastlane/tree/master/fastlane/docs#fastfile">了解详情</a></li>
<li><code>Appfile</code>: 从 Apple Developer Portal 获取和项目相关的信息，<a href="https://github.com/fastlane/fastlane/blob/master/fastlane/docs/Appfile.md">了解详情</a></li>
<li><code>Deliverfile</code>: 从 iTunes Connect 获取和项目相关的信息，<a href="https://github.com/fastlane/fastlane/blob/master/deliver/Deliverfile.md">了解详情</a></li>
</ul>
<p>抛开其他的几个文件先不说，大家先把注意力放到刚创建好的 <code>Fastfile</code> 文件上面（可能有变化，仅作参考），如果大家对 Ruby 有了解的话，它定义的 DSL 语言非常类似 <a href="https://github.com/ruby/rake">rake</a>，但流程上有参考的 <a href="https://github.com/rspec/rspec">rspec</a>，一旦不满足需求还可以使用 Ruby 代码来实现。单凭 DSL 语言来说就算对于 Ruby 没有基础的也能很快掌握，大多都是比较简单易懂的语法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># Customise this file, documentation can be found here:</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"># https://github.com/fastlane/fastlane/tree/master/fastlane/docs</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"># All available actions: https://github.com/fastlane/fastlane/blob/master/fastlane/docs/Actions.md</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># can also be listed using the `fastlane actions` command</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"># Change the syntax highlighting to Ruby</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"># All lines starting with a # are ignored when running `fastlane`</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"># If you want to automatically update fastlane if a new version is available:</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"># update_fastlane</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1"># This is the minimum version number required.</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1"># Update this, if you use features of a newer version</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="n">fastlane_version</span> <span class="s2">&#34;1.95.0&#34;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="n">default_platform</span> <span class="ss">:ios</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="n">platform</span> <span class="ss">:ios</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">  <span class="c1"># 执行所有命令前都会先执行这里</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">  <span class="n">before_all</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="c1"># ENV[&#34;SLACK_URL&#34;] = &#34;https://hooks.slack.com/services/...&#34;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="n">cocoapods</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">  <span class="n">desc</span> <span class="s2">&#34;Runs all the tests&#34;</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">  <span class="n">lane</span> <span class="ss">:test</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="nb">scan</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">
</span></span><span class="line"><span class="ln">30</span><span class="cl">  <span class="n">desc</span> <span class="s2">&#34;Submit a new Beta Build to Apple TestFlight&#34;</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">  <span class="n">desc</span> <span class="s2">&#34;This will also make sure the profile is up to date&#34;</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">  <span class="n">lane</span> <span class="ss">:beta</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">    <span class="c1"># match(type: &#34;appstore&#34;) # more information: https://codesigning.guide</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">    <span class="n">gym</span><span class="p">(</span><span class="ss">scheme</span><span class="p">:</span> <span class="s2">&#34;AppDemo&#34;</span><span class="p">)</span> <span class="c1"># Build your app - more options available</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">    <span class="n">pilot</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">
</span></span><span class="line"><span class="ln">37</span><span class="cl">    <span class="c1"># sh &#34;your_script.sh&#34;</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">    <span class="c1"># You can also use other beta testing services here (run `fastlane actions`)</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl">  <span class="n">desc</span> <span class="s2">&#34;Deploy a new version to the App Store&#34;</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">  <span class="n">lane</span> <span class="ss">:appstore</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">    <span class="c1"># match(type: &#34;appstore&#34;)</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">    <span class="c1"># snapshot</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">    <span class="n">gym</span><span class="p">(</span><span class="ss">scheme</span><span class="p">:</span> <span class="s2">&#34;AppDemo&#34;</span><span class="p">)</span> <span class="c1"># Build your app - more options available</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">    <span class="n">deliver</span><span class="p">(</span><span class="ss">force</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">    <span class="c1"># frameit</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">
</span></span><span class="line"><span class="ln">50</span><span class="cl">  <span class="c1"># 你可以定义属于自己的 lane（任务）</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">  <span class="n">lane</span> <span class="ss">:hello</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">    <span class="nb">puts</span> <span class="s2">&#34;hello world&#34;</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">
</span></span><span class="line"><span class="ln">55</span><span class="cl">  <span class="c1"># 仅当上述流程全部执行成功后才会走这里。其实应该定义为 after_success</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">  <span class="n">after_all</span> <span class="k">do</span> <span class="o">|</span><span class="n">lane</span><span class="o">|</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">    <span class="c1"># slack(</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">    <span class="c1">#   message: &#34;Successfully deployed new App Update.&#34;</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">    <span class="c1"># )</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">
</span></span><span class="line"><span class="ln">62</span><span class="cl">  <span class="c1"># 如果流程发生异常会走这里并终止</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">  <span class="n">error</span> <span class="k">do</span> <span class="o">|</span><span class="n">lane</span><span class="p">,</span> <span class="n">exception</span><span class="o">|</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">    <span class="c1"># slack(</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">    <span class="c1">#   message: exception.message,</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">    <span class="c1">#   success: false</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">    <span class="c1"># )</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>通过上面的注解，我想大家对它已经有了初步的了解，那么定义完之后该如何执行呢？回到刚才的终端（关闭了？那再切换到刚才的 iOS 项目的根目录）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">$ fastlane ios hello
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="o">[</span>11:56:24<span class="o">]</span>: -------------------------------------------------
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="o">[</span>11:56:24<span class="o">]</span>: --- Step: Verifying required fastlane version ---
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="o">[</span>11:56:24<span class="o">]</span>: -------------------------------------------------
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="o">[</span>11:56:24<span class="o">]</span>: fastlane version valid
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="o">[</span>11:56:24<span class="o">]</span>: ------------------------------
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="o">[</span>11:56:24<span class="o">]</span>: --- Step: default_platform ---
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="o">[</span>11:56:24<span class="o">]</span>: ------------------------------
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="o">[</span>11:56:24<span class="o">]</span>: Driving the lane <span class="s1">&#39;ios hello&#39;</span> 🚀
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="o">[</span>11:56:24<span class="o">]</span>: -----------------------
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="o">[</span>11:56:24<span class="o">]</span>: --- Step: cocoapods ---
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="o">[</span>11:56:24<span class="o">]</span>: -----------------------
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="o">[</span>11:56:24<span class="o">]</span>: $ pod install
</span></span><span class="line"><span class="ln">14</span><span class="cl">...
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="o">[</span>11:56:28<span class="o">]</span>: hello world
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl">+------+-------------------------------------+-------------+
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="p">|</span>                     fastlane summary                     <span class="p">|</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">+------+-------------------------------------+-------------+
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="p">|</span> Step <span class="p">|</span> Action                              <span class="p">|</span> Time <span class="o">(</span>in s<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">+------+-------------------------------------+-------------+
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="p">|</span> <span class="m">1</span>    <span class="p">|</span> Verifying required fastlane version <span class="p">|</span> <span class="m">0</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="p">|</span> <span class="m">2</span>    <span class="p">|</span> default_platform                    <span class="p">|</span> <span class="m">0</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="p">|</span> <span class="m">3</span>    <span class="p">|</span> cocoapods                           <span class="p">|</span> <span class="m">4</span>           <span class="p">|</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">+------+-------------------------------------+-------------+
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="o">[</span>11:56:28<span class="o">]</span>: fastlane.tools finished successfully 🎉
</span></span></code></pre></div><p>哒哒！一个简单的任务执行完毕！</p>
<p>如果大家注意观察上面的文件可能注意到一些小细节：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># 自动更新 fastlane 工具，需要 rubygems &gt;= 2.1.0</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">update_fastlane</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># 最低兼容版本，由于 fastlane 还是逐步健壮的阶段更新速度还是蛮快的，</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"># 为了防止新特性在旧版本的不支持会强制设置一个最低兼容版本</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"># 不过工具特别贴心的会在每次执行之后会检查是否有新版本，如果有会在最后末尾追加新版本提醒</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">fastlane_version</span> <span class="s2">&#34;1.95.0&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"># 默认使用平台是 ios，也就是说文件可以定义多个平台，</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"># 通过上述执行的命令也能看出来是执行的 ios 平台下面的 hello 任务。</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"># 这个的作用是可以在执行 fastlane 的时候省略 ios，不信你执行 fastlane hello 试试。</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">default_platform</span> <span class="ss">:ios</span>
</span></span></code></pre></div><h2 id="android-的支持">Android 的支持</h2>
<p>这个的支持我觉得关键是社区的呼声太大，加上贡献者的热情（我提交过许多 issues 和个别 PL，响应非常的迅速）很快就加上了其支持，
但具体的特性不是特别多，主要是对于 <code>gradle</code> 的封装，我先不做展开介绍，大家可以先看看<a href="https://github.com/fastlane/fastlane/blob/master/fastlane/docs/Android.md">官方文档</a>，如果后续有特别不明白的地方我在做具体的讲解。</p>
<p>今天就先写到这里后续我会继续整理更多的使用指南和实战范例共大家参考，最后给大家附赠官方给大家的一些<a href="https://github.com/fastlane/examples">范例</a>。</p>
]]></content:encoded></item><item><title>极速化 CocoaPods</title><link>https://icyleaf.com/2015/01/speed-up-cocoapods/</link><pubDate>Tue, 20 Jan 2015 12:34:56 +0800</pubDate><guid>https://icyleaf.com/2015/01/speed-up-cocoapods/</guid><description>iOS 组件仓库超时，网络环境不畅通该如何解，我来指点一二</description><content:encoded><![CDATA[<p><a href="http://cocoapods.org/">Cocopods</a> 本身是一个优秀的 iOS 开发的包管理工具，涵盖了 7k+ 的开源组件，包管理库是托管在 Github。
众所周知的原因它的速度日渐缓慢，有时会频繁报如下错误：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">$ pod install
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl">Cloning into <span class="s1">&#39;/path/to/ios/project/Pods/xxx&#39;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">
</span></span><span class="line"><span class="ln">5</span><span class="cl">error: RPC failed<span class="p">;</span> <span class="nv">result</span><span class="o">=</span>52, HTTP <span class="nv">code</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">
</span></span><span class="line"><span class="ln">7</span><span class="cl">fatal: The remote end hung up unexpectedly
</span></span></code></pre></div><p>本文主要为解决该问题而诞生的，以下的加速方案不局限于目前已流传的优化方案，而是在此基础上<strong>彻底的加速</strong>！</p>
<ul>
<li>使用淘宝 Ruby Gems 源（Cocoapods 使用 ruby 开发）</li>
<li><code>pod install</code> 时不设置包的更新：<a href="http://phatblat.com/blog/2014/07/30/pod-install/">参考文章</a></li>
<li>使用国内 git 服务器镜像 Cocoapods Spec: <a href="http://blog.devtang.com/blog/2014/05/25/use-cocoapod-to-manage-ios-lib-dependency/">参考文章</a></li>
</ul>
<p>如果你对 Cocoapods 有更深层次的理解，请参见：<a href="http://www.objc.io/issue-6/cocoapods-under-the-hood.html">objc.io: Cocoapods under the hood</a> <a href="http://objccn.io/issue-6-4/">中文版本</a></p>
<p>今天早晨看到微博众多 iOS 开发者赞同转发《<a href="http://weibo.com/p/1001603800875490492754">CocoaPods最佳实践探讨</a>》一文，
针对 <code>Pods</code> 建议纳入版本控制也是无奈之举。之前公司项目中也是这样施行很长一段时间，不排除更新可能会造成很多无用信息&quot;刷屏&quot;，
偶尔还会因为版本冲突造成一些混乱状况需要处理。个人还是更倾向于精简原则，遵循<a href="http://guides.cocoapods.org/using/using-cocoapods.html#should-i-ignore-the-pods-directory-in-source-control">官方的建议</a>。</p>
<p>大家都是技术人员，其实这些小问题难道因为 github 倒下就没有解决方案了吗？！看我如何撕破这层纸老虎：</p>
<h3 id="技术概述">技术概述</h3>
<ul>
<li>Cocopods v0.34.0+</li>
<li>Gitlab: 自建私有 git 服务器</li>
<li>gitlab-mirrors: 专用于 github 镜像至 gitlab 并保持定期更新</li>
<li>rake: ruby 的代码构建工具（不懂 ruby 的可以把它理解为命令聚合工具）</li>
</ul>
<h3 id="技术剖析">技术剖析</h3>
<p>Cocoapods 自身支持<a href="http://guides.cocoapods.org/making/private-cocoapods.html">私有仓库</a>，
恰好的是就在前不久发布的 <a href="https://github.com/CocoaPods/CocoaPods/blob/master/CHANGELOG.md#0340">0.34.0</a> 版本支持 <code>Podfile</code>
添加多个的包源仓库，举个例子：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">source</span> <span class="s1">&#39;https://github.com/artsy/Specs.git&#39;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">source</span> <span class="s1">&#39;https://github.com/CocoaPods/Specs.git&#39;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="n">pod</span> <span class="s1">&#39;AFNetworking&#39;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="n">pod</span> <span class="s1">&#39;Mantle&#39;</span>
</span></span></code></pre></div><p>这个特性其实是为了扩充官方 Spec 的同时可以更好的让开发者管理私有的公共组件，那我同样是从这里下手：</p>
<blockquote>
<p>前提是自己以及搭建好 gitlab 服务器：<a href="https://about.gitlab.com/downloads/">官方教程 （Ubuntu）</a> | <a href="http://icyleaf.com/2013/09/how-to-install-gitlab-on-centos/">本人教程 （CentOS）</a></p>
</blockquote>
<h4 id="自力更生">自力更生</h4>
<p>首先我们需要创建一个自己的 Spec 仓库，目录结构如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">.
</span></span><span class="line"><span class="ln">2</span><span class="cl">├── CocoaPods-version.yml
</span></span><span class="line"><span class="ln">3</span><span class="cl">├── Specs/
</span></span><span class="line"><span class="ln">4</span><span class="cl">├── README.md
</span></span><span class="line"><span class="ln">5</span><span class="cl">├── Rakefile
</span></span><span class="line"><span class="ln">6</span><span class="cl">└── Gemfile
</span></span></code></pre></div><p>配置不做详细描述，这里比官方多了两个文件 <code>Rakefile</code> 和 <code>Gemfile</code> 都是 rake 所需的文件，这个后面会讲到。
再者就是配置 <a href="https://github.com/samrocketman/gitlab-mirrors#three-easy-steps">gitlab-mirrors</a>，教程很详细不再重复。</p>




<div class="updated updated-mark">
  <header class="updated-header color-note">
    <h4 class="updated-title">更新</h4>
    
    <p class="updated-meta">Apr 18, 2022</p>
    
  </header>
  <article class="updated-body">
    gitlab-mirrors 的机制问题再使用其他会有很大的限制，我重新造了一个新轮子 <a href="https://icyleaf.com/2018/04/intro-hpr/">hpr</a> 通过 HTTP REST API + Docker 部署的方式更好的解决了这个问题。
  </article>
</div>


<h4 id="偷梁换柱">偷梁换柱</h4>
<p>利用私有 Spec 仓库特性，可以把官方 <code>Spec</code> 目录下面的包按需或全部镜像过来，再次基础上<strong>把里面涉及 github 的地址替换成 gitlab 的地址</strong></p>
<p>你没有看错，这是核心步骤，如果这步没有做那么和国内镜像的地址没有任何差别。核心代码如下：</p>
<h5 id="rakefile">Rakefile</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nb">require</span> <span class="s1">&#39;uri&#39;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nb">require</span> <span class="s1">&#39;fileutils&#39;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nb">require</span> <span class="s1">&#39;multi_json&#39;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="nb">require</span> <span class="s1">&#39;net/ssh&#39;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">desc</span> <span class="s1">&#39;镜像一个 github 包至 gitlab 仓库&#39;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">task</span> <span class="ss">:clone</span><span class="p">,</span> <span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="p">,</span> <span class="nb">p</span><span class="o">|</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  <span class="nb">name</span> <span class="o">=</span> <span class="nb">p</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  <span class="n">current_path</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">  <span class="n">specs</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;.cocoapods/repos/master/Specs/*&#39;</span><span class="p">)</span><span class="o">]</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl">  <span class="n">repo</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">name</span> <span class="p">}</span><span class="o">.</span><span class="n">first</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">  <span class="k">if</span> <span class="n">repo</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="nb">puts</span> <span class="s2">&#34; * found repo, copy it here&#34;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="n">repo_store_path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_path</span><span class="p">,</span> <span class="s1">&#39;Specs&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="no">FileUtils</span><span class="o">.</span><span class="n">cp_r</span> <span class="n">repo</span><span class="p">,</span> <span class="n">repo_store_path</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="nb">puts</span> <span class="s2">&#34; * updating repo url&#34;</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="no">Dir</span><span class="o">[</span><span class="s2">&#34;</span><span class="si">#{</span><span class="n">repo_store_path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">/*&#34;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">      <span class="n">pod_file</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&#34;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">.podspec.json&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">      <span class="n">json</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pod_file</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">      <span class="n">data</span> <span class="o">=</span> <span class="no">MultiJson</span><span class="o">.</span><span class="n">load</span> <span class="n">json</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">      <span class="k">if</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;source&#39;</span><span class="o">][</span><span class="s1">&#39;git&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">        <span class="nb">puts</span> <span class="s2">&#34; -&gt; </span><span class="si">#{</span><span class="n">data</span><span class="o">[</span><span class="s1">&#39;version&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">: git&#34;</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">        <span class="n">orginal_repo_url</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;source&#39;</span><span class="o">][</span><span class="s1">&#39;git&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="n">coverted_repo_name</span> <span class="o">=</span>  <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">orginal_repo_url</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="o">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="o">].</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">downcase</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">        <span class="n">data</span><span class="o">[</span><span class="s1">&#39;source&#39;</span><span class="o">][</span><span class="s1">&#39;git&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&#34;http://gitlab.dev/mirrors/</span><span class="si">#{</span><span class="n">coverted_repo_name</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">
</span></span><span class="line"><span class="ln">32</span><span class="cl">        <span class="no">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pod_file</span><span class="p">,</span> <span class="no">JSON</span><span class="o">.</span><span class="n">pretty_generate</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">      <span class="k">else</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;source&#39;</span><span class="o">][</span><span class="s1">&#39;http&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">        <span class="nb">puts</span> <span class="s2">&#34; -&gt; </span><span class="si">#{</span><span class="n">data</span><span class="o">[</span><span class="s1">&#39;version&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">: http url, do you want speed up?&#34;</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">      <span class="k">else</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;source&#39;</span><span class="o">][</span><span class="s1">&#39;svn&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">        <span class="nb">puts</span> <span class="s2">&#34; -&gt; </span><span class="si">#{</span><span class="n">data</span><span class="o">[</span><span class="s1">&#39;version&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">: svn repo, do you want speed up?&#34;</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">      <span class="k">end</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">    <span class="nb">puts</span> <span class="s2">&#34;Not find spec named: </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="n">desc</span> <span class="s1">&#39;gitlab 服务器镜像 Cocoapod Spec&#39;</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="n">task</span> <span class="ss">:mirror</span><span class="p">,</span> <span class="o">[</span><span class="ss">:repo</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="p">,</span> <span class="nb">p</span><span class="o">|</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">  <span class="n">host</span>        <span class="o">=</span> <span class="s1">&#39;172..0.1&#39;</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">  <span class="n">user</span>        <span class="o">=</span> <span class="s1">&#39;icyleaf&#39;</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">  <span class="n">options</span>     <span class="o">=</span> <span class="p">{</span><span class="ss">:keys</span> <span class="o">=&gt;</span> <span class="s1">&#39;~/.ssh/keys/id_rsa.pub&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">
</span></span><span class="line"><span class="ln">50</span><span class="cl">  <span class="nb">puts</span> <span class="s2">&#34;Connect gitlab server and mirror&#34;</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">  <span class="no">Net</span><span class="o">::</span><span class="no">SSH</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ssh</span><span class="o">|</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">    <span class="n">gitmirror_path</span> <span class="o">=</span> <span class="s1">&#39;/home/gitmirror/gitlab-mirrors&#39;</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&#34;sudo -u gitmirror -H rake </span><span class="se">\&#34;</span><span class="s2">add[</span><span class="si">#{</span><span class="nb">p</span><span class="o">[</span><span class="ss">:repo</span><span class="o">]</span><span class="si">}</span><span class="s2">]</span><span class="se">\&#34;</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">    <span class="n">stdout</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec!</span><span class="p">(</span><span class="s2">&#34;echo &#39;cd </span><span class="si">#{</span><span class="n">gitmirror_path</span><span class="si">}</span><span class="s2"> &amp;&amp; </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">    <span class="nb">puts</span> <span class="n">stdout</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">    <span class="n">ssh</span><span class="o">.</span><span class="n">loop</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><h5 id="gemfile">Gemfile</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">source</span> <span class="s2">&#34;https://ruby.taobao.org&#34;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="n">gem</span> <span class="s1">&#39;rest_client&#39;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="n">gem</span> <span class="s1">&#39;multi_json&#39;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="n">gem</span> <span class="s1">&#39;rake&#39;</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="n">gem</span> <span class="s1">&#39;net-ssh&#39;</span>
</span></span></code></pre></div><p><code>rake</code> 里面有两个 task：</p>
<ul>
<li>mirror: 镜像 iOS 开源组件</li>
<li>clone: 负责把官方 spec 指定包（开源组件的版本控制）替换 gitlab 地址并加入到私有包仓库</li>
</ul>
<h3 id="总结">总结</h3>
<p>通过工具总有办法可以改进和提升开发者的效率和解决各种的问题，希望本文可以给大家带来更多的灵感！</p>
<h3 id="答疑解惑">答疑解惑</h3>
<h5 id="f-这套理论靠谱吗">F: 这套理论靠谱吗？</h5>
<p>A: 目前我们团队已经采用并运行了很长一段时间，没有任何风险。最大的优势在于兼容官方的仓库，
就算无法链接自己的私有服务器，使用官方和国内镜像的都可以瞬间切换。</p>
<h5 id="f-如果没有服务器可以实现吗">F: 如果没有服务器可以实现吗？</h5>
<p>A: 醒醒吧孩子，就连单纯的镜像官方 Cocoapods Spec 还需要一个服务器执行定期同步脚本呢。</p>
<h5 id="f-国内-git-托管服务器能够支持吗">F: 国内 git 托管服务器能够支持吗？</h5>
<p>A: 据我所知国内大部分 git 托管服务器的解决方案都是基于 gitlab 二次开发的，理论上可行，
上面提到的 gitlab-mirror 本身依赖于 gitlab 的 api 在镜像的同时自动新建仓库。如果有成功的欢迎反馈。</p>
<h5 id="f-我从你代码发现服务器同样调用了一个-rake-脚本你没有开源">F: 我从你代码发现服务器同样调用了一个 rake 脚本，你没有开源！</h5>
<p>A: 眼睛真够敏锐的，个人对 gitlab-mirror 再做镜像时做了一个约束，新建一个 <code>Rakefile</code> 文件放到你的 gitlab-mirror 项目根目录即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nb">require</span> <span class="s1">&#39;uri&#39;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">desc</span> <span class="s2">&#34;Adding repo to gitmirror&#34;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">task</span> <span class="ss">:add</span><span class="p">,</span> <span class="o">[</span><span class="ss">:repo</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="p">,</span> <span class="nb">p</span><span class="o">|</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  <span class="n">repo</span> <span class="o">=</span> <span class="nb">p</span><span class="o">[</span><span class="ss">:repo</span><span class="o">]</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  <span class="k">begin</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="nb">name</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="o">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="o">].</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;.git&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="k">if</span> <span class="nb">name</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">      <span class="sb">`./add_mirror.sh -f --git --project-name </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sb"> --mirror </span><span class="si">#{</span><span class="n">repo</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">  <span class="k">rescue</span> <span class="no">Error</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="nb">puts</span> <span class="s1">&#39;not url&#39;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><h5 id="f-我还有问题">F: 我还有问题！</h5>
<p>A: 麻烦请留言，谢谢！</p>
]]></content:encoded></item><item><title>针对 Universal 应用上线 App Store 的提示</title><link>https://icyleaf.com/2013/02/app-store-review-tips-about-universal-app/</link><pubDate>Tue, 19 Feb 2013 12:34:56 +0800</pubDate><guid>https://icyleaf.com/2013/02/app-store-review-tips-about-universal-app/</guid><description>上线 Universal 被拒后的想法和思考</description><content:encoded><![CDATA[<h2 id="官方禁止新版本支持的设备小余旧版本">官方禁止新版本支持的设备小余旧版本</h2>
<p><a href="https://itunes.apple.com/cn/app/le-ju-ji-suan-qi-zui-gei-li/id397735649?mt=8">乐居计算器</a>是我们的第一款 Universal 应用，这次做了重要变化，但仅限于 iPhone 的修改，本想改本次上线仅支持 iPhone 来赶 deadline，临到上线的时候却被 Xcode 报错：</p>
<blockquote>
<p>&ldquo;This bundle does not support one or more of the devices that were supported in the previous bundle for this app. Bundles must continue to support any devices previously supported.&rdquo;</p>
</blockquote>
<p>官方《<a href="https://developer.apple.com/appstore/guidelines.html">App Store Review Guidelines</a>》却没有提到有这样的限制，最后在官方技术 Q&amp;A 找到答疑，参见 <a href="http://developer.apple.com/library/ios/#qa/qa1623/_index.html">Why am I getting device support errors when uploading my app?</a></p>
<h2 id="iphone-和-ipad-的排名是分开统计的">iPhone 和 iPad 的排名是分开统计的</h2>
<p>不知道大家注意没有，其实就算你发布的 app 是 Universal，但 app store 针对它的排行榜确实分开计算的，因此在做排名统计的时候不要只顾着一个设备的数据。那这个下载的数据怎么计算呢？</p>
<ol>
<li>什么设备下载就算那个设备的数据</li>
<li>通过 itunes 下载的算 iphone 的数据（Ocz）</li>
</ol>
<blockquote>
<p>数据来源：<a href="http://www.quora.com/How-does-being-a-universal-app-affect-App-Store-rankings">How does being a universal app affect App Store rankings</a></p>
</blockquote>
<h2 id="iphoneipad-新版本改为-universal两者都算新品上线">iPhone/iPad 新版本改为 Universal，两者都算新品上线</h2>
<p>原理同上，不再细说</p>
<h2 id="iphoneipad-还是一劳永逸的-universal">iPhone/iPad 还是一劳永逸的 Universal</h2>
<p>这是一个众说纷纭的话题，我的个人建议是，如果团队人较少且应用是免费发布，尽可能做成 Universal，减少不必要的维护成本和开发成本（虽然兼容平台会有一些牺牲）；如果是做付费且运营的人员可以支撑，可以最快最能抓住市场需求的点发布 iPhone 版本，通过市场反应去绝对是否开发 iPad 版本，等推广达到一个峰值（这个需要自己衡量）时，可以把 iPhone 或 iPad 的改成 Universal 版本，再次赚上一笔。</p>
<p>当然也有从 Universal 版拆分为 iPhone 和 iPad 的策略，不过我个人对此营销手段感到反感。重要的事让用户失去了占便宜的特殊心理。</p>
<h3 id="扩展阅读">扩展阅读</h3>
<ul>
<li><a href="http://www.cocoanetics.com/2011/05/to-universal-or-not/">To Universal or Not</a></li>
<li><a href="http://blog.iteleportmobile.com/the-case-for-universal-apps">The Case for Universal Apps</a></li>
</ul>
]]></content:encoded></item><item><title>在 iOS 应用调用 App Store 显示指定应用的详情</title><link>https://icyleaf.com/2012/10/how-to-preview-app-detail-buit-in-app-using-app-store-data/</link><pubDate>Thu, 25 Oct 2012 12:34:56 +0800</pubDate><guid>https://icyleaf.com/2012/10/how-to-preview-app-detail-buit-in-app-using-app-store-data/</guid><description>&lt;p>可能很多手机应用都使用了“应用推荐”的功能，实现方式各式各样，对于 iOS 来说最致命的缺点就是，如果用户喜欢给推荐的应用，当用户点击该应用的时候，系统会硬生生的从当前应用内退出并打开 App Store 查看应用的详情。如果站在用户体验的角度来看，这其实是一个非常差劲的体验。那么能不能有一种方式可以在应用内部打开呢？&lt;/p>...</description><content:encoded><![CDATA[<p>可能很多手机应用都使用了“应用推荐”的功能，实现方式各式各样，对于 iOS 来说最致命的缺点就是，如果用户喜欢给推荐的应用，当用户点击该应用的时候，系统会硬生生的从当前应用内退出并打开 App Store 查看应用的详情。如果站在用户体验的角度来看，这其实是一个非常差劲的体验。那么能不能有一种方式可以在应用内部打开呢？</p>
<p>答案是肯定可以！！ iOS 6 其实包括了很多很好的特性，比如 Soical framework，丰富了分享面板，包括我最近刚刚更新的 ShareKit 也对新浪微博支持了这个特性(<a href="https://github.com/icyleaf/ShareKit/issues/4">ShareKit#4</a>)。还有针对于 O2O 具有杀手锏作用的 Pass Kit framework 等等等等&hellip;&hellip;</p>
<blockquote>
<p>喂喂喂，你说了半天没有讲到正题啊？！！</p>
</blockquote>
<p>咳<del>咳</del>书归正题，如果你没做应用内付费，可能你就忽略了 iOS 6 对 In-App Purchase 的说明：</p>
<blockquote>
<p>The Store Kit framework (StoreKit.framework) now supports the purchasing of iTunes content inside your app and provides support for having downloadable content hosted on Apple servers. With in-app content purchases, you present a view controller that lets users purchase apps, music, books, and other iTunes content directly from within your app. You identify the items you want to make available for purchase but the rest of the transaction is handled for you by Store Kit.</p>
</blockquote>
<p>也就是说 StoreKit framework 支持了在应用下载其他应用的特性！！！兴奋吧，官方很慷慨的支持了这个功能！！如果查看手册，其实咱们用到的只有 SKStoreProductViewController 这个类和所述的 delegate 就够了。</p>
<p>代码如下：</p>
<pre tabindex="0"><code>SKStoreProductViewController *controller = [[SKStoreProductViewController alloc] init];
controller.delegate = self;
NSDictionary *params = [NSDictionary dictionaryWithObject:@&#34;397735649&#34; // App id
                                                   forKey:SKStoreProductParameterITunesItemIdentifier];

[controller loadProductWithParameters:params
                      completionBlock:^(BOOL result, NSError *error) {
                          if (result)
                              [self presentViewController:controller
                                                 animated:YES
                                               completion:nil];
                      }];
</code></pre>]]></content:encoded></item><item><title>如何针对 iOS 设备进行网络抓包分析</title><link>https://icyleaf.com/2012/10/%E5%A6%82%E4%BD%95%E9%92%88%E5%AF%B9-ios-%E8%AE%BE%E5%A4%87%E8%BF%9B%E8%A1%8C%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/</link><pubDate>Mon, 15 Oct 2012 12:34:56 +0800</pubDate><guid>https://icyleaf.com/2012/10/%E5%A6%82%E4%BD%95%E9%92%88%E5%AF%B9-ios-%E8%AE%BE%E5%A4%87%E8%BF%9B%E8%A1%8C%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/</guid><description>&lt;p>Charles 目前是 OS X 上面最好的抓包分析软件，相比 WireShark 功能更加强大，并支持代理功能。&lt;/p>
&lt;ol>
&lt;li>&lt;a href="http://www.ravelrumba.com/blog/ipad-http-debugging/">iPad HTTP Debugging with Charles&lt;/a> - 教大家如何使用它进行代理抓包&lt;/li>
&lt;li>&lt;a href="http://www.skinkers.com/2012/06/12/testing-tethering-data-driven-mobile-apps-with-charles-and-osx-ipad-iphone-http-debugging/">Testing / Tethering Data Driven Mobile Apps with Charles and OSX&lt;/a> - 教大家如何进行 request remap，适合不改动代码的情况下修改域名切换环境&lt;/li>
&lt;/ol>
&lt;p>不过 Charles 的确定就是共享软件，未注册版本可以使用全功能但是限制是只能允许使用 30 分钟，那么&amp;hellip;习惯用 Terminal 的还有一个方法：&lt;a href="http://useyourloaf.com/blog/2012/02/07/remote-packet-capture-for-ios-devices.html">Remote Packet Capture for iOS Devices&lt;/a>&lt;/p>...</description><content:encoded><![CDATA[<p>Charles 目前是 OS X 上面最好的抓包分析软件，相比 WireShark 功能更加强大，并支持代理功能。</p>
<ol>
<li><a href="http://www.ravelrumba.com/blog/ipad-http-debugging/">iPad HTTP Debugging with Charles</a> - 教大家如何使用它进行代理抓包</li>
<li><a href="http://www.skinkers.com/2012/06/12/testing-tethering-data-driven-mobile-apps-with-charles-and-osx-ipad-iphone-http-debugging/">Testing / Tethering Data Driven Mobile Apps with Charles and OSX</a> - 教大家如何进行 request remap，适合不改动代码的情况下修改域名切换环境</li>
</ol>
<p>不过 Charles 的确定就是共享软件，未注册版本可以使用全功能但是限制是只能允许使用 30 分钟，那么&hellip;习惯用 Terminal 的还有一个方法：<a href="http://useyourloaf.com/blog/2012/02/07/remote-packet-capture-for-ios-devices.html">Remote Packet Capture for iOS Devices</a></p>
<pre tabindex="0"><code>$ rvictl -s &lt;UDID&gt;
$ rvictl -l
$ tcpdump -n -t -i rvi0 -q tcp
</code></pre>]]></content:encoded></item><item><title>友盟 iOS 发布渠道自动化脚本</title><link>https://icyleaf.com/2012/05/ios-publish-channel-packger-for-umeng/</link><pubDate>Thu, 10 May 2012 12:34:56 +0800</pubDate><guid>https://icyleaf.com/2012/05/ios-publish-channel-packger-for-umeng/</guid><description>&lt;p>现在公司的大多数手机项目的统计服务都是用的&lt;a href="http:///www.umeng.com">友盟&lt;/a>，而自使用之初到现在都有一个渠道管理的功能，这个最后打包的时候实际上可能会产生一点点的麻烦，最早第一个 app 发布的时候，写了一个半自动的脚本，凑合用了很久，现在觉得需要完全自动化，于是借鉴之前 &lt;a href="http://icyleaf.com/2012/04/automating-script-to-testFlight-from-xcode/">testflightapp 的自动化脚本&lt;/a>，重新改造脚本。&lt;/p>...</description><content:encoded><![CDATA[<p>现在公司的大多数手机项目的统计服务都是用的<a href="http:///www.umeng.com">友盟</a>，而自使用之初到现在都有一个渠道管理的功能，这个最后打包的时候实际上可能会产生一点点的麻烦，最早第一个 app 发布的时候，写了一个半自动的脚本，凑合用了很久，现在觉得需要完全自动化，于是借鉴之前 <a href="http://icyleaf.com/2012/04/automating-script-to-testFlight-from-xcode/">testflightapp 的自动化脚本</a>，重新改造脚本。</p>
<p>实现分两部分：</p>
<ul>
<li>iOS 代码</li>
<li>自动化脚本</li>
</ul>
<p>实现原理很简单，我利用一个文本文件放置在项目当中（比如：<code>PublishChannel.txt</code>），里面只需要存上发布渠道的名字，默认是 <code>App Store</code>。在代码中只需要想友盟调用函数的时候，读取这个文件即可。只需要做这样简单的工作就结束了 iOS 代码部分的工作。</p>
<p>主要的功能基本上都是由自动化脚本完成。因为它要去标记分发渠道，处理打包工作：</p>
<ol>
<li>打包需要一个符合官方发布要求的 Icon，即 512x512 px，PNG 格式且名字必须是 <code>iTunesArtwork</code> （不能包含后缀，无比保证在终端检查）</li>
<li>修改 PublishChannel.txt 的分发渠道</li>
<li>同时需要把 .app 的文件放在 <code>Payload</code> 并和 <code>iTunesArtwork</code> 一起打成 ipa 包（实际上就是一个 zip，改成了 ipa）</li>
</ol>
<p>这样看起来其实工作也不复杂，只不过分发渠道多了就是有些浪费时间。同样还是采用了 Archive 的 Post-Action，这里面可以插入脚本以及外部的调用脚本（如果看不到下面的具体代码，请<a href="https://gist.github.com/2650508">点击这里</a>：</p>
<!-- raw HTML omitted -->
]]></content:encoded></item><item><title>自动化脚本上传应用至 testflightapp</title><link>https://icyleaf.com/2012/04/automating-script-to-testflight-from-xcode/</link><pubDate>Fri, 06 Apr 2012 12:34:56 +0800</pubDate><guid>https://icyleaf.com/2012/04/automating-script-to-testflight-from-xcode/</guid><description>&lt;p>Testflightapp 是团队开发测试中起了重要的角色，尤其是到目前为止一直是免费，最近还推出的 Live 功能不仅可以统计本身的一些数据还可以把现有的一些其他的账户的数据（比如， itunesconnect，Apple iAd，admob 等）导入进一步扩大聚合。&lt;/p>...</description><content:encoded><![CDATA[<p>Testflightapp 是团队开发测试中起了重要的角色，尤其是到目前为止一直是免费，最近还推出的 Live 功能不仅可以统计本身的一些数据还可以把现有的一些其他的账户的数据（比如， itunesconnect，Apple iAd，admob 等）导入进一步扩大聚合。</p>
<p>尤其是它真的重视开发着的核心需求，仅推出了唯一的一个公开 API，就是上传打包后的 ipa 文件，配合 Xcode 中 Archive 的 Post-action 可以轻松搞定自动化的操作。</p>
<p>下面是网上搜集的脚本，算是我发现定制化比较强的<a href="https://gist.github.com/1379127">自动化脚本</a>，而且注解也写的很详细。可以在配合我的打包脚本，可以把各个发布渠道的事情一起自动化。</p>
<blockquote>
<p>注意：Xcode 默认的 run script 是 <code>/bin/sh</code>，而上面的脚本是
<code>/bin/bash</code>。</p>
</blockquote>
<p>这个 Post-action 不爽的地方在于所有的 <code>echo</code> 没有办法直接输出到 Xcode 的 output 里面，所以脚本只能把 log 保持到了 <code>/tmp</code>
目录下面，如果发现出现问题请仔细查看 log。</p>
<p>BTW，Post-actions 添加的脚本对于忽略了 XCode 干扰文件的版本控制来说，它没有归入到版本控制之中，脚本是被转义后放在了一个 xcscheme 的 xml 文件中：</p>
<pre tabindex="0"><code>(project).xcodeproj/xcuserdata/(username).xcuserdatad/xcschemes/(name).xcscheme
</code></pre>]]></content:encoded></item><item><title>pngcrush 的一些用法</title><link>https://icyleaf.com/2012/03/pngcrush-usage-with-ios-apps/</link><pubDate>Fri, 09 Mar 2012 12:34:56 +0800</pubDate><guid>https://icyleaf.com/2012/03/pngcrush-usage-with-ios-apps/</guid><description>&lt;p>pngcrush 顾名思义，看起名字本身就优化 png 的工具，为什么会提到它呢，因为目前所有 iOS app 自身的 png 文件都是经过它优化的，对于优化有的 png，系统本身默认是无法识别的（包括看图工具，作图工具）。但这个工具不仅仅可以优化还可以还原。假如你希望可以学习优秀 iOS App 的一些 png 资源设计，通过这个工具延伸的一些辅助工具，可以快速预览和恢复未优化的图片。&lt;/p>...</description><content:encoded><![CDATA[<p>pngcrush 顾名思义，看起名字本身就优化 png 的工具，为什么会提到它呢，因为目前所有 iOS app 自身的 png 文件都是经过它优化的，对于优化有的 png，系统本身默认是无法识别的（包括看图工具，作图工具）。但这个工具不仅仅可以优化还可以还原。假如你希望可以学习优秀 iOS App 的一些 png 资源设计，通过这个工具延伸的一些辅助工具，可以快速预览和恢复未优化的图片。</p>
<h1 id="pngcrush">pngcrush</h1>
<p>本身就是一个开源的工具，托管在 <a href="http://pmt.sourceforge.net/pngcrush/index.html">SourceForge</a>，可以在任何平台运行，对于安装 Xcode 的童鞋，此工具默认放在：</p>
<pre tabindex="0"><code># XCode 4.3+
/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/pngcrush

# XCode 4.2.x 以下版本
/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/

# 还原 ipa 目录下所以 png 文件到 reverted 目录下面
pngcrush -dir reverted -revert-iphone-optimizations -q ipa/*.png
</code></pre><p>这里还有一些其他版本的<a href="http://stackoverflow.com/questions/7138700/pngcrush-uncrush-on-linux">类似工具</a></p>
<h1 id="quicklook">Quicklook</h1>
<p>OSX 有个系统的快速预览功能，简单的解释（针对于图片来说）：可以显示图片的内容，同时选中文件，按<strong>空格</strong>对于系统可以识别的即可快速查看文件的内容。</p>
<p>但由于 iOS app 的 png 文件是优化后的，既然系统无法识别，那就更别提 Quicklook 了，于是利用 pngcrush 就有了新的产物：PngUncrush.qlgenerator。有了它就可以用 Quicklook 显示和查看 png 图片了。</p>
<p>目前利用这个工具做成的工具很多，包括用 shell 安装的，pkg 文件，实际上原理都是把这个文件丢到系统 <code>/Library/QuickLook/</code> 或者 <code>~/Library/QuickLook/</code> 下面即可。</p>
<p>我觉得比较好用的是 <a href="http://castelliweb.com/blog/2010/05/24/quicklook-plugins-for-mac/">Quicklook Plugins for Mac</a>，这是一个 pkg 安装文件，不仅包括了对于 png 文件的快速预览，同时对于 ipa 文件的图表也会更换为更为直观的 App 图标，方便大家的浏览和识别。</p>
<h1 id="atpeek">atPeek</h1>
<p>我就知道你不会满足上面半自动的工具，我想 <a href="http://www.atpurpose.com/atPeek/">atPeek</a>(奇怪为什么会被墙掉) 也是你在本博文中最满意的工具。正式介绍下，这个工具自打开的一瞬间，就会加载 <code>Music/iTunes/Mobile Applications</code> 目录下面的所有 ipa 文件。点击你需要查看的 ipa 文件，不仅可以查看该 ipa 的基本 App，最让大家爽的是，ipa 的所有资源文件以文件资源管理器的方式呈现出来。嗯，没错！我可以看到你们双眼发光了！</p>
<p>但是，这是一个付费应用，你可以进行的操作就是浏览 ipa 和应用自带的预览功能，任何的放大以及导出 png 资源，都是需要付费的，价格为 $4.99。</p>
]]></content:encoded></item><item><title>如何让 iOS 和 Android 支持自定义字体</title><link>https://icyleaf.com/2011/07/custom-fonts-both-in-ios-and-android/</link><pubDate>Wed, 06 Jul 2011 12:34:56 +0800</pubDate><guid>https://icyleaf.com/2011/07/custom-fonts-both-in-ios-and-android/</guid><description>&lt;p>本篇教程的目前源于我们团队设计师一直询问，iOS(iPhone/iPad) 和 Android
两个平台是否支持自定义字体的问题，恰巧前不久&lt;a href="http://www.v2ex.com/t/15220">唐茶计划&lt;/a>出了一个关于在中文阅读新体验的电子书应用：&lt;a href="http://itunes.apple.com/cn/app/id446752200?mt=8">失控&lt;/a>。里面提到中文的显示采用了香港字体设计室的全新中文黑体字：&lt;a href="http://www.typeisbeautiful.com/2011/07/4276">信黑体&lt;/a>。于是我就在想看来
iOS 是可以支持自定义字体的。通过搜索和研究整理如下，供自己备份和大家参考&lt;/p>...</description><content:encoded><![CDATA[<p>本篇教程的目前源于我们团队设计师一直询问，iOS(iPhone/iPad) 和 Android
两个平台是否支持自定义字体的问题，恰巧前不久<a href="http://www.v2ex.com/t/15220">唐茶计划</a>出了一个关于在中文阅读新体验的电子书应用：<a href="http://itunes.apple.com/cn/app/id446752200?mt=8">失控</a>。里面提到中文的显示采用了香港字体设计室的全新中文黑体字：<a href="http://www.typeisbeautiful.com/2011/07/4276">信黑体</a>。于是我就在想看来
iOS 是可以支持自定义字体的。通过搜索和研究整理如下，供自己备份和大家参考</p>
<h1 id="ios">iOS</h1>
<p>iOS 对字体以样式的支持是非常有限的(内嵌<a href="http://iosfonts.com/">默认字库列表</a>)，尤其说对于用习惯了 HTML + CSS，就觉得 iOS 对字体的扩展真是逊到渣了，当然高人们已经准备为大众造福，出现了轻巧的
<a href="https://github.com/zynga/FontLabel">FontLable</a>，<a href="https://github.com/mattt/TTTAttributedLabel">TTTAttributedLabel</a> 开源库到怪兽级别 <a href="https://github.com/facebook/three20">Three20</a> 开源框架。但假如仅仅是想加载自定义字体来说，对于 iOS 4 版本还是比较简单的：</p>
<ol>
<li>添加自定义字体文件做资源文件添加到 XCode 项目之中</li>
<li>在 info.plist 中新增一个名为 UIAppFonts 的 Key，类型是数组（array）</li>
<li>把新增的字体的文件名（包括后缀）依次填入 UIAppFonts 数组（注意区分大小写）</li>
<li>保存 info.plist（废话）。准备工作完毕，下面是编码部分</li>
</ol>
<pre tabindex="0"><code>@implementation CustomFontLabel

- (id)initWithCoder:(NSCoder *)decoder
{
    if (self = [super initWithCoder: decoder])
    {
        [self setFont: [UIFont fontWithName: @&#34;Custom Font Name&#34; size: self.font.pointSize]];
        // 这里 Custom Font Name 并不是字体的文件名，而且系统注册显示的字体标准名称，比如
        // 比如，微软雅黑，最好就用 Microsoft YaHei （不过这个会存在版权问题把 XD）
        // 另外，注意区分大小写
    }
    return self;
}

@end
</code></pre><p>这里还有更完整的<a href="http://stackoverflow.com/questions/360751/can-i-embed-a-custom-font-in-an-iphone-application">关于 iOS 不同平台支持自定义字体</a>的问答。</p>
<h1 id="android">Android</h1>
<p>Android 默认支持  Droid Sans，Droid Sans Mono 和 Droid Serif 三种字体，其实对于中文的显示还是很不错的，有些类似于微软雅黑字体（<a href="http://www.cnbeta.com/articles/114854.htm">区别</a>）。假如只是对默认的字体进行更换，最简单的方法就是配置 layout 文件：</p>
<pre tabindex="0"><code>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
&lt;LinearLayout xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34;
              android:orientation=&#34;vertical&#34;
              android:layout_width=&#34;fill_parent&#34;
              android:layout_height=&#34;fill_parent&#34;
        &gt;
    &lt;TextView
            android:layout_width=&#34;fill_parent&#34;
            android:layout_height=&#34;wrap_content&#34;
            android:text=&#34;This is a &#39;sans&#39; demo!&#34;
            android:typeface=&#34;sans&#34;
            /&gt;
     &lt;TextView
            android:layout_width=&#34;fill_parent&#34;
            android:layout_height=&#34;wrap_content&#34;
            android:text=&#34;This is a &#39;serif&#39; demo!&#34;
            android:typeface=&#34;serif&#34;
            android:textStyle=&#34;italic&#34;
            /&gt;
     &lt;TextView
            android:layout_width=&#34;fill_parent&#34;
            android:layout_height=&#34;wrap_content&#34;
            android:text=&#34;This is a &#39;monospace&#39; demo!&#34;
            android:typeface=&#34;monospace&#34;
            android:textStyle=&#34;bold&#34;
            /&gt;
&lt;/LinearLayout&gt;
</code></pre><p>但是这样肯定不能满足大家对于字体排版高一级的要求，下面是支持自定义字体的步骤：</p>
<p>首先，添加自定义字体文件放在项目的 <code>assets/fonts</code> 目录下面（目录可能需要自己创建）。</p>
<p>其次，编辑 layout 文件（这里做一个示范）</p>
<pre tabindex="0"><code>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
&lt;LinearLayout xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34;
              android:orientation=&#34;vertical&#34;
              android:layout_width=&#34;fill_parent&#34;
              android:layout_height=&#34;fill_parent&#34;
        &gt;
    &lt;TextView android:id=&#34;@+id/textview&#34;
            android:layout_width=&#34;fill_parent&#34;
            android:layout_height=&#34;wrap_content&#34;
            android:text=&#34;This is a &#39;Microsoft YaHei&#39; demo!&#34;
            /&gt;
    &lt;Button android:id=&#34;@+id/button&#34;
            android:layout_width=&#34;fill_parent&#34;
            android:layout_height=&#34;wrap_content&#34;
            android:text=&#34;This is a &#39;Microsoft YaHei&#39; button!&#34;
            /&gt;
&lt;/LinearLayout&gt;
</code></pre><p>最后，在代码部分实现自定义字体（和 iOS 类似）</p>
<pre tabindex="0"><code>public void onCreate(Bundle savedInstanceState)
{
       super.onCreate(savedInstanceState);
        setContentView(R.layout.main);

        TextView textView = null;
        Button button = null;

        setFont(textView, &#34;fonts/YaHei.ttf&#34;, R.id.text_view);
        setFont(button, &#34;fonts/YaHei.ttf&#34;, R.id.button);
}

void setFont(TextView name, String path, int res)
{
    	name = (TextView) findViewById(res);
        Typeface font = Typeface.createFromAsset(this.getAssets(), path);
        name.setTypeface(font);
}
</code></pre><p>扩展阅读 [<a href="http://mobile.tutsplus.com/tutorials/android/customize-android-fonts/">1</a>] [<a href="http://russenreaktor.wordpress.com/2010/04/29/solved-android-using-custom-fonts/">2</a>]</p>
<p>话说，为什么 Android 到现在都没有更多的开源的库和框架呢？</p>
]]></content:encoded></item><item><title>为 ShareKit 增加国内相关微博/SNS 服务</title><link>https://icyleaf.com/2011/05/append-related-services-into-sharekit-from-china/</link><pubDate>Mon, 02 May 2011 12:34:56 +0800</pubDate><guid>https://icyleaf.com/2011/05/append-related-services-into-sharekit-from-china/</guid><description>&lt;p>在 iDev 圈内，众所周知 ShareKit是一个家喻户晓的分享框架，很多人都在问哪有支持国内相关微博/SNS服务（比如，新浪微博，腾讯微博，豆瓣，开心网，校内等）的类似框架或者谁去做贡献，造福那些拿来主义的人类。正好碰巧我刚刚接触 iOS 开发不久，为了验证文章开头的那段话，恰巧我开发的应用也需要设计这块的内容，我就只好啃下了这块“硬面包”，实际上在熟悉整个 ShareKit 的代码后，外加上对于 OAuth 协议又非常的了解，做一个扩展还是很轻松的，虽然我对 Objective-C 代码并不是很熟悉，这一切得益于 ShareKit。&lt;/p>...</description><content:encoded><![CDATA[<p>在 iDev 圈内，众所周知 ShareKit是一个家喻户晓的分享框架，很多人都在问哪有支持国内相关微博/SNS服务（比如，新浪微博，腾讯微博，豆瓣，开心网，校内等）的类似框架或者谁去做贡献，造福那些拿来主义的人类。正好碰巧我刚刚接触 iOS 开发不久，为了验证文章开头的那段话，恰巧我开发的应用也需要设计这块的内容，我就只好啃下了这块“硬面包”，实际上在熟悉整个 ShareKit 的代码后，外加上对于 OAuth 协议又非常的了解，做一个扩展还是很轻松的，虽然我对 Objective-C 代码并不是很熟悉，这一切得益于 ShareKit。</p>
<p>ShareKit 在整体上，代码写的比较完美，对于新增的服务可以轻松实现，而且另外最最大的一个好处在于国内的这些服务实际上都是 Copy to China，这有大大减少了移植的开发量，比较恶心的事，国内为了证明我们的结构和功能不同于原版，对其有做了细微的调整，这就导致使用标准化的协议不能通过，这对于只是想用的人来说就是一种灾难。</p>
<blockquote>
<p>天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣。人之为学有难易乎？学之，则难者亦易矣；不学，则易者亦难矣。</p>
</blockquote>
<p>上面是从 V2EX某帖子挖出来的一个评论，实际上这段文字大家在学校的时候应该并不陌生，随后又看到了《<a href="http://huajun.w18.net/?p=388">凭什么是我们</a>》这篇文章，更是印证了上面这段话。</p>
<p>为什么我要说上面这段和标题并不沾边的文字呢，实际上现在要发布的日志本来在我看来是非常没有必要的，因为这个项目我已经在 git 上面 fork 并贡献了关于国内相关微博/SNS服务的代码，我以为大家可以通过搜索引擎搜索到，可想还是有人来问我，那好吧，为了减少询问我的次数，以及这篇日志的SEO，我还是写下了这个日志。</p>
<p>Github 项目地址：https://github.com/icyleaf/ShareKit</p>
<p>衷心希望这个 fork 的代码对热情开发的人有所帮助！</p>
]]></content:encoded></item></channel></rss>