<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>ActiveRecord 使用秘笈 | icyleaf</title><link rel=prev href=https://icyleaf.com/2013/10/about-pager-on-git/><link rel=next href=https://icyleaf.com/2013/12/learning-ansible-and-vagrant/><link rel=canonical href=https://icyleaf.com/2013/12/activerecord-tips/><link rel=apple-touch-icon sizes=180x180 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.css><meta name=title content="ActiveRecord 使用秘笈 | icyleaf"><meta name=author content="icyleaf"><meta name=description content="日常写代码热爱户外的梦想家"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/icyleaf.com\/"},"articleSection":"posts","name":"ActiveRecord 使用秘笈","headline":"ActiveRecord 使用秘笈","description":"ActiveRecord 是 Rails 内置的 ORM 框架，大多数人学习 Ruby 都是从 rails 开始，接触的也是这个 ORM，因此就有了这个使用秘笈。 支持 rake db:xxx 命令 在非 rails 项目怎么让 rake 支持 db:xxx 命令呢？把","inLanguage":"zh","author":"icyleaf","creator":"icyleaf","publisher":"icyleaf","accountablePerson":"icyleaf","copyrightHolder":"icyleaf","copyrightYear":"2013","datePublished":"2013-12-03 12:34:56 \u002b0800 \u002b0800","dateModified":"2013-12-03 12:34:56 \u002b0800 \u002b0800","url":"https:\/\/icyleaf.com\/2013\/12\/activerecord-tips\/","wordCount":"663","keywords":["Ruby","ActiveRecord","Rails","icyleaf"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/about title>About</a>
<a class=menu-item href=https://icyleaf.com/projects title>Projects</a>
<a class=menu-item href=https://icyleaf.com/index.xml title>Feed</a>
<span class=divide></span><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/about title><h3>About</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>Projects</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/index.xml title><h3>Feed</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">ActiveRecord 使用秘笈</h1><div class=post-meta><time datetime=2013-12-03 itemprop=datePublished>December 3, 2013</time>
·
<span class=tags>Ruby, ActiveRecord, Rails</span>
·
<span class=post-word-count>663 words · 3 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents></nav></div></div><div class=post-content><div id=post-gallery><p>ActiveRecord 是 Rails 内置的 ORM 框架，大多数人学习 Ruby 都是从 rails 开始，接触的也是这个 ORM，因此就有了这个使用秘笈。</p><h1 id=支持-rake-dbxxx-命令>支持 <code>rake db:xxx</code> 命令</h1><p>在非 rails 项目怎么让 rake 支持 db:xxx 命令呢？把如下代码放到 <code>Rakefile</code> 中:</p><pre><code>namespace :db do
  require 'activerecord'
  require 'yaml'

  desc &quot;加载项目表数据到数据库&quot;
  task :init =&gt; :dbenv do
    file = &quot;db/schema.rb&quot;
    load(file) # 参考 rails 文件结构
  end

  desc &quot;创建数据库初始化数据&quot;
  task :seed =&gt; :dbenv do
    seed_file = File.join(File.dirname(__FILE__), 'db', 'seeds.rb')
    load(seed_file) if File.exist?(seed_file)
  end

  desc &quot;合并 db/migrate 目录下的数据库文件&quot;
  task :migrate =&gt; :dbenv do
    ActiveRecord::Migration.verbose = ENV[&quot;VERBOSE&quot;] ? ENV[&quot;VERBOSE&quot;] == &quot;true&quot; : true
    ActiveRecord::Migrator.migrate(&quot;db/migrate/&quot;, ENV[&quot;VERSION&quot;] ? ENV[&quot;VERSION&quot;].to_i : nil)
    Rake::Task[&quot;db:schema:dump&quot;].invoke if ActiveRecord::Base.schema_format == :ruby
  end

  desc '设定 STEP=n 回滚之前版本的数据库结构'
  task :rollback =&gt; :dbenv do
    step = ENV['STEP'] ? ENV['STEP'].to_i : 1
    ActiveRecord::Migrator.rollback('db/migrate/', step)
    Rake::Task[&quot;db:schema:dump&quot;].invoke if ActiveRecord::Base.schema_format == :ruby
  end

  task :dbenv do
    dbname = ENV['db'] || 'development'
  	$dbconfig = YAML::load('db/database.yml')
    ActiveRecord::Base.establish_connection($dbconfig[dbname])
  end

  namespace :schema do
    desc &quot;把数据库结构写入 db/schema.rb 文件&quot;
    task :dump =&gt; :dbenv do
      require 'active_record/schema_dumper'
      File.open(ENV['SCHEMA'] || &quot;db/schema.rb&quot;, &quot;w&quot;) do |file|
        ActiveRecord::SchemaDumper.dump(ActiveRecord::Base.connection, file)
      end
    end
  end
end
</code></pre><p>初始化数据库结构</p><pre><code>$ rake db:init
</code></pre><h1 id=支持-sql-server>支持 SQL Server</h1><p>只针对 *nix 系统：</p><ol><li>安装 freetds</li></ol><pre><code>* Mac OS: `brew install freetds`
* CentOS: `yum install -y freetds`
</code></pre><ol start=2><li><code>gem install tiny_tds</code></li><li><code>gem install activerecord-sqlserver-adapter</code></li></ol><p>引用如下：</p><pre><code>require 'tiny_tds'
require 'activerecord-sqlserver-adapter'
require 'active_record'

ActiveRecord::Base.establish_connection({
  :adapter =&gt; 'sqlserver'
 :host =&gt; '10.10.10.10',
 :username =&gt; 'sa',
  :password =&gt; 'p@ssword',
  :database =&gt; 'development',
  :timeout =&gt; 10,
  :port =&gt; 1433,
})

class Users &lt; ActiveRecord::Base
	self.table_name = 'User'
	default_scope { lock('WITH (NOLOCK)') }
end
</code></pre><h1 id=多数据库支持>多数据库支持</h1><p>创建 <code>config/database.yml</code> 文件:</p><pre><code>development:
  adapter: mysql2
  host: localhost
  username: root
  password:
  database: development
  timeout: 10
  port: 3306
test:
  adapter: mysql2
  host: 10.10.10.10
  username: root
  password: p@ssword
  database: test
  timeout: 10
  port: 1433
production:
  adapter: mysql2
  host: 33.33.33.33
  username: root
  password: p@ssword
  database: production
</code></pre><p>创建 <code>lib/model.rb</code> 文件:</p><pre><code>$dbconfig = YAML::load(File::open('config/database.yml'))

class User &lt; ActiveRecord::Base
  establish_connection $dbconfig['development']
end

class Post &lt; ActiveRecord::Base
  establish_connection $dbconfig['test']
end

class Tag &lt; ActiveRecord::Base
  establish_connection $dbconfig['production']
end
</code></pre><h1 id=动态创建表名>动态创建表名</h1><p>假若有个需求需要按照每月分表（当然也可以安装业务分表什么的），我们可以通过下面方式调用：</p><pre><code># 插入 post，如果表不存在则创建后插入
post = Post.date('201312').get_or_create_table.create(
  title:'test',
  content:'body'
)

# Model 实现代码
class Post &lt; ActiveRecord::Base
  @date = Time.now.strftime(&quot;%Y%02m&quot;)

  def self.date(date)
  	@date = date
  end

  def self.get_or_create_table(params={})
    self.date(params[:date]) if params[:date]
    self.create_table(params) if !self.exists?
  end

  def self.create_table(params={})
    self.date(params[:date]) if params[:date]
    table_name = self.table_name
    ActiveRecord::Schema.define do
      create_table table_name do |table|
        table.column :title, :string
        table.column :content, :text
        table.column :created_at, :datetime
        table.column :updated_at, :datetime
      end
    end

    return self
  end

  def self.table_exists?
    # 如果你设置了多数据库请取消下行注解并更改配置名（参考上个技巧）
    # ActiveRecord::Base.establish_connection($dbconfig['development'])

    ActiveRecord::Base.connection.tables.include?(self.table_name)
  end

  def table_name
    &quot;#{@date_users}&quot;
  end
end
</code></pre></div></div><div class=post-nav><a href=https://icyleaf.com/2013/10/about-pager-on-git/ class=prev rel=prev title="Git 和 Pager 的那点事"><i class="iconfont icon-left"></i>&nbsp;Git 和 Pager 的那点事</a>
<a href=https://icyleaf.com/2013/12/learning-ansible-and-vagrant/ class=next rel=next title="学习 Ansible + Vagrant">学习 Ansible + Vagrant&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2022</span>
<span>🍺</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script src=https://fastly.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script><script src=https://fastly.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script>pangu.spacingPage()</script><script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: '\/photoswipe\/photoswipe.esm.js',
  });
  lightbox.init();
</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TKQBZ7R259"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-TKQBZ7R259')</script></div></body></html>