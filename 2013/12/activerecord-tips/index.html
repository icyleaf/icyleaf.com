<!doctype html><html lang=zh-cn></html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ActiveRecord ä½¿ç”¨ç§˜ç¬ˆ | icyleaf</title><meta name=keywords content="Ruby,ActiveRecord,Rails"><meta name=description content="ä½œä¸º Rails ç”Ÿæ€ä¹‹ä¸€çš„ ORM ä¸€å®šè¦å¥½å¥½å­¦ä¹ "><meta name=author content="icyleaf"><link rel=canonical href=https://icyleaf.com/2013/12/activerecord-tips/><link rel=icon href=https://icyleaf.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://icyleaf.com/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=https://icyleaf.com/android-chrome-512x512.png><link rel=apple-touch-icon href=https://icyleaf.com/apple-touch-icon.png><link rel=mask-icon href=https://icyleaf.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.min.css><link rel=canonical href=https://icyleaf.com/2013/12/activerecord-tips/><meta property="og:title" content="ActiveRecord ä½¿ç”¨ç§˜ç¬ˆ"><meta property="og:description" content="ä½œä¸º Rails ç”Ÿæ€ä¹‹ä¸€çš„ ORM ä¸€å®šè¦å¥½å¥½å­¦ä¹ "><meta property="og:type" content="article"><meta property="og:url" content="https://icyleaf.com/2013/12/activerecord-tips/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-12-03T12:34:56+08:00"><meta property="article:modified_time" content="2013-12-03T12:34:56+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ActiveRecord ä½¿ç”¨ç§˜ç¬ˆ"><meta name=twitter:description content="ä½œä¸º Rails ç”Ÿæ€ä¹‹ä¸€çš„ ORM ä¸€å®šè¦å¥½å¥½å­¦ä¹ "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://icyleaf.com/posts/"},{"@type":"ListItem","position":2,"name":"ActiveRecord ä½¿ç”¨ç§˜ç¬ˆ","item":"https://icyleaf.com/2013/12/activerecord-tips/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ActiveRecord ä½¿ç”¨ç§˜ç¬ˆ","name":"ActiveRecord ä½¿ç”¨ç§˜ç¬ˆ","description":"ä½œä¸º Rails ç”Ÿæ€ä¹‹ä¸€çš„ ORM ä¸€å®šè¦å¥½å¥½å­¦ä¹ ","keywords":["Ruby","ActiveRecord","Rails"],"articleBody":"ActiveRecord æ˜¯ Rails å†…ç½®çš„ ORM æ¡†æ¶ï¼Œå¤§å¤šæ•°äººå­¦ä¹  Ruby éƒ½æ˜¯ä» rails å¼€å§‹ï¼Œæ¥è§¦çš„ä¹Ÿæ˜¯è¿™ä¸ª ORMï¼Œå› æ­¤å°±æœ‰äº†è¿™ä¸ªä½¿ç”¨ç§˜ç¬ˆã€‚\næ”¯æŒ rake db:xxx å‘½ä»¤ åœ¨é rails é¡¹ç›®æ€ä¹ˆè®© rake æ”¯æŒ db:xxx å‘½ä»¤å‘¢ï¼ŸæŠŠå¦‚ä¸‹ä»£ç æ”¾åˆ° Rakefile ä¸­:\nnamespace :db do require 'activerecord' require 'yaml' desc \"åŠ è½½é¡¹ç›®è¡¨æ•°æ®åˆ°æ•°æ®åº“\" task :init =\u003e :dbenv do file = \"db/schema.rb\" load(file) # å‚è€ƒ rails æ–‡ä»¶ç»“æ„ end desc \"åˆ›å»ºæ•°æ®åº“åˆå§‹åŒ–æ•°æ®\" task :seed =\u003e :dbenv do seed_file = File.join(File.dirname(__FILE__), 'db', 'seeds.rb') load(seed_file) if File.exist?(seed_file) end desc \"åˆå¹¶ db/migrate ç›®å½•ä¸‹çš„æ•°æ®åº“æ–‡ä»¶\" task :migrate =\u003e :dbenv do ActiveRecord::Migration.verbose = ENV[\"VERBOSE\"] ? ENV[\"VERBOSE\"] == \"true\" : true ActiveRecord::Migrator.migrate(\"db/migrate/\", ENV[\"VERSION\"] ? ENV[\"VERSION\"].to_i : nil) Rake::Task[\"db:schema:dump\"].invoke if ActiveRecord::Base.schema_format == :ruby end desc 'è®¾å®š STEP=n å›æ»šä¹‹å‰ç‰ˆæœ¬çš„æ•°æ®åº“ç»“æ„' task :rollback =\u003e :dbenv do step = ENV['STEP'] ? ENV['STEP'].to_i : 1 ActiveRecord::Migrator.rollback('db/migrate/', step) Rake::Task[\"db:schema:dump\"].invoke if ActiveRecord::Base.schema_format == :ruby end task :dbenv do dbname = ENV['db'] || 'development' $dbconfig = YAML::load('db/database.yml') ActiveRecord::Base.establish_connection($dbconfig[dbname]) end namespace :schema do desc \"æŠŠæ•°æ®åº“ç»“æ„å†™å…¥ db/schema.rb æ–‡ä»¶\" task :dump =\u003e :dbenv do require 'active_record/schema_dumper' File.open(ENV['SCHEMA'] || \"db/schema.rb\", \"w\") do |file| ActiveRecord::SchemaDumper.dump(ActiveRecord::Base.connection, file) end end end end åˆå§‹åŒ–æ•°æ®åº“ç»“æ„\n$ rake db:init æ”¯æŒ SQL Server åªé’ˆå¯¹ *nix ç³»ç»Ÿï¼š\nå®‰è£… freetds * Mac OS: `brew install freetds` * CentOS: `yum install -y freetds` gem install tiny_tds gem install activerecord-sqlserver-adapter å¼•ç”¨å¦‚ä¸‹ï¼š\nrequire 'tiny_tds' require 'activerecord-sqlserver-adapter' require 'active_record' ActiveRecord::Base.establish_connection({ :adapter =\u003e 'sqlserver' :host =\u003e '10.10.10.10', :username =\u003e 'sa', :password =\u003e 'p@ssword', :database =\u003e 'development', :timeout =\u003e 10, :port =\u003e 1433, }) class Users \u003c ActiveRecord::Base self.table_name = 'User' default_scope { lock('WITH (NOLOCK)') } end å¤šæ•°æ®åº“æ”¯æŒ åˆ›å»º config/database.yml æ–‡ä»¶:\ndevelopment: adapter: mysql2 host: localhost username: root password: database: development timeout: 10 port: 3306 test: adapter: mysql2 host: 10.10.10.10 username: root password: p@ssword database: test timeout: 10 port: 1433 production: adapter: mysql2 host: 33.33.33.33 username: root password: p@ssword database: production åˆ›å»º lib/model.rb æ–‡ä»¶:\n$dbconfig = YAML::load(File::open('config/database.yml')) class User \u003c ActiveRecord::Base establish_connection $dbconfig['development'] end class Post \u003c ActiveRecord::Base establish_connection $dbconfig['test'] end class Tag \u003c ActiveRecord::Base establish_connection $dbconfig['production'] end åŠ¨æ€åˆ›å»ºè¡¨å å‡è‹¥æœ‰ä¸ªéœ€æ±‚éœ€è¦æŒ‰ç…§æ¯æœˆåˆ†è¡¨ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥å®‰è£…ä¸šåŠ¡åˆ†è¡¨ä»€ä¹ˆçš„ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢æ–¹å¼è°ƒç”¨ï¼š\n# æ’å…¥ postï¼Œå¦‚æœè¡¨ä¸å­˜åœ¨åˆ™åˆ›å»ºåæ’å…¥ post = Post.date('201312').get_or_create_table.create( title:'test', content:'body' ) # Model å®ç°ä»£ç  class Post \u003c ActiveRecord::Base @date = Time.now.strftime(\"%Y%02m\") def self.date(date) @date = date end def self.get_or_create_table(params={}) self.date(params[:date]) if params[:date] self.create_table(params) if !self.exists? end def self.create_table(params={}) self.date(params[:date]) if params[:date] table_name = self.table_name ActiveRecord::Schema.define do create_table table_name do |table| table.column :title, :string table.column :content, :text table.column :created_at, :datetime table.column :updated_at, :datetime end end return self end def self.table_exists? # å¦‚æœä½ è®¾ç½®äº†å¤šæ•°æ®åº“è¯·å–æ¶ˆä¸‹è¡Œæ³¨è§£å¹¶æ›´æ”¹é…ç½®åï¼ˆå‚è€ƒä¸Šä¸ªæŠ€å·§ï¼‰ # ActiveRecord::Base.establish_connection($dbconfig['development']) ActiveRecord::Base.connection.tables.include?(self.table_name) end def table_name \"#{@date_users}\" end end ","wordCount":"663","inLanguage":"zh-cn","datePublished":"2013-12-03T12:34:56+08:00","dateModified":"2013-12-03T12:34:56+08:00","author":{"@type":"Person","name":"icyleaf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://icyleaf.com/2013/12/activerecord-tips/"},"publisher":{"@type":"Organization","name":"icyleaf","logo":{"@type":"ImageObject","url":"https://icyleaf.com/favicon.ico"}}}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/series/homelab title>homelab ç³»åˆ—</a>
<a class=menu-item href=https://icyleaf.com/projects title>å¼€æºé¡¹ç›®</a>
<a class=menu-item href=https://icyleaf.com/about title>å…³äº</a>
<span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/series/homelab title><h3>homelab ç³»åˆ—</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>å¼€æºé¡¹ç›®</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/about title><h3>å…³äº</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop=description>ActiveRecord ä½¿ç”¨ç§˜ç¬ˆ</h1><div class=post-description>ä½œä¸º Rails ç”Ÿæ€ä¹‹ä¸€çš„ ORM ä¸€å®šè¦å¥½å¥½å­¦ä¹ </div><div class=post-meta><time datetime=2013-12-03 itemprop=datePublished>2013-12-03</time>
Â·
<span class=tags>Ruby, ActiveRecord, Rails</span>
Â·
<span class=post-word-count>663 words Â· 3 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>ç›®å½•</h2><div class="post-toc-content always-active"><nav id=TableOfContents></nav></div></div><div class=post-content><div id=post-gallery><p>ActiveRecord æ˜¯ Rails å†…ç½®çš„ ORM æ¡†æ¶ï¼Œå¤§å¤šæ•°äººå­¦ä¹  Ruby éƒ½æ˜¯ä» rails å¼€å§‹ï¼Œæ¥è§¦çš„ä¹Ÿæ˜¯è¿™ä¸ª ORMï¼Œå› æ­¤å°±æœ‰äº†è¿™ä¸ªä½¿ç”¨ç§˜ç¬ˆã€‚</p><h1 id=æ”¯æŒ-rake-dbxxx-å‘½ä»¤>æ”¯æŒ <code>rake db:xxx</code> å‘½ä»¤</h1><p>åœ¨é rails é¡¹ç›®æ€ä¹ˆè®© rake æ”¯æŒ db:xxx å‘½ä»¤å‘¢ï¼ŸæŠŠå¦‚ä¸‹ä»£ç æ”¾åˆ° <code>Rakefile</code> ä¸­:</p><pre tabindex=0><code>namespace :db do
  require &#39;activerecord&#39;
  require &#39;yaml&#39;

  desc &#34;åŠ è½½é¡¹ç›®è¡¨æ•°æ®åˆ°æ•°æ®åº“&#34;
  task :init =&gt; :dbenv do
    file = &#34;db/schema.rb&#34;
    load(file) # å‚è€ƒ rails æ–‡ä»¶ç»“æ„
  end

  desc &#34;åˆ›å»ºæ•°æ®åº“åˆå§‹åŒ–æ•°æ®&#34;
  task :seed =&gt; :dbenv do
    seed_file = File.join(File.dirname(__FILE__), &#39;db&#39;, &#39;seeds.rb&#39;)
    load(seed_file) if File.exist?(seed_file)
  end

  desc &#34;åˆå¹¶ db/migrate ç›®å½•ä¸‹çš„æ•°æ®åº“æ–‡ä»¶&#34;
  task :migrate =&gt; :dbenv do
    ActiveRecord::Migration.verbose = ENV[&#34;VERBOSE&#34;] ? ENV[&#34;VERBOSE&#34;] == &#34;true&#34; : true
    ActiveRecord::Migrator.migrate(&#34;db/migrate/&#34;, ENV[&#34;VERSION&#34;] ? ENV[&#34;VERSION&#34;].to_i : nil)
    Rake::Task[&#34;db:schema:dump&#34;].invoke if ActiveRecord::Base.schema_format == :ruby
  end

  desc &#39;è®¾å®š STEP=n å›æ»šä¹‹å‰ç‰ˆæœ¬çš„æ•°æ®åº“ç»“æ„&#39;
  task :rollback =&gt; :dbenv do
    step = ENV[&#39;STEP&#39;] ? ENV[&#39;STEP&#39;].to_i : 1
    ActiveRecord::Migrator.rollback(&#39;db/migrate/&#39;, step)
    Rake::Task[&#34;db:schema:dump&#34;].invoke if ActiveRecord::Base.schema_format == :ruby
  end

  task :dbenv do
    dbname = ENV[&#39;db&#39;] || &#39;development&#39;
  	$dbconfig = YAML::load(&#39;db/database.yml&#39;)
    ActiveRecord::Base.establish_connection($dbconfig[dbname])
  end

  namespace :schema do
    desc &#34;æŠŠæ•°æ®åº“ç»“æ„å†™å…¥ db/schema.rb æ–‡ä»¶&#34;
    task :dump =&gt; :dbenv do
      require &#39;active_record/schema_dumper&#39;
      File.open(ENV[&#39;SCHEMA&#39;] || &#34;db/schema.rb&#34;, &#34;w&#34;) do |file|
        ActiveRecord::SchemaDumper.dump(ActiveRecord::Base.connection, file)
      end
    end
  end
end
</code></pre><p>åˆå§‹åŒ–æ•°æ®åº“ç»“æ„</p><pre tabindex=0><code>$ rake db:init
</code></pre><h1 id=æ”¯æŒ-sql-server>æ”¯æŒ SQL Server</h1><p>åªé’ˆå¯¹ *nix ç³»ç»Ÿï¼š</p><ol><li>å®‰è£… freetds</li></ol><pre tabindex=0><code>* Mac OS: `brew install freetds`
* CentOS: `yum install -y freetds`
</code></pre><ol start=2><li><code>gem install tiny_tds</code></li><li><code>gem install activerecord-sqlserver-adapter</code></li></ol><p>å¼•ç”¨å¦‚ä¸‹ï¼š</p><pre tabindex=0><code>require &#39;tiny_tds&#39;
require &#39;activerecord-sqlserver-adapter&#39;
require &#39;active_record&#39;

ActiveRecord::Base.establish_connection({
  :adapter =&gt; &#39;sqlserver&#39;
 :host =&gt; &#39;10.10.10.10&#39;,
 :username =&gt; &#39;sa&#39;,
  :password =&gt; &#39;p@ssword&#39;,
  :database =&gt; &#39;development&#39;,
  :timeout =&gt; 10,
  :port =&gt; 1433,
})

class Users &lt; ActiveRecord::Base
	self.table_name = &#39;User&#39;
	default_scope { lock(&#39;WITH (NOLOCK)&#39;) }
end
</code></pre><h1 id=å¤šæ•°æ®åº“æ”¯æŒ>å¤šæ•°æ®åº“æ”¯æŒ</h1><p>åˆ›å»º <code>config/database.yml</code> æ–‡ä»¶:</p><pre tabindex=0><code>development:
  adapter: mysql2
  host: localhost
  username: root
  password:
  database: development
  timeout: 10
  port: 3306
test:
  adapter: mysql2
  host: 10.10.10.10
  username: root
  password: p@ssword
  database: test
  timeout: 10
  port: 1433
production:
  adapter: mysql2
  host: 33.33.33.33
  username: root
  password: p@ssword
  database: production
</code></pre><p>åˆ›å»º <code>lib/model.rb</code> æ–‡ä»¶:</p><pre tabindex=0><code>$dbconfig = YAML::load(File::open(&#39;config/database.yml&#39;))

class User &lt; ActiveRecord::Base
  establish_connection $dbconfig[&#39;development&#39;]
end

class Post &lt; ActiveRecord::Base
  establish_connection $dbconfig[&#39;test&#39;]
end

class Tag &lt; ActiveRecord::Base
  establish_connection $dbconfig[&#39;production&#39;]
end
</code></pre><h1 id=åŠ¨æ€åˆ›å»ºè¡¨å>åŠ¨æ€åˆ›å»ºè¡¨å</h1><p>å‡è‹¥æœ‰ä¸ªéœ€æ±‚éœ€è¦æŒ‰ç…§æ¯æœˆåˆ†è¡¨ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥å®‰è£…ä¸šåŠ¡åˆ†è¡¨ä»€ä¹ˆçš„ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢æ–¹å¼è°ƒç”¨ï¼š</p><pre tabindex=0><code># æ’å…¥ postï¼Œå¦‚æœè¡¨ä¸å­˜åœ¨åˆ™åˆ›å»ºåæ’å…¥
post = Post.date(&#39;201312&#39;).get_or_create_table.create(
  title:&#39;test&#39;,
  content:&#39;body&#39;
)

# Model å®ç°ä»£ç 
class Post &lt; ActiveRecord::Base
  @date = Time.now.strftime(&#34;%Y%02m&#34;)

  def self.date(date)
  	@date = date
  end

  def self.get_or_create_table(params={})
    self.date(params[:date]) if params[:date]
    self.create_table(params) if !self.exists?
  end

  def self.create_table(params={})
    self.date(params[:date]) if params[:date]
    table_name = self.table_name
    ActiveRecord::Schema.define do
      create_table table_name do |table|
        table.column :title, :string
        table.column :content, :text
        table.column :created_at, :datetime
        table.column :updated_at, :datetime
      end
    end

    return self
  end

  def self.table_exists?
    # å¦‚æœä½ è®¾ç½®äº†å¤šæ•°æ®åº“è¯·å–æ¶ˆä¸‹è¡Œæ³¨è§£å¹¶æ›´æ”¹é…ç½®åï¼ˆå‚è€ƒä¸Šä¸ªæŠ€å·§ï¼‰
    # ActiveRecord::Base.establish_connection($dbconfig[&#39;development&#39;])

    ActiveRecord::Base.connection.tables.include?(self.table_name)
  end

  def table_name
    &#34;#{@date_users}&#34;
  end
end
</code></pre></div></div><div class=post-nav><a href=https://icyleaf.com/2013/10/about-pager-on-git/ class=prev rel=prev title="Git å’Œ Pager çš„é‚£ç‚¹äº‹"><i class="iconfont icon-left"></i>&nbsp;Git å’Œ Pager çš„é‚£ç‚¹äº‹</a>
<a href=https://icyleaf.com/2013/12/learning-ansible-and-vagrant/ class=next rel=next title="å­¦ä¹  Ansible + Vagrant">å­¦ä¹  Ansible + Vagrant&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><script>var getTheme=window.localStorage&&window.localStorage.getItem("blog-dark-mode"),getTheme=getTheme??"github-light";let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","icyleaf/icyleaf.com"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.post-comment").innerHTML="",document.querySelector("div.post-comment").appendChild(s)</script></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2023</span>
<span>ğŸº</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script defer src=https://fastly.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script>
<script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: () => import('\/photoswipe\/photoswipe.esm.js'),
  });
  lightbox.init();
</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TKQBZ7R259"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TKQBZ7R259")</script></div></body></html>