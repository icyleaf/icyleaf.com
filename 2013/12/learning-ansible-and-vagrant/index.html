<!doctype html><html lang=zh-cn></html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>学习 Ansible + Vagrant | icyleaf</title><meta name=keywords content="Vagrant,Ruby"><meta name=description content="Vagrant 可能会让人忘记但你不应该不学 Ansible"><meta name=author content="icyleaf"><link rel=canonical href=https://icyleaf.com/2013/12/learning-ansible-and-vagrant/><link rel=icon href=https://icyleaf.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://icyleaf.com/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=https://icyleaf.com/android-chrome-512x512.png><link rel=apple-touch-icon href=https://icyleaf.com/apple-touch-icon.png><link rel=mask-icon href=https://icyleaf.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.min.css><link rel=canonical href=https://icyleaf.com/2013/12/learning-ansible-and-vagrant/><meta property="og:title" content="学习 Ansible + Vagrant"><meta property="og:description" content="Vagrant 可能会让人忘记但你不应该不学 Ansible"><meta property="og:type" content="article"><meta property="og:url" content="https://icyleaf.com/2013/12/learning-ansible-and-vagrant/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-12-21T12:34:56+08:00"><meta property="article:modified_time" content="2013-12-21T12:34:56+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="学习 Ansible + Vagrant"><meta name=twitter:description content="Vagrant 可能会让人忘记但你不应该不学 Ansible"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://icyleaf.com/posts/"},{"@type":"ListItem","position":2,"name":"学习 Ansible + Vagrant","item":"https://icyleaf.com/2013/12/learning-ansible-and-vagrant/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"学习 Ansible + Vagrant","name":"学习 Ansible \u002b Vagrant","description":"Vagrant 可能会让人忘记但你不应该不学 Ansible","keywords":["Vagrant","Ruby"],"articleBody":" Ansible is a radically simple IT orchestration engine that makes your applications and systems easier to deploy. Avoid writing scripts or custom code to deploy and update your applications— automate in a language that approaches plain English, using SSH, with no agents to install on remote systems.\n简单来说 Ansible 是一个极简化的应用和系统部署工具，类似 Puppet、Chef、SaltStack。由于默认使用 ssh 管理服务器（集群），配置文件采用 yaml 而不是某一种特定语言制定。方便至极。\n很多人说 salt 也很用的，为什么不考虑呢，我个人觉得，ansible 的配置文件编写起来比较方便，不需要使用 jinja2 模板引擎适合非 python 用户管理。而且我也较同意 “Ansible and Salt: A detailed comparison” 文章的评测。\n由于个人之前没用过任何其他工具，至于你想知道上面哪些之间有什么区别的话，参见此文：Review: Puppet vs. Chef vs. Ansible vs. Salt 或 “开始使用配置和发布管理” 一文中也有提到其特性。\n安装 大家移步 LinuxToy 的 Ansible 快速上手 一文，以及 使用Vagrant練習環境佈署 作为学习铺垫，我就不再多写。这里我想重点介绍下 Ansible + Vagrant 配合使用技巧。\n其实上面 “使用Vagrant練習環境佈署” 提到的配置文件是 Vagrantfile config version = 1 时候的，当前 vagrant 版本是 1.4.1， Vagrantfile config version = 2，因此配置的部分已经有所变动。大家需要做下更新。\n如果你使用的是 Vagrant 1.4.0+，工具已经完全集成了上述的 DevOps 工具（甚至 Docker，另外一神器，后续看看能否给个介绍）。默认配置文件只包含了 Puppet 和 Chef，大家需要看官方文档。\n如果你是 Mac OS 用户，可以通过 brew 和 brew-cask 命令安装：\n$ brew update $ brew install ansible $ brew cask install vagrant 创建 Vagrant 实例 首先创建学习目录(~/src/learn_ansible)和一个实例，采用 CentOS 6.5 x64 系统：\n$ vagrant init centos65 https://github.com/2creatives/vagrant-centos/releases/download/v6.5.1/centos65-x86_64-20131205.box 下载完毕之后，编辑 Vagrantfile 添加如下内容：\nconfig.vm.network :private_network, ip: \"33.33.33.10\" config.vm.provision :ansible do |ansible| ansible.inventory_path = \"ansbile/hosts\" ansible.playbook = \"ansbile/playbook.yml\" # 默认使用 sudo 权限 ansible.sudo = true # 开启调试信息模式 ansible.verbose = 'vvv' end 并在学习目录创建 ansible 目录以及下面两个文件，结构如下：\n$ tree . ├── Vagrantfile └── ansible ├── hosts └── playbook.yml 1 directory, 3 files `hosts` 文件内容，ip 地址和上面 `Vagrantfile` 设置的一致： [webserver] 33.33.33.10\n`playbook.yml` 文件内容： ansbile 的配置文件，这里指定只作用于 webserver 服务器 使用 vagrant 的 sudu 权限执行任务 hosts: webserver user: vagrant sudo: yes tasks: 任务只有一个，就是安装 nginx name: Install Nginx yum: name=nginx state=present # 连接 \u0026 部署 使用 Vagrant 的好处在于，它集成了这些工具，并通过 `vagrant provision` 这个命令就能连接服务器并部署。这里我想让大家学习到如何通过传统 ssh 链接 vagrant 虚拟机的方法： 从上面的配置文件我们得知，服务器的 ip 是 `33.33.33.10` 而且默认登录到虚拟机上的用户是 vagrant（密码也是用户名），链接端口是 22。我们先拷贝 ssh public key 到服务器上： $ ssh-copy-id vagrant@33.33.33.10\n完成之后，我们就可以通过下面命令测试是否配置成功： $ ansible -u vagrant -i ansible/hosts all -m ping\nwebserver | success » { “changed”: false, “ping”: “pong” }\n返回 `ping: pong` 即为连接成功并可以进行部署。若你之前执行了 `vagrant provision` 就会自动执行 `playbook.yml` 的内容。 今天初探就到此结束，希望通过本篇文字大家对它有个大概的了解。 ","wordCount":"1096","inLanguage":"zh-cn","datePublished":"2013-12-21T12:34:56+08:00","dateModified":"2013-12-21T12:34:56+08:00","author":{"@type":"Person","name":"icyleaf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://icyleaf.com/2013/12/learning-ansible-and-vagrant/"},"publisher":{"@type":"Organization","name":"icyleaf","logo":{"@type":"ImageObject","url":"https://icyleaf.com/favicon.ico"}}}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/series/homelab title>homelab 系列</a>
<a class=menu-item href=https://icyleaf.com/projects title>开源项目</a>
<a class=menu-item href=https://icyleaf.com/gears title>我的设备</a>
<a class=menu-item href=https://icyleaf.com/about title>关于</a>
<span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/series/homelab title><h3>homelab 系列</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>开源项目</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/gears title><h3>我的设备</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/about title><h3>关于</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop=description>学习 Ansible + Vagrant</h1><div class=post-description>Vagrant 可能会让人忘记但你不应该不学 Ansible</div><div class=post-meta><time datetime=2013-12-21 itemprop=datePublished>2013-12-21</time>
·
<span class=tags>Vagrant, Ruby</span>
·
<span class=post-word-count>1096 words · 4 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents></nav></div></div><div class=post-content><div id=post-gallery><blockquote><p>Ansible is a radically simple IT orchestration engine that makes your applications and systems easier to deploy. Avoid writing scripts or custom code to deploy and update your applications— automate in a language that approaches plain English, using SSH, with no agents to install on remote systems.</p></blockquote><p>简单来说 <a href=https://github.com/ansible/ansible>Ansible</a> 是一个极简化的应用和系统部署工具，类似 <a href=https://github.com/puppetlabs/puppet>Puppet</a>、<a href=https://github.com/opscode/chef>Chef</a>、<a href=https://github.com/saltstack/salt>SaltStack</a>。由于默认使用 <code>ssh</code> 管理服务器（集群），配置文件采用 yaml 而不是某一种特定语言制定。方便至极。</p><p>很多人说 salt 也很用的，为什么不考虑呢，我个人觉得，ansible 的配置文件编写起来比较方便，不需要使用 <a href=http://jinja.pocoo.org/>jinja2</a> 模板引擎适合非 <code>python</code> 用户管理。而且我也较同意 &ldquo;<a href=http://missingm.co/2013/06/ansible-and-salt-a-detailed-comparison/>Ansible and Salt: A detailed comparison</a>&rdquo; 文章的评测。</p><p>由于个人之前没用过任何其他工具，至于你想知道上面哪些之间有什么区别的话，参见此文：<a href="http://www.infoworld.com/d/data-center/review-puppet-vs-chef-vs-ansible-vs-salt-231308?page=0,0">Review: Puppet vs. Chef vs. Ansible vs. Salt</a> 或 &ldquo;<a href=http://ttyn.me/2013/02/19/ansible_intro.html>开始使用配置和发布管理</a>&rdquo; 一文中也有提到其特性。</p><h1 id=安装>安装</h1><p>大家移步 LinuxToy 的 <a href=https://linuxtoy.org/archives/hands-on-with-ansible.html>Ansible 快速上手</a> 一文，以及 <a href=http://gogojimmy.net/2013/05/26/vagrant-tutorial/>使用Vagrant練習環境佈署</a> 作为学习铺垫，我就不再多写。这里我想重点介绍下 Ansible + Vagrant 配合使用技巧。</p><blockquote><p>其实上面 &ldquo;使用Vagrant練習環境佈署&rdquo; 提到的配置文件是 Vagrantfile config version = 1 时候的，当前 vagrant 版本是 1.4.1， Vagrantfile config version = 2，因此配置的部分已经有所变动。大家需要做下更新。</p></blockquote><p>如果你使用的是 Vagrant 1.4.0+，工具已经完全集成了上述的 DevOps 工具（甚至 Docker，另外一神器，后续看看能否给个介绍）。默认配置文件只包含了 Puppet 和 Chef，大家需要看<a href=http://docs.vagrantup.com/v2/provisioning/index.html>官方文档</a>。</p><p>如果你是 Mac OS 用户，可以通过 <code>brew</code> 和 <code>brew-cask</code> 命令安装：</p><pre tabindex=0><code>$ brew update
$ brew install ansible
$ brew cask install vagrant
</code></pre><h1 id=创建-vagrant-实例>创建 Vagrant 实例</h1><p>首先创建学习目录(<code>~/src/learn_ansible</code>)和一个实例，采用 CentOS 6.5 x64 系统：</p><pre tabindex=0><code>$ vagrant init centos65 https://github.com/2creatives/vagrant-centos/releases/download/v6.5.1/centos65-x86_64-20131205.box
</code></pre><p>下载完毕之后，编辑 <code>Vagrantfile</code> 添加如下内容：</p><pre tabindex=0><code>config.vm.network :private_network, ip: &#34;33.33.33.10&#34;
config.vm.provision :ansible do |ansible|

ansible.inventory_path = &#34;ansbile/hosts&#34;
	ansible.playbook = &#34;ansbile/playbook.yml&#34;

	# 默认使用 sudo 权限
	ansible.sudo = true
	# 开启调试信息模式
	ansible.verbose = &#39;vvv&#39;
end
</code></pre><p>并在学习目录创建 <code>ansible</code> 目录以及下面两个文件，结构如下：</p><pre tabindex=0><code>$ tree
.
├── Vagrantfile
└── ansible
    ├── hosts
    └── playbook.yml
1 directory, 3 files

`hosts` 文件内容，ip 地址和上面 `Vagrantfile` 设置的一致：
</code></pre><p>[webserver]
33.33.33.10</p><pre tabindex=0><code>
`playbook.yml` 文件内容：
</code></pre><hr><h1 id=ansbile-的配置文件这里指定只作用于-webserver-服务器>ansbile 的配置文件，这里指定只作用于 webserver 服务器</h1><h1 id=使用-vagrant-的-sudu-权限执行任务>使用 vagrant 的 sudu 权限执行任务</h1><ul><li>hosts: webserver
user: vagrant
sudo: yes
tasks:<h1 id=任务只有一个就是安装-nginx>任务只有一个，就是安装 nginx</h1><ul><li>name: Install Nginx
yum: name=nginx state=present</li></ul></li></ul><pre tabindex=0><code>

# 连接 &amp; 部署

使用 Vagrant 的好处在于，它集成了这些工具，并通过 `vagrant provision` 这个命令就能连接服务器并部署。这里我想让大家学习到如何通过传统 ssh 链接 vagrant 虚拟机的方法：

从上面的配置文件我们得知，服务器的 ip 是 `33.33.33.10` 而且默认登录到虚拟机上的用户是 vagrant（密码也是用户名），链接端口是 22。我们先拷贝 ssh public key 到服务器上：
</code></pre><p>$ ssh-copy-id <a href=mailto:vagrant@33.33.33.10>vagrant@33.33.33.10</a></p><pre tabindex=0><code>
完成之后，我们就可以通过下面命令测试是否配置成功：
</code></pre><p>$ ansible -u vagrant -i ansible/hosts all -m ping</p><p>webserver | success &#187; {
&ldquo;changed&rdquo;: false,
&ldquo;ping&rdquo;: &ldquo;pong&rdquo;
}</p><pre tabindex=0><code>
返回 `ping: pong` 即为连接成功并可以进行部署。若你之前执行了 `vagrant provision` 就会自动执行 `playbook.yml` 的内容。


今天初探就到此结束，希望通过本篇文字大家对它有个大概的了解。
</code></pre><div class=post-donate><p class=post-donate-title>如果你觉得我的文章对你有帮助，欢迎打赏，这对我非常重要，谢谢！</p><div class=post-donate-channel><img src=https://icyleaf.com/images/donate/alipay.png alt=支付宝打赏>
<img src=https://icyleaf.com/images/donate/wechat.png alt=微信打赏></div></div></div></div><div class=post-nav><a href=https://icyleaf.com/2013/12/activerecord-tips/ class=prev rel=prev title="ActiveRecord 使用秘笈"><i class="iconfont icon-left"></i>&nbsp;ActiveRecord 使用秘笈</a>
<a href=https://icyleaf.com/2013/12/2013-in-review/ class=next rel=next title="2013 年终总结">2013 年终总结&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><script>var getTheme=window.localStorage&&window.localStorage.getItem("blog-dark-mode"),getTheme=getTheme??"github-light";let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","icyleaf/icyleaf.com"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.post-comment").innerHTML="",document.querySelector("div.post-comment").appendChild(s)</script></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2024</span>
<span>🍺</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script defer src=https://fastly.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script>
<script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: () => import('\/photoswipe\/photoswipe.esm.js'),
  });
  lightbox.init();
</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TKQBZ7R259"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TKQBZ7R259")</script></div></body></html>