<!doctype html><html lang=zh-cn></html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>如何在 CentOS 上安装 Gitlab | icyleaf</title><meta name=keywords content="Linux,CentOS,Git"><meta name=description content="Barl Metal 安装服务依赖还是很痛苦的，CentOS 上是痛苦面具"><meta name=author content="icyleaf"><link rel=canonical href=https://icyleaf.com/2013/09/how-to-install-gitlab-on-centos/><link rel=icon href=https://icyleaf.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://icyleaf.com/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=https://icyleaf.com/android-chrome-512x512.png><link rel=apple-touch-icon href=https://icyleaf.com/apple-touch-icon.png><link rel=mask-icon href=https://icyleaf.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.min.css><link rel=canonical href=https://icyleaf.com/2013/09/how-to-install-gitlab-on-centos/><meta property="og:title" content="如何在 CentOS 上安装 Gitlab"><meta property="og:description" content="Barl Metal 安装服务依赖还是很痛苦的，CentOS 上是痛苦面具"><meta property="og:type" content="article"><meta property="og:url" content="https://icyleaf.com/2013/09/how-to-install-gitlab-on-centos/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-09-17T12:34:56+08:00"><meta property="article:modified_time" content="2013-09-17T12:34:56+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="如何在 CentOS 上安装 Gitlab"><meta name=twitter:description content="Barl Metal 安装服务依赖还是很痛苦的，CentOS 上是痛苦面具"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://icyleaf.com/posts/"},{"@type":"ListItem","position":2,"name":"如何在 CentOS 上安装 Gitlab","item":"https://icyleaf.com/2013/09/how-to-install-gitlab-on-centos/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"如何在 CentOS 上安装 Gitlab","name":"如何在 CentOS 上安装 Gitlab","description":"Barl Metal 安装服务依赖还是很痛苦的，CentOS 上是痛苦面具","keywords":["Linux","CentOS","Git"],"articleBody":"2013 年 08 月的 OpenParty “花事如期” 活动上，晓东在他的机器上演示了自建 Gitlab 的项目，看到 Gitlab 目前已经比较成熟，而不像早期寒碜的界面，这个时候看安装一下也是不错的事情，不过他们的项目文档只提供了 Ubuntu 系统的安装文档，对于 CentOS 没有提到，非官方的文档有比较老久，凭着之前熟悉 Ubuntu 和学习 CentOS，那就开始安装吧：\n以下教程在 CentOS 6 x86_64 版本下操作。\n首先安装 EPEL 和编译依赖库 $ rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm 如果你是非 64 位，去上面的网址找到适合你发行版的最新版本的 epel rpm\n$ yum -y update $ yum -y install gcc gcc-c++ make autoconf libyaml-devel gdbm-devel ncurses-devel openssl-devel zlib-devel readline-devel curl-devel expat-devel gettext-devel tk-devel libxml2-devel libffi-devel libxslt-devel libicu-devel sendmail patch libyaml* pcre-devel sqlite-devel vim 安装 Python 2.7+ Gitlab 要求 Python 2.5.5+ 以及 Ruby 1.9+\n系统 Python 默认是 2.6.x，如果你想把 Python 升级到目前比较流行的 2.7.x 就参照下面步骤，否则直接跳过。（Gitlab 目前不支持 Python 3.0）\n$ mkdir /tmp/gitlab \u0026\u0026 cd /tmp/gitlab $ curl --progress http://python.org/ftp/python/2.7.5/Python-2.7.5.tgz | tar xvf $ cd Python-2.7.5 $ ./configure --prefix=/usr/local $ make \u0026\u0026 make altinstall 安装好之后，需要做两件事情，替换默认 python 的版本至最新版本，\n$ sudo ln -s /usr/local/bin/python2.7 /usr/local/bin/python 因为系统默认 PATH 的寻址路径是 /usr/local/bin\n最后看下 Python 版本是否是刚刚安装的版本：\n$ python --version 由于 yum 是 python 的一个 module，所以这块修改可能会引起无法调用 yum 脚本，所以需要修改这个文件 /usr/bin/yum 的第一行为 !#/usr/bin/python2.6\n安装 Ruby 2.0 Ruby 1.9 和 2.0 的特性差别不大，索性升级至最新 2.0 版本即可\n$ cd /tmp/gitlab $ curl --progress http://cache.ruby-lang.org/pub/ruby/2.0/ruby-2.0.0-p247.tar.gz | tar xz $ cd ruby-2.0.0-p247 $ ./configure $ make $ make install ruby 2.0 已经内置 gem (v2.0.3)，只需要安装 bundler\n$ gem install bundler 若在执行 sudo ruby 或 sudo gem 找不到命令，因为编译的路径配置到了 /usr/local/bin，我们只需要做下软链接到 root 用户可以找到的 $PATH 路径：\n$ ln -s /usr/local/bin/ruby /usr/bin/ruby $ ln -s /usr/local/bin/gem /usr/bin/gem $ ln -s /usr/local/bin/bundle /usr/bin/bundle 安装 Git 和 Gitolite $ yum -y install git-all gitolite 安装 Nginx $ yum -y install nginx $ service nginx start nginx 需要从 EPEL 中安装，默认系统没有 nginx 包。\n安装 Mysql 和 Redis Gitlab 要求强制安装 redis 处理一些数据，另外支持 MySQL 和 PostgreSQL，这里主要以 MySQL 为例\n$ yum -y install mysql mysql-devel mysql-server redis 配置 Mysql 和 gitlab 需要的用户和数据库\n$ service mysqld start $ mysql -u root $ mysql\u003e CREATE USER 'gitlab'@'localhost' IDENTIFIED BY 'gitlab'; $ mysql\u003e CREATE DATABASE IF NOT EXISTS `gitlabhq_production` DEFAULT CHARACTER SET `utf8` COLLATE `utf8_unicode_ci`; $ mysql\u003e GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON `gitlabhq_production`.* TO 'gitlab'@'localhost'; $ mysql\u003e \\q Redis 使用默认配置即可，直接启动\n$ service redis start 添加 Gitlab 用户 $ useradd -c 'GitLab' git CentOS 的命令没有办法直接禁止用户的访问的参数，需要用下面命令：\n$ passwd -l git 安装 Gitlab-shell 使用 root 账户切换到 git 账户下操作，可以比官方教程省去一些麻烦的输入\n$ su git \u0026\u0026 cd /home/git $ git clone https://github.com/gitlabhq/gitlab-shell.git $ cd gitlab-shell 通过 git tag 查看最新版本并切换之\n$ git checkout v1.7.1 编辑配置文件修改你要设定的域名（domain），比如 http://gitlab.dev/\n$ vim config.yml 完成之后执行安装脚本\n$ ./bin/install 安装 Gitlab $ cd /home/git $ git clone https://github.com/gitlabhq/gitlabhq.git gitlab $ cd /home/git/gitlab 通过 git tag 查看最新版本并切换之\n$ git checkout 6.0.1 这里需要配置的东西多一些，这里参考官方的文档，也可以安装我下面的步骤来：\n$ cd /home/git/gitlab 复制配置文件，修改 host 相关的配置项，主要是 domain 要和上面的 http://gitlab.dev\n$ cp config.yml{.example,} $ vim config/gitlab.yml 确认 gitlab 以下目录的权限是否正确\n$ mkdir tmp/pids/ $ mkdir tmp/sockets/ $ chown -R git log/ $ chown -R git tmp/ $ chmod -R u+rwX log/ $ chmod -R u+rwX tmp/ $ chmod -R u+rwX tmp/pids/ $ chmod -R u+rwX tmp/sockets/ 创建 satellites 目录，这个目录是保存各个用户的仓库\n$ mkdir /home/git/gitlab-satellites 创建 uploads 目录（为什么 gitlab 不在项目中创建呢= =！）\n$ mkdir public/uploads $ chmod -R u+rwX public/uploads 复制 unicorn 配置文件\n$ cp config/unicorn.rb{.example,} 设置 ruby web 容器的参数，比如 2GB RAM 服务器可以设置 3 个 worker。\n如果系统其他服务占用了 unicorn 的端口，记得改名。\n$ vim config/unicorn.rb 设置一些 git 全局参数\n$ git config --global user.name \"GitLab\" $ git config --global user.email \"gitlab@localhost\" $ git config --global core.autocrlf input 配置 gitlab 数据库设置\n$ cp config/database.yml{.mysql,} $ vim config/database.yml $ chmod o-rwx config/database.yml 安装必需的 Ruby Gems\n$ cd /home/git/gitlab $ [sudo] gem install charlock_holmes --version '0.6.9.4' $ bundle install --deployment --without development test postgres aws 初始化数据库数据（执行输入 Yes 继续创建）\n$ bundle exec rake gitlab:setup RAILS_ENV=production 设置 init 脚本\n$ sudo cp lib/support/init.d/gitlab /etc/init.d/gitlab $ sudo chmod +x /etc/init.d/gitlab 检查 Gitlab 状态 $ bundle exec rake gitlab:env:info RAILS_ENV=production 启动 gitlab 服务\n$ sudo service gitlab start 再起检查，保证所有项目都是绿色\n$ bundle exec rake gitlab:check RAILS_ENV=production 配置 nginx 根据 nginx 的安装路径适当修改下面的路径即可，我们先把 gitlab 提供的配置文件拷贝过去\n$ sudo mkdir -p /etc/nginx/conf/sites/ $ sudo cp lib/support/nginx/gitlab /etc/nginx/conf/sites/gitlab.conf 根据 nginx 版本和不同发行版的不同，配置结构可能不同根据你的实际情况加载 gitlab.conf\n修改 gitlab.conf 的 YOUR_SERVER_FQDN 为上面设置的 domain。 最后修改 nginx.conf 或者 default.conf 加载 /etc/nginx/conf/site 下所有 conf 文件\nhttp { include /etc/nginx/conf/site/*.conf; server { … } } 保存后，重启各个服务\n$ sudo service nginx reload $ sudo service gitlab restart 开始 Gitlab 之旅 配置好 hosts 即可访问 gitlab.dev\n$ echo \"127.0.0.1 gitlab.dev\" \u003e\u003e /etc/hosts 默认的用户名密码：\nadmin@local.host 5iveL!fe 各种坑 1. 错误日志报权限错误 2013/11/07 00:42:21 [crit] 15875#0: *2 stat() \"/home/git/gitlab/public/favicon.ico.html\" failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: \"GET /favicon.ico HTTP/1.1\", host: \"gitlab.web.lo\" 2013/11/07 00:42:21 [crit] 15875#0: *2 connect() to unix:/home/git/gitlab/tmp/sockets/gitlab.socket failed (13: Permission denied) while connecting to upstream, client: 33.33.33.1, server: gitlab.web.lo, request: \"GET /favicon.ico HTTP/1.1\", upstream: \"http://unix:/home/git/gitlab/tmp/sockets/gitlab.socket:/favicon.ico\", host: \"gitlab.web.lo\" 2013/11/07 00:42:31 [crit] 15875#0: *2 stat() \"/home/git/gitlab/public/\" failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: \"GET / HTTP/1.1\", host: \"gitlab.web.lo\" 2013/11/07 00:42:31 [crit] 15875#0: *2 stat() \"/home/git/gitlab/public//index.html\" failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: \"GET / HTTP/1.1\", host: \"gitlab.web.lo\" 2013/11/07 00:42:31 [crit] 15875#0: *2 stat() \"/home/git/gitlab/public/.html\" failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: \"GET / HTTP/1.1\", host: \"gitlab.web.lo\" 2013/11/07 00:42:31 [crit] 15875#0: *2 connect() to unix:/home/git/gitlab/tmp/sockets/gitlab.socket failed (13: Permission denied) while connecting to upstream, client: 33.33.33.1, server: gitlab.web.lo, request: \"GET / HTTP/1.1\", upstream: \"http://unix:/home/git/gitlab/tmp/sockets/gitlab.socket:/\", host: \"gitlab.web.lo\" 2013/11/07 00:42:31 [crit] 15875#0: *2 stat() \"/home/git/gitlab/public/favicon.ico\" failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: \"GET /favicon.ico HTTP/1.1\", host: \"gitlab.web.lo\" 2013/11/07 00:42:31 [crit] 15875#0: *2 stat() \"/home/git/gitlab/public/favicon.ico/index.html\" failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: \"GET /favicon.ico HTTP/1.1\", host: \"gitlab.web.lo\" 2013/11/07 00:42:31 [crit] 15875#0: *2 stat() \"/home/git/gitlab/public/favicon.ico.html\" failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: \"GET /favicon.ico HTTP/1.1\", host: \"gitlab.web.lo\" 2013/11/07 00:42:31 [crit] 15875#0: *2 connect() to unix:/home/git/gitlab/tmp/sockets/gitlab.socket failed (13: Permission denied) while connecting to upstream, client: 33.33.33.1, server: gitlab.web.lo, request: \"GET /favicon.ico HTTP/1.1\", upstream: \"http://unix:/home/git/gitlab/tmp/sockets/gitlab.socket:/favicon.ico\", host: \"gitlab.web.lo\" 解决方案:\n$ (sudo) chmod o+x /home/git 2. 8080 端口被占用 这样主要是因为 nginx 的配置是做 unicorn 的代理转发，实际上 gitlab 是由 unicorn 容器驱动，而在配置里默认绑定的是 8080 端口\n$ vim /home/git/gitlab/config/unicorn.rb 找到 listen \"127.0.0.1:8080\", :tcp_nopush =\u003e true 修改成其他未占用的端口号即可。\n","wordCount":"1873","inLanguage":"zh-cn","datePublished":"2013-09-17T12:34:56+08:00","dateModified":"2013-09-17T12:34:56+08:00","author":{"@type":"Person","name":"icyleaf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://icyleaf.com/2013/09/how-to-install-gitlab-on-centos/"},"publisher":{"@type":"Organization","name":"icyleaf","logo":{"@type":"ImageObject","url":"https://icyleaf.com/favicon.ico"}}}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/series/homelab title>homelab 系列</a>
<a class=menu-item href=https://icyleaf.com/projects title>开源项目</a>
<a class=menu-item href=https://icyleaf.com/gears title>我的设备</a>
<a class=menu-item href=https://icyleaf.com/about title>关于</a>
<span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/series/homelab title><h3>homelab 系列</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>开源项目</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/gears title><h3>我的设备</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/about title><h3>关于</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop=description>如何在 CentOS 上安装 Gitlab</h1><div class=post-description>Barl Metal 安装服务依赖还是很痛苦的，CentOS 上是痛苦面具</div><div class=post-meta><time datetime=2013-09-17 itemprop=datePublished>2013-09-17</time>
·
<span class=tags>Linux, CentOS, Git</span>
·
<span class=post-word-count>1873 words · 8 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#首先安装-epel-和编译依赖库>首先安装 EPEL 和编译依赖库</a></li><li><a href=#安装-python-27>安装 Python 2.7+</a></li><li><a href=#安装-ruby-20>安装 Ruby 2.0</a></li><li><a href=#安装-git-和-gitolite>安装 Git 和 Gitolite</a></li><li><a href=#安装-nginx>安装 Nginx</a></li><li><a href=#安装-mysql-和-redis>安装 Mysql 和 Redis</a></li><li><a href=#添加-gitlab-用户>添加 Gitlab 用户</a></li><li><a href=#安装-gitlab-shell>安装 Gitlab-shell</a></li><li><a href=#安装-gitlab>安装 Gitlab</a></li><li><a href=#检查-gitlab-状态>检查 Gitlab 状态</a></li><li><a href=#配置-nginx>配置 nginx</a></li><li><a href=#开始-gitlab-之旅>开始 Gitlab 之旅</a></li><li><a href=#各种坑>各种坑</a><ul><li><a href=#1-错误日志报权限错误>1. 错误日志报权限错误</a></li><li><a href=#2-8080-端口被占用>2. 8080 端口被占用</a></li></ul></li></ul></nav></div></div><div class=post-content><div id=post-gallery><p>2013 年 08 月的 OpenParty &ldquo;<a href=http://www.beijing-open-party.org/event/25>花事如期</a>&rdquo; 活动上，<a href=https://github.com/vecio>晓东</a>在他的机器上演示了自建 Gitlab 的项目，看到 Gitlab 目前已经比较成熟，而不像早期寒碜的界面，这个时候看安装一下也是不错的事情，不过他们的项目文档只提供了 Ubuntu 系统的<a href=https://github.com/gitlabhq/gitlabhq#installation>安装文档</a>，对于 CentOS 没有提到，非官方的文档有比较老久，凭着之前熟悉 Ubuntu 和学习 CentOS，那就开始安装吧：</p><p>以下教程在 <code>CentOS 6 x86_64</code> 版本下操作。</p><h2 id=首先安装-epel-和编译依赖库>首先安装 EPEL 和编译依赖库</h2><pre tabindex=0><code>$ rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
</code></pre><blockquote><p>如果你是非 64 位，去上面的网址找到适合你发行版的最新版本的 epel rpm</p></blockquote><pre tabindex=0><code>$ yum -y update
$ yum -y install gcc gcc-c++ make autoconf libyaml-devel gdbm-devel ncurses-devel openssl-devel zlib-devel readline-devel curl-devel expat-devel gettext-devel  tk-devel libxml2-devel libffi-devel libxslt-devel libicu-devel sendmail patch libyaml* pcre-devel sqlite-devel vim
</code></pre><h2 id=安装-python-27>安装 Python 2.7+</h2><p>Gitlab 要求 Python 2.5.5+ 以及 Ruby 1.9+</p><p>系统 Python 默认是 2.6.x，如果你想把 Python 升级到目前比较流行的 2.7.x 就参照下面步骤，否则直接跳过。（Gitlab 目前不支持 Python 3.0）</p><pre tabindex=0><code>$ mkdir /tmp/gitlab &amp;&amp; cd /tmp/gitlab
$ curl --progress http://python.org/ftp/python/2.7.5/Python-2.7.5.tgz | tar xvf
$ cd Python-2.7.5
$ ./configure --prefix=/usr/local
$ make &amp;&amp; make altinstall
</code></pre><p>安装好之后，需要做两件事情，替换默认 python 的版本至最新版本，</p><pre tabindex=0><code>$ sudo ln -s /usr/local/bin/python2.7 /usr/local/bin/python
</code></pre><blockquote><p>因为系统默认 <code>PATH</code> 的寻址路径是 <code>/usr/local/bin</code></p></blockquote><p>最后看下 Python 版本是否是刚刚安装的版本：</p><pre tabindex=0><code>$ python --version
</code></pre><blockquote><p>由于 <code>yum</code> 是 python 的一个 module，所以这块修改可能会引起无法调用 yum 脚本，所以需要修改这个文件 <code>/usr/bin/yum</code> 的第一行为 <code>!#/usr/bin/python2.6</code></p></blockquote><h2 id=安装-ruby-20>安装 Ruby 2.0</h2><p>Ruby 1.9 和 2.0 的特性差别不大，索性升级至最新 2.0 版本即可</p><pre tabindex=0><code>$ cd /tmp/gitlab
$ curl --progress http://cache.ruby-lang.org/pub/ruby/2.0/ruby-2.0.0-p247.tar.gz | tar xz
$ cd ruby-2.0.0-p247
$ ./configure
$ make
$ make install
</code></pre><p>ruby 2.0 已经内置 gem (v2.0.3)，只需要安装 bundler</p><pre tabindex=0><code>$ gem install bundler
</code></pre><blockquote><p>若在执行 <code>sudo ruby</code> 或 <code>sudo gem</code> 找不到命令，因为编译的路径配置到了 <code>/usr/local/bin</code>，我们只需要做下软链接到 root 用户可以找到的 <code>$PATH</code> 路径：</p></blockquote><pre tabindex=0><code>$ ln -s /usr/local/bin/ruby /usr/bin/ruby
$ ln -s /usr/local/bin/gem /usr/bin/gem
$ ln -s /usr/local/bin/bundle /usr/bin/bundle
</code></pre><h2 id=安装-git-和-gitolite>安装 Git 和 Gitolite</h2><pre tabindex=0><code>$ yum -y install git-all gitolite
</code></pre><h2 id=安装-nginx>安装 Nginx</h2><pre tabindex=0><code>$ yum -y install nginx
$ service nginx start
</code></pre><blockquote><p>nginx 需要从 EPEL 中安装，默认系统没有 nginx 包。</p></blockquote><h2 id=安装-mysql-和-redis>安装 Mysql 和 Redis</h2><p>Gitlab 要求强制安装 redis 处理一些数据，另外支持 MySQL 和 PostgreSQL，这里主要以 MySQL 为例</p><pre tabindex=0><code>$ yum -y install mysql mysql-devel mysql-server redis
</code></pre><p>配置 Mysql 和 gitlab 需要的用户和数据库</p><pre tabindex=0><code>$ service mysqld start
$ mysql -u root
$ mysql&gt; CREATE USER &#39;gitlab&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;gitlab&#39;;
$ mysql&gt; CREATE DATABASE IF NOT EXISTS `gitlabhq_production` DEFAULT CHARACTER SET `utf8` COLLATE `utf8_unicode_ci`;
$ mysql&gt; GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON `gitlabhq_production`.* TO &#39;gitlab&#39;@&#39;localhost&#39;;
$ mysql&gt; \q
</code></pre><p>Redis 使用默认配置即可，直接启动</p><pre tabindex=0><code>$ service redis start
</code></pre><h2 id=添加-gitlab-用户>添加 Gitlab 用户</h2><pre tabindex=0><code>$ useradd -c &#39;GitLab&#39; git
</code></pre><p>CentOS 的命令没有办法直接禁止用户的访问的参数，需要用下面命令：</p><pre tabindex=0><code>$ passwd -l git
</code></pre><h2 id=安装-gitlab-shell>安装 Gitlab-shell</h2><p>使用 root 账户切换到 git 账户下操作，可以比官方教程省去一些麻烦的输入</p><pre tabindex=0><code>$ su git &amp;&amp; cd /home/git
$ git clone https://github.com/gitlabhq/gitlab-shell.git
$ cd gitlab-shell
</code></pre><p>通过 <code>git tag</code> 查看最新版本并切换之</p><pre tabindex=0><code>$ git checkout v1.7.1
</code></pre><p>编辑配置文件修改你要设定的域名（domain），比如 <code>http://gitlab.dev/</code></p><pre tabindex=0><code>$ vim config.yml
</code></pre><p>完成之后执行安装脚本</p><pre tabindex=0><code>$ ./bin/install
</code></pre><h2 id=安装-gitlab>安装 Gitlab</h2><pre tabindex=0><code>$ cd /home/git
$ git clone https://github.com/gitlabhq/gitlabhq.git gitlab
$ cd /home/git/gitlab
</code></pre><p>通过 <code>git tag</code> 查看最新版本并切换之</p><pre tabindex=0><code>$ git checkout 6.0.1
</code></pre><p>这里需要配置的东西多一些，这里参考<a href=https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/installation.md#configure-it>官方的文档</a>，也可以安装我下面的步骤来：</p><pre tabindex=0><code>$ cd /home/git/gitlab
</code></pre><p>复制配置文件，修改 host 相关的配置项，主要是 domain 要和上面的 <code>http://gitlab.dev</code></p><pre tabindex=0><code>$ cp config.yml{.example,}
$ vim config/gitlab.yml
</code></pre><p>确认 gitlab 以下目录的权限是否正确</p><pre tabindex=0><code>$ mkdir tmp/pids/
$ mkdir tmp/sockets/
$ chown -R git log/
$ chown -R git tmp/
$ chmod -R u+rwX log/
$ chmod -R u+rwX tmp/
$ chmod -R u+rwX tmp/pids/
$ chmod -R u+rwX tmp/sockets/
</code></pre><p>创建 satellites 目录，这个目录是保存各个用户的仓库</p><pre tabindex=0><code>$ mkdir /home/git/gitlab-satellites
</code></pre><p>创建 uploads 目录（为什么 gitlab 不在项目中创建呢= =！）</p><pre tabindex=0><code>$ mkdir public/uploads
$ chmod -R u+rwX  public/uploads
</code></pre><p>复制 unicorn 配置文件</p><pre tabindex=0><code>$ cp config/unicorn.rb{.example,}
</code></pre><p>设置 ruby web 容器的参数，比如 2GB RAM 服务器可以设置 3 个 worker。</p><blockquote><p>如果系统其他服务占用了 unicorn 的端口，记得改名。</p></blockquote><pre tabindex=0><code>$ vim config/unicorn.rb
</code></pre><p>设置一些 git 全局参数</p><pre tabindex=0><code>$ git config --global user.name &#34;GitLab&#34;
$ git config --global user.email &#34;gitlab@localhost&#34;
$ git config --global core.autocrlf input
</code></pre><p>配置 gitlab 数据库设置</p><pre tabindex=0><code>$ cp config/database.yml{.mysql,}
$ vim config/database.yml
$ chmod o-rwx config/database.yml
</code></pre><p>安装必需的 Ruby Gems</p><pre tabindex=0><code>$ cd /home/git/gitlab
$ [sudo] gem install charlock_holmes --version &#39;0.6.9.4&#39;
$ bundle install --deployment --without development test postgres aws
</code></pre><p>初始化数据库数据（执行输入 <code>Yes</code> 继续创建）</p><pre tabindex=0><code>$ bundle exec rake gitlab:setup RAILS_ENV=production
</code></pre><p>设置 init 脚本</p><pre tabindex=0><code>$ sudo cp lib/support/init.d/gitlab /etc/init.d/gitlab
$ sudo chmod +x /etc/init.d/gitlab
</code></pre><h2 id=检查-gitlab-状态>检查 Gitlab 状态</h2><pre tabindex=0><code>$ bundle exec rake gitlab:env:info RAILS_ENV=production
</code></pre><p>启动 gitlab 服务</p><pre tabindex=0><code>$ sudo service gitlab start
</code></pre><p>再起检查，保证所有项目都是绿色</p><pre tabindex=0><code>$ bundle exec rake gitlab:check RAILS_ENV=production
</code></pre><h2 id=配置-nginx>配置 nginx</h2><p>根据 nginx 的安装路径适当修改下面的路径即可，我们先把 gitlab 提供的配置文件拷贝过去</p><pre tabindex=0><code>$ sudo mkdir -p /etc/nginx/conf/sites/
$ sudo cp lib/support/nginx/gitlab /etc/nginx/conf/sites/gitlab.conf
</code></pre><blockquote><p>根据 nginx 版本和不同发行版的不同，配置结构可能不同根据你的实际情况加载 <code>gitlab.conf</code></p></blockquote><p>修改 <code>gitlab.conf</code> 的 <code>YOUR_SERVER_FQDN</code> 为上面设置的 domain。
最后修改 <code>nginx.conf</code> 或者 <code>default.conf</code> 加载 <code>/etc/nginx/conf/site</code> 下所有 conf 文件</p><pre tabindex=0><code>http {

	include /etc/nginx/conf/site/*.conf;

	server {
		…
	}
}
</code></pre><p>保存后，重启各个服务</p><pre tabindex=0><code>$ sudo service nginx reload
$ sudo service gitlab restart
</code></pre><h2 id=开始-gitlab-之旅>开始 Gitlab 之旅</h2><p>配置好 hosts 即可访问 <code>gitlab.dev</code></p><pre tabindex=0><code>$ echo &#34;127.0.0.1 gitlab.dev&#34; &gt;&gt; /etc/hosts
</code></pre><p>默认的用户名密码：</p><pre tabindex=0><code>admin@local.host
5iveL!fe
</code></pre><h2 id=各种坑>各种坑</h2><h3 id=1-错误日志报权限错误>1. 错误日志报权限错误</h3><pre tabindex=0><code>2013/11/07 00:42:21 [crit] 15875#0: *2 stat() &#34;/home/git/gitlab/public/favicon.ico.html&#34; failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: &#34;GET /favicon.ico HTTP/1.1&#34;, host: &#34;gitlab.web.lo&#34;
2013/11/07 00:42:21 [crit] 15875#0: *2 connect() to unix:/home/git/gitlab/tmp/sockets/gitlab.socket failed (13: Permission denied) while connecting to upstream, client: 33.33.33.1, server: gitlab.web.lo, request: &#34;GET /favicon.ico HTTP/1.1&#34;, upstream: &#34;http://unix:/home/git/gitlab/tmp/sockets/gitlab.socket:/favicon.ico&#34;, host: &#34;gitlab.web.lo&#34;
2013/11/07 00:42:31 [crit] 15875#0: *2 stat() &#34;/home/git/gitlab/public/&#34; failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: &#34;GET / HTTP/1.1&#34;, host: &#34;gitlab.web.lo&#34;
2013/11/07 00:42:31 [crit] 15875#0: *2 stat() &#34;/home/git/gitlab/public//index.html&#34; failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: &#34;GET / HTTP/1.1&#34;, host: &#34;gitlab.web.lo&#34;
2013/11/07 00:42:31 [crit] 15875#0: *2 stat() &#34;/home/git/gitlab/public/.html&#34; failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: &#34;GET / HTTP/1.1&#34;, host: &#34;gitlab.web.lo&#34;
2013/11/07 00:42:31 [crit] 15875#0: *2 connect() to unix:/home/git/gitlab/tmp/sockets/gitlab.socket failed (13: Permission denied) while connecting to upstream, client: 33.33.33.1, server: gitlab.web.lo, request: &#34;GET / HTTP/1.1&#34;, upstream: &#34;http://unix:/home/git/gitlab/tmp/sockets/gitlab.socket:/&#34;, host: &#34;gitlab.web.lo&#34;
2013/11/07 00:42:31 [crit] 15875#0: *2 stat() &#34;/home/git/gitlab/public/favicon.ico&#34; failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: &#34;GET /favicon.ico HTTP/1.1&#34;, host: &#34;gitlab.web.lo&#34;
2013/11/07 00:42:31 [crit] 15875#0: *2 stat() &#34;/home/git/gitlab/public/favicon.ico/index.html&#34; failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: &#34;GET /favicon.ico HTTP/1.1&#34;, host: &#34;gitlab.web.lo&#34;
2013/11/07 00:42:31 [crit] 15875#0: *2 stat() &#34;/home/git/gitlab/public/favicon.ico.html&#34; failed (13: Permission denied), client: 33.33.33.1, server: gitlab.web.lo, request: &#34;GET /favicon.ico HTTP/1.1&#34;, host: &#34;gitlab.web.lo&#34;
2013/11/07 00:42:31 [crit] 15875#0: *2 connect() to unix:/home/git/gitlab/tmp/sockets/gitlab.socket failed (13: Permission denied) while connecting to upstream, client: 33.33.33.1, server: gitlab.web.lo, request: &#34;GET /favicon.ico HTTP/1.1&#34;, upstream: &#34;http://unix:/home/git/gitlab/tmp/sockets/gitlab.socket:/favicon.ico&#34;, host: &#34;gitlab.web.lo&#34;
</code></pre><p>解决方案:</p><pre tabindex=0><code>$ (sudo) chmod o+x /home/git
</code></pre><h3 id=2-8080-端口被占用>2. 8080 端口被占用</h3><p>这样主要是因为 nginx 的配置是做 unicorn 的代理转发，实际上 gitlab 是由 unicorn 容器驱动，而在配置里默认绑定的是 <code>8080</code> 端口</p><pre tabindex=0><code>$ vim /home/git/gitlab/config/unicorn.rb
</code></pre><p>找到 <code>listen "127.0.0.1:8080", :tcp_nopush => true</code> 修改成其他未占用的端口号即可。</p></div></div><div class=post-nav><a href=https://icyleaf.com/2013/09/network-configuration-in-centos/ class=prev rel=prev title="配置 CentOS 的网络联网设置"><i class="iconfont icon-left"></i>&nbsp;配置 CentOS 的网络联网设置</a>
<a href=https://icyleaf.com/2013/10/about-pager-on-git/ class=next rel=next title="Git 和 Pager 的那点事">Git 和 Pager 的那点事&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><script>var getTheme=window.localStorage&&window.localStorage.getItem("blog-dark-mode"),getTheme=getTheme??"github-light";let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","icyleaf/icyleaf.com"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.post-comment").innerHTML="",document.querySelector("div.post-comment").appendChild(s)</script></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2024</span>
<span>🍺</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script defer src=https://fastly.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script>
<script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: () => import('\/photoswipe\/photoswipe.esm.js'),
  });
  lightbox.init();
</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TKQBZ7R259"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TKQBZ7R259")</script></div></body></html>