<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Gitlab API Wrapper for Crystal | icyleaf</title><link rel=prev href=https://icyleaf.com/2016/07/intro-fastlane-automation-for-ios-and-android/><link rel=next href=https://icyleaf.com/2016/07/fastlane-in-action/><link rel=canonical href=https://icyleaf.com/2016/07/gitlab-api-wrapper-for-crystal/><link rel=apple-touch-icon sizes=180x180 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.css><meta name=title content="Gitlab API Wrapper for Crystal | icyleaf"><meta name=author content="icyleaf"><meta name=description content="日常写代码热爱户外的梦想家"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/icyleaf.com\/"},"articleSection":"posts","name":"Gitlab API Wrapper for Crystal","headline":"Gitlab API Wrapper for Crystal","description":"学习新语音最好的途径就是造轮子","inLanguage":"zh","author":"icyleaf","creator":"icyleaf","publisher":"icyleaf","accountablePerson":"icyleaf","copyrightHolder":"icyleaf","copyrightYear":"2016","datePublished":"2016-07-11 20:41:26 \u002b0800 \u002b0800","dateModified":"2016-07-11 20:41:26 \u002b0800 \u002b0800","url":"https:\/\/icyleaf.com\/2016\/07\/gitlab-api-wrapper-for-crystal\/","wordCount":"1082","keywords":["Ruby","Crystal","icyleaf"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/about title>About</a>
<a class=menu-item href=https://icyleaf.com/projects title>Projects</a>
<a class=menu-item href=https://icyleaf.com/index.xml title>Feed</a>
<span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/about title><h3>About</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>Projects</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/index.xml title><h3>Feed</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop=description>Gitlab API Wrapper for Crystal</h1><div class=post-description>学习新语音最好的途径就是造轮子</div><div class=post-meta><time datetime=2016-07-11 itemprop=datePublished>July 11, 2016</time>
·
<span class=tags>Ruby, Crystal</span>
·
<span class=post-word-count>1082 words · 4 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#gitlabcr>Gitlab.cr</a></li><li><a href=#为什么学习-crystal>为什么学习 Crystal？</a></li><li><a href=#语言优势>语言优势</a></li><li><a href=#语言友好>语言友好</a></li><li><a href=#语言限制>语言限制</a></li><li><a href=#最后想说的话>最后想说的话</a></li><li><a href=#相关资源>相关资源</a></li></ul></nav></div></div><div class=post-content><div id=post-gallery><h2 id=gitlabcr>Gitlab.cr</h2><p><a href=https://github.com/icyleaf/gitlab.cr>gitlab.cr</a> 是我最近课下练习的新语言 <a href=http://crystal-lang.org/>Crystal</a> 写的 gitlab 包，方法和功能和 <a href=https://github.com/NARKOZ/gitlab>gitlab ruby 版本</a>基本类似。</p><p>目前已经完成了大部分 API 的封装，在一边熟悉 crystal 的同时一边补充，其中肯定有一些性能问题和坑，毕竟没有任何依赖都是自己实现的。比较坑爹的是官方手册太简单，也没有实时跟进，能够好好翻阅的其实也就是官方的 API 文档和源码。不过 crystal 还算比较人性化的一面，默认集成了类似 rspce 的单元测试（简化版）和依赖库管理 shards（类似 bundler）和生成文档的工具。通过 <a href=https://travis-ci.org/%60%60>travis-ci</a> 会自动生成每次 git push 的变化。</p><p>API 文档：http://icyleaf.github.io/gitlab.cr/</p><h2 id=为什么学习-crystal>为什么学习 Crystal？</h2><p><img src=https://cloud.githubusercontent.com/assets/209371/13291809/022e2360-daf8-11e5-8be7-d02c1c8b38fb.png alt="crystal logo" loading=lazy></p><p>Ruby 的缺点众所周知的一个点就是慢，虽说用它的人都不在乎主要是用的爽，so what！这一致命的坑其实默默的被承受着，很多的 Ruby 开发者也在一直寻觅着新的更高性能的语言。比如 Gitlab 的 Build Runner 使用 Go 实现了。Rails 的核心开发者基于多年对 Ruby 的怨念而开发的 Elixir，还有 Firefox 主导的 Rust 也吸引了不少目光。有那么多选择为什么偏偏选了这么一个没有听说过的语言？</p><h2 id=语言优势>语言优势</h2><ul><li>类似 Ruby 风格语法（但舍弃了一些动态特性）</li><li>一切都是对象（和 Ruby 一样）</li><li>自动类型推荐和静态类型检查</li><li>支持方法重载</li><li>易用的 C 语言库的绑定机制</li><li>基于 LLVM（目前不支持 Windows）</li><li>编译性语言，可以打包二进制包</li></ul><p>仅仅是这些可能大家觉得没什么，其实对我来说也不够冲击力，最重要的关键是在我从订阅的 Ruby Weekly 周刊看到 sidekiq 的作者用 crystal 重新实现了核心部分发的<a href=http://www.mikeperham.com/2016/05/25/sidekiq-for-crystal/>博文分享</a>，提到的一点：<strong>至少是比 ruby 2.3 大部分代码要快 3-5 倍，减少至少 3 倍的内存占用</strong>。怀着怀疑的态度我大概的研究了这个语言，确实看到了新希望。</p><table><thead><tr><th>库</th><th>语言</th><th>并发量</th><th>平均响应时间</th></tr></thead><tbody><tr><td><a href=https://github.com/sdogruyol/fast-http-server>fast-http-server</a></td><td><code>Crystal</code></td><td>18348.47rpm</td><td>8.67ms</td></tr><tr><td><a href=https://github.com/indexzero/http-server>http-server</a></td><td><code>Node.js</code></td><td>2105.55rpm</td><td>47.92ms</td></tr><tr><td><a href=https://docs.python.org/2/library/simplehttpserver.html>SimpleHTTPServer</a></td><td><code>Python</code></td><td>785.14rpm</td><td>1.91ms</td></tr></tbody></table><p>还有一份一直再更新维护的语言之间的<a href=https://github.com/kostya/benchmarks>评测</a>仅供参考，看着里面的数据还是蛮吸引人的。</p><blockquote><p>评测数据来源: <a href=http://www.akitaonrails.com/2016/05/31/flirting-with-crystal-a-rubyist-perspective>Flirting with Crystal, a Rubyist Perspective</a></p></blockquote><h2 id=语言友好>语言友好</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln> 1</span><span class=cl><span class=c1># File: server.cr</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=nb>require</span> <span class=s2>&#34;http/server&#34;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=n>server</span> <span class=o>=</span> <span class=no>HTTP</span><span class=o>::</span><span class=no>Server</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=mi>8080</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>context</span><span class=o>|</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>  <span class=n>context</span><span class=o>.</span><span class=n>response</span><span class=o>.</span><span class=n>content_type</span> <span class=o>=</span> <span class=s2>&#34;text/plain&#34;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=n>context</span><span class=o>.</span><span class=n>response</span><span class=o>.</span><span class=n>print</span> <span class=s2>&#34;Hello world! The time is </span><span class=si>#{</span><span class=no>Time</span><span class=o>.</span><span class=n>now</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=nb>puts</span> <span class=s2>&#34;Listening on http://0.0.0.0:8080&#34;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=n>server</span><span class=o>.</span><span class=n>listen</span>
</span></span></code></pre></div><p>看着是不是是不是和 Ruby 差不多。通过命令编译成二进制在运行试试：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>$ crystal build --release server.cr
</span></span><span class=line><span class=ln>2</span><span class=cl>$ ./server
</span></span><span class=line><span class=ln>3</span><span class=cl>Listening on http://0.0.0.0:8080
</span></span></code></pre></div><blockquote><p>macOS 用户可以通过 brew 进行安装 <code>brew install crystal-lang</code></p></blockquote><h2 id=语言限制>语言限制</h2><ul><li>没有了强大的黑魔法，尤其是针对 <code>eval</code> 和 <code>send</code> 两个的缺失。提供了 macro 的方式可以实现部分动态定义方法的机制。</li><li>require 引入必须放置在头部（crystal 0.7.7 以上版本的限制）</li><li>有待优化的 gc 机制（目前采用的是 <a href=https://zh.wikipedia.org/wiki/%E8%B2%9D%E5%A7%86%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8>Hans Boehm GC</a>）</li><li>还在开发中的语言，API 变化很快</li></ul><h2 id=最后想说的话>最后想说的话</h2><p>总体来说是一个让人眼前一亮的语言，很是期待后续的进化。我相信 sidekiq 作者的那篇博文也让无数开发者看到了新大陆。目前项目也在<a href=https://salt.bountysource.com/teams/crystal-lang>捐献</a>中，如果你对它感兴趣不妨慷慨的动动自己的钱包，Ruby 的创始人 matz 直接捐献了 $500。</p><h2 id=相关资源>相关资源</h2><ul><li>作者 Twitter: <a href=https://twitter.com/asterite>https://twitter.com/asterite</a></li><li>Awesome Crystal: <a href=http://awesome-crystal.com/>http://awesome-crystal.com/</a></li><li>Sidekiq for Crystal: <a href=http://www.mikeperham.com/2016/05/25/sidekiq-for-crystal/>http://www.mikeperham.com/2016/05/25/sidekiq-for-crystal/</a></li><li>Test Driving Sidekiq and Crystal: <a href=http://www.mikeperham.com/2016/06/14/test-driving-sidekiq-and-crystal/>http://www.mikeperham.com/2016/06/14/test-driving-sidekiq-and-crystal/</a></li><li>Flirting with Crystal, a Rubyist Perspective: <a href=http://www.akitaonrails.com/2016/05/31/flirting-with-crystal-a-rubyist-perspective>http://www.akitaonrails.com/2016/05/31/flirting-with-crystal-a-rubyist-perspective</a></li></ul></div></div><div class=post-nav><a href=https://icyleaf.com/2016/07/intro-fastlane-automation-for-ios-and-android/ class=prev rel=prev title=Fastlane><i class="iconfont icon-left"></i>&nbsp;Fastlane</a>
<a href=https://icyleaf.com/2016/07/fastlane-in-action/ class=next rel=next title="深入浅出 Fastlane 一看你就懂">深入浅出 Fastlane 一看你就懂&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//icyleaf.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2022</span>
<span>🍺</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script src=https://fastly.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js crossorigin=anonymous></script>
<script defer src=https://icyleaf.com/js/vendor_main.min.js></script>
<script src=https://fastly.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script>
<script>pangu.spacingPage()</script><script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: '\/photoswipe\/photoswipe.esm.js',
  });
  lightbox.init();
</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TKQBZ7R259"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TKQBZ7R259")</script></div></body></html>