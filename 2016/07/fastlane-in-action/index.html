<!doctype html><html lang=zh-cn></html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>深入浅出 Fastlane 一看你就懂 | icyleaf</title>
<meta name=keywords content="iOS,Android,CI,CD,Ruby,Fastlane"><meta name=description content="系列文章的第二篇，带你了解 fastlane 使用流程"><meta name=author content="icyleaf"><link rel=canonical href=https://icyleaf.com/2016/07/fastlane-in-action/><link rel=apple-touch-icon href=https://icyleaf.com/apple-touch-icon.png><link rel=icon href=https://icyleaf.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://icyleaf.com/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=https://icyleaf.com/android-chrome-512x512.png><link rel=icon type=image/svg+xml href=https://icyleaf.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.min.css><link rel=alternate hreflang=zh-cn href=https://icyleaf.com/2016/07/fastlane-in-action/><link rel=canonical href=https://icyleaf.com/2016/07/fastlane-in-action/><meta property="og:title" content="深入浅出 Fastlane 一看你就懂"><meta property="og:description" content="系列文章的第二篇，带你了解 fastlane 使用流程"><meta property="og:type" content="article"><meta property="og:url" content="https://icyleaf.com/2016/07/fastlane-in-action/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-07-19T20:12:07+08:00"><meta property="article:modified_time" content="2016-07-19T20:12:07+08:00"><meta property="og:see_also" content="https://icyleaf.com/2017/03/fastlane-match-in-action/"><meta property="og:see_also" content="https://icyleaf.com/2016/07/intro-fastlane-automation-for-ios-and-android/"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入浅出 Fastlane 一看你就懂"><meta name=twitter:description content="系列文章的第二篇，带你了解 fastlane 使用流程"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://icyleaf.com/posts/"},{"@type":"ListItem","position":2,"name":"深入浅出 Fastlane 一看你就懂","item":"https://icyleaf.com/2016/07/fastlane-in-action/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"深入浅出 Fastlane 一看你就懂","name":"深入浅出 Fastlane 一看你就懂","description":"系列文章的第二篇，带你了解 fastlane 使用流程","keywords":["iOS","Android","CI","CD","Ruby","Fastlane"],"articleBody":"本篇我想着重介绍 fastlane 本身的基本使用，这里使用 fastlane v1.98.0 作为演示版本。\n命令行工具 安装之后默认会安装一个命令行工具 fastlane，利用它可以初始化、执行任务、查看任务定义、查看可用的动作和动作的详细定义，甚至可以用它来创建自定义的动作、插件以及一些辅助功能。想了解的话可以先看看它的帮助：\n1$ fastlane --help 2 3 fastlane 4 5 CLI for 'fastlane' - The easiest way to automate building and releasing your iOS and Android apps 6 7 Run using `fastlane [platform] [lane_name]` 8 To pass values to the lanes use `fastlane [platform] [lane_name] key:value key2:value2` 9 10 Commands: 11 action Shows more information for a specific command 12 actions Lists all available fastlane actions 13 add_plugin Add a new plugin to your fastlane setup 14 disable_crash_reporting Deprecated: fastlane doesn't use a crash reporter any more 15 docs Generate a markdown based documentation based on the Fastfile 16 enable_auto_complete Enable tab auto completion 17 enable_crash_reporting Deprecated: fastlane doesn't use a crash reporter any more 18 help Display global or [command] help documentation 19 init Helps you with your initial fastlane setup 20 install_plugins Install all plugins for this project 21 lanes Lists all available lanes and shows their description 22 list Lists all available lanes without description 23 new_action Create a new custom action for fastlane. 24 new_plugin Create a new plugin that can be used with fastlane 25 run Run a fastlane one-off action without a full lane 26 search_plugins Search for plugins, search query is optional 27 trigger Run a sepcific lane. Pass the lane name and optionally the platform first. 28 update_plugins Update all plugin dependencies 29 30 Global Options: 31 --verbose 32 -h, --help Display help documentation 33 -v, --version Display version information 34 35 Author: 36 Felix Krause 37 38 Website: 39 https://fastlane.tools 40 41 GitHub: 42 https://github.com/fastlane/fastlane 我会随着下面每个概念的解释和展开来配合上面的命令一起讲解。\n生命周期 执行顺序 方法名 说明 1 before_all 在执行 lane 之前只执行一次 2 before_each 每次执行 lane 之前都会执行一次 3 lane 自定义的任务 4 after_each 每次执行 lane 之后都会执行一次 5 after_all 在执行 lane 成功结束之后执行一次 6 error 在执行上述情况任意环境报错都会中止并执行一次 以上的部分大家在上一篇已经见识过了，有些还没接触到，不用着急都会一一说明。\n任务（lane） 正常情况下你可能只会是用到一种任务方法 lane 但其实它会包含很多中高级用法。在文章的末尾会详细描述。\n任务定义 定义任务的方法类似于 rake 的 task，但使用上缺比前者要好用很多，见下表：\n定义 是否必须 说明 备注 desc false 方法描述 可多次使用打到换行的目的 name true 方法名 符号化的方法名 options false 方法参数 返回 Hash 类型 task true 方法主体 参考 ruby 的方法代码且支持 ruby 代码 1desc '定义一个 build 方法' 2desc '参数 adhoc 判断是否为内测版本, 默认为 false' 3desc 'fastlane build' 4desc 'fastlane build adhoc:true' 5lane :build do |options| 6 # task to do something 7 adhoc = options[:adhoc] || false 8 puts \"adhoc: #{adhoc}\" 9 10 gym(type: adhoc ? 'adhoc' : 'appstore') 11end 任务执行 一般情况下它需要配合定义好的 lane 才能使用，刚刚我们定义的一个 build 方法，我们这里就试着执行一下吧。\n1# 默认执行 2$ fastlane build 3# 传递参数 4$ fastlane build adhoc:true 任务互调 lane 其实可以理解为 def 的别名，因此多个 lane 的话实际上是可以相互调用的，这个其实特别实用，这样其实我就可以把 cocoapods 的执行放到单独的 lane 里面而不是 before_all，这样执行非构建的任务就不会执行不相关的任务或动作，因此 fastlane 而产生了一个私有任务用内部使用 private_lane\n1 2default_platform :ios 3 4platform :ios do 5 desc '构建前的准备工作' 6 desc '这是一个私有任务，仅供 Fastfile 内部 lane 调用使用' 7 lane :prepare do 8 cocoapods 9 match 10 end 11 12 desc '通用的构建任务' 13 desc 'fastlane build' 14 desc 'fastlane build type:adhoc' 15 lane :build do |options| 16 # 调用上面 prepare 私有任务 17 prepare 18 19 case options[:type] 20 when 'adhoc' 21 # 调用 下面 adhoc 任务 22 adhoc 23 else 24 # 调用下面 appstore 任务 25 appstore 26 end 27 end 28 29 desc '构建 adhoc 任务' 30 desc 'fastlane adhoc' 31 lane :adhoc do 32 gym(type: 'adhoc') 33 end 34 35 desc '构建 appstore 任务' 36 desc 'fastlane appstore' 37 lane :appstore do 38 gym(type: 'appstore') 39 end 40end 上面的任务中，build/adhoc/appstore 都可以执行，只有 prepare 是无法通过命令行外部执行，如果执行会直接报错：\n1$ fastlane prepare 2[19:17:42]: You can't call the private lane 'prepare' directly 任务返回值 和 ruby 的方法一致，每个 lane 最后一行会默认作为返回值（无需 return）。\n1 2lane :sum do |options| 3 options[:a] + optiona[:b] 4end 5 6lane :calculate do 7 value = sum(a: 3, b: 5) 8 puts value #=\u003e 8 9end 引入外部任务文件 Fastfile 除了自身以外还能够引入外部其他的 Fastfile 并调用任务，只需要导入外部文件并使用特殊的方法标识即可：\n1. import - 导入本地文件 1# 导入 lanes 目录的 AndroidFastfile 2import \"lanes/AndroidFastfile\" 2. import_from_git - 导入 git 仓库文件 可以直接引入 git 仓库的 Fastfile 文件是一个非常赞的功能，通过使用发现其实现原理是先把 git 仓库克隆下来后在引入相对于的文件，因此建议国内在没有网络加速（翻墙）的情况下尽量不用引入比较大的 git 仓库，否则使用会需要漫长的等待…\n1# 导入 mozilla/firefox-ios 项目下 fastlane 下面 Fastfile 文件 2import_from_git(url: 'https://github.com/mozilla/firefox-ios') 3# 或者 4import_from_git(url: 'git@github.com:mozilla/firefox-ios.git', 5 path: 'fastlane/Fastfile') 假若外部引入的 Fastfile 有个方法是 build，在命令行工具直接执行即可，如果外部和内部都有相同的任务名，执行会直接报错：\n1$ fastlane ios build 2 3[!] Lane 'gradle' was defined multiple times! 如果发生这样的事情且你希望在主体 Fastfile 也调用的话需要使用特殊的方法定义：override_lane\n注意：此方法只会覆盖外部的相同方法名的代码执行，目前暂时无法使用类似 ruby 的 super 继承原由方法！\n1override_lane :build do 2 ... 3end 任务查看 只需执行下面这行命令就可以看到非私有任务的可用列表信息\n1$ fastlane lanes 2 3--------- ios--------- 4----- fastlane ios build 5通用的构建任务 6fastlane build 7fastlane build type:adhoc 8 9----- fastlane ios adhoc 10构建 adhoc 任务 11 12----- fastlane ios appstore 13构建 appstore 任务 14 15Execute using `fastlane [lane_name]` 扩展（Action） 扩展是 fastlane 的杀手锏，重在集成了众多非常优秀好用的方法供 lane 内部使用，截至 fastlane v1.98.0 版本以包含 175 个扩展，这个数量还在陆续增加中。扩展初期是由发起人一个人完成，后续的大部分都是社区共享，如果你发现没有你想要的扩展，可以先去 issues 搜索下没有要么自己动手提交要么只有等待了.\n扩展列表 1$ fastlane actions 2+--------------------+-------------------------------------------------------------+------------------+ 3| Available fastlane actions | 4+--------------------+-------------------------------------------------------------+------------------+ 5| Action | Description | Author | 6+--------------------+-------------------------------------------------------------+------------------+ 7| adb | Run ADB Actions | hjanuschka | 8| adb_devices | Get an Array of Connected android device serials | hjanuschka | 9| add_git_tag | This will add an annotated git tag to the current branch | Multiple | 10... 11+--------------------+-------------------------------------------------------------+------------------+ 12 Total of 175 actions 13 14Get more information for one specific action using `fastlane action [name]` 扩展使用帮助 1# 查看 adb 扩展的使用帮助 2$ fastlane action adb 3Loading documentation for adb: 4 5+---------------------------------+ 6| adb | 7+---------------------------------+ 8| Run ADB Actions | 9| | 10| see adb --help for more details | 11| | 12| Created by hjanuschka | 13+---------------------------------+ 14 15+----------+----------------------------------------------------------------------+-------------------+---------+ 16| adb Options | 17+----------+----------------------------------------------------------------------+-------------------+---------+ 18| Key | Description | Env Var | Default | 19+----------+----------------------------------------------------------------------+-------------------+---------+ 20| serial | Android serial, which device should be used for this command | FL_ANDROID_SERIAL | | 21| command | All commands you want to pass to the adb command, e.g. `kill-server` | FL_ADB_COMMAND | | 22| adb_path | The path to your `adb` binary | FL_ADB_PATH | adb | 23+----------+----------------------------------------------------------------------+-------------------+---------+ 24 25+-------------------------------+ 26| adb Return Value | 27+-------------------------------+ 28| The output of the adb command | 29+-------------------------------+ 30 31More information can be found on https://github.com/fastlane/fastlane/blob/master/fastlane/docs/Actions.md 创建自定义扩展 通过内置的命令创建你需要的扩展，扩展名必须是全部小写且只能使用下划线分割词组，生成好的扩展文件会在 fastlane/actions 目录找到:\n1$ fastlane new_action 2Must be lower case, and use a '_' between words. Do not use '.' 3examples: 'testflight', 'upload_to_s3' 4Name of your action: hello 5[15:33:15]: Created new action file './fastlane/actions/hello.rb'. Edit it to implement your custom action. 这块会占比较大的篇幅，尽情期待后续的展开。\n引入外部扩展 这块其实也有两种方法可以引入，文件引入是官方教程提供的方法，第二种是我个人尝试出来的，第三种是最近版本才官方支持的。\n1. 本地文件引入 自定义的扩展其实也算是本地文件引入的一种形式，当然位于其他路径的通过指定方法也能做到\n1# 引入项目根目录 script/share_actions 路径 2actions_path '../script/share_actions' 2. rubygem 引入 不再建议使用本方法，请看第三种插件引入。\n我在团队内部创建了一个自定义的扩展，仅限于团队内部使用而无法贡献社区，我只能采取封装成 ruby gem 包，通过 ruby 的 require 方式引入，最终可以完美支持，目前已在项目中使用大半年之久。最重要的是我是开源的：fastlane-qyer\n1# 首先安装需要的 rubygem: gem install fastlane-qyer 2require 'fastlane-qyer' 3 4lane :upload do 5 qyer(api_key: '[token]') 6end 注意，使用 rubygem 引入的无法在 fastlane actions 中显示出来，也无法使用 fastlane action [name] 查看使用帮助。我猜想一是官方没有这样提供思路，二是就算你引入了 gem 也不是特别好判断里面的文件结构。\n3. 插件引入 我注意到 1.93.0 增加了插件机制，很好的解决第二种出现的一些问题。大概看了一下主要是采用 Gemfile 的方式使用 Pluginfile 维护了引入第三方插件列表。实现原理还是属于第二种方法。\n通过 fastlane search_plugins 查看当前支持的插件，并使用 fastlane add_plugins [name] 引入。\n1$ fastlane search_plugins 2[16:04:33]: Listing all available fastlane plugins 3 4+--------------------------+---------------------------------------------------+-----------+ 5| Available fastlane plugins | 6+--------------------------+---------------------------------------------------+-----------+ 7| Name | Description | Downloads | 8+--------------------------+---------------------------------------------------+-----------+ 9| ruby | Useful fastlane actions for Ruby projects | 782 | 10| versioning | Allows to work set/get app version directly | 758 | 11| | to/from Info.plist | | 12| branding | Add some branding to your fastlane output | 716 | 13| instrumented_tests | New action to run instrumented tests for android. | 590 | 14| | This basically creates and boots an emulator | | 15| | before running an gradle commands so that you can | | 16| | run instrumented tests against that emulator. | | 17| | After the gradle command is executed, the avd | | 18| | gets shut down and deleted. This is really | | 19| | helpful on CI services, keeping them clean and | | 20| | always having a fresh avd for testing. | | 21| xamarin_build | Build xamarin android\\ios projects | 582 | 22| appicon | Generate required icon sizes and iconset from a | 509 | 23| | master application icon. | | 24... 25| download_file | This action downloads a file from an HTTP/HTTPS | 171 | 26| | url (e.g. ZIP file) and puts it in a destination | | 27| | path | | 28+--------------------------+---------------------------------------------------+-----------+ 29 30# 添加 sentry 插件 31$ fastlane add_plugin sentry 32[16:16:23]: Plugin 'fastlane-plugin-sentry' was added to './fastlane/Pluginfile' 33[16:16:23]: It looks like fastlane plugins are not yet set up for this project. 34[16:16:23]: fastlane will create a new Gemfile at path 'Gemfile' 35[16:16:23]: This change is neccessary for fastlane plugins to work 36Should fastlane modify the Gemfile at path 'Gemfile' for you? (y/n) 37y 38[16:16:29]: Successfully modified 'Gemfile' 39[16:16:29]: Make sure to commit your Gemfile, Gemfile.lock and Pluginfile to version control 40Installing plugin dependencies... 41Successfully installed plugins 42 43$ cat fastlane/Pluginfile 44# Autogenerated by fastlane 45# 46# Ensure this file is checked in to source control! 47 48gem 'fastlane-plugin-sentry' 更详细的继续期待后续报道，我要挖坑无数。\n扩展的命令行调用 社区的力量果然是很强大的，陆续添加了那么多功能，早期用户表示不开心！嗯，由于社区的呼声和贡献目前可以通过命令调用扩展：\n1# 使用 notification 扩展发送一个通知消息 2$ fastlane run notification message:\"Hi macOS\" title:\"Fastlane Notification\" 3[15:58:05]: -------------------------- 4[15:58:05]: --- Step: notification --- 5[15:58:05]: -------------------------- 6[15:58:05]: Result: true 辅助功能 自动更新 fastlane 提供一个方法 update_fastlane 用于对于自身的版本检查和更新，这个第一篇文章我也有提到过。它其实一个是一个扩展，使用 fastlane action update_fastlane 能够看到使用帮助。它有一个参数是可以指定检查特定的 fastlane 工具并进行更新，但其实它是使用 rubygems 进行对 gem 的更新，因此这块其实可以传入任何需要检查并更新的 gem：\n1update_fastlane(tools:'fastlane,gym,match,cocoapods,rest-client') 环境变量 从 fastlane 的设计体系上在各个地方都加入了环境变量的支持，每个扩展的参数、以及扩展需要共享给其他扩展和任务读取的数据都是通过环境变量获取，如下是我收集的比较常用的列表：\n环境变量 来源 说明 备注 FASTLANE_USER credentials_manager Apple 开发者账户名 验证通过后会保存 Keychain FASTLANE_PASSWORD credentials_manager Apple 开发者账户密码 验证通过后会保存 Keychain FASTLANE_TEAM_IDCERT_TEAM_ID producesigh Apple 团队 ID DELIVER_USERPRODUCE_USERNAME deliverproduce iTunesConnect 账户名 DELIVER_PASSWORD deliver iTunesConnect 账户密码 MATCH_PASSWORD match 证书加/解密密码 FASTLANE_XCODE_LIST_TIMEOUT fastlane_core 获取 iOS Scheme 的超时时间 默认 10s ","wordCount":"3521","inLanguage":"zh-cn","datePublished":"2016-07-19T20:12:07+08:00","dateModified":"2016-07-19T20:12:07+08:00","author":{"@type":"Person","name":"icyleaf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://icyleaf.com/2016/07/fastlane-in-action/"},"publisher":{"@type":"Organization","name":"icyleaf","logo":{"@type":"ImageObject","url":"https://icyleaf.com/favicon.ico"}}}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/series/homelab title>homelab 系列
</a><a class=menu-item href=https://icyleaf.com/projects title>开源项目
</a><a class=menu-item href=https://icyleaf.com/gears title>我的设备
</a><a class=menu-item href=https://icyleaf.com/about title>关于
</a><span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/series/homelab title><h3>homelab 系列</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>开源项目</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/gears title><h3>我的设备</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/about title><h3>关于</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop=description>深入浅出 Fastlane 一看你就懂</h1><div class=post-description>系列文章的第二篇，带你了解 fastlane 使用流程</div><div class=post-meta><time datetime=2016-07-19 itemprop=datePublished>2016-07-19</time>
·
<span class=tags>iOS, Android, CI, CD, Ruby, Fastlane</span>
·
<span class=post-word-count>3521 words · 16 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#命令行工具>命令行工具</a></li><li><a href=#生命周期>生命周期</a></li><li><a href=#任务lane>任务（lane）</a><ul><li><a href=#任务定义>任务定义</a></li><li><a href=#任务执行>任务执行</a></li><li><a href=#任务互调>任务互调</a></li><li><a href=#任务返回值>任务返回值</a></li><li><a href=#引入外部任务文件>引入外部任务文件</a></li><li><a href=#任务查看>任务查看</a></li></ul></li><li><a href=#扩展action>扩展（Action）</a><ul><li><a href=#扩展列表>扩展列表</a></li><li><a href=#扩展使用帮助>扩展使用帮助</a></li><li><a href=#创建自定义扩展>创建自定义扩展</a></li><li><a href=#引入外部扩展>引入外部扩展</a></li><li><a href=#扩展的命令行调用>扩展的命令行调用</a></li></ul></li><li><a href=#辅助功能>辅助功能</a><ul><li><a href=#自动更新>自动更新</a></li><li><a href=#环境变量>环境变量</a></li></ul></li></ul></nav></div></div><div class=post-content><div class=post-series><h4 class=series-title><a href=https://icyleaf.com/series/fastlane/>Fastlane（3 篇）</a></h4><ol class=series-list><li class=series-item><a href=https://icyleaf.com/2016/07/intro-fastlane-automation-for-ios-and-android/>Fastlane - iOS 和 Android 的自动化构建工具</a></li><li class=series-item><span class=current-serie>深入浅出 Fastlane 一看你就懂</span></li><li class=series-item><a href=https://icyleaf.com/2017/03/fastlane-match-in-action/>你虐我千百遍，我待你如初恋，直到我遇到 match</a></li></ol></div><div id=post-gallery><p>本篇我想着重介绍 <code>fastlane</code> 本身的基本使用，这里使用 fastlane v1.98.0 作为演示版本。</p><h2 id=命令行工具>命令行工具</h2><p>安装之后默认会安装一个命令行工具 <code>fastlane</code>，利用它可以初始化、执行任务、查看任务定义、查看可用的动作和动作的详细定义，甚至可以用它来创建自定义的动作、插件以及一些辅助功能。想了解的话可以先看看它的帮助：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>$ fastlane --help
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  fastlane
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl>  CLI <span class=k>for</span> <span class=s1>&#39;fastlane&#39;</span> - The easiest way to automate building and releasing your iOS and Android apps
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl>        Run using <span class=sb>`</span>fastlane <span class=o>[</span>platform<span class=o>]</span> <span class=o>[</span>lane_name<span class=o>]</span><span class=sb>`</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>        To pass values to the lanes use <span class=sb>`</span>fastlane <span class=o>[</span>platform<span class=o>]</span> <span class=o>[</span>lane_name<span class=o>]</span> key:value key2:value2<span class=sb>`</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>  Commands:
</span></span><span class=line><span class=ln>11</span><span class=cl>    action                  Shows more information <span class=k>for</span> a specific <span class=nb>command</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    actions                 Lists all available fastlane actions
</span></span><span class=line><span class=ln>13</span><span class=cl>    add_plugin              Add a new plugin to your fastlane setup
</span></span><span class=line><span class=ln>14</span><span class=cl>    disable_crash_reporting Deprecated: fastlane doesn<span class=s1>&#39;t use a crash reporter any more
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=s1>    docs                    Generate a markdown based documentation based on the Fastfile
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=s1>    enable_auto_complete    Enable tab auto completion
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=s1>    enable_crash_reporting  Deprecated: fastlane doesn&#39;</span>t use a crash reporter any more
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=nb>help</span>                    Display global or <span class=o>[</span>command<span class=o>]</span> <span class=nb>help</span> documentation
</span></span><span class=line><span class=ln>19</span><span class=cl>    init                    Helps you with your initial fastlane setup
</span></span><span class=line><span class=ln>20</span><span class=cl>    install_plugins         Install all plugins <span class=k>for</span> this project
</span></span><span class=line><span class=ln>21</span><span class=cl>    lanes                   Lists all available lanes and shows their description
</span></span><span class=line><span class=ln>22</span><span class=cl>    list                    Lists all available lanes without description
</span></span><span class=line><span class=ln>23</span><span class=cl>    new_action              Create a new custom action <span class=k>for</span> fastlane.
</span></span><span class=line><span class=ln>24</span><span class=cl>    new_plugin              Create a new plugin that can be used with fastlane
</span></span><span class=line><span class=ln>25</span><span class=cl>    run                     Run a fastlane one-off action without a full lane
</span></span><span class=line><span class=ln>26</span><span class=cl>    search_plugins          Search <span class=k>for</span> plugins, search query is optional
</span></span><span class=line><span class=ln>27</span><span class=cl>    trigger                 Run a sepcific lane. Pass the lane name and optionally the platform first.
</span></span><span class=line><span class=ln>28</span><span class=cl>    update_plugins          Update all plugin dependencies
</span></span><span class=line><span class=ln>29</span><span class=cl>
</span></span><span class=line><span class=ln>30</span><span class=cl>  Global Options:
</span></span><span class=line><span class=ln>31</span><span class=cl>    --verbose
</span></span><span class=line><span class=ln>32</span><span class=cl>    -h, --help           Display <span class=nb>help</span> documentation
</span></span><span class=line><span class=ln>33</span><span class=cl>    -v, --version        Display version information
</span></span><span class=line><span class=ln>34</span><span class=cl>
</span></span><span class=line><span class=ln>35</span><span class=cl>  Author:
</span></span><span class=line><span class=ln>36</span><span class=cl>    Felix Krause &lt;fastlane@krausefx.com&gt;
</span></span><span class=line><span class=ln>37</span><span class=cl>
</span></span><span class=line><span class=ln>38</span><span class=cl>  Website:
</span></span><span class=line><span class=ln>39</span><span class=cl>    https://fastlane.tools
</span></span><span class=line><span class=ln>40</span><span class=cl>
</span></span><span class=line><span class=ln>41</span><span class=cl>  GitHub:
</span></span><span class=line><span class=ln>42</span><span class=cl>    https://github.com/fastlane/fastlane
</span></span></code></pre></div><p>我会随着下面每个概念的解释和展开来配合上面的命令一起讲解。</p><h2 id=生命周期>生命周期</h2><table><thead><tr><th style=text-align:left>执行顺序</th><th style=text-align:left>方法名</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>1</td><td style=text-align:left>before_all</td><td style=text-align:left>在执行 lane 之前只执行一次</td></tr><tr><td style=text-align:left>2</td><td style=text-align:left>before_each</td><td style=text-align:left>每次执行 lane 之前都会执行一次</td></tr><tr><td style=text-align:left>3</td><td style=text-align:left>lane</td><td style=text-align:left>自定义的任务</td></tr><tr><td style=text-align:left>4</td><td style=text-align:left>after_each</td><td style=text-align:left>每次执行 lane 之后都会执行一次</td></tr><tr><td style=text-align:left>5</td><td style=text-align:left>after_all</td><td style=text-align:left>在执行 lane 成功结束之后执行一次</td></tr><tr><td style=text-align:left>6</td><td style=text-align:left>error</td><td style=text-align:left>在执行上述情况任意环境报错都会中止并执行一次</td></tr></tbody></table><p>以上的部分大家在上一篇已经见识过了，有些还没接触到，不用着急都会一一说明。</p><h2 id=任务lane>任务（lane）</h2><p>正常情况下你可能只会是用到一种任务方法 <code>lane</code> 但其实它会包含很多中高级用法。在文章的末尾会详细描述。</p><h3 id=任务定义>任务定义</h3><p>定义任务的方法类似于 rake 的 task，但使用上缺比前者要好用很多，见下表：</p><table><thead><tr><th style=text-align:left>定义</th><th style=text-align:left>是否必须</th><th style=text-align:left>说明</th><th style=text-align:left>备注</th></tr></thead><tbody><tr><td style=text-align:left>desc</td><td style=text-align:left><code>false</code></td><td style=text-align:left>方法描述</td><td style=text-align:left>可多次使用打到换行的目的</td></tr><tr><td style=text-align:left>name</td><td style=text-align:left><code>true</code></td><td style=text-align:left>方法名</td><td style=text-align:left>符号化的方法名</td></tr><tr><td style=text-align:left>options</td><td style=text-align:left><code>false</code></td><td style=text-align:left>方法参数</td><td style=text-align:left>返回 Hash 类型</td></tr><tr><td style=text-align:left>task</td><td style=text-align:left><code>true</code></td><td style=text-align:left>方法主体</td><td style=text-align:left>参考 ruby 的方法代码且支持 ruby 代码</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln> 1</span><span class=cl><span class=n>desc</span> <span class=s1>&#39;定义一个 build 方法&#39;</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=n>desc</span> <span class=s1>&#39;参数 adhoc 判断是否为内测版本, 默认为 false&#39;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=n>desc</span> <span class=s1>&#39;fastlane build&#39;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=n>desc</span> <span class=s1>&#39;fastlane build adhoc:true&#39;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=n>lane</span> <span class=ss>:build</span> <span class=k>do</span> <span class=o>|</span><span class=n>options</span><span class=o>|</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=c1># task to do something</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=n>adhoc</span> <span class=o>=</span> <span class=n>options</span><span class=o>[</span><span class=ss>:adhoc</span><span class=o>]</span> <span class=o>||</span> <span class=kp>false</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=nb>puts</span> <span class=s2>&#34;adhoc: </span><span class=si>#{</span><span class=n>adhoc</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>  <span class=n>gym</span><span class=p>(</span><span class=ss>type</span><span class=p>:</span> <span class=n>adhoc</span> <span class=p>?</span> <span class=s1>&#39;adhoc&#39;</span> <span class=p>:</span> <span class=s1>&#39;appstore&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h3 id=任务执行>任务执行</h3><p>一般情况下它需要配合定义好的 lane 才能使用，刚刚我们定义的一个 build 方法，我们这里就试着执行一下吧。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># 默认执行</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>$ fastlane build
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=c1># 传递参数</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>$ fastlane build adhoc:true
</span></span></code></pre></div><h3 id=任务互调>任务互调</h3><p><code>lane</code> 其实可以理解为 <code>def</code> 的别名，因此多个 lane 的话实际上是可以相互调用的，这个其实特别实用，这样其实我就可以把 cocoapods 的执行放到单独的 lane 里面而不是 <code>before_all</code>，这样执行非构建的任务就不会执行不相关的任务或动作，因此 fastlane 而产生了一个私有任务用内部使用 <code>private_lane</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln> 1</span><span class=cl>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=n>default_platform</span> <span class=ss>:ios</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=n>platform</span> <span class=ss>:ios</span> <span class=k>do</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>  <span class=n>desc</span> <span class=s1>&#39;构建前的准备工作&#39;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=n>desc</span> <span class=s1>&#39;这是一个私有任务，仅供 Fastfile 内部 lane 调用使用&#39;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=n>lane</span> <span class=ss>:prepare</span> <span class=k>do</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=n>cocoapods</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=n>match</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl>  <span class=n>desc</span> <span class=s1>&#39;通用的构建任务&#39;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>  <span class=n>desc</span> <span class=s1>&#39;fastlane build&#39;</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>  <span class=n>desc</span> <span class=s1>&#39;fastlane build type:adhoc&#39;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>  <span class=n>lane</span> <span class=ss>:build</span> <span class=k>do</span> <span class=o>|</span><span class=n>options</span><span class=o>|</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=c1># 调用上面 prepare 私有任务</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=n>prepare</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=k>case</span> <span class=n>options</span><span class=o>[</span><span class=ss>:type</span><span class=o>]</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=k>when</span> <span class=s1>&#39;adhoc&#39;</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>      <span class=c1># 调用 下面 adhoc 任务</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>      <span class=n>adhoc</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>      <span class=c1># 调用下面 appstore 任务</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>      <span class=n>appstore</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>
</span></span><span class=line><span class=ln>29</span><span class=cl>  <span class=n>desc</span> <span class=s1>&#39;构建 adhoc 任务&#39;</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>  <span class=n>desc</span> <span class=s1>&#39;fastlane adhoc&#39;</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>  <span class=n>lane</span> <span class=ss>:adhoc</span> <span class=k>do</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>    <span class=n>gym</span><span class=p>(</span><span class=ss>type</span><span class=p>:</span> <span class=s1>&#39;adhoc&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>
</span></span><span class=line><span class=ln>35</span><span class=cl>  <span class=n>desc</span> <span class=s1>&#39;构建 appstore 任务&#39;</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>  <span class=n>desc</span> <span class=s1>&#39;fastlane appstore&#39;</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>  <span class=n>lane</span> <span class=ss>:appstore</span> <span class=k>do</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>    <span class=n>gym</span><span class=p>(</span><span class=ss>type</span><span class=p>:</span> <span class=s1>&#39;appstore&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=ln>40</span><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>上面的任务中，<code>build</code>/<code>adhoc</code>/<code>appstore</code> 都可以执行，只有 <code>prepare</code> 是无法通过命令行外部执行，如果执行会直接报错：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>$ fastlane prepare
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=o>[</span>19:17:42<span class=o>]</span>: You can<span class=s1>&#39;t call the private lane &#39;</span>prepare<span class=err>&#39;</span> directly
</span></span></code></pre></div><h3 id=任务返回值>任务返回值</h3><p>和 ruby 的方法一致，每个 lane 最后一行会默认作为返回值（无需 <a href=http://learnrubythehardway.org/book/ex21.html>return</a>）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln>1</span><span class=cl>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=n>lane</span> <span class=ss>:sum</span> <span class=k>do</span> <span class=o>|</span><span class=n>options</span><span class=o>|</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>  <span class=n>options</span><span class=o>[</span><span class=ss>:a</span><span class=o>]</span> <span class=o>+</span> <span class=n>optiona</span><span class=o>[</span><span class=ss>:b</span><span class=o>]</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=n>lane</span> <span class=ss>:calculate</span> <span class=k>do</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>  <span class=n>value</span> <span class=o>=</span> <span class=n>sum</span><span class=p>(</span><span class=ss>a</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=ss>b</span><span class=p>:</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=ln>8</span><span class=cl>  <span class=nb>puts</span> <span class=n>value</span> <span class=c1>#=&gt; 8</span>
</span></span><span class=line><span class=ln>9</span><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h3 id=引入外部任务文件>引入外部任务文件</h3><p><code>Fastfile</code> 除了自身以外还能够引入外部其他的 <code>Fastfile</code> 并调用任务，只需要导入外部文件并使用特殊的方法标识即可：</p><h4 id=1-import---导入本地文件>1. import - 导入本地文件</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln>1</span><span class=cl><span class=c1># 导入 lanes 目录的 AndroidFastfile</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=n>import</span> <span class=s2>&#34;lanes/AndroidFastfile&#34;</span>
</span></span></code></pre></div><h4 id=2-import_from_git---导入-git-仓库文件>2. import_from_git - 导入 git 仓库文件</h4><p>可以直接引入 git 仓库的 Fastfile 文件是一个非常赞的功能，通过使用发现其实现原理是先把 git 仓库克隆下来后在引入相对于的文件，因此建议国内在没有网络加速（翻墙）的情况下尽量不用引入比较大的 git 仓库，否则使用会需要漫长的等待&mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln>1</span><span class=cl><span class=c1># 导入 mozilla/firefox-ios 项目下 fastlane 下面 Fastfile 文件</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=n>import_from_git</span><span class=p>(</span><span class=ss>url</span><span class=p>:</span> <span class=s1>&#39;https://github.com/mozilla/firefox-ios&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=c1># 或者</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=n>import_from_git</span><span class=p>(</span><span class=ss>url</span><span class=p>:</span> <span class=s1>&#39;git@github.com:mozilla/firefox-ios.git&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>               <span class=ss>path</span><span class=p>:</span> <span class=s1>&#39;fastlane/Fastfile&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>假若外部引入的 <code>Fastfile</code> 有个方法是 <strong>build</strong>，在命令行工具直接执行即可，如果外部和内部都有相同的任务名，执行会直接报错：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>$ fastlane ios build
</span></span><span class=line><span class=ln>2</span><span class=cl>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=o>[</span>!<span class=o>]</span> Lane <span class=s1>&#39;gradle&#39;</span> was defined multiple times!
</span></span></code></pre></div><p>如果发生这样的事情且你希望在主体 <code>Fastfile</code> 也调用的话需要使用特殊的方法定义：<code>override_lane</code></p><blockquote><p>注意：此方法只会覆盖外部的相同方法名的代码执行，目前暂时无法使用类似 ruby 的 <code>super</code> 继承原由方法！</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln>1</span><span class=cl><span class=n>override_lane</span> <span class=ss>:build</span> <span class=k>do</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h3 id=任务查看>任务查看</h3><p>只需执行下面这行命令就可以看到非私有任务的可用列表信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>$ fastlane lanes
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl>--------- ios---------
</span></span><span class=line><span class=ln> 4</span><span class=cl>----- fastlane ios build
</span></span><span class=line><span class=ln> 5</span><span class=cl>通用的构建任务
</span></span><span class=line><span class=ln> 6</span><span class=cl>fastlane build
</span></span><span class=line><span class=ln> 7</span><span class=cl>fastlane build type:adhoc
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl>----- fastlane ios adhoc
</span></span><span class=line><span class=ln>10</span><span class=cl>构建 adhoc 任务
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl>----- fastlane ios appstore
</span></span><span class=line><span class=ln>13</span><span class=cl>构建 appstore 任务
</span></span><span class=line><span class=ln>14</span><span class=cl>
</span></span><span class=line><span class=ln>15</span><span class=cl>Execute using <span class=sb>`</span>fastlane <span class=o>[</span>lane_name<span class=o>]</span><span class=sb>`</span>
</span></span></code></pre></div><h2 id=扩展action>扩展（Action）</h2><p>扩展是 fastlane 的杀手锏，重在集成了众多非常优秀好用的方法供 lane 内部使用，截至 fastlane v<code>1.98.0</code> 版本以包含 175 个扩展，这个数量还在陆续增加中。扩展初期是由发起人一个人完成，后续的大部分都是社区共享，如果你发现没有你想要的扩展，可以先去 <a href="https://github.com/fastlane/fastlane/issues?q=is%3Aopen+is%3Aissue+label%3Aaction">issues</a> 搜索下没有要么自己动手提交要么只有等待了.</p><h3 id=扩展列表>扩展列表</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>$ fastlane actions
</span></span><span class=line><span class=ln> 2</span><span class=cl>+--------------------+-------------------------------------------------------------+------------------+
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=p>|</span>                                   Available fastlane actions                                        <span class=p>|</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>+--------------------+-------------------------------------------------------------+------------------+
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=p>|</span> Action             <span class=p>|</span> Description                                                 <span class=p>|</span> Author           <span class=p>|</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>+--------------------+-------------------------------------------------------------+------------------+
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=p>|</span> adb                <span class=p>|</span> Run ADB Actions                                             <span class=p>|</span> hjanuschka       <span class=p>|</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=p>|</span> adb_devices        <span class=p>|</span> Get an Array of Connected android device serials            <span class=p>|</span> hjanuschka       <span class=p>|</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=p>|</span> add_git_tag        <span class=p>|</span> This will add an annotated git tag to the current branch    <span class=p>|</span> Multiple         <span class=p>|</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>...
</span></span><span class=line><span class=ln>11</span><span class=cl>+--------------------+-------------------------------------------------------------+------------------+
</span></span><span class=line><span class=ln>12</span><span class=cl>  Total of <span class=m>175</span> actions
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl>Get more information <span class=k>for</span> one specific action using <span class=sb>`</span>fastlane action <span class=o>[</span>name<span class=o>]</span><span class=sb>`</span>
</span></span></code></pre></div><h3 id=扩展使用帮助>扩展使用帮助</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl><span class=c1># 查看 adb 扩展的使用帮助</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>$ fastlane action adb
</span></span><span class=line><span class=ln> 3</span><span class=cl>Loading documentation <span class=k>for</span> adb:
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl>+---------------------------------+
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=p>|</span>               adb               <span class=p>|</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>+---------------------------------+
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=p>|</span> Run ADB Actions                 <span class=p>|</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=p>|</span>                                 <span class=p>|</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=p>|</span> see adb --help <span class=k>for</span> more details <span class=p>|</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=p>|</span>                                 <span class=p>|</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=p>|</span> Created by hjanuschka           <span class=p>|</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>+---------------------------------+
</span></span><span class=line><span class=ln>14</span><span class=cl>
</span></span><span class=line><span class=ln>15</span><span class=cl>+----------+----------------------------------------------------------------------+-------------------+---------+
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=p>|</span>                                                  adb Options                                                  <span class=p>|</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>+----------+----------------------------------------------------------------------+-------------------+---------+
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=p>|</span> Key      <span class=p>|</span> Description                                                          <span class=p>|</span> Env Var           <span class=p>|</span> Default <span class=p>|</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>+----------+----------------------------------------------------------------------+-------------------+---------+
</span></span><span class=line><span class=ln>20</span><span class=cl><span class=p>|</span> serial   <span class=p>|</span> Android serial, which device should be used <span class=k>for</span> this <span class=nb>command</span>         <span class=p>|</span> FL_ANDROID_SERIAL <span class=p>|</span>         <span class=p>|</span>
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=p>|</span> <span class=nb>command</span>  <span class=p>|</span> All commands you want to pass to the adb command, e.g. <span class=sb>`</span>kill-server<span class=sb>`</span> <span class=p>|</span> FL_ADB_COMMAND    <span class=p>|</span>         <span class=p>|</span>
</span></span><span class=line><span class=ln>22</span><span class=cl><span class=p>|</span> adb_path <span class=p>|</span> The path to your <span class=sb>`</span>adb<span class=sb>`</span> binary                                        <span class=p>|</span> FL_ADB_PATH       <span class=p>|</span> adb     <span class=p>|</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>+----------+----------------------------------------------------------------------+-------------------+---------+
</span></span><span class=line><span class=ln>24</span><span class=cl>
</span></span><span class=line><span class=ln>25</span><span class=cl>+-------------------------------+
</span></span><span class=line><span class=ln>26</span><span class=cl><span class=p>|</span>       adb Return Value        <span class=p>|</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>+-------------------------------+
</span></span><span class=line><span class=ln>28</span><span class=cl><span class=p>|</span> The output of the adb <span class=nb>command</span> <span class=p>|</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>+-------------------------------+
</span></span><span class=line><span class=ln>30</span><span class=cl>
</span></span><span class=line><span class=ln>31</span><span class=cl>More information can be found on https://github.com/fastlane/fastlane/blob/master/fastlane/docs/Actions.md
</span></span></code></pre></div><h3 id=创建自定义扩展>创建自定义扩展</h3><p>通过内置的命令创建你需要的扩展，扩展名必须是全部小写且只能使用下划线分割词组，生成好的扩展文件会在 <code>fastlane/actions</code> 目录找到:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>$ fastlane new_action
</span></span><span class=line><span class=ln>2</span><span class=cl>Must be lower <span class=k>case</span>, and use a <span class=s1>&#39;_&#39;</span> between words. Do not use <span class=s1>&#39;.&#39;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>examples: <span class=s1>&#39;testflight&#39;</span>, <span class=s1>&#39;upload_to_s3&#39;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>Name of your action: hello
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=o>[</span>15:33:15<span class=o>]</span>: Created new action file <span class=s1>&#39;./fastlane/actions/hello.rb&#39;</span>. Edit it to implement your custom action.
</span></span></code></pre></div><p>这块会占比较大的篇幅，尽情期待后续的展开。</p><h3 id=引入外部扩展>引入外部扩展</h3><p>这块其实也有两种方法可以引入，文件引入是官方教程提供的方法，第二种是我个人尝试出来的，第三种是最近版本才官方支持的。</p><h4 id=1-本地文件引入>1. 本地文件引入</h4><p>自定义的扩展其实也算是本地文件引入的一种形式，当然位于其他路径的通过指定方法也能做到</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln>1</span><span class=cl><span class=c1># 引入项目根目录 script/share_actions 路径</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=n>actions_path</span> <span class=s1>&#39;../script/share_actions&#39;</span>
</span></span></code></pre></div><h4 id=2-rubygem-引入>2. rubygem 引入</h4><blockquote><p>不再建议使用本方法，请看第三种插件引入。</p></blockquote><p>我在团队内部创建了一个自定义的扩展，仅限于团队内部使用而无法贡献社区，我只能采取封装成 ruby gem 包，通过 ruby 的 <code>require</code> 方式引入，最终可以完美支持，目前已在项目中使用大半年之久。最重要的是我是开源的：<a href=https://github.com/icyleaf/fastlane-qyer>fastlane-qyer</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln>1</span><span class=cl><span class=c1># 首先安装需要的 rubygem: gem install fastlane-qyer</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=nb>require</span> <span class=s1>&#39;fastlane-qyer&#39;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=n>lane</span> <span class=ss>:upload</span> <span class=k>do</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>  <span class=n>qyer</span><span class=p>(</span><span class=ss>api_key</span><span class=p>:</span> <span class=s1>&#39;[token]&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>注意，使用 rubygem 引入的无法在 fastlane actions 中显示出来，也无法使用 fastlane action [name] 查看使用帮助。我猜想一是官方没有这样提供思路，二是就算你引入了 gem 也不是特别好判断里面的文件结构。</p><h4 id=3-插件引入>3. 插件引入</h4><p>我注意到 <a href=https://github.com/fastlane/fastlane/releases/tag/1.93.0>1.93.0</a> 增加了插件机制，很好的解决第二种出现的一些问题。大概看了一下主要是采用 <code>Gemfile</code> 的方式使用 <code>Pluginfile</code> 维护了引入第三方插件列表。实现原理还是属于第二种方法。</p><p>通过 <code>fastlane search_plugins</code> 查看当前支持的插件，并使用 <code>fastlane add_plugins [name]</code> 引入。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>$ fastlane search_plugins
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=o>[</span>16:04:33<span class=o>]</span>: Listing all available fastlane plugins
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl>+--------------------------+---------------------------------------------------+-----------+
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=p>|</span>                                Available fastlane plugins                                <span class=p>|</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>+--------------------------+---------------------------------------------------+-----------+
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=p>|</span> Name                     <span class=p>|</span> Description                                       <span class=p>|</span> Downloads <span class=p>|</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>+--------------------------+---------------------------------------------------+-----------+
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=p>|</span> ruby                     <span class=p>|</span> Useful fastlane actions <span class=k>for</span> Ruby projects         <span class=p>|</span> <span class=m>782</span>       <span class=p>|</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=p>|</span> versioning               <span class=p>|</span> Allows to work set/get app version directly       <span class=p>|</span> <span class=m>758</span>       <span class=p>|</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=p>|</span>                          <span class=p>|</span> to/from Info.plist                                <span class=p>|</span>           <span class=p>|</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=p>|</span> branding                 <span class=p>|</span> Add some branding to your fastlane output         <span class=p>|</span> <span class=m>716</span>       <span class=p>|</span>
</span></span><span class=line><span class=ln>13</span><span class=cl><span class=p>|</span> instrumented_tests       <span class=p>|</span> New action to run instrumented tests <span class=k>for</span> android. <span class=p>|</span> <span class=m>590</span>       <span class=p>|</span>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=p>|</span>                          <span class=p>|</span> This basically creates and boots an emulator      <span class=p>|</span>           <span class=p>|</span>
</span></span><span class=line><span class=ln>15</span><span class=cl><span class=p>|</span>                          <span class=p>|</span> before running an gradle commands so that you can <span class=p>|</span>           <span class=p>|</span>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=p>|</span>                          <span class=p>|</span> run instrumented tests against that emulator.     <span class=p>|</span>           <span class=p>|</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=p>|</span>                          <span class=p>|</span> After the gradle <span class=nb>command</span> is executed, the avd     <span class=p>|</span>           <span class=p>|</span>
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=p>|</span>                          <span class=p>|</span> gets shut down and deleted. This is really        <span class=p>|</span>           <span class=p>|</span>
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=p>|</span>                          <span class=p>|</span> helpful on CI services, keeping them clean and    <span class=p>|</span>           <span class=p>|</span>
</span></span><span class=line><span class=ln>20</span><span class=cl><span class=p>|</span>                          <span class=p>|</span> always having a fresh avd <span class=k>for</span> testing.            <span class=p>|</span>           <span class=p>|</span>
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=p>|</span> xamarin_build            <span class=p>|</span> Build xamarin android<span class=se>\i</span>os projects                <span class=p>|</span> <span class=m>582</span>       <span class=p>|</span>
</span></span><span class=line><span class=ln>22</span><span class=cl><span class=p>|</span> appicon                  <span class=p>|</span> Generate required icon sizes and iconset from a   <span class=p>|</span> <span class=m>509</span>       <span class=p>|</span>
</span></span><span class=line><span class=ln>23</span><span class=cl><span class=p>|</span>                          <span class=p>|</span> master application icon.                          <span class=p>|</span>           <span class=p>|</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>...
</span></span><span class=line><span class=ln>25</span><span class=cl><span class=p>|</span> download_file            <span class=p>|</span> This action downloads a file from an HTTP/HTTPS   <span class=p>|</span> <span class=m>171</span>       <span class=p>|</span>
</span></span><span class=line><span class=ln>26</span><span class=cl><span class=p>|</span>                          <span class=p>|</span> url <span class=o>(</span>e.g. ZIP file<span class=o>)</span> and puts it in a destination  <span class=p>|</span>           <span class=p>|</span>
</span></span><span class=line><span class=ln>27</span><span class=cl><span class=p>|</span>                          <span class=p>|</span> path                                              <span class=p>|</span>           <span class=p>|</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>+--------------------------+---------------------------------------------------+-----------+
</span></span><span class=line><span class=ln>29</span><span class=cl>
</span></span><span class=line><span class=ln>30</span><span class=cl><span class=c1># 添加 sentry 插件</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>$ fastlane add_plugin sentry
</span></span><span class=line><span class=ln>32</span><span class=cl><span class=o>[</span>16:16:23<span class=o>]</span>: Plugin <span class=s1>&#39;fastlane-plugin-sentry&#39;</span> was added to <span class=s1>&#39;./fastlane/Pluginfile&#39;</span>
</span></span><span class=line><span class=ln>33</span><span class=cl><span class=o>[</span>16:16:23<span class=o>]</span>: It looks like fastlane plugins are not yet <span class=nb>set</span> up <span class=k>for</span> this project.
</span></span><span class=line><span class=ln>34</span><span class=cl><span class=o>[</span>16:16:23<span class=o>]</span>: fastlane will create a new Gemfile at path <span class=s1>&#39;Gemfile&#39;</span>
</span></span><span class=line><span class=ln>35</span><span class=cl><span class=o>[</span>16:16:23<span class=o>]</span>: This change is neccessary <span class=k>for</span> fastlane plugins to work
</span></span><span class=line><span class=ln>36</span><span class=cl>Should fastlane modify the Gemfile at path <span class=s1>&#39;Gemfile&#39;</span> <span class=k>for</span> you? <span class=o>(</span>y/n<span class=o>)</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>y
</span></span><span class=line><span class=ln>38</span><span class=cl><span class=o>[</span>16:16:29<span class=o>]</span>: Successfully modified <span class=s1>&#39;Gemfile&#39;</span>
</span></span><span class=line><span class=ln>39</span><span class=cl><span class=o>[</span>16:16:29<span class=o>]</span>: Make sure to commit your Gemfile, Gemfile.lock and Pluginfile to version control
</span></span><span class=line><span class=ln>40</span><span class=cl>Installing plugin dependencies...
</span></span><span class=line><span class=ln>41</span><span class=cl>Successfully installed plugins
</span></span><span class=line><span class=ln>42</span><span class=cl>
</span></span><span class=line><span class=ln>43</span><span class=cl>$ cat fastlane/Pluginfile
</span></span><span class=line><span class=ln>44</span><span class=cl><span class=c1># Autogenerated by fastlane</span>
</span></span><span class=line><span class=ln>45</span><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=ln>46</span><span class=cl><span class=c1># Ensure this file is checked in to source control!</span>
</span></span><span class=line><span class=ln>47</span><span class=cl>
</span></span><span class=line><span class=ln>48</span><span class=cl>gem <span class=s1>&#39;fastlane-plugin-sentry&#39;</span>
</span></span></code></pre></div><p>更详细的继续期待后续报道，我要挖坑无数。</p><h3 id=扩展的命令行调用>扩展的命令行调用</h3><p>社区的力量果然是很强大的，陆续添加了那么多功能，早期用户表示不开心！嗯，由于社区的呼声和贡献目前可以通过命令调用扩展：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># 使用 notification 扩展发送一个通知消息</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>$ fastlane run notification message:<span class=s2>&#34;Hi macOS&#34;</span> title:<span class=s2>&#34;Fastlane Notification&#34;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=o>[</span>15:58:05<span class=o>]</span>: --------------------------
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=o>[</span>15:58:05<span class=o>]</span>: --- Step: notification ---
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=o>[</span>15:58:05<span class=o>]</span>: --------------------------
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=o>[</span>15:58:05<span class=o>]</span>: Result: <span class=nb>true</span>
</span></span></code></pre></div><h2 id=辅助功能>辅助功能</h2><h3 id=自动更新>自动更新</h3><p>fastlane 提供一个方法 <code>update_fastlane</code> 用于对于自身的版本检查和更新，这个第一篇文章我也有提到过。它其实一个是一个扩展，使用 <code>fastlane action update_fastlane</code> 能够看到使用帮助。它有一个参数是可以指定检查特定的 fastlane 工具并进行更新，但其实它是使用 rubygems 进行对 gem 的更新，因此这块其实可以传入任何需要检查并更新的 gem：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln>1</span><span class=cl><span class=n>update_fastlane</span><span class=p>(</span><span class=ss>tools</span><span class=p>:</span><span class=s1>&#39;fastlane,gym,match,cocoapods,rest-client&#39;</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=环境变量>环境变量</h3><p>从 fastlane 的设计体系上在各个地方都加入了环境变量的支持，每个扩展的参数、以及扩展需要共享给其他扩展和任务读取的数据都是通过环境变量获取，如下是我收集的比较常用的列表：</p><table><thead><tr><th style=text-align:left>环境变量</th><th style=text-align:left>来源</th><th style=text-align:left>说明</th><th style=text-align:left>备注</th></tr></thead><tbody><tr><td style=text-align:left>FASTLANE_USER</td><td style=text-align:left>credentials_manager</td><td style=text-align:left>Apple 开发者账户名</td><td style=text-align:left>验证通过后会保存 Keychain</td></tr><tr><td style=text-align:left>FASTLANE_PASSWORD</td><td style=text-align:left>credentials_manager</td><td style=text-align:left>Apple 开发者账户密码</td><td style=text-align:left>验证通过后会保存 Keychain</td></tr><tr><td style=text-align:left>FASTLANE_TEAM_IDCERT_TEAM_ID</td><td style=text-align:left>producesigh</td><td style=text-align:left>Apple 团队 ID</td><td style=text-align:left></td></tr><tr><td style=text-align:left>DELIVER_USER&lt;br >PRODUCE_USERNAME</td><td style=text-align:left>deliverproduce</td><td style=text-align:left>iTunesConnect 账户名</td><td style=text-align:left></td></tr><tr><td style=text-align:left>DELIVER_PASSWORD</td><td style=text-align:left>deliver</td><td style=text-align:left>iTunesConnect 账户密码</td><td style=text-align:left></td></tr><tr><td style=text-align:left>MATCH_PASSWORD</td><td style=text-align:left>match</td><td style=text-align:left>证书加/解密密码</td><td style=text-align:left></td></tr><tr><td style=text-align:left>FASTLANE_XCODE_LIST_TIMEOUT</td><td style=text-align:left>fastlane_core</td><td style=text-align:left>获取 iOS Scheme 的超时时间</td><td style=text-align:left>默认 10s</td></tr></tbody></table><div class=post-donate><p class=post-donate-title>如果你觉得我的文章对你有帮助，欢迎打赏，这对我非常重要，谢谢！</p><div class=post-donate-channel><img src=https://icyleaf.com/images/donate/alipay.png alt=支付宝打赏>
<img src=https://icyleaf.com/images/donate/wechat.png alt=微信打赏></div></div></div></div><div class=post-nav><a href=https://icyleaf.com/2016/07/gitlab-api-wrapper-for-crystal/ class=prev rel=prev title="Gitlab API Wrapper for Crystal"><i class="iconfont icon-left"></i>&nbsp;Gitlab API Wrapper for Crystal</a>
<a href=https://icyleaf.com/2016/08/how-to-install-rancher-on-osx/ class=next rel=next title="如何在 OS X 上安装 Rancher">如何在 OS X 上安装 Rancher&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><script>var getTheme=window.localStorage&&window.localStorage.getItem("blog-dark-mode"),getTheme=getTheme??"github-light";let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","icyleaf/icyleaf.com"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.post-comment").innerHTML="",document.querySelector("div.post-comment").appendChild(s)</script></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2024</span>
<span>🍺</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script defer src=https://fastly.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script><script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: () => import('\/photoswipe\/photoswipe.esm.js'),
  });
  lightbox.init();
</script></div></body></html>