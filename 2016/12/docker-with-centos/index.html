<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Docker 摸爬滚打对抗 CentOS 6 | icyleaf</title><link rel=prev href=https://icyleaf.com/2016/08/how-to-install-rancher-on-osx/><link rel=next href=https://icyleaf.com/2017/03/how-to-get-temporary-car-license-in-beijing/><link rel=canonical href=https://icyleaf.com/2016/12/docker-with-centos/><link rel=apple-touch-icon sizes=180x180 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.css><meta name=title content="Docker 摸爬滚打对抗 CentOS 6 | icyleaf"><meta name=author content="icyleaf"><meta name=description content="日常写代码热爱户外的梦想家"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/icyleaf.com\/"},"articleSection":"posts","name":"Docker 摸爬滚打对抗 CentOS 6","headline":"Docker 摸爬滚打对抗 CentOS 6","description":"2018年10月18日更新： 国庆期间恰巧服务器硬盘故障且运维并没有做 raid 备份，给更换了一台新内部服务器，索性升级到了 CentOS 7，因此针对 \u000fCentOS 6 安装 Docker 的","inLanguage":"zh-cn","author":"icyleaf","creator":"icyleaf","publisher":"icyleaf","accountablePerson":"icyleaf","copyrightHolder":"icyleaf","copyrightYear":"2016","datePublished":"2016-12-30 17:52:30 \u002b0800 \u002b0800","dateModified":"2016-12-30 17:52:30 \u002b0800 \u002b0800","url":"https:\/\/icyleaf.com\/2016\/12\/docker-with-centos\/","wordCount":"1303","keywords":["docker","centos","icyleaf"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-back2home-logo"><span class=logo_mark>>$</span>
<a href=https://icyleaf.com/><span class=logo_text>cd /home/</span>
<span class=logo_cursor></span></a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/posts title>Posts</a>
<a class=menu-item href=https://icyleaf.com/categories title>Categories</a>
<a class=menu-item href=https://icyleaf.com/tags title>Tags</a>
<a class=menu-item href=https://icyleaf.com/about title>About</a>
<span class=divide></span><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/posts title><h3>Posts</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/categories title><h3>Categories</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/tags title><h3>Tags</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/about title><h3>About</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=post-cover><img src=https://icyleaf.com/images/cover.jpg></div><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">Docker 摸爬滚打对抗 CentOS 6</h1><div class=post-meta>Written by <a itemprop=name href=https://icyleaf.com/ rel=author>icyleaf</a> with ♥
<span class=post-time>on <time datetime=2016-12-30 itemprop=datePublished>December 30, 2016</time></span>
in
<i class="iconfont icon-folder"></i>
<span class=post-category><a href=https://icyleaf.com/categories/technology/>Technology,</a></span>
<span class=post-word-count>1303 words</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#安装-docker>安装 Docker</a><ul><li><a href=#171>1.7.1</a></li><li><a href=#171-以上版本>1.7.1 以上版本</a></li></ul></li><li><a href=#配置-docker>配置 Docker</a></li><li><a href=#疑难杂症>疑难杂症</a><ul><li></li></ul></li></ul></nav></div></div><div class=post-content><blockquote><p>2018年10月18日更新：</p></blockquote><p>国庆期间恰巧服务器硬盘故障且运维并没有做 raid 备份，给更换了一台新内部服务器，索性升级到了 CentOS 7，因此针对 CentOS 6 安装 Docker 的答疑不再更新。</p><h2 id=前言>前言</h2><p>前不久终于把我们移动团队内部服务器从 CentOS 5.x 升级到了 6.8。本来是拜托让升级至 7.0 版本起码能用上 docker 1.12 版本还是靠谱的事情。
事情往往难以预料的被告知其他团队在安装 7.0 之后造成内部服务器群的网卡失灵的诡异故障只能作罢，想想起码还有个早期 docker 版本可安装也就先这么着吧。</p><p>这个是在 <a href=http://icyleaf.com/2013/09/how-to-install-gitlab-on-centos/>如何在CentOS 上安装Gitlab</a> 之后有一个无奈的使用指南，
因为运维也有他的考虑方面，参见知乎讨论：<a href=https://www.zhihu.com/question/29191794>如何说服运维选择 Debian/Ubuntu 而不是 CentOS</a></p><h2 id=安装-docker>安装 Docker</h2><h3 id=171>1.7.1</h3><p>Docker 最后一个支持 CentOS 6 的版本是 1.7.1 还必须安装 epel 源之后就<a href=https://github.com/docker/docker/issues/14365>被大家欢天喜地的抛弃了 6 的支持</a>。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>sudo rpm -ivh http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
<span class=ln>2</span>sudo yum -y remove docker
<span class=ln>3</span>sudo yum install libselinux-python docker-io
</code></pre></div><blockquote><p>由于 yum 内 docker 已经被其他使用，不用安装错误了。</p></blockquote><h3 id=171-以上版本>1.7.1 以上版本</h3><p><strong>请果断放弃这种想法</strong>，虽然你可能在网上搜索有个别的文章说把内核升级到 3.10 后可以安装 docker 1.9 版本，经过我个人反复测试根本不可行！</p><p>当然如果你还是坚持想尝试，请参考如下链接：</p><ul><li><a href=http://www.pangxie.space/docker/364>http://www.pangxie.space/docker/364</a></li><li><a href=http://www.cnblogs.com/dongdongwq/p/5381752.html>http://www.cnblogs.com/dongdongwq/p/5381752.html</a></li><li><a href=http://0evin.com/2016/06/17/%5B%E5%8E%9F%E5%88%9B%5DCentOS6.5%E5%AE%89%E8%A3%85Docker1.11.X%E7%89%88%E6%9C%AC/>http://0evin.com/2016/06/17/%5B%E5%8E%9F%E5%88%9B%5DCentOS6.5%E5%AE%89%E8%A3%85Docker1.11.X%E7%89%88%E6%9C%AC/</a></li></ul><h2 id=配置-docker>配置 Docker</h2><p>安装成功后先不要配置开机自启动和启动服务，docker 的官方镜像在国内众所周知的慢的一塌糊涂，如果你是在国内服务器使用请参考如下配置。</p><p>我这里把我个人私藏已久的好用的镜像告诉大家，大家可不要以为我用的是阿里云或者 DaoCloud 这类有很多限制的玩意：</p><ul><li>中国科技大学镜像：https://docker.mirrors.ustc.edu.cn</li><li>网易蜂巢镜像：http://hub-mirror.c.163.com</li></ul><p>同样需要注意的是 1.7.1 版本的 docker 配置文件是在 <code>/etc/sysconfig/docker</code> 而不是网上和官方说的 <code>/etc/default/docker</code> 打开此文件在 other_args 配置对于的源即可。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln> 1</span><span class=c1># /etc/sysconfig/docker</span>
<span class=ln> 2</span><span class=c1>#</span>
<span class=ln> 3</span><span class=c1># Other arguments to pass to the docker daemon process</span>
<span class=ln> 4</span><span class=c1># These will be parsed by the sysv initscript and appended</span>
<span class=ln> 5</span><span class=c1># to the arguments list passed to docker -d</span>
<span class=ln> 6</span>
<span class=ln> 7</span><span class=c1>#other_args=</span>
<span class=ln> 8</span><span class=c1>#other_args=&#34;--registry-mirror=http://hub-mirror.c.163.com&#34;</span>
<span class=ln> 9</span><span class=nv>other_args</span><span class=o>=</span><span class=s2>&#34;--registry-mirror=https://docker.mirrors.ustc.edu.cn&#34;</span>
<span class=ln>10</span>
<span class=ln>11</span><span class=nv>DOCKER_CERT_PATH</span><span class=o>=</span>/etc/docker
<span class=ln>12</span>
<span class=ln>13</span><span class=c1># Resolves: rhbz#1176302 (docker issue #407)</span>
<span class=ln>14</span><span class=nv>DOCKER_NOWARN_KERNEL_VERSION</span><span class=o>=</span><span class=m>1</span>
<span class=ln>15</span>
<span class=ln>16</span><span class=c1># Location used for temporary files, such as those created by</span>
<span class=ln>17</span><span class=c1># # docker load and build operations. Default is /var/lib/docker/tmp</span>
<span class=ln>18</span><span class=c1># # Can be overriden by setting the following environment variable.</span>
<span class=ln>19</span><span class=c1># # DOCKER_TMPDIR=/var/tmp</span>
</code></pre></div><p>后面就没什么好说的了，启动服务和设置开机自启动就完事了</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>sudo chkconfig docker on
<span class=ln>2</span>sudo service docker start
</code></pre></div><p>验证下启动的服务是否已经配置了国内镜像源</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>$ ps aux <span class=p>|</span> grep <span class=s2>&#34;docker -d&#34;</span>
<span class=ln>2</span>
<span class=ln>3</span>root     <span class=m>16992</span>  0.1  0.1 <span class=m>1239860</span> <span class=m>32276</span> ?       Sl   Dec29   2:02 /usr/bin/docker -d --registry-mirror<span class=o>=</span>https://docker.mirrors.ustc.edu.cn
<span class=ln>4</span>root     <span class=m>26873</span>  0.0  0.0 <span class=m>103332</span>   <span class=m>876</span> pts/2    S+   18:16   0:00 grep docker -d
</code></pre></div><h2 id=疑难杂症>疑难杂症</h2><h4 id=1-使用国内镜像源-pull-镜像偶尔会失败反复几次就可以解决>1. 使用国内镜像源 pull 镜像偶尔会失败，反复几次就可以解决</h4><p>频次不高原因未知，因此还未重视。</p><h4 id=2-docker-web-管理工具>2. Docker Web 管理工具</h4><blockquote><p>2018年10月更新：</p></blockquote><p>推荐使用 <a href=https://github.com/portainer/portainer>portainer</a> ，兼容 1.7 的部分功能可能会发生部分功能和参数无法显示但不影响使用。之前我有推荐 rancher（可参考前篇文章：<a href=http://icyleaf.com/2016/08/how-to-install-rancher-on-osx/>如何在 OS X 上安装 Rancher
</a>），但 rancher 官方要求 docker 最低版本是 1.9+。</p><h4 id=3-docker-进程挂了重启后无法恢复之前的-containers>3. Docker 进程挂了重启后无法恢复之前的 containers</h4><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>$ docker start c39206003c7a
<span class=ln>2</span>Error: Cannot start container c39206003c7a: Error getting container c39206003c7ae8992a554a9ac2ea130327fc4af1b2c389656c34baf9a56c84b5 from driver devicemapper: Error mounting <span class=s1>&#39;/dev/mapper/docker-253:0-267081-c39206003c7ae8992a554a9ac2ea130327fc4af1b2c389656c34baf9a56c84b5&#39;</span> on <span class=s1>&#39;/var/lib/docker/devicemapper/mnt/c39206003c7ae8992a554a9ac2ea130327fc4af1b2c389656c34baf9a56c84b5&#39;</span>: device or resource busy
<span class=ln>3</span>2014/05/08 19:14:57 Error: failed to start one or more containers
</code></pre></div><p>这种一般是因为意外终止进程造成上次的 volume 没有正常 unmount，只需手动操作下即可：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>unmount /var/lib/docker/devicemapper/mnt/d640aea67108b04c6a5ba14645966b092db1f807f3e3f41dca7a1470f76b68fb
</code></pre></div><blockquote><p><code>d640aea67108b04c6a5ba14645966b092db1f807f3e3f41dca7a1470f76b68fb</code> 是根据不同 container 生成的，请根据实际情况复制和执行。</p></blockquote><p>这个真没办法，只能在 Dockerfile 或者进实例里面进行修改时区，这个我就不过多赘述了。</p><h4 id=4-升级运行的-container-版本>4. 升级运行的 container 版本</h4><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>$ docker stop xxxx
<span class=ln>2</span>$ docker create --volumes-from &lt;container_name_of_original_server&gt; <span class=se>\ </span>--name xxx-data image/name:&lt;tag_of_previous_rancher_server&gt;
<span class=ln>3</span>$ docker pull image/name:latest
<span class=ln>4</span>$ docker run -d --volumes-from xxx-data --restart<span class=o>=</span>unless-stopped <span class=se>\ </span>-p 8080:8080 image/namel.:latest
</code></pre></div><h4 id=5-非-root-用户执行-docker>5. 非 root 用户执行 docker</h4><p>创建 docker 用户组并重启 docker 服务，之后把你想要的用户加到 docker 用户组即可。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>$ groupadd docker
<span class=ln>2</span>$ service docker restart
<span class=ln>3</span>$ usermod -a -G docker icyleaf
</code></pre></div><h4 id=6-宿主机-cst-时间会造成-docker-实例时间不准>6. 宿主机 CST 时间会造成 docker 实例时间不准</h4><p>这个真没办法，只能在 Dockerfile 或者进实例里面进行修改时区，这个我就不过多赘述了。</p></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>icyleaf</span></p><p class=copyright-item><span>Link:</span>
<a href=https://icyleaf.com/2016/12/docker-with-centos/>https://icyleaf.com/2016/12/docker-with-centos/</a></p></div><div class=post-tags><section><i class="iconfont icon-tag"></i>Tag(s):
<span class=tag><a href=https://icyleaf.com/tags/docker/>#docker</a></span>
<span class=tag><a href=https://icyleaf.com/tags/centos/>#centos</a></span></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://icyleaf.com/>home</a></span></section></div><div class=post-nav><a href=https://icyleaf.com/2016/08/how-to-install-rancher-on-osx/ class=prev rel=prev title="如何在 OS X 上安装 Rancher"><i class="iconfont icon-left"></i>&nbsp;如何在 OS X 上安装 Rancher</a>
<a href=https://icyleaf.com/2017/03/how-to-get-temporary-car-license-in-beijing/ class=next rel=next title=北京上临时牌照流程>北京上临时牌照流程&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//icyleaf.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2021</span>
<span>🍺</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span>
| <span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/icyleaf/hugo-theme-nicesima target=_blank rel="external nofollow">nicesima</a></span></div></footer><script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script><script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script>pangu.spacingPage()</script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-2570916-5','auto'),ga('send','pageview')</script></div></body></html>