<!doctype html><html lang=zh-cn></html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Rails æ„å»ºé•œåƒå®‰å…¨å¤„ç†åŠ å¯†å‡­è¯ | icyleaf</title><meta name=keywords content="Rails,Docker"><meta name=description content="Docker æ„å»ºé•œåƒè¯¥å¦‚ä½•æ­£ç¡®å¤„ç† master key å’Œ credentials.yml.enc"><meta name=author content="icyleaf"><link rel=canonical href=https://icyleaf.com/2022/09/rails-build-docker-image-handle-encrypted-credentials-securely/><link rel=icon href=https://icyleaf.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://icyleaf.com/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=https://icyleaf.com/android-chrome-512x512.png><link rel=apple-touch-icon href=https://icyleaf.com/apple-touch-icon.png><link rel=mask-icon href=https://icyleaf.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.min.css><link rel=canonical href=https://icyleaf.com/2022/09/rails-build-docker-image-handle-encrypted-credentials-securely/><meta property="og:title" content="Rails æ„å»ºé•œåƒå®‰å…¨å¤„ç†åŠ å¯†å‡­è¯"><meta property="og:description" content="Docker æ„å»ºé•œåƒè¯¥å¦‚ä½•æ­£ç¡®å¤„ç† master key å’Œ credentials.yml.enc"><meta property="og:type" content="article"><meta property="og:url" content="https://icyleaf.com/2022/09/rails-build-docker-image-handle-encrypted-credentials-securely/"><meta property="og:image" content="https://images.unsplash.com/photo-1584949091598-c31daaaa4aa9?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2370&q=80"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-15T13:58:31+08:00"><meta property="article:modified_time" content="2022-09-15T13:58:31+08:00"><meta property="og:see_also" content="https://icyleaf.com/2022/09/perfect-solution-to-steup-rails-encrypted-credentials/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1584949091598-c31daaaa4aa9?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2370&q=80"><meta name=twitter:title content="Rails æ„å»ºé•œåƒå®‰å…¨å¤„ç†åŠ å¯†å‡­è¯"><meta name=twitter:description content="Docker æ„å»ºé•œåƒè¯¥å¦‚ä½•æ­£ç¡®å¤„ç† master key å’Œ credentials.yml.enc"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://icyleaf.com/posts/"},{"@type":"ListItem","position":2,"name":"Rails æ„å»ºé•œåƒå®‰å…¨å¤„ç†åŠ å¯†å‡­è¯","item":"https://icyleaf.com/2022/09/rails-build-docker-image-handle-encrypted-credentials-securely/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Rails æ„å»ºé•œåƒå®‰å…¨å¤„ç†åŠ å¯†å‡­è¯","name":"Rails æ„å»ºé•œåƒå®‰å…¨å¤„ç†åŠ å¯†å‡­è¯","description":"Docker æ„å»ºé•œåƒè¯¥å¦‚ä½•æ­£ç¡®å¤„ç† master key å’Œ credentials.yml.enc","keywords":["Rails","Docker"],"articleBody":"æœ€è¿‘åœ¨åšä¸€ä¸ªå°çš„ Side Project ä½œä¸ºå…¬å…±æœåŠ¡é¦–è¦æ˜¯éœ€è¦ä¿è¯ç”¨æˆ·æ•°æ®çš„ç»å¯¹å®‰å…¨ï¼Œè¿™å°±éœ€è¦å¯¹æ•°æ®åº“æ•°æ®åšåŠ å¯†å¤„ç†ã€‚\nRails 5.2 å¼€å§‹æ”¯æŒ credentials.yml.enc åŠ å¯†å‡­è¯ï¼Œ 6.0 æ”¯æŒå¤šç¯å¢ƒçš„ credentials åŠ å¯†å‡­è¯ï¼Œ 7.0 æ”¯æŒå¯¹ model æ•°æ®åº“è¡¨å­—æ®µåŠ å¯†å¤„ç†ï¼Œä½†æˆ‘ä» 5.1 æ”¯æŒ secrets.yml å¼€å§‹å°±æ²¡ä½¿ç”¨è¿‡ã€‚ æœ€è¿‘ä¸€å‘¨å¼€å‘åŠ æ‘¸ç´¢ä¸‹æ¥ï¼Œæ€»ç»“ä¸€å¥è¯ï¼šä¸€ç›´åŠ å¯†ä¸€ç›´çˆ½ï¼Œå®¹å™¨åŒ–å¥”èµ´ç«è‘¬åœºã€‚\næœºåˆ¶åŸç† åˆå§‹åŒ–ä¸€ä¸ª Rails 5.2+ é¡¹ç›®ä¼šåœ¨é¡¹ç›®æ ¹ç›®å½• config ç”Ÿæˆ master.key å’Œ credentials.yml.enc ä¸¤ä¸ªæ–‡ä»¶ï¼Œå‰è€…å¯ä»¥ç†è§£ä¸ºæ ¸å¿ƒå¯†é’¥ï¼Œåè€…æ˜¯ç”¨æ ¸å¿ƒå¯†é’¥é€šè¿‡ ActiveSupport::EncryptedConfiguration åŠ å¯†ç±»ç”Ÿæˆçš„åŠ å¯†åçš„æ•°æ®æ–‡ä»¶ã€‚\nåªéœ€è¦ä¿è¯ master.key ä¸ä¼šæ³„éœ²ï¼Œé€šè¿‡ rails credentials:edit é…ç½®æœåŠ¡æ‰€éœ€çš„å„è‡ªç§å¯† tokenã€secret key ä¹‹ç±»ä¹Ÿå¯ä»¥å®‰å…¨çš„æäº¤åˆ° Git ä»“åº“ä¸­ã€‚\nå­˜å‚¨è·¯å¾„ å¯†é’¥å’ŒåŠ å¯†åçš„æ–‡ä»¶ä¼šå­˜åœ¨å¦‚ä¸‹ç›®å½•ï¼š\n1# ç¼ºçœ 2config/master.key 3config/credentials.yml.enc 4 5# Rails ç”Ÿäº§ç¯å¢ƒå†³å®š (6.0 å¼€å§‹æ”¯æŒ) 6# å¦‚ä¸‹åˆ†åˆ«å¯¹åº” development å’Œ production ç¯å¢ƒ 7config/credentials/development.key 8config/credentials/development.yml.enc 9 10config/credentials/production.key 11config/credentials/production.yml.enc è§¦å‘æœºåˆ¶ åªè¦è¿è¡Œçš„ä»£ç ä¼šæ¶‰åŠ config/environment.rb æ–‡ä»¶è§£å¯†æµç¨‹å°±ä¼šè‡ªåŠ¨è¢«è§¦å‘ï¼Œæ¯”å¦‚ï¼š\nrails server rails console Rakefile é™„åŠ  :environment å‚æ•°çš„æ‰€æœ‰ tasks å¸¸è§åŠ è§£å¯†æŠ¥é”™ è§£å¯†æœºåˆ¶è¢«è§¦å‘çš„é‚£ä¸€åˆ»ï¼Œå®ƒä¼šä»å­˜å‚¨è·¯å¾„ä»ç¼ºçœåˆ°å½“å‰ç”Ÿäº§ç¯å¢ƒå»å¯»æ‰¾å¯¹åº”çš„æ–‡ä»¶ï¼Œmaster key ä¼šä¼˜å…ˆè¯»å– RAILS_MASTER_KEY ç¯å¢ƒå˜é‡çš„å€¼ï¼Œæ²¡æœ‰æ‰ä¼šå»å­˜å‚¨æ–‡ä»¶è¯»å–ï¼Œéƒ½æ²¡æœ‰æ‰¾åˆ°å°±æŠ¥é”™ MissingKeyError é”™è¯¯ã€‚\nmaster key åœ¨ Rails 5.2 ~ 7 ç‰ˆæœ¬å¯†é’¥çš„é•¿åº¦å¿…é¡»ç¬¦åˆ aes-128-gcm ä¹Ÿå°±æ˜¯ 32 å­—èŠ‚ï¼Œè®¾ç½®é”™è¯¯ä¼šå¾—åˆ° InvalidKeyLengthError é”™è¯¯ã€‚\n*.enc æ–‡ä»¶ä¸å­˜åœ¨ä¼šè§¦å‘ MissingContentError é”™è¯¯ã€‚\nå…¶ä»–çš„é”™è¯¯è¿˜æœ‰å¯èƒ½æ˜¯ï¼š\n1# é€šå¸¸æ˜¯ credentials.yml.enc æ–‡ä»¶ç¼ºå¤±æˆ–æœªè®¾ç½® secret_key_base (SECRET_KEY_BASE) çš„å€¼ 2ArgumentError: Missing `secret_key_base` for 'production' environment, set this string with `bin/rails credentials:edit` 3 4# master key å¯†é’¥ä¸æ­£ç¡®æ— æ³•è§£å¯† 5Unable to load application: ActiveSupport::MessageEncryptor::InvalidMessage: ActiveSupport::MessageEncryptor::InvalidMessage 6 7# é”™è¯¯åŒä¸Š 8OpenSSL::Cipher::CipherError æˆå°±å¤§ä½“éƒ½åˆ—å‡ºæ¥äº†ï¼Œè‡³äºä½ èƒ½åˆ°å“ªæ­¥å°±çœ‹ä½ çš„é€ åŒ–äº†ï¼ˆå¼€ç©ç¬‘ï¼‰ã€‚\næ•°æ®åº“å­—æ®µåŠ å¯† Rails é»˜è®¤å¹¶ä¸ä¼šå¯¹æ•°æ®åº“å­—æ®µåŠ å¯†ï¼Œåœ¨ 7.0 å¼€å§‹å…è®¸å¼€å‘è€…å®šä¹‰åŠ å¯†å­—æ®µä¹Ÿå…è®¸è‡ªå®šä¹‰åŠ è§£å¯†æ–¹æ³•ã€‚è¿™ä¸ªä¸æ˜¯æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ä¸å†å±•å¼€ã€‚\nåˆå§‹åŒ–éœ€è¦é€šè¿‡å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆä¸€ä¸ªéšæœºçš„ Keysï¼š\n1$ rails db:encryption:init 2Add this entry to the credentials of the target environment: 3 4active_record_encryption: 5 primary_key: KMw07GoiPScVwtmoNxlBv7YibFCnB4dU 6 deterministic_key: CTttlez04KZcy3MCMFtZ8FUEopSAmJOr 7 key_derivation_salt: FwUgrDWHX3wN7kKw5gYSsYEgzxRnYBWh åœ¨é€šè¿‡ rails credentials:edit æŠŠä¸Šç«¯åŠ å¯†ä¸²åŠ åˆ° credentials é‡Œé¢ä¿å­˜å³å¯ï¼Œä¸åŒçš„åŠ å¯†ä¸²æ˜¯æ— æ³•è§£å¯†å·²ç»å­˜åœ¨æ•°æ®åº“ä¸­çš„æ•°æ®çš„ï¼Œåˆ‡è®°ï¼åˆ‡è®°ï¼åˆ‡è®°ï¼ å¦åˆ™ä½ ä¼šå†è·å¾—ä¸€ä¸ªæˆå°± ActiveRecord::Encryption::Errors::Decryption æŠ¥é”™ã€‚\né•œåƒæ„å»ºå¤„ç† æ­å–œä½ ï¼Œä»ç°åœ¨å¼€å§‹ä½ æœ¬åº”å½“ç›´é¢ææƒ§ï¼Œå¯æƒœä½ å‘ç°äº†æˆ‘è¿™ç¯‡æ–‡ç« ç¼ºå°‘äº†ç‚¹æ‚²æƒ¨çš„ç»å†ã€‚\nåˆ¶ä½œ Docker é•œåƒæ— è®ºä»€ä¹ˆæƒ…å†µéƒ½è¦ä¿è¯ä¸ä¼šåŒ…å«ä»»ä½•ç§å¯†æ•°æ®ï¼ŒRails ç»•ä¸å¼€çš„ç‚¹ä¸»è¦æ˜¯ rails assets:complieã€‚ ä¸Šé¢æˆ‘ä¹Ÿè¯´äº†åªè¦æ¶‰åŠ :environment å‚æ•°çš„æ‰€æœ‰ tasks éƒ½ä¼šèµ°è§£å¯†æµç¨‹ï¼Œå®ƒä¹Ÿä¸ä¾‹å¤–ã€‚\næ„å»ºæ–¹é¢æˆ‘é€šè¿‡ä¸‰ç§æ–¹å¼æ¥è§£æå¦‚æœä»ä¸å®‰å…¨åˆ°å®‰å…¨çš„æ„å»ºè¿‡ç¨‹ï¼š\nğŸš« æœ€ä¸å®‰å…¨çš„æ–¹å¼ é•œåƒæ„å»ºå…è®¸è®¾ç½® build-arg ä¼ é€’ï¼š\n1FROM ruby:3.0.3 2 3ARG master_key 4ENV RAILS_MASTER_KEY=$master_key 5ENV RAILS_ENV=production 6 7# çœç•¥ 8... 9 10RUN bin/rails assets:complie 11# æˆ–è€… 12RUN RAILS_MASTER_KEY=$master_key bin/rails assets:complie æ‰§è¡Œæ„å»ºå‘½ä»¤ docker build -t app --build-arg master_key=[32bits-length-key] . æ„å»ºåè™½ç„¶å¯ä»¥è·å¾—é•œåƒï¼Œä½†æ„å»ºæ—¶è®¾ç½®çš„å€¼ä¹Ÿè¢«å°è£…åœ¨äº†å®¹å™¨ä¸­ï¼Œå°±ç®—æ²¡æœ‰å°è£…åˆ°å®¹å™¨ä¸­ä½¿ç”¨ docker history ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå› æ­¤è¿™ç§æ–¹å¼æ˜¯ç»å¯¹ä¸å¯å–çš„ã€‚\nâ­•ï¸ æ”¹è¿›ç‰ˆ ä½ å¯èƒ½ä¼šçœ‹åˆ°æœ‰äº›é•œåƒçš„ Dockerfile é‡Œé¢ä¼šåŒ…å«å¤šä¸ª FROM çš„å¤šé˜¶æ®µæ„å»ºã€‚è¿™ä¸ªæ˜¯ä¸ºäº†åˆ©ç”¨éš”ç¦»èµ„æºï¼Œé‡å¤åˆ©ç”¨ç¼“å­˜æœºåˆ¶çš„æ–¹å¼ä½¿å¾—æœ€ç»ˆçš„å®¹å™¨æå¯èƒ½çš„å°å’Œå®‰å…¨ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæŠŠç§å¯†æ•°æ®éš”ç¦»åœ¨å‰é¢çš„ä¸´æ—¶é•œåƒä¸­ã€‚\n1FROM ruby:3.0.3 as builder 2 3ARG workspace=/app 4ARG master_key 5ENV RAILS_MASTER_KEY=$master_key 6ENV RAILS_ENV=production 7 8# çœç•¥ 9... 10 11WORKDIR $workspace 12RUN bin/rails assets:complie 13 14# çœç•¥ 15... 16 17FROM ruby:3.0.3-slim 18 19# çœç•¥ 20... 21 22COPY --from=builder $workspace $workspace é•œåƒå­˜åœ¨ builder å’Œä¸€ä¸ªç¼ºçœåå­—ï¼ˆé€šå¸¸æ˜¯ stage-N, N æ˜¯æ•°å­—ä» 1 å¼€å§‹ï¼‰ä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µæ˜¯æœ€ä¸å®‰å…¨æ–¹å¼çš„å®ç°æ–¹å¼ï¼Œè¿™é‡Œåœ¨æœ€åä¸€ä¸ªé˜¶æ®µé€šè¿‡ä¸€ä¸ªå¹²å‡€å®‰å…¨çš„é•œåƒæŠŠä¸Šä¸€ä¸ªé˜¶æ®µçš„ç»“æœæ–‡ä»¶å¤åˆ¶è¿‡æ¥å°±è¾¾æˆäº†ç¬¬ä¸€ä¸ªé˜¶æ®µä¸­ç§å¯†æ•°æ®æ³„éœ²çš„é—®é¢˜ã€‚\nè¿™ç§æ–¹å¼ä¹Ÿæ˜¯å½“å‰å¤§å¤šæ•°äººä¼šåº”ç”¨çš„æ–¹å¼ï¼Œå°¤å…¶åˆ©ç”¨ Github Action çš„ Encrypted secrets åŠŸèƒ½ä»æŸç§ç¨‹åº¦ä¸Šæœç»äº†éšç§æ•°æ®çš„æ³„éœ²ã€‚\nâœ… åŠ å¼ºç‰ˆ Buildkit æ˜¯ Docker æ–°ä¸€ä»£é•œåƒæ„å»ºå·¥å…·ï¼Œå¯ç”¨å¯ä»¥é€šè¿‡é…ç½®ç¯å¢ƒå˜é‡ DOCKER_BUILDKIT=1 æˆ–åœ¨ Docker é…ç½®æ–‡ä»¶çš„ features å­—å…¸å¢åŠ  \"buildkit\" : \"true\"ã€‚\nç”±äºé‡‡ç”¨æ–°çš„æ„å»ºå·¥å…·ï¼Œé¢å¤–è¿˜éœ€è¦åœ¨ Dockerfile å¤´éƒ¨æ˜¾æ€§å£°æ˜æ–°çš„è¯­æ³•ï¼šsyntax = docker/dockerfile:1.2 é…åˆ æ–°çš„æ„å»º secret 1# syntax = docker/dockerfile:1.2 2FROM ruby:3.0.3 3 4ARG workspace=/app 5WORKDIR $workspace 6 7# çœç•¥ 8... 9 10RUN --mount=type=secret,id=master_key,target=config/master.key,required=true \\ 11 bin/rails assets:precompile æ„å»ºå‘½ä»¤æ‰§è¡Œéœ€è¦é€šè¿‡ buildx CLI å­å‘½ä»¤æ¥å®Œæˆï¼š\n1$ docker buildx build \\ 2 --secret id=master_key,src=config/master.key \\ 3 -t app . ç»“åˆ â€“mount-type=secret æ”¯æŒçš„å‚æ•°:\nå‚æ•°å è¯´æ˜ id å¯†é’¥çš„å”¯ä¸€ idï¼Œé»˜è®¤æ˜¯ target å‚æ•°çš„å€¼çš„æ–‡ä»¶å target é•œåƒå†…æŒ‚è½½çš„è·¯å¾„ï¼Œé»˜è®¤æ˜¯ /run/secrets/ + id required è®¾ç½® true å½“å¯†é’¥ä¸å­˜åœ¨æ—¶æŠ¥é”™ï¼Œé»˜è®¤æ˜¯ false mode æŒ‚è½½åçš„æ–‡ä»¶æƒé™ï¼Œé»˜è®¤æ˜¯ 0400 uid è®¾ç½®å¯†é’¥æ–‡ä»¶çš„ç”¨æˆ· IDï¼Œé»˜è®¤æ˜¯ 0 gid è®¾ç½®å¯†é’¥æ–‡ä»¶çš„ç”¨æˆ·ç»„ IDï¼Œé»˜è®¤æ˜¯ 0 id å…³è” CLI ä¼ å‚å’Œæ„å»ºé•œåƒä¸­æ‰§è¡Œæ­¥éª¤ï¼ŒCLI å…¥å‚è®¾ç½® secret çš„è¾“å…¥æ–‡ä»¶ï¼Œæ„å»ºé•œåƒåˆ™éœ€è¦æŠŠ secret å¯¼å‡ºåˆ°é•œåƒä¸­å…·ä½“çš„è·¯å¾„ï¼Œå…¶å®å°±æ˜¯è¿™ä¹ˆç®€å•ã€‚æå°‘æ•°æ”¯æŒ Docker éƒ¨ç½²çš„äº‘æœåŠ¡ï¼Œæ¯”å¦‚ Render æ”¯æŒè¿™ç§æ–¹å¼ã€‚éƒ¨ç½²åˆ°äº‘æœåŠ¡ä¸Šè¿˜éœ€è¦é‡æ–°è€ƒé‡ä¸‹ã€‚\næœ¬ç¯‡å°ç»“ æŠ˜è…¾ä¸€åœˆç»ˆäºè·å¾—äº†ä¸€ä¸ªå¹²å‡€ã€å®‰å…¨çš„é•œåƒï¼Œç­‰åˆ°éƒ¨ç½²æ—¶åˆå‚»çœ¼äº†ã€‚é¢å‘æŠ€æœ¯äººå‘˜æˆ–å…¬å¸çš„é¡¹ç›®å€’è¿˜å¥½ï¼Œåˆå§‹åŒ–æ—¶é€šè¿‡å‘½ä»¤ä¸€é€šæ“ä½œé…ç½®å®Œä¹Ÿä¸éœ€è¦å¤„ç† master key ä¸åŒ¹é…çš„æƒ…å†µã€‚ æ— è®ºä½¿ç”¨ä¸Šé¢æ”¹è¿›ç‰ˆè¿˜æ˜¯åŠ å¼ºç‰ˆéƒ½èƒ½è¿‡é¡ºåˆ©è·‘èµ·æ¥ã€‚å¦‚æœ Docker é•œåƒæ˜¯è¦é¢å‘å®¢æˆ·çš„è¯ï¼Œæ€ä¹ˆè®©ä»–ä»¬åˆå§‹åŒ–ä¸€ä¸ªå±äºä»–ä»¬è‡ªå·±çš„ master key å’ŒåŠ å¯†æ•°æ®å‘¢ï¼Ÿå¼€å§‹æŒ å¤´äº†å§ã€‚\næœªå®Œå¾…ç»­â€¦ ç¿»çœ‹ç­”æ¡ˆã€‚\nå‚è€ƒèµ„æº Railsã®credentials.yml.encã¨master keyã‚’Dockerã§å®‰å…¨ã«æ‰±ã† Donâ€™t leak your Docker imageâ€™s build secrets ","wordCount":"1968","inLanguage":"zh-cn","image":"https://images.unsplash.com/photo-1584949091598-c31daaaa4aa9?ixlib=rb-1.2.1\u0026ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8\u0026auto=format\u0026fit=crop\u0026w=2370\u0026q=80","datePublished":"2022-09-15T13:58:31+08:00","dateModified":"2022-09-15T13:58:31+08:00","author":{"@type":"Person","name":"icyleaf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://icyleaf.com/2022/09/rails-build-docker-image-handle-encrypted-credentials-securely/"},"publisher":{"@type":"Organization","name":"icyleaf","logo":{"@type":"ImageObject","url":"https://icyleaf.com/favicon.ico"}}}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/series/homelab title>homelab ç³»åˆ—</a>
<a class=menu-item href=https://icyleaf.com/projects title>å¼€æºé¡¹ç›®</a>
<a class=menu-item href=https://icyleaf.com/gears title>æˆ‘çš„è®¾å¤‡</a>
<a class=menu-item href=https://icyleaf.com/about title>å…³äº</a>
<span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/series/homelab title><h3>homelab ç³»åˆ—</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>å¼€æºé¡¹ç›®</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/gears title><h3>æˆ‘çš„è®¾å¤‡</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/about title><h3>å…³äº</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=post-cover><img src="https://images.unsplash.com/photo-1584949091598-c31daaaa4aa9?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2370&amp;q=80" loading=lazy><p class=cover-author>Photo by
<a href=https://unsplash.com/photos/FWoq_ldWlNQ>Mitchell Luo</a>
/
<a href=https://unsplash.com>Unsplash</a></p></div><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop=description>Rails æ„å»ºé•œåƒå®‰å…¨å¤„ç†åŠ å¯†å‡­è¯</h1><div class=post-description>Docker æ„å»ºé•œåƒè¯¥å¦‚ä½•æ­£ç¡®å¤„ç† master key å’Œ credentials.yml.enc</div><div class=post-meta><time datetime=2022-09-15 itemprop=datePublished>2022-09-15</time>
Â·
<span class=tags>Rails, Docker</span>
Â·
<span class=post-word-count>1968 words Â· 8 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>ç›®å½•</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#æœºåˆ¶åŸç†>æœºåˆ¶åŸç†</a><ul><li><a href=#å­˜å‚¨è·¯å¾„>å­˜å‚¨è·¯å¾„</a></li><li><a href=#è§¦å‘æœºåˆ¶>è§¦å‘æœºåˆ¶</a></li><li><a href=#å¸¸è§åŠ è§£å¯†æŠ¥é”™>å¸¸è§åŠ è§£å¯†æŠ¥é”™</a></li></ul></li><li><a href=#æ•°æ®åº“å­—æ®µåŠ å¯†>æ•°æ®åº“å­—æ®µåŠ å¯†</a></li><li><a href=#é•œåƒæ„å»ºå¤„ç†>é•œåƒæ„å»ºå¤„ç†</a><ul><li><a href=#-æœ€ä¸å®‰å…¨çš„æ–¹å¼>ğŸš« æœ€ä¸å®‰å…¨çš„æ–¹å¼</a></li><li><a href=#-æ”¹è¿›ç‰ˆ>â­•ï¸ æ”¹è¿›ç‰ˆ</a></li><li><a href=#-åŠ å¼ºç‰ˆ>âœ… åŠ å¼ºç‰ˆ</a></li></ul></li><li><a href=#æœ¬ç¯‡å°ç»“>æœ¬ç¯‡å°ç»“</a></li><li><a href=#å‚è€ƒèµ„æº>å‚è€ƒèµ„æº</a></li></ul></nav></div></div><div class=post-content><div class=post-series><h4 class=series-title><a href=https://icyleaf.com/series/dockerdeployrails/>Docker éƒ¨ç½² Rails æŒ‡åŒ—ï¼ˆ2 ç¯‡ï¼‰</a></h4><ol class=series-list><li class=series-item><span class=current-serie>Rails æ„å»ºé•œåƒå®‰å…¨å¤„ç†åŠ å¯†å‡­è¯</span></li><li class=series-item><a href=https://icyleaf.com/2022/09/perfect-solution-to-steup-rails-encrypted-credentials/>Rails äº§å“ç¯å¢ƒé…ç½®åŠ å¯†å‡­è¯çš„å®Œç¾æ–¹æ¡ˆ</a></li></ol></div><div id=post-gallery><p>æœ€è¿‘åœ¨åšä¸€ä¸ªå°çš„ Side Project ä½œä¸ºå…¬å…±æœåŠ¡é¦–è¦æ˜¯éœ€è¦ä¿è¯ç”¨æˆ·æ•°æ®çš„ç»å¯¹å®‰å…¨ï¼Œè¿™å°±éœ€è¦å¯¹æ•°æ®åº“æ•°æ®åšåŠ å¯†å¤„ç†ã€‚</p><p>Rails <a href=https://qiita.com/NaokiIshimura/items/2a179f2ab910992c4d39>5.2</a> å¼€å§‹æ”¯æŒ <code>credentials.yml.enc</code> åŠ å¯†å‡­è¯ï¼Œ
<a href=https://blog.saeloun.com/2019/10/10/rails-6-adds-support-for-multi-environment-credentials.html>6.0</a> æ”¯æŒå¤šç¯å¢ƒçš„ credentials åŠ å¯†å‡­è¯ï¼Œ
<a href=https://blog.saeloun.com/2021/06/09/rails-7-add-encryption-to-active-record.html>7.0</a> æ”¯æŒå¯¹ model æ•°æ®åº“è¡¨å­—æ®µåŠ å¯†å¤„ç†ï¼Œä½†æˆ‘ä» 5.1 æ”¯æŒ <code>secrets.yml</code> å¼€å§‹å°±æ²¡ä½¿ç”¨è¿‡ã€‚
æœ€è¿‘ä¸€å‘¨å¼€å‘åŠ æ‘¸ç´¢ä¸‹æ¥ï¼Œæ€»ç»“ä¸€å¥è¯ï¼š<strong>ä¸€ç›´åŠ å¯†ä¸€ç›´çˆ½ï¼Œå®¹å™¨åŒ–å¥”èµ´ç«è‘¬åœºã€‚</strong></p><h2 id=æœºåˆ¶åŸç†>æœºåˆ¶åŸç†</h2><p>åˆå§‹åŒ–ä¸€ä¸ª Rails 5.2+ é¡¹ç›®ä¼šåœ¨é¡¹ç›®æ ¹ç›®å½• <code>config</code> ç”Ÿæˆ <code>master.key</code> å’Œ <code>credentials.yml.enc</code> ä¸¤ä¸ªæ–‡ä»¶ï¼Œå‰è€…å¯ä»¥ç†è§£ä¸ºæ ¸å¿ƒå¯†é’¥ï¼Œåè€…æ˜¯ç”¨æ ¸å¿ƒå¯†é’¥é€šè¿‡
<a href=https://github.com/rails/rails/blob/7-0-stable/activesupport/lib/active_support/encrypted_configuration.rb>ActiveSupport::EncryptedConfiguration</a> åŠ å¯†ç±»ç”Ÿæˆçš„åŠ å¯†åçš„æ•°æ®æ–‡ä»¶ã€‚</p><p>åªéœ€è¦ä¿è¯ <code>master.key</code> ä¸ä¼šæ³„éœ²ï¼Œé€šè¿‡ <code>rails credentials:edit</code> é…ç½®æœåŠ¡æ‰€éœ€çš„å„è‡ªç§å¯† tokenã€secret key ä¹‹ç±»ä¹Ÿå¯ä»¥å®‰å…¨çš„æäº¤åˆ° Git ä»“åº“ä¸­ã€‚</p><h3 id=å­˜å‚¨è·¯å¾„>å­˜å‚¨è·¯å¾„</h3><p>å¯†é’¥å’ŒåŠ å¯†åçš„æ–‡ä»¶ä¼šå­˜åœ¨å¦‚ä¸‹ç›®å½•ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl><span class=c1># ç¼ºçœ</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>config/master.key
</span></span><span class=line><span class=ln> 3</span><span class=cl>config/credentials.yml.enc
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=c1># Rails ç”Ÿäº§ç¯å¢ƒå†³å®š (6.0 å¼€å§‹æ”¯æŒ)</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1># å¦‚ä¸‹åˆ†åˆ«å¯¹åº” development å’Œ production ç¯å¢ƒ</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>config/credentials/development.key
</span></span><span class=line><span class=ln> 8</span><span class=cl>config/credentials/development.yml.enc
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>config/credentials/production.key
</span></span><span class=line><span class=ln>11</span><span class=cl>config/credentials/production.yml.enc
</span></span></code></pre></div><h3 id=è§¦å‘æœºåˆ¶>è§¦å‘æœºåˆ¶</h3><p>åªè¦è¿è¡Œçš„ä»£ç ä¼šæ¶‰åŠ <code>config/environment.rb</code> æ–‡ä»¶è§£å¯†æµç¨‹å°±ä¼šè‡ªåŠ¨è¢«è§¦å‘ï¼Œæ¯”å¦‚ï¼š</p><ul><li><code>rails server</code></li><li><code>rails console</code></li><li><code>Rakefile</code> é™„åŠ  <code>:environment</code> å‚æ•°çš„æ‰€æœ‰ tasks</li></ul><h3 id=å¸¸è§åŠ è§£å¯†æŠ¥é”™>å¸¸è§åŠ è§£å¯†æŠ¥é”™</h3><p>è§£å¯†æœºåˆ¶è¢«è§¦å‘çš„é‚£ä¸€åˆ»ï¼Œå®ƒä¼šä»å­˜å‚¨è·¯å¾„ä»ç¼ºçœåˆ°å½“å‰ç”Ÿäº§ç¯å¢ƒå»å¯»æ‰¾å¯¹åº”çš„æ–‡ä»¶ï¼Œmaster key ä¼šä¼˜å…ˆè¯»å– <code>RAILS_MASTER_KEY</code> ç¯å¢ƒå˜é‡çš„å€¼ï¼Œæ²¡æœ‰æ‰ä¼šå»å­˜å‚¨æ–‡ä»¶è¯»å–ï¼Œéƒ½æ²¡æœ‰æ‰¾åˆ°å°±æŠ¥é”™ <code>MissingKeyError</code> é”™è¯¯ã€‚</p><p>master key åœ¨ Rails 5.2 ~ 7 ç‰ˆæœ¬å¯†é’¥çš„é•¿åº¦å¿…é¡»ç¬¦åˆ aes-128-gcm ä¹Ÿå°±æ˜¯ 32 å­—èŠ‚ï¼Œè®¾ç½®é”™è¯¯ä¼šå¾—åˆ° <code>InvalidKeyLengthError</code> é”™è¯¯ã€‚</p><p><code>*.enc</code> æ–‡ä»¶ä¸å­˜åœ¨ä¼šè§¦å‘ <code>MissingContentError</code> é”™è¯¯ã€‚</p><p>å…¶ä»–çš„é”™è¯¯è¿˜æœ‰å¯èƒ½æ˜¯ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># é€šå¸¸æ˜¯ credentials.yml.enc æ–‡ä»¶ç¼ºå¤±æˆ–æœªè®¾ç½® secret_key_base (SECRET_KEY_BASE) çš„å€¼</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>ArgumentError: Missing <span class=sb>`</span>secret_key_base<span class=sb>`</span> <span class=k>for</span> <span class=s1>&#39;production&#39;</span> environment, <span class=nb>set</span> this string with <span class=sb>`</span>bin/rails credentials:edit<span class=sb>`</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=c1># master key å¯†é’¥ä¸æ­£ç¡®æ— æ³•è§£å¯†</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>Unable to load application: ActiveSupport::MessageEncryptor::InvalidMessage: ActiveSupport::MessageEncryptor::InvalidMessage
</span></span><span class=line><span class=ln>6</span><span class=cl>
</span></span><span class=line><span class=ln>7</span><span class=cl><span class=c1># é”™è¯¯åŒä¸Š</span>
</span></span><span class=line><span class=ln>8</span><span class=cl>OpenSSL::Cipher::CipherError
</span></span></code></pre></div><p>æˆå°±å¤§ä½“éƒ½åˆ—å‡ºæ¥äº†ï¼Œè‡³äºä½ èƒ½åˆ°å“ªæ­¥å°±çœ‹ä½ çš„é€ åŒ–äº†ï¼ˆå¼€ç©ç¬‘ï¼‰ã€‚</p><h2 id=æ•°æ®åº“å­—æ®µåŠ å¯†>æ•°æ®åº“å­—æ®µåŠ å¯†</h2><p>Rails é»˜è®¤å¹¶ä¸ä¼šå¯¹æ•°æ®åº“å­—æ®µåŠ å¯†ï¼Œåœ¨ 7.0 å¼€å§‹å…è®¸å¼€å‘è€…å®šä¹‰åŠ å¯†å­—æ®µä¹Ÿå…è®¸è‡ªå®šä¹‰åŠ è§£å¯†æ–¹æ³•ã€‚è¿™ä¸ªä¸æ˜¯æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ä¸å†å±•å¼€ã€‚</p><p>åˆå§‹åŒ–éœ€è¦é€šè¿‡å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆä¸€ä¸ªéšæœºçš„ Keysï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>$ rails db:encryption:init
</span></span><span class=line><span class=ln>2</span><span class=cl>Add this entry to the credentials of the target environment:
</span></span><span class=line><span class=ln>3</span><span class=cl>
</span></span><span class=line><span class=ln>4</span><span class=cl>active_record_encryption:
</span></span><span class=line><span class=ln>5</span><span class=cl>  primary_key: KMw07GoiPScVwtmoNxlBv7YibFCnB4dU
</span></span><span class=line><span class=ln>6</span><span class=cl>  deterministic_key: CTttlez04KZcy3MCMFtZ8FUEopSAmJOr
</span></span><span class=line><span class=ln>7</span><span class=cl>  key_derivation_salt: FwUgrDWHX3wN7kKw5gYSsYEgzxRnYBWh
</span></span></code></pre></div><p>åœ¨é€šè¿‡ <code>rails credentials:edit</code> æŠŠä¸Šç«¯åŠ å¯†ä¸²åŠ åˆ° credentials é‡Œé¢ä¿å­˜å³å¯ï¼Œ<strong>ä¸åŒçš„åŠ å¯†ä¸²æ˜¯æ— æ³•è§£å¯†å·²ç»å­˜åœ¨æ•°æ®åº“ä¸­çš„æ•°æ®çš„ï¼Œåˆ‡è®°ï¼åˆ‡è®°ï¼åˆ‡è®°ï¼</strong>
å¦åˆ™ä½ ä¼šå†è·å¾—ä¸€ä¸ªæˆå°± <code>ActiveRecord::Encryption::Errors::Decryption</code> æŠ¥é”™ã€‚</p><h2 id=é•œåƒæ„å»ºå¤„ç†>é•œåƒæ„å»ºå¤„ç†</h2><blockquote><p>æ­å–œä½ ï¼Œä»ç°åœ¨å¼€å§‹ä½ æœ¬åº”å½“ç›´é¢ææƒ§ï¼Œå¯æƒœä½ å‘ç°äº†æˆ‘è¿™ç¯‡æ–‡ç« ç¼ºå°‘äº†ç‚¹æ‚²æƒ¨çš„ç»å†ã€‚</p></blockquote><p>åˆ¶ä½œ Docker é•œåƒæ— è®ºä»€ä¹ˆæƒ…å†µéƒ½è¦ä¿è¯ä¸ä¼šåŒ…å«ä»»ä½•ç§å¯†æ•°æ®ï¼ŒRails ç»•ä¸å¼€çš„ç‚¹ä¸»è¦æ˜¯ <code>rails assets:complie</code>ã€‚
ä¸Šé¢æˆ‘ä¹Ÿè¯´äº†åªè¦æ¶‰åŠ <code>:environment</code> å‚æ•°çš„æ‰€æœ‰ tasks éƒ½ä¼šèµ°è§£å¯†æµç¨‹ï¼Œå®ƒä¹Ÿä¸ä¾‹å¤–ã€‚</p><p>æ„å»ºæ–¹é¢æˆ‘é€šè¿‡ä¸‰ç§æ–¹å¼æ¥è§£æå¦‚æœä»ä¸å®‰å…¨åˆ°å®‰å…¨çš„æ„å»ºè¿‡ç¨‹ï¼š</p><h3 id=-æœ€ä¸å®‰å…¨çš„æ–¹å¼>ğŸš« æœ€ä¸å®‰å…¨çš„æ–¹å¼</h3><p>é•œåƒæ„å»ºå…è®¸è®¾ç½® <a href=https://docs.docker.com/engine/reference/commandline/build/#set-build-time-variables---build-arg>build-arg</a> ä¼ é€’ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=ln> 1</span><span class=cl><span class=k>FROM</span><span class=s> ruby:3.0.3</span><span class=err>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=err></span><span class=k>ARG</span> master_key<span class=err>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>RAILS_MASTER_KEY</span><span class=o>=</span><span class=nv>$master_key</span><span class=err>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>RAILS_ENV</span><span class=o>=</span>production
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=c># çœç•¥</span><span class=err>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=err></span>...<span class=err>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=err></span><span class=k>RUN</span> bin/rails assets:complie<span class=err>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=err></span><span class=c># æˆ–è€…</span><span class=err>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nv>RAILS_MASTER_KEY</span><span class=o>=</span><span class=nv>$master_key</span> bin/rails assets:complie<span class=err>
</span></span></span></code></pre></div><p>æ‰§è¡Œæ„å»ºå‘½ä»¤ <code>docker build -t app --build-arg master_key=[32bits-length-key] .</code> æ„å»ºåè™½ç„¶å¯ä»¥è·å¾—é•œåƒï¼Œä½†æ„å»ºæ—¶è®¾ç½®çš„å€¼ä¹Ÿè¢«å°è£…åœ¨äº†å®¹å™¨ä¸­ï¼Œå°±ç®—æ²¡æœ‰å°è£…åˆ°å®¹å™¨ä¸­ä½¿ç”¨ <code>docker history</code> ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå› æ­¤è¿™ç§æ–¹å¼æ˜¯ç»å¯¹ä¸å¯å–çš„ã€‚</p><h3 id=-æ”¹è¿›ç‰ˆ>â­•ï¸ æ”¹è¿›ç‰ˆ</h3><p>ä½ å¯èƒ½ä¼šçœ‹åˆ°æœ‰äº›é•œåƒçš„ Dockerfile é‡Œé¢ä¼šåŒ…å«å¤šä¸ª <code>FROM</code> çš„<a href=https://docs.docker.com/develop/develop-images/multistage-build/>å¤šé˜¶æ®µæ„å»º</a>ã€‚è¿™ä¸ªæ˜¯ä¸ºäº†åˆ©ç”¨éš”ç¦»èµ„æºï¼Œé‡å¤åˆ©ç”¨ç¼“å­˜æœºåˆ¶çš„æ–¹å¼ä½¿å¾—æœ€ç»ˆçš„å®¹å™¨æå¯èƒ½çš„å°å’Œå®‰å…¨ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæŠŠç§å¯†æ•°æ®éš”ç¦»åœ¨å‰é¢çš„ä¸´æ—¶é•œåƒä¸­ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=ln> 1</span><span class=cl><span class=k>FROM</span><span class=s> ruby:3.0.3 as builder</span><span class=err>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>workspace</span><span class=o>=</span>/app<span class=err>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=err></span><span class=k>ARG</span> master_key<span class=err>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>RAILS_MASTER_KEY</span><span class=o>=</span><span class=nv>$master_key</span><span class=err>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>RAILS_ENV</span><span class=o>=</span>production
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c># çœç•¥</span><span class=err>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=err></span>...<span class=err>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> $workspace</span><span class=err>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=err></span><span class=k>RUN</span> bin/rails assets:complie<span class=err>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=err></span><span class=c># çœç•¥</span><span class=err>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=err></span>...<span class=err>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> ruby:3.0.3-slim</span><span class=err>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=err></span><span class=c># çœç•¥</span><span class=err>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=err></span>...<span class=err>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder <span class=nv>$workspace</span> <span class=nv>$workspace</span><span class=err>
</span></span></span></code></pre></div><p>é•œåƒå­˜åœ¨ <code>builder</code> å’Œä¸€ä¸ªç¼ºçœåå­—ï¼ˆé€šå¸¸æ˜¯ <code>stage-N</code>, N æ˜¯æ•°å­—ä» 1 å¼€å§‹ï¼‰ä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µæ˜¯æœ€ä¸å®‰å…¨æ–¹å¼çš„å®ç°æ–¹å¼ï¼Œè¿™é‡Œåœ¨æœ€åä¸€ä¸ªé˜¶æ®µé€šè¿‡ä¸€ä¸ªå¹²å‡€å®‰å…¨çš„é•œåƒæŠŠä¸Šä¸€ä¸ªé˜¶æ®µçš„ç»“æœæ–‡ä»¶å¤åˆ¶è¿‡æ¥å°±è¾¾æˆäº†ç¬¬ä¸€ä¸ªé˜¶æ®µä¸­ç§å¯†æ•°æ®æ³„éœ²çš„é—®é¢˜ã€‚</p><p>è¿™ç§æ–¹å¼ä¹Ÿæ˜¯å½“å‰å¤§å¤šæ•°äººä¼šåº”ç”¨çš„æ–¹å¼ï¼Œå°¤å…¶åˆ©ç”¨ Github Action çš„ <a href=https://docs.github.com/en/actions/security-guides/encrypted-secrets>Encrypted secrets</a> åŠŸèƒ½ä»æŸç§ç¨‹åº¦ä¸Šæœç»äº†éšç§æ•°æ®çš„æ³„éœ²ã€‚</p><h3 id=-åŠ å¼ºç‰ˆ>âœ… åŠ å¼ºç‰ˆ</h3><p><a href=https://docs.docker.com/develop/develop-images/build_enhancements/>Buildkit</a> æ˜¯ Docker æ–°ä¸€ä»£é•œåƒæ„å»ºå·¥å…·ï¼Œå¯ç”¨å¯ä»¥é€šè¿‡é…ç½®ç¯å¢ƒå˜é‡ <code>DOCKER_BUILDKIT=1</code> æˆ–åœ¨ Docker é…ç½®æ–‡ä»¶çš„ features å­—å…¸å¢åŠ  <code>"buildkit" : "true"</code>ã€‚</p><p>ç”±äºé‡‡ç”¨æ–°çš„æ„å»ºå·¥å…·ï¼Œé¢å¤–è¿˜éœ€è¦åœ¨ Dockerfile å¤´éƒ¨æ˜¾æ€§å£°æ˜æ–°çš„è¯­æ³•ï¼š<code>syntax = docker/dockerfile:1.2</code> é…åˆ
<a href=https://docs.docker.com/develop/develop-images/build_enhancements/#new-docker-build-secret-information>æ–°çš„æ„å»º secret</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=ln> 1</span><span class=cl><span class=c># syntax = docker/dockerfile:1.2</span><span class=err>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> ruby:3.0.3</span><span class=err>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>workspace</span><span class=o>=</span>/app<span class=err>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> $workspace</span><span class=err>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=err></span><span class=c># çœç•¥</span><span class=err>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=err></span>...<span class=err>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=err></span><span class=k>RUN</span> --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>secret,id<span class=o>=</span>master_key,target<span class=o>=</span>config/master.key,required<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=se></span>    bin/rails assets:precompile<span class=err>
</span></span></span></code></pre></div><p>æ„å»ºå‘½ä»¤æ‰§è¡Œéœ€è¦é€šè¿‡ <a href=https://docs.docker.com/build/buildx/install/>buildx</a> CLI å­å‘½ä»¤æ¥å®Œæˆï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>$ docker buildx build <span class=se>\
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=se></span>  --secret <span class=nv>id</span><span class=o>=</span>master_key,src<span class=o>=</span>config/master.key <span class=se>\
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=se></span>  -t app .
</span></span></code></pre></div><p>ç»“åˆ <a href=https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/reference.md#run---mounttypesecret>&ndash;mount-type=secret</a> æ”¯æŒçš„å‚æ•°:</p><table><thead><tr><th>å‚æ•°å</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>id</td><td>å¯†é’¥çš„å”¯ä¸€ idï¼Œé»˜è®¤æ˜¯ target å‚æ•°çš„å€¼çš„æ–‡ä»¶å</td></tr><tr><td>target</td><td>é•œåƒå†…æŒ‚è½½çš„è·¯å¾„ï¼Œé»˜è®¤æ˜¯ <code>/run/secrets/</code> + <code>id</code></td></tr><tr><td>required</td><td>è®¾ç½® <code>true</code> å½“å¯†é’¥ä¸å­˜åœ¨æ—¶æŠ¥é”™ï¼Œé»˜è®¤æ˜¯ <code>false</code></td></tr><tr><td>mode</td><td>æŒ‚è½½åçš„æ–‡ä»¶æƒé™ï¼Œé»˜è®¤æ˜¯ <code>0400</code></td></tr><tr><td>uid</td><td>è®¾ç½®å¯†é’¥æ–‡ä»¶çš„ç”¨æˆ· IDï¼Œé»˜è®¤æ˜¯ <code>0</code></td></tr><tr><td>gid</td><td>è®¾ç½®å¯†é’¥æ–‡ä»¶çš„ç”¨æˆ·ç»„ IDï¼Œé»˜è®¤æ˜¯ <code>0</code></td></tr></tbody></table><p><code>id</code> å…³è” CLI ä¼ å‚å’Œæ„å»ºé•œåƒä¸­æ‰§è¡Œæ­¥éª¤ï¼ŒCLI å…¥å‚è®¾ç½® secret çš„è¾“å…¥æ–‡ä»¶ï¼Œæ„å»ºé•œåƒåˆ™éœ€è¦æŠŠ secret å¯¼å‡ºåˆ°é•œåƒä¸­å…·ä½“çš„è·¯å¾„ï¼Œå…¶å®å°±æ˜¯è¿™ä¹ˆç®€å•ã€‚æå°‘æ•°æ”¯æŒ Docker
éƒ¨ç½²çš„äº‘æœåŠ¡ï¼Œæ¯”å¦‚ <a href=https://render.com/docs/docker-secrets>Render</a> æ”¯æŒè¿™ç§æ–¹å¼ã€‚éƒ¨ç½²åˆ°äº‘æœåŠ¡ä¸Šè¿˜éœ€è¦é‡æ–°è€ƒé‡ä¸‹ã€‚</p><h2 id=æœ¬ç¯‡å°ç»“>æœ¬ç¯‡å°ç»“</h2><p>æŠ˜è…¾ä¸€åœˆç»ˆäºè·å¾—äº†ä¸€ä¸ªå¹²å‡€ã€å®‰å…¨çš„é•œåƒï¼Œç­‰åˆ°éƒ¨ç½²æ—¶åˆå‚»çœ¼äº†ã€‚é¢å‘æŠ€æœ¯äººå‘˜æˆ–å…¬å¸çš„é¡¹ç›®å€’è¿˜å¥½ï¼Œåˆå§‹åŒ–æ—¶é€šè¿‡å‘½ä»¤ä¸€é€šæ“ä½œé…ç½®å®Œä¹Ÿä¸éœ€è¦å¤„ç† master key ä¸åŒ¹é…çš„æƒ…å†µã€‚
æ— è®ºä½¿ç”¨ä¸Šé¢æ”¹è¿›ç‰ˆè¿˜æ˜¯åŠ å¼ºç‰ˆéƒ½èƒ½è¿‡é¡ºåˆ©è·‘èµ·æ¥ã€‚å¦‚æœ Docker é•œåƒæ˜¯è¦é¢å‘å®¢æˆ·çš„è¯ï¼Œæ€ä¹ˆè®©ä»–ä»¬åˆå§‹åŒ–ä¸€ä¸ªå±äºä»–ä»¬è‡ªå·±çš„ master key å’ŒåŠ å¯†æ•°æ®å‘¢ï¼Ÿå¼€å§‹æŒ å¤´äº†å§ã€‚</p><p><del>æœªå®Œå¾…ç»­&mldr;</del> <a href=https://icyleaf.com/2022/09/perfect-solution-to-steup-rails-encrypted-credentials/>ç¿»çœ‹ç­”æ¡ˆ</a>ã€‚</p><h2 id=å‚è€ƒèµ„æº>å‚è€ƒèµ„æº</h2><ul><li><a href=https://techblog.lclco.com/entry/2021/07/27/110000>Railsã®credentials.yml.encã¨master keyã‚’Dockerã§å®‰å…¨ã«æ‰±ã†</a></li><li><a href=https://pythonspeed.com/articles/docker-build-secrets/>Donâ€™t leak your Docker imageâ€™s build secrets</a></li></ul><div class=post-donate><p class=post-donate-title>å¦‚æœä½ è§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿æ‰“èµï¼Œè¿™å¯¹æˆ‘éå¸¸é‡è¦ï¼Œè°¢è°¢ï¼</p><div class=post-donate-channel><img src=https://icyleaf.com/images/donate/alipay.png alt=æ”¯ä»˜å®æ‰“èµ>
<img src=https://icyleaf.com/images/donate/wechat.png alt=å¾®ä¿¡æ‰“èµ></div></div></div></div><div class=post-nav><a href=https://icyleaf.com/2022/02/how-to-homelab-part-0/ class=prev rel=prev title="å¦‚ä½•æ­å»ºå®¶ç”¨ homelab: å…ˆå¯¼ç¯‡"><i class="iconfont icon-left"></i>&nbsp;å¦‚ä½•æ­å»ºå®¶ç”¨ homelab: å…ˆå¯¼ç¯‡</a>
<a href=https://icyleaf.com/2022/09/perfect-solution-to-steup-rails-encrypted-credentials/ class=next rel=next title="Rails äº§å“ç¯å¢ƒé…ç½®åŠ å¯†å‡­è¯çš„å®Œç¾æ–¹æ¡ˆ">Rails äº§å“ç¯å¢ƒé…ç½®åŠ å¯†å‡­è¯çš„å®Œç¾æ–¹æ¡ˆ&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><script>var getTheme=window.localStorage&&window.localStorage.getItem("blog-dark-mode"),getTheme=getTheme??"github-light";let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","icyleaf/icyleaf.com"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.post-comment").innerHTML="",document.querySelector("div.post-comment").appendChild(s)</script></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2024</span>
<span>ğŸº</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script defer src=https://fastly.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script>
<script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: () => import('\/photoswipe\/photoswipe.esm.js'),
  });
  lightbox.init();
</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TKQBZ7R259"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TKQBZ7R259")</script></div></body></html>