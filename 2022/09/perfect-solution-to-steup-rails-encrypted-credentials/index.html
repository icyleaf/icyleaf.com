<!doctype html><html lang=zh-cn></html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Rails äº§å“ç¯å¢ƒé…ç½®åŠ å¯†å‡­è¯çš„å®Œç¾æ–¹æ¡ˆ | icyleaf</title><meta name=keywords content="Rails,Docker"><meta name=description content="é¢å‘ç”¨æˆ·çš„é¡¹ç›®å¦‚ä½•ä¿è¯æ•°æ®å®‰å…¨çš„æƒ…å†µä¸‹ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªä¾¿æ·éƒ¨ç½²æ–¹å¼"><meta name=author content="icyleaf"><link rel=canonical href=https://icyleaf.com/2022/09/perfect-solution-to-steup-rails-encrypted-credentials/><link rel=icon href=https://icyleaf.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://icyleaf.com/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=https://icyleaf.com/android-chrome-512x512.png><link rel=apple-touch-icon href=https://icyleaf.com/apple-touch-icon.png><link rel=mask-icon href=https://icyleaf.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.min.css><link rel=canonical href=https://icyleaf.com/2022/09/perfect-solution-to-steup-rails-encrypted-credentials/><meta property="og:title" content="Rails äº§å“ç¯å¢ƒé…ç½®åŠ å¯†å‡­è¯çš„å®Œç¾æ–¹æ¡ˆ"><meta property="og:description" content="é¢å‘ç”¨æˆ·çš„é¡¹ç›®å¦‚ä½•ä¿è¯æ•°æ®å®‰å…¨çš„æƒ…å†µä¸‹ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªä¾¿æ·éƒ¨ç½²æ–¹å¼"><meta property="og:type" content="article"><meta property="og:url" content="https://icyleaf.com/2022/09/perfect-solution-to-steup-rails-encrypted-credentials/"><meta property="og:image" content="https://images.unsplash.com/photo-1527694747350-2d483ffcff28?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=3267&q=80"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-16T13:58:31+08:00"><meta property="article:modified_time" content="2022-09-16T13:58:31+08:00"><meta property="og:see_also" content="https://icyleaf.com/2022/09/rails-build-docker-image-handle-encrypted-credentials-securely/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1527694747350-2d483ffcff28?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=3267&q=80"><meta name=twitter:title content="Rails äº§å“ç¯å¢ƒé…ç½®åŠ å¯†å‡­è¯çš„å®Œç¾æ–¹æ¡ˆ"><meta name=twitter:description content="é¢å‘ç”¨æˆ·çš„é¡¹ç›®å¦‚ä½•ä¿è¯æ•°æ®å®‰å…¨çš„æƒ…å†µä¸‹ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªä¾¿æ·éƒ¨ç½²æ–¹å¼"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://icyleaf.com/posts/"},{"@type":"ListItem","position":2,"name":"Rails äº§å“ç¯å¢ƒé…ç½®åŠ å¯†å‡­è¯çš„å®Œç¾æ–¹æ¡ˆ","item":"https://icyleaf.com/2022/09/perfect-solution-to-steup-rails-encrypted-credentials/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Rails äº§å“ç¯å¢ƒé…ç½®åŠ å¯†å‡­è¯çš„å®Œç¾æ–¹æ¡ˆ","name":"Rails äº§å“ç¯å¢ƒé…ç½®åŠ å¯†å‡­è¯çš„å®Œç¾æ–¹æ¡ˆ","description":"é¢å‘ç”¨æˆ·çš„é¡¹ç›®å¦‚ä½•ä¿è¯æ•°æ®å®‰å…¨çš„æƒ…å†µä¸‹ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªä¾¿æ·éƒ¨ç½²æ–¹å¼","keywords":["Rails","Docker"],"articleBody":"ç»­æ¥ä¸Šæ–‡ï¼Œé¡¹ç›®å·²ç»æ„å»ºé•œåƒåä¸‹ä¸€æ­¥å¤§æ¦‚ç‡å°±è¦å¼€å§‹é¢å‘å—ä¼—äººç¾¤å»ä¼ æ’­ä½¿ç”¨ã€‚ä½ æœ‰æƒ³è¿‡è®©ç”¨æˆ·è‡ªå»ºæœåŠ¡æ—¶ä»–è¦è¸©çš„å‘å—ï¼Ÿé‚£ç»å¯¹å°±æ˜¯åŠ å¯†å‡­è¯çš„é…ç½®ã€‚\nRails æ•™ä½ è¿™ä¹ˆåš å¾ˆé—æ†¾é™¤äº† Rails å¯¥å¯¥å‡ ç¬”çš„é…ç½®ä»¥å¤–ä½ å‡ ä¹æ‰¾ä¸åˆ°ä»»ä½•ä¸ä¸€æ ·çš„æ–‡ç« ã€‚åŠ å¯†å‡­è¯çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š\n1â”œâ”€â”€ config 2â”‚ â”œâ”€â”€ master.key # æ ¸å¿ƒç§é’¥ 3â”‚ â”œâ”€â”€ credentials.yml.enc # åŠ å¯†å‡­è¯ 4â”‚ â””â”€â”€ ... master.key æ˜¯æŸç§ç®—æ³•éšæœºç”Ÿæˆçš„åŠ å¯†ä¸²ï¼Œcredentials.yml.enc æ˜¯å­˜å‚¨äº†å„ç§ keyã€tokenã€secret value çš„ YAML æ•°æ®åŠ å¯†åçš„å‡­è¯æ•°æ®ã€‚\nRails ä»¥å®‰å…¨ä¸ºç”±ï¼ˆæˆ‘çŒœçš„ï¼‰å¯¹å¼€å‘è€…ä¹Ÿâ€œå°é—­â€äº†åŠ å¯†è¿‡ç¨‹ï¼Œåªèƒ½é€šè¿‡ rails credentials:edit å‘½ä»¤è§£å¯† YAML æ•°æ®æ‰èƒ½ç¼–è¾‘å’Œä¿å­˜ã€‚æœ€è‡´å‘½çš„è¯¥å‘½ä»¤æ˜¯ä½¿ç”¨ EDITOR ç¯å¢ƒå˜é‡é…ç½®çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œè¿™ä¸ªé€šå¸¸æ˜¯ vim, nano ç­‰ç»ˆç«¯æ–‡æœ¬ç¼–è¾‘å™¨ã€‚\nè¿™å°±éœ€è¦åœ¨éƒ¨ç½²é¡¹ç›®çš„æ—¶å€™æ— æ³•ä¸€é”®éƒ¨ç½²ï¼Œå¿…é¡»åœ¨éƒ¨ç½²å‰è®©ä½¿ç”¨è€…æ•²ä¸€å †çš„å‘½ä»¤ã€è¿˜è¦åœ¨ç»ˆç«¯çš„æ–‡æœ¬ç¼–è¾‘å™¨å†æ•²ä¸€å †éœ€è¦é…ç½®çš„æ•°æ®ã€‚\næˆ‘æƒ³ä¸ä»…ä½¿ç”¨è€…ä¼šç–¯æ‰ï¼Œå¾ˆå¤š Rails å¼€å‘è€…æˆ–è®¸ä¹Ÿä¼šå‘æ€µã€‚\næˆ‘çš„æœ€ä½³å®è·µ æˆªæ­¢ 2022-10-20 ä¸ºæ­¢é€‚ç”¨äº Rails 7.x ç‰ˆæœ¬ã€‚\nä¸Šé¢æåˆ°çš„â€œå°é—­â€çš„æ„æ€æ˜¯ä½¿ç”¨è€…ä¸å¯è§åŠ è§£å¯†è¿‡ç¨‹ï¼Œä½†å¯é€šè¿‡å¼€æºä»£ç ä¸€æ¢ç©¶ç«Ÿã€‚\næˆ‘çš„æ€è·¯å¾ˆç®€å•ï¼Œä¸æå‰ç”Ÿæˆå’ŒæŒ‚è½½ä¸Šé¢ä¸¤ä¸ªæ–‡ä»¶ï¼Œé€šè¿‡è®¾ç½® RAILS_MASTER_KEY å’Œ RAILS_ENCRYPTED_CREDENTIALS ä¸¤ä¸ªç¯å¢ƒå˜é‡å†å˜ç›¸å®ç°ã€‚\nRAILS_MASTER_KEY æ˜¯ Rails å†…ç½®çš„å˜é‡ï¼Œå®ƒä¼šä¼˜å…ˆè¯»å–æœ€åæ‰ä¼šè¯»å– config/master.keyã€‚\nRAILS_ENCRYPTED_CREDENTIALS ç¯å¢ƒå˜é‡ä¿å­˜ credentials.yml.enc æ–‡ä»¶çš„åŠ å¯†å‡­è¯æ•°æ®ï¼Œé¡¹ç›®å¯åŠ¨é˜¶æ®µé€šè¿‡è„šæœ¬é¢„å¤„ç†ã€‚\nåŠ å¯†å‡­è¯ç”Ÿæˆå™¨ é¢å‘ç”¨æˆ·è‡ªåŠ¨åŒ–é…ç½®ï¼Œè¿™å°±æ„å‘³ç€éœ€è¦é¡¹ç›®å¼€å‘è€…æä¾›å‚»ç“œå¼çš„é…ç½®å·¥å…·ã€‚\nåŠ å¯†å‡­è¯ç”Ÿæˆå™¨\nä¸Šé¢æ˜¯ä¸€ä¸ªå®ç°åŠŸèƒ½çš„åŸºç¡€ç‰ˆæœ¬ï¼Œå¦‚æœéƒ¨ç½²æ–¹å¼æ˜¯ Docker æˆ– docker-compose ä¹Ÿå¯ä»¥æä¾›ç”Ÿæˆå¯¹åº”çš„éƒ¨ç½²è„šæœ¬æˆ–æ–‡ä»¶ã€‚\næ ¸å¿ƒæºç  ç”Ÿæˆè§„åˆ™å‡å€Ÿé‰´ Rails å†…éƒ¨ ActiveSupport::EncryptedFile å’Œ ActiveSupport::EncryptedConfiguration é€»è¾‘ï¼Œæ•°æ®åº“åŠ å¯†å‚è€ƒ database.rakeï¼š\n1def create 2 env_key = \"TEMP_MASTER_KEY\" 3 ENV[env_key] = ActiveSupport::EncryptedConfiguration.generate_key 4 generator = ActiveSupport::EncryptedConfiguration.new( 5 config_path: \"\", 6 key_path: \"\", 7 env_key: env_key, 8 raise_if_missing_key: false 9 ) 10 11 master_key = generator.key 12 contents = { 13 \"secret_key_base\" =\u003e SecureRandom.alphanumeric(64), 14 \"active_record_encryption\" =\u003e { 15 \"primary_key\" =\u003e SecureRandom.alphanumeric(32), 16 \"deterministic_key\" =\u003e SecureRandom.alphanumeric(32), 17 \"key_derivation_salt\" =\u003e SecureRandom.alphanumeric(32), 18 } 19 } 20 21 ENV.delete(env_key) 22 render json: { 23 master_key: master_key, 24 encrypted_credentials: generator.send(:encrypt, YAML.dump(contents)), 25 contents: contents 26 } 27end è‡ªåŠ¨åŒ–å¤„ç†è„šæœ¬ ç¯å¢ƒå˜é‡é…ç½®çš„ RAILS_ENCRYPTED_CREDENTIALS å˜é‡å¹¶ä¸ä¼šè¢« Rails è¯†åˆ«ï¼Œå¿…é¡»åœ¨ä¾èµ– Rails ç›¸å…³æœåŠ¡è¿è¡Œå‰ï¼ˆåŒ…æ‹¬ Sidekiqï¼‰æŠŠå˜é‡çš„å€¼è½¬æ¢æˆå¯¹åº”çš„æ–‡ä»¶å³å¯ã€‚\n1namespace :app do 2 task :credentials do 3 master_key_path = Rails.root.join('config', 'credentials', 'production.key') 4 encrypted_file_path = Rails.root.join('config', 'credentials', 'production.yml.enc') 5 encrypted_credentials = ENV['RAILS_ENCRYPTED_CREDENTIALS'].presence 6 7 if encrypted_credentials \u0026\u0026 (!File.exist?(encrypted_file_path) || File.read(encrypted_file_path).empty?) 8 puts \"Write encrypted data into #{encrypted_file_path}\" 9 File.write(encrypted_file_path, ENV['RAILS_ENCRYPTED_CREDENTIALS']) 10 end 11 12 encrypted = Rails.application.encrypted(encrypted_file_path) 13 if encrypted.key.nil? 14 fail [ 15 \"Missing `RAILS_MASTER_KEY` enviroment value and not found file in #{master_key_path}.\", 16 \"Make sure generate one first and store it in a safe place.\" 17 ].join(\"\\n\") 18 end 19 20 next if encrypted_credentials 21 22 begin 23 data = File.empty?(encrypted_file_path) ? {} : (YAML.load(encrypted.read) || {}) 24 puts \"Preparing encrypted keys: secret_key_base, active_record_encryption ...\" 25 26 # Priority: environment \u003e rails builtin \u003e credentials.yml.enc data 27 data['secret_key_base'] = ENV['SECRET_TOKEN'].presence || data['secret_key_base'] || SecureRandom.alphanumeric(32) 28 29 # Support encrypted_key in model 30 data['active_record_encryption'] = { 31 'primary_key' =\u003e SecureRandom.alphanumeric(32), 32 'deterministic_key' =\u003e SecureRandom.alphanumeric(32), 33 'key_derivation_salt' =\u003e SecureRandom.alphanumeric(32), 34 } 35 36 Rails.application.encrypted(encrypted_file_path).write(YAML.dump(data)) 37 rescue OpenSSL::Cipher::CipherError, ActiveSupport::MessageEncryptor::InvalidMessage 38 puts \"Couldn't decrypt #{encrypted_file_path}. Perhaps `RAILS_MASTER_KEY` enviroment value is incorrect?\" 39 end 40 end 41end Docker é…ç½® 1docker run -d \\ 2 -e RAILS_MASTER_KEY=\"[master_key]\" \\ 3 -e RAILS_ENCRYPTED_CREDENTIALS=\"[encrypted]\" \\ 4 [image_name] æˆ‘çš„æœ€ä½³å®è·µå¹¶ä¸ä»£è¡¨æ˜¯æœ€å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼Œæœ€èµ·ç èƒ½å¤Ÿè®©ç”¨æˆ·é¿å…ç¢°è§¦ä»£ç ä¹Ÿèƒ½å¤Ÿå¾ˆè½»æ¾çš„éƒ¨ç½²æ‰æ˜¯å‰æï¼Œä¸æ˜¯å—ï¼Ÿ\n","wordCount":"1080","inLanguage":"zh-cn","image":"https://images.unsplash.com/photo-1527694747350-2d483ffcff28?ixlib=rb-1.2.1\u0026ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8\u0026auto=format\u0026fit=crop\u0026w=3267\u0026q=80","datePublished":"2022-09-16T13:58:31+08:00","dateModified":"2022-09-16T13:58:31+08:00","author":{"@type":"Person","name":"icyleaf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://icyleaf.com/2022/09/perfect-solution-to-steup-rails-encrypted-credentials/"},"publisher":{"@type":"Organization","name":"icyleaf","logo":{"@type":"ImageObject","url":"https://icyleaf.com/favicon.ico"}}}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/series/homelab title>homelab ç³»åˆ—</a>
<a class=menu-item href=https://icyleaf.com/projects title>å¼€æºé¡¹ç›®</a>
<a class=menu-item href=https://icyleaf.com/gears title>æˆ‘çš„è®¾å¤‡</a>
<a class=menu-item href=https://icyleaf.com/about title>å…³äº</a>
<span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/series/homelab title><h3>homelab ç³»åˆ—</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>å¼€æºé¡¹ç›®</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/gears title><h3>æˆ‘çš„è®¾å¤‡</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/about title><h3>å…³äº</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=post-cover><img src="https://images.unsplash.com/photo-1527694747350-2d483ffcff28?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=3267&amp;q=80" loading=lazy><p class=cover-author>Photo by
<a href=https://unsplash.com/photos/8yCmQODY2SY>Hello I'm Nik</a>
/
<a href=https://unsplash.com>Unsplash</a></p></div><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop=description>Rails äº§å“ç¯å¢ƒé…ç½®åŠ å¯†å‡­è¯çš„å®Œç¾æ–¹æ¡ˆ</h1><div class=post-description>é¢å‘ç”¨æˆ·çš„é¡¹ç›®å¦‚ä½•ä¿è¯æ•°æ®å®‰å…¨çš„æƒ…å†µä¸‹ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªä¾¿æ·éƒ¨ç½²æ–¹å¼</div><div class=post-meta><time datetime=2022-09-16 itemprop=datePublished>2022-09-16</time>
Â·
<span class=tags>Rails, Docker</span>
Â·
<span class=post-word-count>1080 words Â· 4 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>ç›®å½•</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#rails-æ•™ä½ è¿™ä¹ˆåš>Rails æ•™ä½ è¿™ä¹ˆåš</a></li><li><a href=#æˆ‘çš„æœ€ä½³å®è·µ>æˆ‘çš„æœ€ä½³å®è·µ</a><ul><li><a href=#åŠ å¯†å‡­è¯ç”Ÿæˆå™¨>åŠ å¯†å‡­è¯ç”Ÿæˆå™¨</a></li><li><a href=#è‡ªåŠ¨åŒ–å¤„ç†è„šæœ¬>è‡ªåŠ¨åŒ–å¤„ç†è„šæœ¬</a></li><li><a href=#docker-é…ç½®>Docker é…ç½®</a></li></ul></li></ul></nav></div></div><div class=post-content><div class=post-series><h4 class=series-title><a href=https://icyleaf.com/series/dockerdeployrails/>Docker éƒ¨ç½² Rails æŒ‡åŒ—ï¼ˆ2 ç¯‡ï¼‰</a></h4><ol class=series-list><li class=series-item><a href=https://icyleaf.com/2022/09/rails-build-docker-image-handle-encrypted-credentials-securely/>Rails æ„å»ºé•œåƒå®‰å…¨å¤„ç†åŠ å¯†å‡­è¯</a></li><li class=series-item><span class=current-serie>Rails äº§å“ç¯å¢ƒé…ç½®åŠ å¯†å‡­è¯çš„å®Œç¾æ–¹æ¡ˆ</span></li></ol></div><div id=post-gallery><p>ç»­æ¥ä¸Šæ–‡ï¼Œé¡¹ç›®å·²ç»æ„å»ºé•œåƒåä¸‹ä¸€æ­¥å¤§æ¦‚ç‡å°±è¦å¼€å§‹é¢å‘å—ä¼—äººç¾¤å»ä¼ æ’­ä½¿ç”¨ã€‚ä½ æœ‰æƒ³è¿‡è®©ç”¨æˆ·è‡ªå»ºæœåŠ¡æ—¶ä»–è¦è¸©çš„å‘å—ï¼Ÿé‚£ç»å¯¹å°±æ˜¯åŠ å¯†å‡­è¯çš„é…ç½®ã€‚</p><h2 id=rails-æ•™ä½ è¿™ä¹ˆåš>Rails æ•™ä½ è¿™ä¹ˆåš</h2><p>å¾ˆé—æ†¾é™¤äº† Rails å¯¥å¯¥å‡ ç¬”çš„é…ç½®ä»¥å¤–ä½ å‡ ä¹æ‰¾ä¸åˆ°ä»»ä½•ä¸ä¸€æ ·çš„æ–‡ç« ã€‚åŠ å¯†å‡­è¯çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=ln>1</span><span class=cl>â”œâ”€â”€ config
</span></span><span class=line><span class=ln>2</span><span class=cl>â”‚  â”œâ”€â”€ master.key           <span class=c1># æ ¸å¿ƒç§é’¥</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>â”‚  â”œâ”€â”€ credentials.yml.enc  <span class=c1># åŠ å¯†å‡­è¯</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>â”‚  â””â”€â”€ ...
</span></span></code></pre></div><p><code>master.key</code> æ˜¯æŸç§ç®—æ³•éšæœºç”Ÿæˆçš„åŠ å¯†ä¸²ï¼Œ<code>credentials.yml.enc</code> æ˜¯å­˜å‚¨äº†å„ç§ keyã€tokenã€secret value çš„ YAML æ•°æ®åŠ å¯†åçš„å‡­è¯æ•°æ®ã€‚</p><p>Rails ä»¥å®‰å…¨ä¸ºç”±ï¼ˆæˆ‘çŒœçš„ï¼‰å¯¹å¼€å‘è€…ä¹Ÿâ€œå°é—­â€äº†åŠ å¯†è¿‡ç¨‹ï¼Œåªèƒ½é€šè¿‡ <code>rails credentials:edit</code> å‘½ä»¤è§£å¯† YAML æ•°æ®æ‰èƒ½ç¼–è¾‘å’Œä¿å­˜ã€‚æœ€è‡´å‘½çš„è¯¥å‘½ä»¤æ˜¯ä½¿ç”¨ <code>EDITOR</code> ç¯å¢ƒå˜é‡é…ç½®çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œè¿™ä¸ªé€šå¸¸æ˜¯ vim, nano ç­‰ç»ˆç«¯æ–‡æœ¬ç¼–è¾‘å™¨ã€‚</p><p>è¿™å°±éœ€è¦åœ¨éƒ¨ç½²é¡¹ç›®çš„æ—¶å€™æ— æ³•ä¸€é”®éƒ¨ç½²ï¼Œå¿…é¡»åœ¨éƒ¨ç½²å‰è®©ä½¿ç”¨è€…æ•²ä¸€å †çš„å‘½ä»¤ã€è¿˜è¦åœ¨ç»ˆç«¯çš„æ–‡æœ¬ç¼–è¾‘å™¨å†æ•²ä¸€å †éœ€è¦é…ç½®çš„æ•°æ®ã€‚</p><p>æˆ‘æƒ³ä¸ä»…ä½¿ç”¨è€…ä¼šç–¯æ‰ï¼Œå¾ˆå¤š Rails å¼€å‘è€…æˆ–è®¸ä¹Ÿä¼šå‘æ€µã€‚</p><h2 id=æˆ‘çš„æœ€ä½³å®è·µ>æˆ‘çš„æœ€ä½³å®è·µ</h2><blockquote><p>æˆªæ­¢ 2022-10-20 ä¸ºæ­¢é€‚ç”¨äº Rails 7.x ç‰ˆæœ¬ã€‚</p></blockquote><p>ä¸Šé¢æåˆ°çš„â€œå°é—­â€çš„æ„æ€æ˜¯ä½¿ç”¨è€…ä¸å¯è§åŠ è§£å¯†è¿‡ç¨‹ï¼Œä½†å¯é€šè¿‡<a href=https://github.com/rails/rails/blob/7-0-stable/railties/lib/rails/commands/credentials/credentials_command.rb>å¼€æºä»£ç </a>ä¸€æ¢ç©¶ç«Ÿã€‚</p><p>æˆ‘çš„æ€è·¯å¾ˆç®€å•ï¼Œä¸æå‰ç”Ÿæˆå’ŒæŒ‚è½½ä¸Šé¢ä¸¤ä¸ªæ–‡ä»¶ï¼Œé€šè¿‡è®¾ç½® <code>RAILS_MASTER_KEY</code> å’Œ <code>RAILS_ENCRYPTED_CREDENTIALS</code> ä¸¤ä¸ªç¯å¢ƒå˜é‡å†å˜ç›¸å®ç°ã€‚</p><ul><li><p><code>RAILS_MASTER_KEY</code> æ˜¯ Rails å†…ç½®çš„å˜é‡ï¼Œå®ƒä¼š<a href=https://github.com/rails/rails/blob/7-0-stable/activesupport/lib/active_support/encrypted_file.rb#L53>ä¼˜å…ˆè¯»å–</a>æœ€åæ‰ä¼šè¯»å– <code>config/master.key</code>ã€‚</p></li><li><p><code>RAILS_ENCRYPTED_CREDENTIALS</code> ç¯å¢ƒå˜é‡ä¿å­˜ <code>credentials.yml.enc</code> æ–‡ä»¶çš„åŠ å¯†å‡­è¯æ•°æ®ï¼Œé¡¹ç›®å¯åŠ¨é˜¶æ®µé€šè¿‡è„šæœ¬é¢„å¤„ç†ã€‚</p></li></ul><h3 id=åŠ å¯†å‡­è¯ç”Ÿæˆå™¨>åŠ å¯†å‡­è¯ç”Ÿæˆå™¨</h3><p>é¢å‘ç”¨æˆ·è‡ªåŠ¨åŒ–é…ç½®ï¼Œè¿™å°±æ„å‘³ç€éœ€è¦é¡¹ç›®å¼€å‘è€…æä¾›å‚»ç“œå¼çš„é…ç½®å·¥å…·ã€‚</p><figure data-pswp=2278x1206 data-size=800x><a href=https://icyleaf.com/uploads/2022/09/16/generate-encrypted-credentials-tools.png class=gallery-item target=_blank data-pswp-width=2278 data-pswp-height=1206><img src=https://icyleaf.com/uploads/2022/09/16/generate-encrypted-credentials-tools_hu53cdae0c645814fab78a15ed8fe0af52_167183_800x0_resize_box_3.png></a><figcaption><p>åŠ å¯†å‡­è¯ç”Ÿæˆå™¨</p></figcaption></figure><p>ä¸Šé¢æ˜¯ä¸€ä¸ªå®ç°åŠŸèƒ½çš„åŸºç¡€ç‰ˆæœ¬ï¼Œå¦‚æœéƒ¨ç½²æ–¹å¼æ˜¯ Docker æˆ– docker-compose ä¹Ÿå¯ä»¥æä¾›ç”Ÿæˆå¯¹åº”çš„éƒ¨ç½²è„šæœ¬æˆ–æ–‡ä»¶ã€‚</p><h4 id=æ ¸å¿ƒæºç >æ ¸å¿ƒæºç </h4><p>ç”Ÿæˆè§„åˆ™å‡å€Ÿé‰´ Rails å†…éƒ¨ <code>ActiveSupport::EncryptedFile</code> å’Œ <code>ActiveSupport::EncryptedConfiguration</code> é€»è¾‘ï¼Œæ•°æ®åº“åŠ å¯†å‚è€ƒ <a href=https://github.com/rails/rails/blob/7-0-stable/activerecord/lib/active_record/railties/databases.rake#L531>database.rake</a>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln> 1</span><span class=cl><span class=k>def</span> <span class=nf>create</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=n>env_key</span> <span class=o>=</span> <span class=s2>&#34;TEMP_MASTER_KEY&#34;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=no>ENV</span><span class=o>[</span><span class=n>env_key</span><span class=o>]</span> <span class=o>=</span> <span class=no>ActiveSupport</span><span class=o>::</span><span class=no>EncryptedConfiguration</span><span class=o>.</span><span class=n>generate_key</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=n>generator</span> <span class=o>=</span> <span class=no>ActiveSupport</span><span class=o>::</span><span class=no>EncryptedConfiguration</span><span class=o>.</span><span class=n>new</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=ss>config_path</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=ss>key_path</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=ss>env_key</span><span class=p>:</span> <span class=n>env_key</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=ss>raise_if_missing_key</span><span class=p>:</span> <span class=kp>false</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl>  <span class=n>master_key</span> <span class=o>=</span> <span class=n>generator</span><span class=o>.</span><span class=n>key</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>  <span class=n>contents</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=s2>&#34;secret_key_base&#34;</span> <span class=o>=&gt;</span> <span class=no>SecureRandom</span><span class=o>.</span><span class=n>alphanumeric</span><span class=p>(</span><span class=mi>64</span><span class=p>),</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=s2>&#34;active_record_encryption&#34;</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>      <span class=s2>&#34;primary_key&#34;</span> <span class=o>=&gt;</span> <span class=no>SecureRandom</span><span class=o>.</span><span class=n>alphanumeric</span><span class=p>(</span><span class=mi>32</span><span class=p>),</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>      <span class=s2>&#34;deterministic_key&#34;</span> <span class=o>=&gt;</span> <span class=no>SecureRandom</span><span class=o>.</span><span class=n>alphanumeric</span><span class=p>(</span><span class=mi>32</span><span class=p>),</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>      <span class=s2>&#34;key_derivation_salt&#34;</span> <span class=o>=&gt;</span> <span class=no>SecureRandom</span><span class=o>.</span><span class=n>alphanumeric</span><span class=p>(</span><span class=mi>32</span><span class=p>),</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>
</span></span><span class=line><span class=ln>21</span><span class=cl>  <span class=no>ENV</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>env_key</span><span class=p>)</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>  <span class=n>render</span> <span class=ss>json</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>    <span class=ss>master_key</span><span class=p>:</span> <span class=n>master_key</span><span class=p>,</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>    <span class=ss>encrypted_credentials</span><span class=p>:</span> <span class=n>generator</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=ss>:encrypt</span><span class=p>,</span> <span class=no>YAML</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>contents</span><span class=p>)),</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>    <span class=ss>contents</span><span class=p>:</span> <span class=n>contents</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>27</span><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h3 id=è‡ªåŠ¨åŒ–å¤„ç†è„šæœ¬>è‡ªåŠ¨åŒ–å¤„ç†è„šæœ¬</h3><p>ç¯å¢ƒå˜é‡é…ç½®çš„ <code>RAILS_ENCRYPTED_CREDENTIALS</code> å˜é‡å¹¶ä¸ä¼šè¢« Rails è¯†åˆ«ï¼Œå¿…é¡»åœ¨ä¾èµ– Rails ç›¸å…³æœåŠ¡è¿è¡Œå‰ï¼ˆåŒ…æ‹¬ Sidekiqï¼‰æŠŠå˜é‡çš„å€¼è½¬æ¢æˆå¯¹åº”çš„æ–‡ä»¶å³å¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=ln> 1</span><span class=cl><span class=n>namespace</span> <span class=ss>:app</span> <span class=k>do</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=n>task</span> <span class=ss>:credentials</span> <span class=k>do</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=n>master_key_path</span> <span class=o>=</span> <span class=no>Rails</span><span class=o>.</span><span class=n>root</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;config&#39;</span><span class=p>,</span> <span class=s1>&#39;credentials&#39;</span><span class=p>,</span> <span class=s1>&#39;production.key&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=n>encrypted_file_path</span> <span class=o>=</span> <span class=no>Rails</span><span class=o>.</span><span class=n>root</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;config&#39;</span><span class=p>,</span> <span class=s1>&#39;credentials&#39;</span><span class=p>,</span> <span class=s1>&#39;production.yml.enc&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=n>encrypted_credentials</span> <span class=o>=</span> <span class=no>ENV</span><span class=o>[</span><span class=s1>&#39;RAILS_ENCRYPTED_CREDENTIALS&#39;</span><span class=o>].</span><span class=n>presence</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=k>if</span> <span class=n>encrypted_credentials</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=no>File</span><span class=o>.</span><span class=n>exist?</span><span class=p>(</span><span class=n>encrypted_file_path</span><span class=p>)</span> <span class=o>||</span> <span class=no>File</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>encrypted_file_path</span><span class=p>)</span><span class=o>.</span><span class=n>empty?</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>      <span class=nb>puts</span> <span class=s2>&#34;Write encrypted data into </span><span class=si>#{</span><span class=n>encrypted_file_path</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>      <span class=no>File</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>encrypted_file_path</span><span class=p>,</span> <span class=no>ENV</span><span class=o>[</span><span class=s1>&#39;RAILS_ENCRYPTED_CREDENTIALS&#39;</span><span class=o>]</span><span class=p>)</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=n>encrypted</span> <span class=o>=</span> <span class=no>Rails</span><span class=o>.</span><span class=n>application</span><span class=o>.</span><span class=n>encrypted</span><span class=p>(</span><span class=n>encrypted_file_path</span><span class=p>)</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=k>if</span> <span class=n>encrypted</span><span class=o>.</span><span class=n>key</span><span class=o>.</span><span class=n>nil?</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>      <span class=nb>fail</span> <span class=o>[</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>        <span class=s2>&#34;Missing `RAILS_MASTER_KEY` enviroment value and not found file in </span><span class=si>#{</span><span class=n>master_key_path</span><span class=si>}</span><span class=s2>.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>        <span class=s2>&#34;Make sure generate one first and store it in a safe place.&#34;</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>      <span class=o>].</span><span class=n>join</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=k>next</span> <span class=k>if</span> <span class=n>encrypted_credentials</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>
</span></span><span class=line><span class=ln>22</span><span class=cl>    <span class=k>begin</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>      <span class=n>data</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>empty?</span><span class=p>(</span><span class=n>encrypted_file_path</span><span class=p>)</span> <span class=p>?</span> <span class=p>{}</span> <span class=p>:</span> <span class=p>(</span><span class=no>YAML</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>encrypted</span><span class=o>.</span><span class=n>read</span><span class=p>)</span> <span class=o>||</span> <span class=p>{})</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>      <span class=nb>puts</span> <span class=s2>&#34;Preparing encrypted keys: secret_key_base, active_record_encryption ...&#34;</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>
</span></span><span class=line><span class=ln>26</span><span class=cl>      <span class=c1># Priority: environment &gt; rails builtin &gt; credentials.yml.enc data</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>      <span class=n>data</span><span class=o>[</span><span class=s1>&#39;secret_key_base&#39;</span><span class=o>]</span> <span class=o>=</span> <span class=no>ENV</span><span class=o>[</span><span class=s1>&#39;SECRET_TOKEN&#39;</span><span class=o>].</span><span class=n>presence</span> <span class=o>||</span> <span class=n>data</span><span class=o>[</span><span class=s1>&#39;secret_key_base&#39;</span><span class=o>]</span> <span class=o>||</span> <span class=no>SecureRandom</span><span class=o>.</span><span class=n>alphanumeric</span><span class=p>(</span><span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>
</span></span><span class=line><span class=ln>29</span><span class=cl>      <span class=c1># Support encrypted_key in model</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>      <span class=n>data</span><span class=o>[</span><span class=s1>&#39;active_record_encryption&#39;</span><span class=o>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>        <span class=s1>&#39;primary_key&#39;</span> <span class=o>=&gt;</span> <span class=no>SecureRandom</span><span class=o>.</span><span class=n>alphanumeric</span><span class=p>(</span><span class=mi>32</span><span class=p>),</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>        <span class=s1>&#39;deterministic_key&#39;</span> <span class=o>=&gt;</span> <span class=no>SecureRandom</span><span class=o>.</span><span class=n>alphanumeric</span><span class=p>(</span><span class=mi>32</span><span class=p>),</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>        <span class=s1>&#39;key_derivation_salt&#39;</span> <span class=o>=&gt;</span> <span class=no>SecureRandom</span><span class=o>.</span><span class=n>alphanumeric</span><span class=p>(</span><span class=mi>32</span><span class=p>),</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>
</span></span><span class=line><span class=ln>36</span><span class=cl>      <span class=no>Rails</span><span class=o>.</span><span class=n>application</span><span class=o>.</span><span class=n>encrypted</span><span class=p>(</span><span class=n>encrypted_file_path</span><span class=p>)</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=no>YAML</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>    <span class=k>rescue</span> <span class=no>OpenSSL</span><span class=o>::</span><span class=no>Cipher</span><span class=o>::</span><span class=no>CipherError</span><span class=p>,</span> <span class=no>ActiveSupport</span><span class=o>::</span><span class=no>MessageEncryptor</span><span class=o>::</span><span class=no>InvalidMessage</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>      <span class=nb>puts</span> <span class=s2>&#34;Couldn&#39;t decrypt </span><span class=si>#{</span><span class=n>encrypted_file_path</span><span class=si>}</span><span class=s2>. Perhaps `RAILS_MASTER_KEY` enviroment value is incorrect?&#34;</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=ln>41</span><span class=cl><span class=k>end</span>
</span></span></code></pre></div><h3 id=docker-é…ç½®>Docker é…ç½®</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=ln>1</span><span class=cl>docker run -d <span class=se>\
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=se></span>  -e <span class=nv>RAILS_MASTER_KEY</span><span class=o>=</span><span class=s2>&#34;[master_key]&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=se></span>  -e <span class=nv>RAILS_ENCRYPTED_CREDENTIALS</span><span class=o>=</span><span class=s2>&#34;[encrypted]&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=se></span>  <span class=o>[</span>image_name<span class=o>]</span>
</span></span></code></pre></div><p>æˆ‘çš„æœ€ä½³å®è·µå¹¶ä¸ä»£è¡¨æ˜¯æœ€å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼Œæœ€èµ·ç èƒ½å¤Ÿè®©ç”¨æˆ·é¿å…ç¢°è§¦ä»£ç ä¹Ÿèƒ½å¤Ÿå¾ˆè½»æ¾çš„éƒ¨ç½²æ‰æ˜¯å‰æï¼Œä¸æ˜¯å—ï¼Ÿ</p></div></div><div class=post-nav><a href=https://icyleaf.com/2022/09/rails-build-docker-image-handle-encrypted-credentials-securely/ class=prev rel=prev title="Rails æ„å»ºé•œåƒå®‰å…¨å¤„ç†åŠ å¯†å‡­è¯"><i class="iconfont icon-left"></i>&nbsp;Rails æ„å»ºé•œåƒå®‰å…¨å¤„ç†åŠ å¯†å‡­è¯</a>
<a href=https://icyleaf.com/2022/11/how-to-render-image-between-light-and-dark-mode-with-css/ class=next rel=next title="ä½¿ç”¨ CSS æ”¯æŒå›¾ç‰‡é»‘æš—æ¨¡å¼åŠ¨æ€åˆ‡æ¢">ä½¿ç”¨ CSS æ”¯æŒå›¾ç‰‡é»‘æš—æ¨¡å¼åŠ¨æ€åˆ‡æ¢&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><script>var getTheme=window.localStorage&&window.localStorage.getItem("blog-dark-mode"),getTheme=getTheme??"github-light";let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","icyleaf/icyleaf.com"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.post-comment").innerHTML="",document.querySelector("div.post-comment").appendChild(s)</script></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2024</span>
<span>ğŸº</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script defer src=https://fastly.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script>
<script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: () => import('\/photoswipe\/photoswipe.esm.js'),
  });
  lightbox.init();
</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TKQBZ7R259"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TKQBZ7R259")</script></div></body></html>