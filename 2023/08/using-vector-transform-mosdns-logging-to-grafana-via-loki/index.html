<!doctype html><html lang=zh-cn></html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>vector + loki å®ç° mosdns æ•°æ®çœ‹æ¿ | icyleaf</title>
<meta name=keywords content="vector,mosdns,loki,linux,openwrt,grafana"><meta name=description content="å¿«é€ŸéªŒè¯è§„åˆ™çš„åŒæ—¶å®ç°ç±»ä¼¼ AdGuard Home å¥½çœ‹çš„æ•°æ®çœ‹æ¿"><meta name=author content="icyleaf"><link rel=canonical href=https://icyleaf.com/2023/08/using-vector-transform-mosdns-logging-to-grafana-via-loki/><link rel=apple-touch-icon href=https://icyleaf.com/apple-touch-icon.png><link rel=icon href=https://icyleaf.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://icyleaf.com/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=https://icyleaf.com/android-chrome-512x512.png><link rel=icon type=image/svg+xml href=https://icyleaf.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.min.css><link rel=alternate hreflang=zh-cn href=https://icyleaf.com/2023/08/using-vector-transform-mosdns-logging-to-grafana-via-loki/><link rel=canonical href=https://icyleaf.com/2023/08/using-vector-transform-mosdns-logging-to-grafana-via-loki/><meta property="og:title" content="vector + loki å®ç° mosdns æ•°æ®çœ‹æ¿"><meta property="og:description" content="å¿«é€ŸéªŒè¯è§„åˆ™çš„åŒæ—¶å®ç°ç±»ä¼¼ AdGuard Home å¥½çœ‹çš„æ•°æ®çœ‹æ¿"><meta property="og:type" content="article"><meta property="og:url" content="https://icyleaf.com/2023/08/using-vector-transform-mosdns-logging-to-grafana-via-loki/"><meta property="og:image" content="https://images.unsplash.com/photo-1668089135991-e2d5ca8c62a6?ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=2874&amp;q=80"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-23T10:04:13+08:00"><meta property="article:modified_time" content="2023-08-23T10:04:13+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1668089135991-e2d5ca8c62a6?ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=2874&amp;q=80"><meta name=twitter:title content="vector + loki å®ç° mosdns æ•°æ®çœ‹æ¿"><meta name=twitter:description content="å¿«é€ŸéªŒè¯è§„åˆ™çš„åŒæ—¶å®ç°ç±»ä¼¼ AdGuard Home å¥½çœ‹çš„æ•°æ®çœ‹æ¿"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://icyleaf.com/posts/"},{"@type":"ListItem","position":2,"name":"vector + loki å®ç° mosdns æ•°æ®çœ‹æ¿","item":"https://icyleaf.com/2023/08/using-vector-transform-mosdns-logging-to-grafana-via-loki/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"vector + loki å®ç° mosdns æ•°æ®çœ‹æ¿","name":"vector \u002b loki å®ç° mosdns æ•°æ®çœ‹æ¿","description":"å¿«é€ŸéªŒè¯è§„åˆ™çš„åŒæ—¶å®ç°ç±»ä¼¼ AdGuard Home å¥½çœ‹çš„æ•°æ®çœ‹æ¿","keywords":["vector","mosdns","loki","linux","openwrt","grafana"],"articleBody":" æ›´æ–° Jun 7, 2024\n5.3 æ—¥å¿—ç»“æ„ä½œè€…åˆåšè°ƒæ•´äº†ï¼Œå®Œæ•´é…ç½®å·²æ›´æ–°ï¼Œå¦‚æœæ˜¯ 5.0 ~ 5.1.x ç‰ˆæœ¬éœ€è¦æ³¨æ„å®Œæ•´é…ç½®ä¸‹é¢çš„ä»£ç å¯¹æ¯”éƒ¨åˆ†ã€‚ ä½œè€…è‡ªå·±ä½¿ç”¨æ˜¯æŠŠ modsns ä»ä¹‹å‰çš„åç½®æ”¹æˆäº†å‰ç½®æµ‹è¯•äº†å¥½å‡ ä¸ªæœˆï¼Œå¥½å¤„æ˜¯æŸäº›æœåŠ¡æŒ‚äº†ä¹Ÿä¸ä¼šå½±å“ DNS çš„è§£æï¼Œæœ‰æƒ³äº†è§£å…·ä½“ç»†èŠ‚çš„å—ï¼Ÿ æ›´æ–°ç»´æŠ¤ä¸æ˜“ï¼Œæ¬¢è¿åœ¨æ–‡ç« å°¾éƒ¨æ‰“èµä½œè€…ï¼Œè¿™ä¸ªå¯¹äºä½œè€…å¾ˆé‡è¦ï¼Œæ„Ÿè°¢ä½ çš„æ”¯æŒï¼\næˆ‘æ˜¯ä» 4.0 ç‰ˆæœ¬å¼€å§‹ä½¿ç”¨ mosdnsï¼Œç»å†äº† 4.1 å’Œ 4.2 ä¸ç¨³å®šçš„åŠŸèƒ½æ›´æ–°å’Œä»Šå¹´ 1 æœˆä»½å‘å¸ƒ 5.x å¤§ç‰ˆæœ¬é‡æ„åè²Œä¼¼å·²ç»ç¨³å®šä¸‹æ¥ã€‚\næ‰˜ @river_leaves çš„ç¦åˆ©ç”¨ mosdns è‡ªå¸¦çš„ prometheus metrics æ¥å£å®æ—¶æŸ¥çœ‹ DNS è§£ææƒ…å†µã€‚\né…ç½®ä¸­çš„è§„åˆ™æ˜¯çµæ´»ä¸”æœ‰æ—¶å€™å¾ˆéš¾è°ƒè¯•ï¼Œä¸ºäº†éªŒè¯é…ç½®è§„åˆ™æ˜¯å¦æœ‰æ•ˆä»¥åŠå¯è§†åŒ–çœ‹åˆ°åŸŸåè®¿é—®é¢‘æ¬¡ï¼Œæˆ‘ä» mosdns æ—¥å¿—æœ¬èº«ä¸‹æ‰‹ï¼Œéœ€è¦çš„å·¥å…·æœ‰ vectorã€prometheusã€loki å’Œ grafanaã€‚\nå®æ—¶ç›‘æ§ mosdns è§„åˆ™è§£æ Grafana çœ‹æ¿\nå½“å‰æ•™ç¨‹ä»…é€‚ç”¨äº mosdns 5.0 ~ 5.3.x ç‰ˆæœ¬ï¼ˆåç»­ç‰ˆæœ¬æ²¡æœ‰å‘å¸ƒå¯èƒ½å­˜åœ¨é…ç½®å˜åŒ–ï¼Œä¾æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰ã€‚\nmosdns mosdns 5 ç‰ˆæœ¬é‡‡ç”¨äº†æ–°æ•°æ®æºè§£åŒ…æ ¼å¼ï¼Œé…ç½®æˆ‘å®åœ¨æ‡’å¾—è°ƒæ•´äº†ï¼Œç›´æ¥åœ¨é‡‡ç”¨äº† luci-app-mosdns æ’ä»¶é…ç½®å¾®è°ƒã€‚é…ç½®ä¸­å„ä¸ª plugins åç§°è¯·ç¡®ä¿ä¸è¦ä¿®æ”¹å’Œå˜åŠ¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´ vector è½¬æ¢è§„åˆ™æ— æ³•æ­£å¸¸å·¥ä½œã€‚\nçœ‹ä¸åˆ°ä¸‹é¢é…ç½®æ–‡ä»¶çš„ï¼Œé€ä¸Šç›´è¾¾ç”µæ¢¯ã€‚\né…ç½®å®šä¹‰äº† mosdns æ—¥å¿—çš„æ–‡ä»¶è·¯å¾„ä¸º /var/log/mosdns.logï¼Œè¾“å‡ºæ—¥å¿—ç­‰çº§åªéœ€è¦æ˜¯ INFO å³å¯ã€‚å¦‚æœ mosdns æœåŠ¡æ‰€åœ¨ç£ç›˜ç©ºé—´è¾ƒå°å»ºè®®ä½¿ç”¨ logrotate æ¥åˆ‡å‰²æ—¥å¿—å¹¶æ§åˆ¶å½’æ¡£æ—¥å¿—æ•°é‡ï¼Œä»¥å…å‡ºç°ç©ºé—´ä¸è¶³çš„æƒ…å†µã€‚\n1/var/log/mosdns.log { 2 daily 3 rotate 2 4 compress 5 missingok 6 notifempty 7 copytruncate 8} copytruncate çš„æ„æ€æ˜¯å°†æ—§æ—¥å¿—æ–‡ä»¶çš„å†…å®¹å¤åˆ¶åˆ°æ–°æ—¥å¿—æ–‡ä»¶ï¼Œé»˜è®¤æ˜¯ç›´æ¥æ”¹ååŸæ–‡ä»¶ä¼šé€ æˆ mosdns è¿è¡Œæ—¥å¿—è®°å½•å‡ºç°é—®é¢˜ï¼Œè®¾ç½®å¥½åç¡®ä¿ logrotate å®šæ—¶è¿è¡Œï¼š\n1# crontab -e 20 1 * * * /bin/sh -c \"/usr/sbin/logrotate -l=syslog -d /etc/logrotate.d\" vector vector æ˜¯ä¸€ä¸ªæ—¥å¿—æ”¶é›†å·¥å…·ï¼Œèƒ½å¤Ÿä»å¤šä¸ªæºï¼ˆSourceï¼‰æ”¶é›†ã€è½¬æ¢ï¼ˆTransformï¼‰å¹¶æ¨é€åˆ°ä¸‹ä¸€ä¸ªæ¥æ”¶å™¨ï¼ˆSinksï¼‰ã€‚\nvector éœ€è¦èƒ½å¤Ÿç›´æ¥è®¿é—®åˆ° mosdns çš„æ—¥å¿—æ–‡ä»¶ã€‚è¿™é‡Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å®ç°ï¼šä¸€ç§æ˜¯ä¸¤ä¸ªæœåŠ¡éƒ½åœ¨ä¸€å°æœºå™¨ä¸Šè¿è¡Œï¼Œå¦å¤–ä¸€ç§æ˜¯é€šè¿‡å®¹å™¨åŒ–å…±äº« volume è®© vector å¯ä»¥è¯»å– mosdns æ—¥å¿—ã€‚\nå·¥å…·æœ¬èº«æ˜¯ Go è¯­è¨€å¼€å‘ä» Github ç›´æ¥ä¸‹è½½å¥½å¯¹åº”çš„åŒ…è§£å‹ç¼©å°±èƒ½å¤Ÿä½¿ç”¨æˆ–è€…ä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬ï¼š\n1curl --proto '=https' --tlsv1.2 -sSf https://sh.vector.dev | bash Openwrt/Immortalwrt ç”¨æˆ·å¯ä½¿ç”¨æˆ‘ä¸ªäººç»´æŠ¤çš„ä»“åº“ icyleaf/openwrt-dist æ·»åŠ åå³å¯å®‰è£…ï¼ˆæ”¯æŒ amd64ã€armv8 å¹³å°çš„ snapshot å’Œ 23.05.0 ä¸¤ä¸ªåˆ†æ”¯ï¼‰ï¼š\næ·»åŠ ä»“åº“å¯†é’¥\n1wget http://cdn.jsdelivr.net/gh/icyleaf/openwrt-dist@master/key-build.pub 2opkg-key add key-build.pub æ ¹æ® openwrt å¹³å°ä¸åŒä¿®æ”¹æºåœ°å€\n1# æºè§„åˆ™ 2# src/gz icyleaf https://icyleaf-openwrt-repo.vercel.app/{{{target}}/packages/{{arch}} 3 4# æ·»åŠ  snapshot åˆ†æ”¯ amd64 (x86/64) å¹³å°çš„æº 5echo \"src/gz icyleaf https://icyleaf-openwrt-repo.vercel.app/snapshots/packages/x86/64\" \u003e\u003e /etc/opkg/customfeeds.conf å®‰è£… vector\n1opkg update 2opkg install vector ä¿®æ”¹ /etc/vector/config.yml çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹\n1data_dir: /tmp/vector 2 3sources: 4 mosdns-log-file: 5 type: file 6 include: 7 - /var/log/mosdns.log 8 read_from: beginning 9 10transforms: 11 mosdns-input: 12 type: filter 13 inputs: 14 - mosdns-log-file 15 condition: | 16 .file == \"/var/log/mosdns.log\" 17 18 mosdns-data: 19 type: remap 20 inputs: 21 - mosdns-input 22 drop_on_error: true 23 source: | 24 .type = \"mosdns\" 25 .app = \"mosdns\" 26 del(.host) 27 del(.file) 28 del(.source_type) 29 30 message_parts = split!(.message, r'\\t') 31 32 .timestamp = parse_timestamp!(message_parts[0], format: \"%F %T\") 33 .level = message_parts[1] 34 35 if (length(message_parts) == 6) { 36 .plugin = message_parts[2] 37 .processor = message_parts[3] 38 .message = message_parts[4] 39 40 if (exists(message_parts[5])) { 41 .metadata = parse_json!(message_parts[5]) 42 . = merge!(., .metadata) 43 del(.metadata) 44 } 45 } else { 46 .processor = message_parts[2] 47 .message = message_parts[3] 48 49 if (exists(message_parts[4])) { 50 .metadata = parse_json!(message_parts[4]) 51 . = merge!(., .metadata) 52 del(.metadata) 53 } 54 } 55 56 if (exists(.query)) { 57 . = merge!(., .query) 58 del(.query) 59 } 60 61sinks: 62 # åŒæ­¥åˆ° lokiï¼Œæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ endpoint çš„å€¼ 63 loki: 64 type: loki 65 inputs: 66 - mosdns-data 67 endpoint: 'http://10.10.10.2:3100' 68 encoding: 69 codec: json 70 labels: 71 app: '{{ app }}' 72 type: '{{ type }}' 73 healthcheck: 74 enabled: true 75 76 # ä¸´æ—¶è¾“å‡ºè½¬æ¢æ•°æ®åˆ° vector æ§åˆ¶å°ï¼ˆç”Ÿäº§ç¯å¢ƒè¯·ç¦ç”¨ï¼‰ 77 debug_mosdns: 78 type: console 79 inputs: 80 - mosdns-data 81 encoding: 82 codec: json mosdns 5.3 å¯¹æ¯” 5.0 ~ 5.1.x ç‰ˆæœ¬æ—¶é—´æˆ³å’Œ query å­—æ®µåšäº†ä¿®æ”¹ï¼Œéœ€è¦è°ƒæ•´é…ç½®æ–‡ä»¶ï¼š\n1... 2- .timestamp = parse_timestamp!(message_parts[0], format: \"%F %T\") 3+ .timestamp = parse_timestamp!(message_parts[0], format: \"%FT%T%.9fZ\") 4 5... 6 if (exists(.query)) { 7- . = merge!(., .query) 8- del(.query) 9+ query_parts = split!(.query, r'\\s') 10+ .domain = query_parts[0] 11+ .record = query_parts[2] 12+ .address = query_parts[5] 13 } è¿è¡Œ vector æœåŠ¡ï¼ˆéƒ¨ç½²å¥½ loki åå†è¿è¡Œï¼‰\né openwrt ç”¨æˆ·ä½¿ç”¨\n1vector --config /etc/vector/config.yml --watch-config --verbose openwrt ç”¨æˆ·ä½¿ç”¨\n1$ /etc/init.d/vector start 2 3Loaded with warnings [\"/etc/vector/config.yml\"] 4----------------------------------------------- 5âˆš Component configuration 6âˆš Health check \"loki\" 7âˆš Health check \"vector\" 8----------------------------------------------- 9 Validated ä½¿ç”¨ openwrt æ’ä»¶çš„ vector æœåŠ¡æœ¬èº«æ˜¯ä¼šç›‘æ§é…ç½®æ–‡ä»¶å˜åŒ–å¹¶é‡è½½ï¼Œåé¢å†è°ƒæ•´çš„æ—¶å€™ä¹Ÿä¸éœ€è¦åå¤é‡å¯æœåŠ¡ã€‚\nprometheus prometheus æ˜¯ä¸€ä¸ªç›‘æ§æ•°æ®æœåŠ¡ï¼Œå¯ä»¥ä½œä¸º Grafana æ•°æ®æºä½¿ç”¨ã€‚å®‰è£…å‚è€ƒå®˜æ–¹æ•™ç¨‹ï¼Œé…ç½®æ–‡ä»¶éœ€è¦æŠŠ mosdns metrics åœ°å€ï¼ˆæ¯”å¦‚æ˜¯ 10.10.10.1:8338ï¼‰åŠ åˆ° prometheus.yml æ–‡ä»¶ä¸­:\n1global: 2 scrape_interval: 1m 3 evaluation_interval: 1m 4 5scrape_configs: 6+ - job_name: mosdns 7+ scrape_interval: 5s 8+ # scrape_timeout: 10s 9+ 10+ # metrics_path: /metrics 11+ static_configs: 12+ - targets: 13+ - 10.10.10.1:8338 loki loki æ˜¯ä¸€ä¸ªæ—¥å¿—èšåˆæœåŠ¡ï¼Œæœ¬èº«ä¹Ÿæ˜¯ Grafana ç ”å‘çš„ï¼Œå¯ä»¥ä½œä¸º Grafana æ•°æ®æºä½¿ç”¨ã€‚å‚ç…§å®˜æ–¹æ–‡æ¡£å°±èƒ½éƒ¨ç½²å¥½ loki å’Œ Grafanaï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯è¦æå‰ä¸‹è½½å¥½ loki é…ç½®æ–‡ä»¶ã€‚éƒ¨ç½²å¥½ä¹‹åæŠŠ loki åœ°å€æ›´æ–°åˆ°ä¸Šé¢ vector é…ç½®ã€‚\ngrafana grafana æ˜¯ä¸€ä¸ªæ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œå®‰è£…è§ loki éƒ¨åˆ†ï¼Œå·²æœ‰æœåŠ¡ç›´æ¥è·³è¿‡ã€‚\nDashboard çœ‹æ¿çš„é…ç½®å°±éå¸¸ç®€å•äº†ï¼Œå…ˆæ·»åŠ å¥½ prometheus å’Œ loki çš„æ•°æ®æºåï¼Œå¯¼å…¥ mosdns v5 çœ‹æ¿ï¼ŒæŒ‰ç…§å›¾ç¤ºé…ç½®å³å¯ã€‚\nGrafana å¯¼å…¥ Dashboard çœ‹æ¿\nGrafana é…ç½®æ•°æ®æº\nç»“è¯­ æ„Ÿè°¢ mosdns é•¿è¾¾å‡ ä¸ªæœˆçš„é…ç½®ç¨³å®šä¹‹å‰æŒ–çš„å‘å¡«ä¸Šäº†ï¼Œæ’’èŠ±ï¼\n","wordCount":"1689","inLanguage":"zh-cn","image":"https://images.unsplash.com/photo-1668089135991-e2d5ca8c62a6?ixlib=rb-4.0.3\u0026ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026auto=format\u0026fit=crop\u0026w=2874\u0026q=80","datePublished":"2023-08-23T10:04:13+08:00","dateModified":"2023-08-23T10:04:13+08:00","author":{"@type":"Person","name":"icyleaf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://icyleaf.com/2023/08/using-vector-transform-mosdns-logging-to-grafana-via-loki/"},"publisher":{"@type":"Organization","name":"icyleaf","logo":{"@type":"ImageObject","url":"https://icyleaf.com/favicon.ico"}}}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/series/homelab title>homelab ç³»åˆ—
</a><a class=menu-item href=https://icyleaf.com/projects title>å¼€æºé¡¹ç›®
</a><a class=menu-item href=https://icyleaf.com/gears title>æˆ‘çš„è®¾å¤‡
</a><a class=menu-item href=https://icyleaf.com/about title>å…³äº
</a><span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/series/homelab title><h3>homelab ç³»åˆ—</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>å¼€æºé¡¹ç›®</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/gears title><h3>æˆ‘çš„è®¾å¤‡</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/about title><h3>å…³äº</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=post-cover><img src="https://images.unsplash.com/photo-1668089135991-e2d5ca8c62a6?ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=2874&amp;q=80" loading=lazy><p class=cover-author>Photo by
<a href=https://unsplash.com/@greenpeacesuomi>Greenpeace Finland
</a>/
<a href=https://unsplash.com>Unsplash</a></p></div><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop=description>vector + loki å®ç° mosdns æ•°æ®çœ‹æ¿</h1><div class=post-description>å¿«é€ŸéªŒè¯è§„åˆ™çš„åŒæ—¶å®ç°ç±»ä¼¼ AdGuard Home å¥½çœ‹çš„æ•°æ®çœ‹æ¿</div><div class=post-meta><time datetime=2023-08-23 itemprop=datePublished>2023-08-23</time>
Â·
<span class=tags>vector, mosdns, loki, linux, openwrt, grafana</span>
Â·
<span class=post-word-count>1689 words Â· 7 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>ç›®å½•</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#mosdns>mosdns</a></li><li><a href=#vector>vector</a></li><li><a href=#prometheus>prometheus</a></li><li><a href=#loki>loki</a></li><li><a href=#grafana>grafana</a></li><li><a href=#ç»“è¯­>ç»“è¯­</a></li></ul></nav></div></div><div class=post-content><div id=post-gallery><div class="updated updated-mark"><header class="updated-header color-note"><h4 class=updated-title>æ›´æ–°</h4><p class=updated-meta>Jun 7, 2024</p></header><article class=updated-body><ul><li>5.3 æ—¥å¿—ç»“æ„ä½œè€…åˆåšè°ƒæ•´äº†ï¼Œå®Œæ•´é…ç½®å·²æ›´æ–°ï¼Œå¦‚æœæ˜¯ 5.0 ~ 5.1.x ç‰ˆæœ¬éœ€è¦æ³¨æ„å®Œæ•´é…ç½®ä¸‹é¢çš„ä»£ç å¯¹æ¯”éƒ¨åˆ†ã€‚</li><li>ä½œè€…è‡ªå·±ä½¿ç”¨æ˜¯æŠŠ modsns ä»ä¹‹å‰çš„åç½®æ”¹æˆäº†å‰ç½®æµ‹è¯•äº†å¥½å‡ ä¸ªæœˆï¼Œå¥½å¤„æ˜¯æŸäº›æœåŠ¡æŒ‚äº†ä¹Ÿä¸ä¼šå½±å“ DNS çš„è§£æï¼Œæœ‰æƒ³äº†è§£å…·ä½“ç»†èŠ‚çš„å—ï¼Ÿ</li></ul><p>æ›´æ–°ç»´æŠ¤ä¸æ˜“ï¼Œæ¬¢è¿åœ¨æ–‡ç« å°¾éƒ¨æ‰“èµä½œè€…ï¼Œè¿™ä¸ªå¯¹äºä½œè€…å¾ˆé‡è¦ï¼Œæ„Ÿè°¢ä½ çš„æ”¯æŒï¼</p></article></div><p>æˆ‘æ˜¯ä» 4.0 ç‰ˆæœ¬å¼€å§‹ä½¿ç”¨ <a href=https://github.com/IrineSistiana/mosdns>mosdns</a>ï¼Œç»å†äº† 4.1 å’Œ 4.2 <a href=https://github.com/IrineSistiana/mosdns/discussions/417#discussioncomment-3831982>ä¸ç¨³å®šçš„åŠŸèƒ½æ›´æ–°</a>å’Œä»Šå¹´ 1 æœˆä»½å‘å¸ƒ 5.x å¤§ç‰ˆæœ¬é‡æ„åè²Œä¼¼å·²ç»ç¨³å®šä¸‹æ¥ã€‚</p><p>æ‰˜ @<a href=https://twitter.com/river_leaves/status/1574393162163896321>river_leaves</a> çš„ç¦åˆ©ç”¨ mosdns è‡ªå¸¦çš„ <a href=https://irine-sistiana.gitbook.io/mosdns-wiki/mosdns-v5/api-shuo-ming>prometheus metrics</a> æ¥å£å®æ—¶æŸ¥çœ‹ DNS è§£ææƒ…å†µã€‚</p><p>é…ç½®ä¸­çš„è§„åˆ™æ˜¯çµæ´»ä¸”æœ‰æ—¶å€™å¾ˆéš¾è°ƒè¯•ï¼Œä¸ºäº†éªŒè¯é…ç½®è§„åˆ™æ˜¯å¦æœ‰æ•ˆä»¥åŠå¯è§†åŒ–çœ‹åˆ°åŸŸåè®¿é—®é¢‘æ¬¡ï¼Œæˆ‘ä» mosdns æ—¥å¿—æœ¬èº«ä¸‹æ‰‹ï¼Œéœ€è¦çš„å·¥å…·æœ‰ vectorã€prometheusã€loki å’Œ grafanaã€‚</p><figure data-pswp=2552x1204 data-size=800x><a href=https://icyleaf.com/uploads/2023/08/grafana-mosdns.png class=gallery-item target=_blank data-pswp-width=2552 data-pswp-height=1204><img src=https://icyleaf.com/uploads/2023/08/grafana-mosdns_hu14669541674982067454.png></a><figcaption><p>å®æ—¶ç›‘æ§ mosdns è§„åˆ™è§£æ Grafana çœ‹æ¿</p></figcaption></figure><blockquote><p>å½“å‰æ•™ç¨‹ä»…é€‚ç”¨äº mosdns 5.0 ~ 5.3.x ç‰ˆæœ¬ï¼ˆåç»­ç‰ˆæœ¬æ²¡æœ‰å‘å¸ƒå¯èƒ½å­˜åœ¨é…ç½®å˜åŒ–ï¼Œä¾æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰ã€‚</p></blockquote><h2 id=mosdns>mosdns</h2><p>mosdns 5 ç‰ˆæœ¬é‡‡ç”¨äº†<a href=https://github.com/IrineSistiana/mosdns/discussions/584>æ–°æ•°æ®æºè§£åŒ…æ ¼å¼</a>ï¼Œé…ç½®æˆ‘å®åœ¨æ‡’å¾—è°ƒæ•´äº†ï¼Œç›´æ¥åœ¨é‡‡ç”¨äº† <a href=https://github.com/sbwml/luci-app-mosdns>luci-app-mosdns</a> æ’ä»¶é…ç½®å¾®è°ƒã€‚é…ç½®ä¸­å„ä¸ª plugins åç§°è¯·ç¡®ä¿ä¸è¦ä¿®æ”¹å’Œå˜åŠ¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´ vector è½¬æ¢è§„åˆ™æ— æ³•æ­£å¸¸å·¥ä½œã€‚</p><p>çœ‹ä¸åˆ°ä¸‹é¢é…ç½®æ–‡ä»¶çš„ï¼Œé€ä¸Š<a href=https://gist.github.com/icyleaf/e98093f673b4b2850226db582447175a#file-mosdns_config_v5-yaml>ç›´è¾¾ç”µæ¢¯</a>ã€‚</p><script type=text/javascript src="http://gist.github.com/e98093f673b4b2850226db582447175a.js?file=mosdns_config_v5.yaml&theme=dark"></script><p>é…ç½®å®šä¹‰äº† mosdns æ—¥å¿—çš„æ–‡ä»¶è·¯å¾„ä¸º <code>/var/log/mosdns.log</code>ï¼Œè¾“å‡ºæ—¥å¿—ç­‰çº§åªéœ€è¦æ˜¯ INFO å³å¯ã€‚å¦‚æœ mosdns æœåŠ¡æ‰€åœ¨ç£ç›˜ç©ºé—´è¾ƒå°å»ºè®®ä½¿ç”¨ logrotate æ¥åˆ‡å‰²æ—¥å¿—å¹¶æ§åˆ¶å½’æ¡£æ—¥å¿—æ•°é‡ï¼Œä»¥å…å‡ºç°ç©ºé—´ä¸è¶³çš„æƒ…å†µã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=ln>1</span><span class=cl>/var/log/mosdns.log {
</span></span><span class=line><span class=ln>2</span><span class=cl>  daily
</span></span><span class=line><span class=ln>3</span><span class=cl>  rotate 2
</span></span><span class=line><span class=ln>4</span><span class=cl>  compress
</span></span><span class=line><span class=ln>5</span><span class=cl>  missingok
</span></span><span class=line><span class=ln>6</span><span class=cl>  notifempty
</span></span><span class=line><span class=ln>7</span><span class=cl>  copytruncate
</span></span><span class=line><span class=ln>8</span><span class=cl>}
</span></span></code></pre></div><p><code>copytruncate</code> çš„æ„æ€æ˜¯å°†æ—§æ—¥å¿—æ–‡ä»¶çš„å†…å®¹å¤åˆ¶åˆ°æ–°æ—¥å¿—æ–‡ä»¶ï¼Œé»˜è®¤æ˜¯ç›´æ¥æ”¹ååŸæ–‡ä»¶ä¼šé€ æˆ mosdns è¿è¡Œæ—¥å¿—è®°å½•å‡ºç°é—®é¢˜ï¼Œè®¾ç½®å¥½åç¡®ä¿ logrotate å®šæ—¶è¿è¡Œï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># crontab -e</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=m>0</span> <span class=m>1</span> * * * /bin/sh -c <span class=s2>&#34;/usr/sbin/logrotate -l=syslog -d /etc/logrotate.d&#34;</span>
</span></span></code></pre></div><h2 id=vector>vector</h2><p><a href=https://vector.dev>vector</a> æ˜¯ä¸€ä¸ªæ—¥å¿—æ”¶é›†å·¥å…·ï¼Œèƒ½å¤Ÿä»å¤šä¸ªæºï¼ˆSourceï¼‰æ”¶é›†ã€è½¬æ¢ï¼ˆTransformï¼‰å¹¶æ¨é€åˆ°ä¸‹ä¸€ä¸ªæ¥æ”¶å™¨ï¼ˆSinksï¼‰ã€‚</p><figure data-pswp=1630x736 data-size=800x><a href=https://icyleaf.com/uploads/2023/08/vector-flow.png class=gallery-item target=_blank data-pswp-width=1630 data-pswp-height=736><img src=https://icyleaf.com/uploads/2023/08/vector-flow_hu10473946876088393779.png></a></figure><p>vector éœ€è¦èƒ½å¤Ÿç›´æ¥è®¿é—®åˆ° mosdns çš„æ—¥å¿—æ–‡ä»¶ã€‚è¿™é‡Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å®ç°ï¼šä¸€ç§æ˜¯ä¸¤ä¸ªæœåŠ¡éƒ½åœ¨ä¸€å°æœºå™¨ä¸Šè¿è¡Œï¼Œå¦å¤–ä¸€ç§æ˜¯é€šè¿‡å®¹å™¨åŒ–å…±äº« volume è®© vector å¯ä»¥è¯»å– mosdns æ—¥å¿—ã€‚</p><p>å·¥å…·æœ¬èº«æ˜¯ Go è¯­è¨€å¼€å‘ä» Github ç›´æ¥ä¸‹è½½å¥½å¯¹åº”çš„åŒ…è§£å‹ç¼©å°±èƒ½å¤Ÿä½¿ç”¨æˆ–è€…ä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>curl --proto <span class=s1>&#39;=https&#39;</span> --tlsv1.2 -sSf https://sh.vector.dev <span class=p>|</span> bash
</span></span></code></pre></div><p>Openwrt/Immortalwrt ç”¨æˆ·å¯ä½¿ç”¨æˆ‘ä¸ªäººç»´æŠ¤çš„ä»“åº“ <a href=https://github.com/icyleaf/openwrt-dist>icyleaf/openwrt-dist</a> æ·»åŠ åå³å¯å®‰è£…ï¼ˆæ”¯æŒ amd64ã€armv8 å¹³å°çš„ snapshot å’Œ 23.05.0 ä¸¤ä¸ªåˆ†æ”¯ï¼‰ï¼š</p><p>æ·»åŠ ä»“åº“å¯†é’¥</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>wget http://cdn.jsdelivr.net/gh/icyleaf/openwrt-dist@master/key-build.pub
</span></span><span class=line><span class=ln>2</span><span class=cl>opkg-key add key-build.pub
</span></span></code></pre></div><p>æ ¹æ® openwrt å¹³å°ä¸åŒä¿®æ”¹æºåœ°å€</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># æºè§„åˆ™</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=c1># src/gz icyleaf https://icyleaf-openwrt-repo.vercel.app/{{{target}}/packages/{{arch}}</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=c1># æ·»åŠ  snapshot åˆ†æ”¯ amd64 (x86/64) å¹³å°çš„æº</span>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=nb>echo</span> <span class=s2>&#34;src/gz icyleaf https://icyleaf-openwrt-repo.vercel.app/snapshots/packages/x86/64&#34;</span> &gt;&gt; /etc/opkg/customfeeds.conf
</span></span></code></pre></div><p>å®‰è£… vector</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>opkg update
</span></span><span class=line><span class=ln>2</span><span class=cl>opkg install vector
</span></span></code></pre></div><p>ä¿®æ”¹ <code>/etc/vector/config.yml</code> çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>data_dir</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/vector</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=nt>sources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>mosdns-log-file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>file</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=nt>include</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>      </span>- <span class=l>/var/log/mosdns.log</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=nt>read_from</span><span class=p>:</span><span class=w> </span><span class=l>beginning</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w></span><span class=nt>transforms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>  </span><span class=nt>mosdns-input</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>filter</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>    </span><span class=nt>inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>      </span>- <span class=l>mosdns-log-file</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=sd>      .file == &#34;/var/log/mosdns.log&#34;</span><span class=w>      
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>  </span><span class=nt>mosdns-data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>remap</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>    </span><span class=nt>inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>      </span>- <span class=l>mosdns-input</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>    </span><span class=nt>drop_on_error</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>    </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=sd>      .type = &#34;mosdns&#34;
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=sd>      .app = &#34;mosdns&#34;
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=sd>      del(.host)
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=sd>      del(.file)
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=sd>      del(.source_type)
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=sd>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=sd>      message_parts = split!(.message, r&#39;\t&#39;)
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=sd>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=sd>      .timestamp = parse_timestamp!(message_parts[0], format: &#34;%F %T&#34;)
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=sd>      .level = message_parts[1]
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=sd>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=sd>      if (length(message_parts) == 6) {
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=sd>        .plugin = message_parts[2]
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=sd>        .processor = message_parts[3]
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=sd>        .message = message_parts[4]
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=sd>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=sd>        if (exists(message_parts[5])) {
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=sd>          .metadata = parse_json!(message_parts[5])
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=sd>          . = merge!(., .metadata)
</span></span></span><span class=line><span class=ln>43</span><span class=cl><span class=sd>          del(.metadata)
</span></span></span><span class=line><span class=ln>44</span><span class=cl><span class=sd>        }
</span></span></span><span class=line><span class=ln>45</span><span class=cl><span class=sd>      } else {
</span></span></span><span class=line><span class=ln>46</span><span class=cl><span class=sd>        .processor = message_parts[2]
</span></span></span><span class=line><span class=ln>47</span><span class=cl><span class=sd>        .message = message_parts[3]
</span></span></span><span class=line><span class=ln>48</span><span class=cl><span class=sd>
</span></span></span><span class=line><span class=ln>49</span><span class=cl><span class=sd>        if (exists(message_parts[4])) {
</span></span></span><span class=line><span class=ln>50</span><span class=cl><span class=sd>          .metadata = parse_json!(message_parts[4])
</span></span></span><span class=line><span class=ln>51</span><span class=cl><span class=sd>          . = merge!(., .metadata)
</span></span></span><span class=line><span class=ln>52</span><span class=cl><span class=sd>          del(.metadata)
</span></span></span><span class=line><span class=ln>53</span><span class=cl><span class=sd>        }
</span></span></span><span class=line><span class=ln>54</span><span class=cl><span class=sd>      }
</span></span></span><span class=line><span class=ln>55</span><span class=cl><span class=sd>
</span></span></span><span class=line><span class=ln>56</span><span class=cl><span class=sd>      if (exists(.query)) {
</span></span></span><span class=line><span class=ln>57</span><span class=cl><span class=sd>        . = merge!(., .query)
</span></span></span><span class=line><span class=ln>58</span><span class=cl><span class=sd>        del(.query)
</span></span></span><span class=line><span class=ln>59</span><span class=cl><span class=sd>      }</span><span class=w>      
</span></span></span><span class=line><span class=ln>60</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>61</span><span class=cl><span class=w></span><span class=nt>sinks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>62</span><span class=cl><span class=w>  </span><span class=c># åŒæ­¥åˆ° lokiï¼Œæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ endpoint çš„å€¼</span><span class=w>
</span></span></span><span class=line><span class=ln>63</span><span class=cl><span class=w>  </span><span class=nt>loki</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>64</span><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>loki</span><span class=w>
</span></span></span><span class=line><span class=ln>65</span><span class=cl><span class=w>    </span><span class=nt>inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>66</span><span class=cl><span class=w>      </span>- <span class=l>mosdns-data</span><span class=w>
</span></span></span><span class=line><span class=ln>67</span><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;http://10.10.10.2:3100&#39;</span><span class=w>
</span></span></span><span class=line><span class=ln>68</span><span class=cl><span class=w>    </span><span class=nt>encoding</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>69</span><span class=cl><span class=w>      </span><span class=nt>codec</span><span class=p>:</span><span class=w> </span><span class=l>json</span><span class=w>
</span></span></span><span class=line><span class=ln>70</span><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>71</span><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{ app }}&#39;</span><span class=w>
</span></span></span><span class=line><span class=ln>72</span><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{ type }}&#39;</span><span class=w>
</span></span></span><span class=line><span class=ln>73</span><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>74</span><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=ln>75</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>76</span><span class=cl><span class=w>  </span><span class=c># ä¸´æ—¶è¾“å‡ºè½¬æ¢æ•°æ®åˆ° vector æ§åˆ¶å°ï¼ˆç”Ÿäº§ç¯å¢ƒè¯·ç¦ç”¨ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=ln>77</span><span class=cl><span class=w>  </span><span class=nt>debug_mosdns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>78</span><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>console</span><span class=w>
</span></span></span><span class=line><span class=ln>79</span><span class=cl><span class=w>    </span><span class=nt>inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>80</span><span class=cl><span class=w>      </span>- <span class=l>mosdns-data</span><span class=w>
</span></span></span><span class=line><span class=ln>81</span><span class=cl><span class=w>    </span><span class=nt>encoding</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>82</span><span class=cl><span class=w>      </span><span class=nt>codec</span><span class=p>:</span><span class=w> </span><span class=l>json</span><span class=w>
</span></span></span></code></pre></div><p>mosdns 5.3 å¯¹æ¯” 5.0 ~ 5.1.x ç‰ˆæœ¬æ—¶é—´æˆ³å’Œ query å­—æ®µåšäº†ä¿®æ”¹ï¼Œéœ€è¦è°ƒæ•´é…ç½®æ–‡ä»¶ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=ln> 1</span><span class=cl>...
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=gd>-      .timestamp = parse_timestamp!(message_parts[0], format: &#34;%F %T&#34;)
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=gd></span><span class=gi>+      .timestamp = parse_timestamp!(message_parts[0], format: &#34;%FT%T%.9fZ&#34;)
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=gi></span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>...
</span></span><span class=line><span class=ln> 6</span><span class=cl>      if (exists(.query)) {
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=gd>-        . = merge!(., .query)
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=gd>-        del(.query)
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=gd></span><span class=gi>+        query_parts = split!(.query, r&#39;\s&#39;)
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=gi>+        .domain = query_parts[0]
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=gi>+        .record = query_parts[2]
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=gi>+        .address = query_parts[5]
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=gi></span>      }
</span></span></code></pre></div><p>è¿è¡Œ vector æœåŠ¡ï¼ˆéƒ¨ç½²å¥½ loki åå†è¿è¡Œï¼‰</p><p>é openwrt ç”¨æˆ·ä½¿ç”¨</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>vector --config /etc/vector/config.yml --watch-config --verbose
</span></span></code></pre></div><p>openwrt ç”¨æˆ·ä½¿ç”¨</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>$ /etc/init.d/vector start
</span></span><span class=line><span class=ln>2</span><span class=cl>
</span></span><span class=line><span class=ln>3</span><span class=cl>Loaded with warnings <span class=o>[</span><span class=s2>&#34;/etc/vector/config.yml&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>-----------------------------------------------
</span></span><span class=line><span class=ln>5</span><span class=cl>âˆš Component configuration
</span></span><span class=line><span class=ln>6</span><span class=cl>âˆš Health check <span class=s2>&#34;loki&#34;</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>âˆš Health check <span class=s2>&#34;vector&#34;</span>
</span></span><span class=line><span class=ln>8</span><span class=cl>-----------------------------------------------
</span></span><span class=line><span class=ln>9</span><span class=cl>                                      Validated
</span></span></code></pre></div><p>ä½¿ç”¨ openwrt æ’ä»¶çš„ vector æœåŠ¡æœ¬èº«æ˜¯ä¼šç›‘æ§é…ç½®æ–‡ä»¶å˜åŒ–å¹¶é‡è½½ï¼Œåé¢å†è°ƒæ•´çš„æ—¶å€™ä¹Ÿä¸éœ€è¦åå¤é‡å¯æœåŠ¡ã€‚</p><h2 id=prometheus>prometheus</h2><p><a href=https://prometheus.io/>prometheus</a> æ˜¯ä¸€ä¸ªç›‘æ§æ•°æ®æœåŠ¡ï¼Œå¯ä»¥ä½œä¸º Grafana æ•°æ®æºä½¿ç”¨ã€‚å®‰è£…å‚è€ƒ<a href=https://prometheus.io/docs/prometheus/latest/installation/>å®˜æ–¹æ•™ç¨‹</a>ï¼Œé…ç½®æ–‡ä»¶éœ€è¦æŠŠ mosdns metrics åœ°å€ï¼ˆæ¯”å¦‚æ˜¯ 10.10.10.1:8338ï¼‰åŠ åˆ° <code>prometheus.yml</code> æ–‡ä»¶ä¸­:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=ln> 1</span><span class=cl>global:
</span></span><span class=line><span class=ln> 2</span><span class=cl>  scrape_interval:     1m
</span></span><span class=line><span class=ln> 3</span><span class=cl>  evaluation_interval: 1m
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl>scrape_configs:
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=gi>+  - job_name: mosdns
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=gi>+    scrape_interval: 5s
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=gi>+    # scrape_timeout: 10s
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=gi>+
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=gi>+    # metrics_path: /metrics
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=gi>+    static_configs:
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=gi>+      - targets:
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=gi>+        - 10.10.10.1:8338
</span></span></span></code></pre></div><h2 id=loki>loki</h2><p><a href=https://grafana.com/oss/loki/>loki</a> æ˜¯ä¸€ä¸ªæ—¥å¿—èšåˆæœåŠ¡ï¼Œæœ¬èº«ä¹Ÿæ˜¯ Grafana ç ”å‘çš„ï¼Œå¯ä»¥ä½œä¸º Grafana æ•°æ®æºä½¿ç”¨ã€‚å‚ç…§<a href=https://grafana.com/docs/loki/latest/installation/docker/>å®˜æ–¹æ–‡æ¡£</a>å°±èƒ½éƒ¨ç½²å¥½ loki å’Œ Grafanaï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯è¦æå‰ä¸‹è½½å¥½ loki <a href=https://raw.githubusercontent.com/grafana/loki/v2.8.0/cmd/loki/loki-local-config.yaml>é…ç½®æ–‡ä»¶</a>ã€‚éƒ¨ç½²å¥½ä¹‹åæŠŠ loki åœ°å€æ›´æ–°åˆ°ä¸Šé¢ vector é…ç½®ã€‚</p><h2 id=grafana>grafana</h2><p><a href=https://grafana.com/>grafana</a> æ˜¯ä¸€ä¸ªæ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œå®‰è£…è§ loki éƒ¨åˆ†ï¼Œå·²æœ‰æœåŠ¡ç›´æ¥è·³è¿‡ã€‚</p><p>Dashboard çœ‹æ¿çš„é…ç½®å°±éå¸¸ç®€å•äº†ï¼Œå…ˆæ·»åŠ å¥½ prometheus å’Œ loki çš„æ•°æ®æºåï¼Œå¯¼å…¥ <a href=https://grafana.com/grafana/dashboards/19305-mosdns-v5/>mosdns v5 çœ‹æ¿</a>ï¼ŒæŒ‰ç…§å›¾ç¤ºé…ç½®å³å¯ã€‚</p><figure data-pswp=1804x800 data-size=800x><a href=https://icyleaf.com/uploads/2023/08/import-grafana-dashboard.png class=gallery-item target=_blank data-pswp-width=1804 data-pswp-height=800><img src=https://icyleaf.com/uploads/2023/08/import-grafana-dashboard_hu17516823876611020524.png></a><figcaption><p>Grafana å¯¼å…¥ Dashboard çœ‹æ¿</p></figcaption></figure><figure data-pswp=2138x1306 data-size=800x><a href=https://icyleaf.com/uploads/2023/08/configure-grafana-database.png class=gallery-item target=_blank data-pswp-width=2138 data-pswp-height=1306><img src=https://icyleaf.com/uploads/2023/08/configure-grafana-database_hu9312454246112292748.png></a><figcaption><p>Grafana é…ç½®æ•°æ®æº</p></figcaption></figure><h2 id=ç»“è¯­>ç»“è¯­</h2><p>æ„Ÿè°¢ mosdns é•¿è¾¾å‡ ä¸ªæœˆçš„é…ç½®ç¨³å®šä¹‹å‰æŒ–çš„å‘å¡«ä¸Šäº†ï¼Œæ’’èŠ±ï¼</p><div class=post-donate><p class=post-donate-title>å¦‚æœä½ è§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿æ‰“èµï¼Œè¿™å¯¹æˆ‘éå¸¸é‡è¦ï¼Œè°¢è°¢ï¼</p><div class=post-donate-channel><img src=https://icyleaf.com/images/donate/alipay.png alt=æ”¯ä»˜å®æ‰“èµ>
<img src=https://icyleaf.com/images/donate/wechat.png alt=å¾®ä¿¡æ‰“èµ></div></div></div></div><div class=post-nav><a href=https://icyleaf.com/2023/07/how-to-homelab-part-3-storages/ class=prev rel=prev title="å¦‚ä½•æ­å»ºå®¶ç”¨ homelab: æ•°æ®å­˜å‚¨"><i class="iconfont icon-left"></i>&nbsp;å¦‚ä½•æ­å»ºå®¶ç”¨ homelab: æ•°æ®å­˜å‚¨</a>
<a href=https://icyleaf.com/2024/10/setup-legacy-brother-laser-became-to-a-wireless-airprint/ class=next rel=next title=è®©åƒç°çš„å…„å¼Ÿæ‰“å°æœºç„•å‘æ–°ç”Ÿï¼šæ— çº¿æ‰“å°>è®©åƒç°çš„å…„å¼Ÿæ‰“å°æœºç„•å‘æ–°ç”Ÿï¼šæ— çº¿æ‰“å°&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><script>var getTheme=window.localStorage&&window.localStorage.getItem("blog-dark-mode"),getTheme=getTheme??"github-light";let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","icyleaf/icyleaf.com"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.post-comment").innerHTML="",document.querySelector("div.post-comment").appendChild(s)</script></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2025</span>
<span>ğŸº</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script defer src=https://fastly.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script><script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: () => import('\/photoswipe\/photoswipe.esm.js'),
  });
  lightbox.init();
</script></div></body></html>