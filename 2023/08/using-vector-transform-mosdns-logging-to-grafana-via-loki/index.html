<!doctype html><html lang=zh-cn></html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>vector + loki 实现 mosdns 数据看板 | icyleaf</title>
<meta name=keywords content="vector,mosdns,loki,linux,openwrt,grafana"><meta name=description content="快速验证规则的同时实现类似 AdGuard Home 好看的数据看板"><meta name=author content="icyleaf"><link rel=canonical href=https://icyleaf.com/2023/08/using-vector-transform-mosdns-logging-to-grafana-via-loki/><link rel=apple-touch-icon href=https://icyleaf.com/apple-touch-icon.png><link rel=icon href=https://icyleaf.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://icyleaf.com/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=https://icyleaf.com/android-chrome-512x512.png><link rel=icon type=image/svg+xml href=https://icyleaf.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.min.css><link rel=alternate hreflang=zh-cn href=https://icyleaf.com/2023/08/using-vector-transform-mosdns-logging-to-grafana-via-loki/><link rel=canonical href=https://icyleaf.com/2023/08/using-vector-transform-mosdns-logging-to-grafana-via-loki/><meta property="og:title" content="vector + loki 实现 mosdns 数据看板"><meta property="og:description" content="快速验证规则的同时实现类似 AdGuard Home 好看的数据看板"><meta property="og:type" content="article"><meta property="og:url" content="https://icyleaf.com/2023/08/using-vector-transform-mosdns-logging-to-grafana-via-loki/"><meta property="og:image" content="https://images.unsplash.com/photo-1668089135991-e2d5ca8c62a6?ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=2874&amp;q=80"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-23T10:04:13+08:00"><meta property="article:modified_time" content="2023-08-23T10:04:13+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1668089135991-e2d5ca8c62a6?ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=2874&amp;q=80"><meta name=twitter:title content="vector + loki 实现 mosdns 数据看板"><meta name=twitter:description content="快速验证规则的同时实现类似 AdGuard Home 好看的数据看板"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://icyleaf.com/posts/"},{"@type":"ListItem","position":2,"name":"vector + loki 实现 mosdns 数据看板","item":"https://icyleaf.com/2023/08/using-vector-transform-mosdns-logging-to-grafana-via-loki/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"vector + loki 实现 mosdns 数据看板","name":"vector \u002b loki 实现 mosdns 数据看板","description":"快速验证规则的同时实现类似 AdGuard Home 好看的数据看板","keywords":["vector","mosdns","loki","linux","openwrt","grafana"],"articleBody":" 更新 Jun 7, 2024\n5.3 日志结构作者又做调整了，完整配置已更新，如果是 5.0 ~ 5.1.x 版本需要注意完整配置下面的代码对比部分。 作者自己使用是把 modsns 从之前的后置改成了前置测试了好几个月，好处是某些服务挂了也不会影响 DNS 的解析，有想了解具体细节的吗？ 更新维护不易，欢迎在文章尾部打赏作者，这个对于作者很重要，感谢你的支持！\n我是从 4.0 版本开始使用 mosdns，经历了 4.1 和 4.2 不稳定的功能更新和今年 1 月份发布 5.x 大版本重构后貌似已经稳定下来。\n托 @river_leaves 的福利用 mosdns 自带的 prometheus metrics 接口实时查看 DNS 解析情况。\n配置中的规则是灵活且有时候很难调试，为了验证配置规则是否有效以及可视化看到域名访问频次，我从 mosdns 日志本身下手，需要的工具有 vector、prometheus、loki 和 grafana。\n实时监控 mosdns 规则解析 Grafana 看板\n当前教程仅适用于 mosdns 5.0 ~ 5.3.x 版本（后续版本没有发布可能存在配置变化，依据实际情况调整）。\nmosdns mosdns 5 版本采用了新数据源解包格式，配置我实在懒得调整了，直接在采用了 luci-app-mosdns 插件配置微调。配置中各个 plugins 名称请确保不要修改和变动，否则会导致 vector 转换规则无法正常工作。\n看不到下面配置文件的，送上直达电梯。\n配置定义了 mosdns 日志的文件路径为 /var/log/mosdns.log，输出日志等级只需要是 INFO 即可。如果 mosdns 服务所在磁盘空间较小建议使用 logrotate 来切割日志并控制归档日志数量，以免出现空间不足的情况。\n1/var/log/mosdns.log { 2 daily 3 rotate 2 4 compress 5 missingok 6 notifempty 7 copytruncate 8} copytruncate 的意思是将旧日志文件的内容复制到新日志文件，默认是直接改名原文件会造成 mosdns 运行日志记录出现问题，设置好后确保 logrotate 定时运行：\n1# crontab -e 20 1 * * * /bin/sh -c \"/usr/sbin/logrotate -l=syslog -d /etc/logrotate.d\" vector vector 是一个日志收集工具，能够从多个源（Source）收集、转换（Transform）并推送到下一个接收器（Sinks）。\nvector 需要能够直接访问到 mosdns 的日志文件。这里有两种方式可以实现：一种是两个服务都在一台机器上运行，另外一种是通过容器化共享 volume 让 vector 可以读取 mosdns 日志。\n工具本身是 Go 语言开发从 Github 直接下载好对应的包解压缩就能够使用或者使用一键安装脚本：\n1curl --proto '=https' --tlsv1.2 -sSf https://sh.vector.dev | bash Openwrt/Immortalwrt 用户可使用我个人维护的仓库 icyleaf/openwrt-dist 添加后即可安装（支持 amd64、armv8 平台的 snapshot 和 23.05.0 两个分支）：\n添加仓库密钥\n1wget http://cdn.jsdelivr.net/gh/icyleaf/openwrt-dist@master/key-build.pub 2opkg-key add key-build.pub 根据 openwrt 平台不同修改源地址\n1# 源规则 2# src/gz icyleaf https://icyleaf-openwrt-repo.vercel.app/{{{target}}/packages/{{arch}} 3 4# 添加 snapshot 分支 amd64 (x86/64) 平台的源 5echo \"src/gz icyleaf https://icyleaf-openwrt-repo.vercel.app/snapshots/packages/x86/64\" \u003e\u003e /etc/opkg/customfeeds.conf 安装 vector\n1opkg update 2opkg install vector 修改 /etc/vector/config.yml 的配置文件如下\n1data_dir: /tmp/vector 2 3sources: 4 mosdns-log-file: 5 type: file 6 include: 7 - /var/log/mosdns.log 8 read_from: beginning 9 10transforms: 11 mosdns-input: 12 type: filter 13 inputs: 14 - mosdns-log-file 15 condition: | 16 .file == \"/var/log/mosdns.log\" 17 18 mosdns-data: 19 type: remap 20 inputs: 21 - mosdns-input 22 drop_on_error: true 23 source: | 24 .type = \"mosdns\" 25 .app = \"mosdns\" 26 del(.host) 27 del(.file) 28 del(.source_type) 29 30 message_parts = split!(.message, r'\\t') 31 32 .timestamp = parse_timestamp!(message_parts[0], format: \"%F %T\") 33 .level = message_parts[1] 34 35 if (length(message_parts) == 6) { 36 .plugin = message_parts[2] 37 .processor = message_parts[3] 38 .message = message_parts[4] 39 40 if (exists(message_parts[5])) { 41 .metadata = parse_json!(message_parts[5]) 42 . = merge!(., .metadata) 43 del(.metadata) 44 } 45 } else { 46 .processor = message_parts[2] 47 .message = message_parts[3] 48 49 if (exists(message_parts[4])) { 50 .metadata = parse_json!(message_parts[4]) 51 . = merge!(., .metadata) 52 del(.metadata) 53 } 54 } 55 56 if (exists(.query)) { 57 . = merge!(., .query) 58 del(.query) 59 } 60 61sinks: 62 # 同步到 loki，根据实际情况修改 endpoint 的值 63 loki: 64 type: loki 65 inputs: 66 - mosdns-data 67 endpoint: 'http://10.10.10.2:3100' 68 encoding: 69 codec: json 70 labels: 71 app: '{{ app }}' 72 type: '{{ type }}' 73 healthcheck: 74 enabled: true 75 76 # 临时输出转换数据到 vector 控制台（生产环境请禁用） 77 debug_mosdns: 78 type: console 79 inputs: 80 - mosdns-data 81 encoding: 82 codec: json mosdns 5.3 对比 5.0 ~ 5.1.x 版本时间戳和 query 字段做了修改，需要调整配置文件：\n1... 2- .timestamp = parse_timestamp!(message_parts[0], format: \"%F %T\") 3+ .timestamp = parse_timestamp!(message_parts[0], format: \"%FT%T%.9fZ\") 4 5... 6 if (exists(.query)) { 7- . = merge!(., .query) 8- del(.query) 9+ query_parts = split!(.query, r'\\s') 10+ .domain = query_parts[0] 11+ .record = query_parts[2] 12+ .address = query_parts[5] 13 } 运行 vector 服务（部署好 loki 后再运行）\n非 openwrt 用户使用\n1vector --config /etc/vector/config.yml --watch-config --verbose openwrt 用户使用\n1$ /etc/init.d/vector start 2 3Loaded with warnings [\"/etc/vector/config.yml\"] 4----------------------------------------------- 5√ Component configuration 6√ Health check \"loki\" 7√ Health check \"vector\" 8----------------------------------------------- 9 Validated 使用 openwrt 插件的 vector 服务本身是会监控配置文件变化并重载，后面再调整的时候也不需要反复重启服务。\nprometheus prometheus 是一个监控数据服务，可以作为 Grafana 数据源使用。安装参考官方教程，配置文件需要把 mosdns metrics 地址（比如是 10.10.10.1:8338）加到 prometheus.yml 文件中:\n1global: 2 scrape_interval: 1m 3 evaluation_interval: 1m 4 5scrape_configs: 6+ - job_name: mosdns 7+ scrape_interval: 5s 8+ # scrape_timeout: 10s 9+ 10+ # metrics_path: /metrics 11+ static_configs: 12+ - targets: 13+ - 10.10.10.1:8338 loki loki 是一个日志聚合服务，本身也是 Grafana 研发的，可以作为 Grafana 数据源使用。参照官方文档就能部署好 loki 和 Grafana，唯一需要注意的是要提前下载好 loki 配置文件。部署好之后把 loki 地址更新到上面 vector 配置。\ngrafana grafana 是一个数据可视化工具，安装见 loki 部分，已有服务直接跳过。\nDashboard 看板的配置就非常简单了，先添加好 prometheus 和 loki 的数据源后，导入 mosdns v5 看板，按照图示配置即可。\nGrafana 导入 Dashboard 看板\nGrafana 配置数据源\n结语 感谢 mosdns 长达几个月的配置稳定之前挖的坑填上了，撒花！\n","wordCount":"1689","inLanguage":"zh-cn","image":"https://images.unsplash.com/photo-1668089135991-e2d5ca8c62a6?ixlib=rb-4.0.3\u0026ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\u0026auto=format\u0026fit=crop\u0026w=2874\u0026q=80","datePublished":"2023-08-23T10:04:13+08:00","dateModified":"2023-08-23T10:04:13+08:00","author":{"@type":"Person","name":"icyleaf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://icyleaf.com/2023/08/using-vector-transform-mosdns-logging-to-grafana-via-loki/"},"publisher":{"@type":"Organization","name":"icyleaf","logo":{"@type":"ImageObject","url":"https://icyleaf.com/favicon.ico"}}}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/series/homelab title>homelab 系列
</a><a class=menu-item href=https://icyleaf.com/projects title>开源项目
</a><a class=menu-item href=https://icyleaf.com/gears title>我的设备
</a><a class=menu-item href=https://icyleaf.com/about title>关于
</a><span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/series/homelab title><h3>homelab 系列</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>开源项目</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/gears title><h3>我的设备</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/about title><h3>关于</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=post-cover><img src="https://images.unsplash.com/photo-1668089135991-e2d5ca8c62a6?ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=2874&amp;q=80" loading=lazy><p class=cover-author>Photo by
<a href=https://unsplash.com/@greenpeacesuomi>Greenpeace Finland
</a>/
<a href=https://unsplash.com>Unsplash</a></p></div><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop=description>vector + loki 实现 mosdns 数据看板</h1><div class=post-description>快速验证规则的同时实现类似 AdGuard Home 好看的数据看板</div><div class=post-meta><time datetime=2023-08-23 itemprop=datePublished>2023-08-23</time>
·
<span class=tags>vector, mosdns, loki, linux, openwrt, grafana</span>
·
<span class=post-word-count>1689 words · 7 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#mosdns>mosdns</a></li><li><a href=#vector>vector</a></li><li><a href=#prometheus>prometheus</a></li><li><a href=#loki>loki</a></li><li><a href=#grafana>grafana</a></li><li><a href=#结语>结语</a></li></ul></nav></div></div><div class=post-content><div id=post-gallery><div class="updated updated-mark"><header class="updated-header color-note"><h4 class=updated-title>更新</h4><p class=updated-meta>Jun 7, 2024</p></header><article class=updated-body><ul><li>5.3 日志结构作者又做调整了，完整配置已更新，如果是 5.0 ~ 5.1.x 版本需要注意完整配置下面的代码对比部分。</li><li>作者自己使用是把 modsns 从之前的后置改成了前置测试了好几个月，好处是某些服务挂了也不会影响 DNS 的解析，有想了解具体细节的吗？</li></ul><p>更新维护不易，欢迎在文章尾部打赏作者，这个对于作者很重要，感谢你的支持！</p></article></div><p>我是从 4.0 版本开始使用 <a href=https://github.com/IrineSistiana/mosdns>mosdns</a>，经历了 4.1 和 4.2 <a href=https://github.com/IrineSistiana/mosdns/discussions/417#discussioncomment-3831982>不稳定的功能更新</a>和今年 1 月份发布 5.x 大版本重构后貌似已经稳定下来。</p><p>托 @<a href=https://twitter.com/river_leaves/status/1574393162163896321>river_leaves</a> 的福利用 mosdns 自带的 <a href=https://irine-sistiana.gitbook.io/mosdns-wiki/mosdns-v5/api-shuo-ming>prometheus metrics</a> 接口实时查看 DNS 解析情况。</p><p>配置中的规则是灵活且有时候很难调试，为了验证配置规则是否有效以及可视化看到域名访问频次，我从 mosdns 日志本身下手，需要的工具有 vector、prometheus、loki 和 grafana。</p><figure data-pswp=2552x1204 data-size=800x><a href=https://icyleaf.com/uploads/2023/08/grafana-mosdns.png class=gallery-item target=_blank data-pswp-width=2552 data-pswp-height=1204><img src=https://icyleaf.com/uploads/2023/08/grafana-mosdns_hu14669541674982067454.png></a><figcaption><p>实时监控 mosdns 规则解析 Grafana 看板</p></figcaption></figure><blockquote><p>当前教程仅适用于 mosdns 5.0 ~ 5.3.x 版本（后续版本没有发布可能存在配置变化，依据实际情况调整）。</p></blockquote><h2 id=mosdns>mosdns</h2><p>mosdns 5 版本采用了<a href=https://github.com/IrineSistiana/mosdns/discussions/584>新数据源解包格式</a>，配置我实在懒得调整了，直接在采用了 <a href=https://github.com/sbwml/luci-app-mosdns>luci-app-mosdns</a> 插件配置微调。配置中各个 plugins 名称请确保不要修改和变动，否则会导致 vector 转换规则无法正常工作。</p><p>看不到下面配置文件的，送上<a href=https://gist.github.com/icyleaf/e98093f673b4b2850226db582447175a#file-mosdns_config_v5-yaml>直达电梯</a>。</p><script type=text/javascript src="http://gist.github.com/e98093f673b4b2850226db582447175a.js?file=mosdns_config_v5.yaml&theme=dark"></script><p>配置定义了 mosdns 日志的文件路径为 <code>/var/log/mosdns.log</code>，输出日志等级只需要是 INFO 即可。如果 mosdns 服务所在磁盘空间较小建议使用 logrotate 来切割日志并控制归档日志数量，以免出现空间不足的情况。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=ln>1</span><span class=cl>/var/log/mosdns.log {
</span></span><span class=line><span class=ln>2</span><span class=cl>  daily
</span></span><span class=line><span class=ln>3</span><span class=cl>  rotate 2
</span></span><span class=line><span class=ln>4</span><span class=cl>  compress
</span></span><span class=line><span class=ln>5</span><span class=cl>  missingok
</span></span><span class=line><span class=ln>6</span><span class=cl>  notifempty
</span></span><span class=line><span class=ln>7</span><span class=cl>  copytruncate
</span></span><span class=line><span class=ln>8</span><span class=cl>}
</span></span></code></pre></div><p><code>copytruncate</code> 的意思是将旧日志文件的内容复制到新日志文件，默认是直接改名原文件会造成 mosdns 运行日志记录出现问题，设置好后确保 logrotate 定时运行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># crontab -e</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=m>0</span> <span class=m>1</span> * * * /bin/sh -c <span class=s2>&#34;/usr/sbin/logrotate -l=syslog -d /etc/logrotate.d&#34;</span>
</span></span></code></pre></div><h2 id=vector>vector</h2><p><a href=https://vector.dev>vector</a> 是一个日志收集工具，能够从多个源（Source）收集、转换（Transform）并推送到下一个接收器（Sinks）。</p><figure data-pswp=1630x736 data-size=800x><a href=https://icyleaf.com/uploads/2023/08/vector-flow.png class=gallery-item target=_blank data-pswp-width=1630 data-pswp-height=736><img src=https://icyleaf.com/uploads/2023/08/vector-flow_hu10473946876088393779.png></a></figure><p>vector 需要能够直接访问到 mosdns 的日志文件。这里有两种方式可以实现：一种是两个服务都在一台机器上运行，另外一种是通过容器化共享 volume 让 vector 可以读取 mosdns 日志。</p><p>工具本身是 Go 语言开发从 Github 直接下载好对应的包解压缩就能够使用或者使用一键安装脚本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>curl --proto <span class=s1>&#39;=https&#39;</span> --tlsv1.2 -sSf https://sh.vector.dev <span class=p>|</span> bash
</span></span></code></pre></div><p>Openwrt/Immortalwrt 用户可使用我个人维护的仓库 <a href=https://github.com/icyleaf/openwrt-dist>icyleaf/openwrt-dist</a> 添加后即可安装（支持 amd64、armv8 平台的 snapshot 和 23.05.0 两个分支）：</p><p>添加仓库密钥</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>wget http://cdn.jsdelivr.net/gh/icyleaf/openwrt-dist@master/key-build.pub
</span></span><span class=line><span class=ln>2</span><span class=cl>opkg-key add key-build.pub
</span></span></code></pre></div><p>根据 openwrt 平台不同修改源地址</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># 源规则</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=c1># src/gz icyleaf https://icyleaf-openwrt-repo.vercel.app/{{{target}}/packages/{{arch}}</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=c1># 添加 snapshot 分支 amd64 (x86/64) 平台的源</span>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=nb>echo</span> <span class=s2>&#34;src/gz icyleaf https://icyleaf-openwrt-repo.vercel.app/snapshots/packages/x86/64&#34;</span> &gt;&gt; /etc/opkg/customfeeds.conf
</span></span></code></pre></div><p>安装 vector</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>opkg update
</span></span><span class=line><span class=ln>2</span><span class=cl>opkg install vector
</span></span></code></pre></div><p>修改 <code>/etc/vector/config.yml</code> 的配置文件如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>data_dir</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/vector</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=nt>sources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>mosdns-log-file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>file</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=nt>include</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>      </span>- <span class=l>/var/log/mosdns.log</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=nt>read_from</span><span class=p>:</span><span class=w> </span><span class=l>beginning</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w></span><span class=nt>transforms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>  </span><span class=nt>mosdns-input</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>filter</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>    </span><span class=nt>inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>      </span>- <span class=l>mosdns-log-file</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=sd>      .file == &#34;/var/log/mosdns.log&#34;</span><span class=w>      
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>  </span><span class=nt>mosdns-data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>remap</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>    </span><span class=nt>inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>      </span>- <span class=l>mosdns-input</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>    </span><span class=nt>drop_on_error</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>    </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=sd>      .type = &#34;mosdns&#34;
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=sd>      .app = &#34;mosdns&#34;
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=sd>      del(.host)
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=sd>      del(.file)
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=sd>      del(.source_type)
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=sd>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=sd>      message_parts = split!(.message, r&#39;\t&#39;)
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=sd>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=sd>      .timestamp = parse_timestamp!(message_parts[0], format: &#34;%F %T&#34;)
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=sd>      .level = message_parts[1]
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=sd>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=sd>      if (length(message_parts) == 6) {
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=sd>        .plugin = message_parts[2]
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=sd>        .processor = message_parts[3]
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=sd>        .message = message_parts[4]
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=sd>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=sd>        if (exists(message_parts[5])) {
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=sd>          .metadata = parse_json!(message_parts[5])
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=sd>          . = merge!(., .metadata)
</span></span></span><span class=line><span class=ln>43</span><span class=cl><span class=sd>          del(.metadata)
</span></span></span><span class=line><span class=ln>44</span><span class=cl><span class=sd>        }
</span></span></span><span class=line><span class=ln>45</span><span class=cl><span class=sd>      } else {
</span></span></span><span class=line><span class=ln>46</span><span class=cl><span class=sd>        .processor = message_parts[2]
</span></span></span><span class=line><span class=ln>47</span><span class=cl><span class=sd>        .message = message_parts[3]
</span></span></span><span class=line><span class=ln>48</span><span class=cl><span class=sd>
</span></span></span><span class=line><span class=ln>49</span><span class=cl><span class=sd>        if (exists(message_parts[4])) {
</span></span></span><span class=line><span class=ln>50</span><span class=cl><span class=sd>          .metadata = parse_json!(message_parts[4])
</span></span></span><span class=line><span class=ln>51</span><span class=cl><span class=sd>          . = merge!(., .metadata)
</span></span></span><span class=line><span class=ln>52</span><span class=cl><span class=sd>          del(.metadata)
</span></span></span><span class=line><span class=ln>53</span><span class=cl><span class=sd>        }
</span></span></span><span class=line><span class=ln>54</span><span class=cl><span class=sd>      }
</span></span></span><span class=line><span class=ln>55</span><span class=cl><span class=sd>
</span></span></span><span class=line><span class=ln>56</span><span class=cl><span class=sd>      if (exists(.query)) {
</span></span></span><span class=line><span class=ln>57</span><span class=cl><span class=sd>        . = merge!(., .query)
</span></span></span><span class=line><span class=ln>58</span><span class=cl><span class=sd>        del(.query)
</span></span></span><span class=line><span class=ln>59</span><span class=cl><span class=sd>      }</span><span class=w>      
</span></span></span><span class=line><span class=ln>60</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>61</span><span class=cl><span class=w></span><span class=nt>sinks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>62</span><span class=cl><span class=w>  </span><span class=c># 同步到 loki，根据实际情况修改 endpoint 的值</span><span class=w>
</span></span></span><span class=line><span class=ln>63</span><span class=cl><span class=w>  </span><span class=nt>loki</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>64</span><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>loki</span><span class=w>
</span></span></span><span class=line><span class=ln>65</span><span class=cl><span class=w>    </span><span class=nt>inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>66</span><span class=cl><span class=w>      </span>- <span class=l>mosdns-data</span><span class=w>
</span></span></span><span class=line><span class=ln>67</span><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;http://10.10.10.2:3100&#39;</span><span class=w>
</span></span></span><span class=line><span class=ln>68</span><span class=cl><span class=w>    </span><span class=nt>encoding</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>69</span><span class=cl><span class=w>      </span><span class=nt>codec</span><span class=p>:</span><span class=w> </span><span class=l>json</span><span class=w>
</span></span></span><span class=line><span class=ln>70</span><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>71</span><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{ app }}&#39;</span><span class=w>
</span></span></span><span class=line><span class=ln>72</span><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{ type }}&#39;</span><span class=w>
</span></span></span><span class=line><span class=ln>73</span><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>74</span><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=ln>75</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>76</span><span class=cl><span class=w>  </span><span class=c># 临时输出转换数据到 vector 控制台（生产环境请禁用）</span><span class=w>
</span></span></span><span class=line><span class=ln>77</span><span class=cl><span class=w>  </span><span class=nt>debug_mosdns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>78</span><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>console</span><span class=w>
</span></span></span><span class=line><span class=ln>79</span><span class=cl><span class=w>    </span><span class=nt>inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>80</span><span class=cl><span class=w>      </span>- <span class=l>mosdns-data</span><span class=w>
</span></span></span><span class=line><span class=ln>81</span><span class=cl><span class=w>    </span><span class=nt>encoding</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>82</span><span class=cl><span class=w>      </span><span class=nt>codec</span><span class=p>:</span><span class=w> </span><span class=l>json</span><span class=w>
</span></span></span></code></pre></div><p>mosdns 5.3 对比 5.0 ~ 5.1.x 版本时间戳和 query 字段做了修改，需要调整配置文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=ln> 1</span><span class=cl>...
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=gd>-      .timestamp = parse_timestamp!(message_parts[0], format: &#34;%F %T&#34;)
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=gd></span><span class=gi>+      .timestamp = parse_timestamp!(message_parts[0], format: &#34;%FT%T%.9fZ&#34;)
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=gi></span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>...
</span></span><span class=line><span class=ln> 6</span><span class=cl>      if (exists(.query)) {
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=gd>-        . = merge!(., .query)
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=gd>-        del(.query)
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=gd></span><span class=gi>+        query_parts = split!(.query, r&#39;\s&#39;)
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=gi>+        .domain = query_parts[0]
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=gi>+        .record = query_parts[2]
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=gi>+        .address = query_parts[5]
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=gi></span>      }
</span></span></code></pre></div><p>运行 vector 服务（部署好 loki 后再运行）</p><p>非 openwrt 用户使用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>vector --config /etc/vector/config.yml --watch-config --verbose
</span></span></code></pre></div><p>openwrt 用户使用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>$ /etc/init.d/vector start
</span></span><span class=line><span class=ln>2</span><span class=cl>
</span></span><span class=line><span class=ln>3</span><span class=cl>Loaded with warnings <span class=o>[</span><span class=s2>&#34;/etc/vector/config.yml&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>-----------------------------------------------
</span></span><span class=line><span class=ln>5</span><span class=cl>√ Component configuration
</span></span><span class=line><span class=ln>6</span><span class=cl>√ Health check <span class=s2>&#34;loki&#34;</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>√ Health check <span class=s2>&#34;vector&#34;</span>
</span></span><span class=line><span class=ln>8</span><span class=cl>-----------------------------------------------
</span></span><span class=line><span class=ln>9</span><span class=cl>                                      Validated
</span></span></code></pre></div><p>使用 openwrt 插件的 vector 服务本身是会监控配置文件变化并重载，后面再调整的时候也不需要反复重启服务。</p><h2 id=prometheus>prometheus</h2><p><a href=https://prometheus.io/>prometheus</a> 是一个监控数据服务，可以作为 Grafana 数据源使用。安装参考<a href=https://prometheus.io/docs/prometheus/latest/installation/>官方教程</a>，配置文件需要把 mosdns metrics 地址（比如是 10.10.10.1:8338）加到 <code>prometheus.yml</code> 文件中:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=ln> 1</span><span class=cl>global:
</span></span><span class=line><span class=ln> 2</span><span class=cl>  scrape_interval:     1m
</span></span><span class=line><span class=ln> 3</span><span class=cl>  evaluation_interval: 1m
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl>scrape_configs:
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=gi>+  - job_name: mosdns
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=gi>+    scrape_interval: 5s
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=gi>+    # scrape_timeout: 10s
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=gi>+
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=gi>+    # metrics_path: /metrics
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=gi>+    static_configs:
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=gi>+      - targets:
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=gi>+        - 10.10.10.1:8338
</span></span></span></code></pre></div><h2 id=loki>loki</h2><p><a href=https://grafana.com/oss/loki/>loki</a> 是一个日志聚合服务，本身也是 Grafana 研发的，可以作为 Grafana 数据源使用。参照<a href=https://grafana.com/docs/loki/latest/installation/docker/>官方文档</a>就能部署好 loki 和 Grafana，唯一需要注意的是要提前下载好 loki <a href=https://raw.githubusercontent.com/grafana/loki/v2.8.0/cmd/loki/loki-local-config.yaml>配置文件</a>。部署好之后把 loki 地址更新到上面 vector 配置。</p><h2 id=grafana>grafana</h2><p><a href=https://grafana.com/>grafana</a> 是一个数据可视化工具，安装见 loki 部分，已有服务直接跳过。</p><p>Dashboard 看板的配置就非常简单了，先添加好 prometheus 和 loki 的数据源后，导入 <a href=https://grafana.com/grafana/dashboards/19305-mosdns-v5/>mosdns v5 看板</a>，按照图示配置即可。</p><figure data-pswp=1804x800 data-size=800x><a href=https://icyleaf.com/uploads/2023/08/import-grafana-dashboard.png class=gallery-item target=_blank data-pswp-width=1804 data-pswp-height=800><img src=https://icyleaf.com/uploads/2023/08/import-grafana-dashboard_hu17516823876611020524.png></a><figcaption><p>Grafana 导入 Dashboard 看板</p></figcaption></figure><figure data-pswp=2138x1306 data-size=800x><a href=https://icyleaf.com/uploads/2023/08/configure-grafana-database.png class=gallery-item target=_blank data-pswp-width=2138 data-pswp-height=1306><img src=https://icyleaf.com/uploads/2023/08/configure-grafana-database_hu9312454246112292748.png></a><figcaption><p>Grafana 配置数据源</p></figcaption></figure><h2 id=结语>结语</h2><p>感谢 mosdns 长达几个月的配置稳定之前挖的坑填上了，撒花！</p><div class=post-donate><p class=post-donate-title>如果你觉得我的文章对你有帮助，欢迎打赏，这对我非常重要，谢谢！</p><div class=post-donate-channel><img src=https://icyleaf.com/images/donate/alipay.png alt=支付宝打赏>
<img src=https://icyleaf.com/images/donate/wechat.png alt=微信打赏></div></div></div></div><div class=post-nav><a href=https://icyleaf.com/2023/07/how-to-homelab-part-3-storages/ class=prev rel=prev title="如何搭建家用 homelab: 数据存储"><i class="iconfont icon-left"></i>&nbsp;如何搭建家用 homelab: 数据存储</a>
<a href=https://icyleaf.com/2024/10/setup-legacy-brother-laser-became-to-a-wireless-airprint/ class=next rel=next title=让吃灰的兄弟打印机焕发新生：无线打印>让吃灰的兄弟打印机焕发新生：无线打印&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><script>var getTheme=window.localStorage&&window.localStorage.getItem("blog-dark-mode"),getTheme=getTheme??"github-light";let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","icyleaf/icyleaf.com"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.post-comment").innerHTML="",document.querySelector("div.post-comment").appendChild(s)</script></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2025</span>
<span>🍺</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script defer src=https://fastly.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script><script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: () => import('\/photoswipe\/photoswipe.esm.js'),
  });
  lightbox.init();
</script></div></body></html>