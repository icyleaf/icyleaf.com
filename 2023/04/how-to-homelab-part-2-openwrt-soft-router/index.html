<!doctype html><html lang=zh-cn></html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>如何搭建家用 homelab: Openwrt 软路由 | icyleaf</title><meta name=keywords content="hardware,architecture,openwrt"><meta name=description content="用牺牲硬件的网络转换效率来换取不必受设备提供商的限制和可玩性"><meta name=author content="icyleaf"><link rel=canonical href=https://icyleaf.com/2023/04/how-to-homelab-part-2-openwrt-soft-router/><link rel=icon href=https://icyleaf.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://icyleaf.com/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=https://icyleaf.com/android-chrome-512x512.png><link rel=apple-touch-icon href=https://icyleaf.com/apple-touch-icon.png><link rel=mask-icon href=https://icyleaf.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.min.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.min.css><link rel=canonical href=https://icyleaf.com/2023/04/how-to-homelab-part-2-openwrt-soft-router/><meta property="og:title" content="如何搭建家用 homelab: Openwrt 软路由"><meta property="og:description" content="用牺牲硬件的网络转换效率来换取不必受设备提供商的限制和可玩性"><meta property="og:type" content="article"><meta property="og:url" content="https://icyleaf.com/2023/04/how-to-homelab-part-2-openwrt-soft-router/"><meta property="og:image" content="https://images.unsplash.com/photo-1521542464131-cb30f7398bc6?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2673&q=80"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-26T20:30:00+08:00"><meta property="article:modified_time" content="2023-04-26T20:30:00+08:00"><meta property="og:see_also" content="https://icyleaf.com/2023/07/how-to-homelab-part-3-storages/"><meta property="og:see_also" content="https://icyleaf.com/2023/01/how-to-homelab-part-1-hardware-and-architecture/"><meta property="og:see_also" content="https://icyleaf.com/2022/02/how-to-homelab-part-0/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1521542464131-cb30f7398bc6?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2673&q=80"><meta name=twitter:title content="如何搭建家用 homelab: Openwrt 软路由"><meta name=twitter:description content="用牺牲硬件的网络转换效率来换取不必受设备提供商的限制和可玩性"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://icyleaf.com/posts/"},{"@type":"ListItem","position":2,"name":"如何搭建家用 homelab: Openwrt 软路由","item":"https://icyleaf.com/2023/04/how-to-homelab-part-2-openwrt-soft-router/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"如何搭建家用 homelab: Openwrt 软路由","name":"如何搭建家用 homelab: Openwrt 软路由","description":"用牺牲硬件的网络转换效率来换取不必受设备提供商的限制和可玩性","keywords":["hardware","architecture","openwrt"],"articleBody":" 加入讨论群 方便大家沟通交流，开通了 Discord 讨论群便于第一时间获得教程的最新更新，并提供关于 Homelab 沟通、疑惑解答专区，欢迎大家加入。 路由器是猫总管（调制解调器）最得力的一把手，掌管 homelab 网络大权。对于中国玩家提到软路由肯定绕不开 OpenWrt，今天我尝试用一个全新的视角唠唠这个大家熟悉却又陌生的系统。 以下会涉及大量的基础认知、概念理解，不会涉及网络配置或高阶玩法。\n什么是 OpenWrt 与同价位的硬路由相比，软路由硬件更好，可配置性更高，但需要一定的网络知识才能发挥作用。软硬路由的选择取决于网络环境的场景，有些人投入了软路由的怀抱，有些人经历了软路由后坚定的使用硬路由，还有些人的硬路由之下还会接一个软路由当旁路由1。\nOpenWrt 首先是一个开源的操作系统，能够实现硬路由器的核心功能：LAN 和 WAN 的网络转发、路由（DHCP、防火墙、DNS 解析等），在 Linux 开放的生态和社区基础上扩展出丰富的功能2，这个是硬件路由器没有能力达到的（钞能力或重刷魔改固件除外）。\n图片来源SuLingGG/OpenWrt-Rpi 丰富的软件包资源\n它适配 x86、x86_64、arm、arm64 和 MIPS 等架构上千种硬件设备。硬件要求极低，21.02 版本最低要求 16M 闪存和 128M 内存，2023 年的今天没有人会拿老的硬路由古董去折腾它了吧，没有吧？没有吧？任意一台淘汰的 x86 设备都高于这个配置。 且在 x86/x86Z_64 平台安装它甚至比安装 Ubuntu、Debian 系统还要简单。较全的列表请查阅官方硬件支持列表 未列入的还可以在 Github 搜索。\n版本分布 OpenWrt 虽然有一套发布流程却没有稳定的发版节奏和老版本的废弃规则。版本号类似语义化版本规范划分 X.Y.Z 三段。X.Y 是年和月相对固定，小功能迭代全靠更新 Z 的值。版本大致划分两类：\n稳定版：生产环境 Ready 的稳定版本。v22.03.2 是该系列的最新版本。 开发版：不稳定但会包含不断的迭代增强功能的开发版本，也称之为 snapshot 版本，完成里程碑会进入 RC 版本。 版本 状态 重大变化 snapshot 开发版本 - 22.03 最新版本 基于 5.10 内核、防火墙迁移 nftables、黑暗模式 21.02 可看做是 LTS 版本 基于 5.4 内核、DSA 初步支持 19.07 不再支持 基于 4.11 内核、WPA3 支持、客户端渲染 luci 18.06 不再支持 基于 4.9 或 4.11 内核、合并 Lede 源码 LEDE 17.01 不再支持 基于 4.4 内核 以上版本信息是截止 2023 年 4 月底。\n衍生及支系 话说天下大势，分久必合，合久必分\n开源系统生态同样遵循，有些是不满原系统的管理或生态愤恨分支的支系，有些是针对特定的方面有了深化的衍生功能，列举几个我了解的支系。\nLEDE LEDE 是前者的原因分支出来的一派，新增了很多关键新功能和对新设备的支持而崛起，在 2018 年 1 月 LEDE 宣布和 OpenWRT 和解正式宣布合并，合并后使用 OpenWrt 的名字和 LEDE 的代码。\n早期国内知名的 Lean 狼大的 Lede 系统，很多国内玩家最早接触的系统之一。\nImmortalwrt 基于官方分支的 Immortalwrt 是一个跟进上游速度很快又融合了 Lean 狼大版本特色的新支系。Lean 狼大也有参与其中，主要是针对中国玩家定制的固件，拥有更好的本地化适配、加入了各种官方软件列表中没有但是国内环境中可能会用到的软件功能，比如网络多拨、国内镜像及翻开也不会告诉你的功能等。 我从 21.02 开始跟进并使用 snapshot 开发版本没遇到什么大坑，该项目每周都会定时合并上游的代码。\niStoreOS 同样是基于官方分支的 iStoreOS 另辟蹊径，舍弃了 OpenWrt 自身的包管理机制，重新打造了一套类似 KoolCenter 梅林固件的软件商店用于解决因为 OpenWRT 系统依赖和软件包依赖杂乱导致不同平台的插件依赖不匹配而无法安装的问题。同时提供多套 UI 操作界面和类似上面一样特色功能和 NAS 向功能：网盘、Docker、异地组网、相册备份等。\n由于个人没有实际部署和使用，按下不表。\n固件构成 不同的硬件和软件包的搭配组合衍生出五花八门的固件版本。那有没有想过固件到底是什么，有什么组成的呢？\n固件的构成主要是三类 vmlinuz、rootfs 和系统引导。\nvmlinux 是 ELF 文件最原始包含 Linux 内核静态链接的可执行文件；vmlinuz 是压缩后的 vmlinux 且能可启动的文件3。 rootfs 是 OpenWrt 的根分区的所有文件，提供 gzip 压缩后的原始文件、ext4 分区后的文件和 squashfs 分区后的文件。 系统引导是引导设备开机后正确引领到上述两个文件的 bootloader，OpenWrt 借助的是 grub2 来实现 legacy 或 EFI 分区引导。 固件文件名包含的 combined 译为合并这就是上面几个文件的自由组合，组合方式会从文件分区和封装两个字段体现。\nOpenwrt 固件文件解构\nOpenWrt 文件系统分区可选择 ext4 或 squashFS。ext4 是一个可读可写的分区格式，这也是 Linux 生态应用最广的文件系统；对比 squashFS 它是一个只读的分区格式，看似不好用但它却有一个非常诱人的功能，可恢复出厂设置或直刷同文件分区的固件达到升级的功能，只不过需要挂在其他可写的磁盘做扩展应用。\n封装格式提供可烧录的 iso、img 镜像外，还提供了虚拟化的镜像文件，方便使用者根据各自的情况随意部署。\n多提一句，官方还额外其他提供一个组合字段 -factory 和 -sysupgrade 来区分全新安装或升级的专属固件，这俩不能混用。\n本节会涉及 Linux 的启动机制，我也是略懂皮毛，如果有描述错误请指正。\n安装固件 Openwrt 固件镜像文件\n我相信结合上面的固件构成的原理在选择什么类型的固件上会迎刃而解了吧。安装步骤略过不讲了吧，网络上有太多的教程可供参考。\n系统核心 访问渠道 OpenWrt 提供 Web UI 和 SSH 两种方式访问和管理，默认 Web 界面由 luci 实现前端展示，uhttpd 负责 web 代理服务。 可通过浏览器访问 http://192.168.1.1 或 http://openwrt.lan 打开，默认开放 80 端口；SSH 端口为 22，默认用户名为 root，没有密码。\n图片来源3elajar OpenWrt luci 丰富的主题\nluci 是官方维护和默认内置开启的前端 UI 实现，其实深挖能发现还有很多的实现方案。 还有社区近期还在维护的 oui、x-wrt 和很久不再更新的 juci 等。 这也能够看的出来 OpenWrt 在系统开放性上有很大的包容度。\n网络接口 默认使用 LAN 2（eth1） 为 WAN 口，LAN 1（eth0）为 LAN 口，如果有多个 WAN、LAN 口需要在网络接口中重新配置。\n配置管理 系统的配置文件系统层面绝大多数的配置文件都储存在 /etc/config 路径下面，编辑保存后是保存对于配置文件而不是实际修改对应服务，因此需要再执行提交操作，这部会完成把部分服务的中间配置更新到真正的配置文件中，再有必要的执行服务的重启操作。\n我会通过“修改 LAN IP 地址”的例子分别演示 OpenWrt 配置文件的修改的几种途径。\n通过 Web UI luci 提供网页的可视化操作，比如查看配置、更新管理等配置的管理工作。\n分别选择 “网络” -\u003e “接口”，找到接口 lan 右侧的编辑按钮，点开后编辑 IPv4 地址，保存再应用。\n通过终端编辑器 使用 vim 或 nano 这类文本编辑器编辑 /etc/config/network 文件，找到 lan 分段下面的 ipaddr 修改值：\n1config interface 'loopback' 2 option device 'lo' 3 option proto 'static' 4 option ipaddr '127.0.0.1' 5 option netmask '255.0.0.0' 6 7config globals 'globals' 8 option ula_prefix 'fdd3:af57:2ab4::/48' 9 10config device 11 option name 'br-lan' 12 option type 'bridge' 13 list ports 'eth0' 14 option ipv6 '0' 15 16config interface 'lan' 17 option device 'br-lan' 18 option proto 'static' 19-\toption ipaddr '192.168.1.1' 20+\toption ipaddr '10.10.10.1' 21 option netmask '255.255.255.0' 22 option ip6assign '60' 23 option gateway '192.168.16.1' 24 list dns '233.5.5.5' 25 list dns '202.106.0.20' 保存后在重启 network 服务。\n1$ /etc/init.d/network restart 通过终端 uci 工具 图片来源OpenWrt Wiki Openwrt uci 对应关系\nuci 是配置管理的快捷 CLI 工具，它会比网页编辑或终端找配置文件编辑都要方便。\n1# 设置 LAN 的 IP 地址 2$ uci set network.lan.ipaddr=10.10.10.1 3# 提交应用操作 4$ uci commit network 5# 重启网络服务 6$ /etc/init.d/network restart 通过 JSON-RPC 接口 图片来源Rapid@twitter API 接口方案一览图\nOpenwrt 内部通信全靠的是 ubus 总线工具，JSON-RPC 是基于它的二次封装的接口服务。固件默认不会开启此服务，如果需要请在编译固件配置中开启它。\n1# 登录认证获得 token (返回 JSON 的 result 字段值) 2$ curl http:///cgi-bin/luci/rpc/auth --data ' 3{ 4 \"id\": 1, 5 \"method\": \"login\", 6 \"params\": [ 7 \"user\", \"password\" 8 ] 9}' 10 11# 修改 LAN IP 地址 12$ curl http:///cgi-bin/luci/rpc/uci?auth=yourtoken --data ' 13{ 14 \"method\":\"set\", 15 \"params\":[ 16 \"network\", \"lan\", \"ipaddr\", \"10.10.10.1\" 17 ] 18}' 19 20# 提交 network 配置变更 21$ curl http:///cgi-bin/luci/rpc/uci?auth=yourtoken --data ' 22{ 23 \"method\":\"commit\", 24 \"params\":[ 25 \"network\" 26 ] 27}' 28 29# 重启 network 服务 （接口请求后可能无法正常响应） 30$ curl http:///cgi-bin/luci/rpc/sys?auth=yourtoken --data ' 31{ 32 \"method\":\"call\", 33 \"params\":[ 34 \"/etc/init.d/network restart\" 35 ] 36}' 更全面的接口地址和调试可前往我维护的 Postman OpenWrt RPC 接口合集。\n设备管理 Dnsmasq 是默认配置和管理设备 DHCP、DNS 为一体的服务，配置文件是 /etc/config/dhcp，应用服务 /etc/init.d/dnsmasq。\n防火墙 OpenWrt 22.03 版本开始不再使用 iptable 而是该用 nfstable 实现。两个同时时候存在不兼容情况需要注意。防火墙还承担接口转发的配置， 配置文件是 /etc/config/firewall，应用服务 /etc/init.d/firewall。\nDDNS 动态动态域名解析，解决公网IP不固定的问题，前提是要有公网 IP 才行。可通过给客户提工单说需要用摄像头看家里的猫猫、狗狗、鱼鱼、龟龟为理由有一定概率给开通。 配置文件是 /etc/config/ddns，应用服务 /etc/init.d/ddns。注意使用不同的域名供应商需要安装对应的软件包扩展才行。\n包管理 opkg 是 OpenWrt 的包管理工具，命令类似于 Debian 的 apt。 它可设置官方和第三方源。也能安装、升级和卸载包的功能。配置目录文件是 /etc/opkg.conf 文件和 /etc/okpg 目录下面的其他源配置文件构成。软件包是 .ipk 扩展名。网页端也有对应的功能实现。\n编译固件 国内似乎有一个偏见，任何的软件升级和新软件包都要重新编译和重刷固件，以至于流行起了利用 Github Action 白嫖资源来编译符合一万个人心中的哈姆雷特。\n编译固件的教程也异常的多，在 Github 能找到很多硬件设备、很多个性化的编译固件的工具，实在懒省事也有开发者提供在线自定义构建固件工具供您选择。\n前期刚开始接触的时候我也不例外加入到了编译固件的行列，直到最近意识到编译固件只是为了升级几个软件包版本而觉得这个事情有些偏离了设计初衷，我也开始尝试自己编译所需的软件包和软件源。\n开发软件包 如果你是要开发新软件包或编译软件包，你会立刻头大起来，这方面的资源可是少的可怜，我的建议是照着官方文档一步步来。\n你需要的是理解如何准备开发环境、克隆源码、安装编译环境和了解项目的目录结构，官方也考虑到前期准备会异常辛苦和困难重重，特意提供一个三种开发包。\nOpenwrt 开发包文件\ntoolchain: 包含了 GCC 编译器、编译必须的二进制工具和链接器（比如 tar, binutils 等）以及 C 标准库（比如 glibc、musl、uClibc 或者 dietlibc）组成的预编译环境，方便修改 OpenWrt 源码。 SDK: 包含了预编译 toolchain 包和一个编译平台（target 或叫 platform）用于不同平台交叉 ipk 软件包的开发套件。需要注意的是仅允许 ipk 软件包交叉编译，固件本身无法交叉编译。 imagebuilder: 一个能够快速调整固件内容的特定平台预编译的开箱包，能够这个预设好的环境精简预装的 ipk 包、调整系统参数也能够快速生成个性化固件。需要注意的是软件包是提前预设好，只能精简无法添加新软件包。 本章节只是浅浅让大家了解并没有计划全面展开，如果你想更深入如何开发一个 OpenWrt 软件包，欢迎留言跟我互动，多的话我或许会单开一个系列。\n最后想说的话 在我的 Homelab 网络拓扑中 OpenWrt 仅仅承担有线部分的网络转发和路由功能，主要是 DHCP、DNS、DDNS 和网络加速为主，无线网络会再通过下游的 Mesh AP 完成。 Docker、网盘等这类复杂且有风险的功能不会出现在 OpenWrt 系统。\n接下来会开启存储服务和 VM 虚拟机管理系统 Proxmox 等核心基础服务。\n可参考川叶的教程查看主旁路由设置和性能对比 ↩︎\n维基百科的解释 ↩︎\nvmlinuz 资料参考内核环境搭建和基础知识和vmlinuz 文件解压缩 ↩︎\n","wordCount":"4418","inLanguage":"zh-cn","image":"https://images.unsplash.com/photo-1521542464131-cb30f7398bc6?ixlib=rb-4.0.3\u0026ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8\u0026auto=format\u0026fit=crop\u0026w=2673\u0026q=80","datePublished":"2023-04-26T20:30:00+08:00","dateModified":"2023-04-26T20:30:00+08:00","author":{"@type":"Person","name":"icyleaf"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://icyleaf.com/2023/04/how-to-homelab-part-2-openwrt-soft-router/"},"publisher":{"@type":"Organization","name":"icyleaf","logo":{"@type":"ImageObject","url":"https://icyleaf.com/favicon.ico"}}}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/series/homelab title>homelab 系列</a>
<a class=menu-item href=https://icyleaf.com/projects title>开源项目</a>
<a class=menu-item href=https://icyleaf.com/gears title>我的设备</a>
<a class=menu-item href=https://icyleaf.com/about title>关于</a>
<span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/series/homelab title><h3>homelab 系列</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>开源项目</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/gears title><h3>我的设备</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/about title><h3>关于</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=post-cover><img src="https://images.unsplash.com/photo-1521542464131-cb30f7398bc6?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2673&amp;q=80" loading=lazy><p class=cover-author>Photo by
<a href=https://unsplash.com/photos/UrtxBX5i5SE>Thomas Jensen</a>
/
<a href=https://unsplash.com>Unsplash</a></p></div><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop=description>如何搭建家用 homelab: Openwrt 软路由</h1><div class=post-description>用牺牲硬件的网络转换效率来换取不必受设备提供商的限制和可玩性</div><div class=post-meta><time datetime=2023-04-26 itemprop=datePublished>2023-04-26</time>
·
<span class=tags>hardware, architecture, openwrt</span>
·
<span class=post-word-count>4418 words · 20 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#什么是-openwrt>什么是 OpenWrt</a></li><li><a href=#版本分布>版本分布</a></li><li><a href=#衍生及支系>衍生及支系</a><ul><li><a href=#lede>LEDE</a></li><li><a href=#immortalwrt>Immortalwrt</a></li><li><a href=#istoreos>iStoreOS</a></li></ul></li><li><a href=#固件构成>固件构成</a></li><li><a href=#安装固件>安装固件</a></li><li><a href=#系统核心>系统核心</a><ul><li><a href=#访问渠道>访问渠道</a></li><li><a href=#网络接口>网络接口</a></li><li><a href=#配置管理>配置管理</a></li><li><a href=#设备管理>设备管理</a></li><li><a href=#防火墙>防火墙</a></li><li><a href=#ddns>DDNS</a></li><li><a href=#包管理>包管理</a></li></ul></li><li><a href=#编译固件>编译固件</a><ul><li><a href=#开发软件包>开发软件包</a></li></ul></li><li><a href=#最后想说的话>最后想说的话</a></li></ul></nav></div></div><div class=post-content><div class=post-series><h4 class=series-title><a href=https://icyleaf.com/series/homelab/>Homelab（4 篇）</a></h4><ol class=series-list><li class=series-item><a href=https://icyleaf.com/2022/02/how-to-homelab-part-0/>如何搭建家用 homelab: 先导篇</a></li><li class=series-item><a href=https://icyleaf.com/2023/01/how-to-homelab-part-1-hardware-and-architecture/>如何搭建家用 homelab: 硬件和架构</a></li><li class=series-item><span class=current-serie>如何搭建家用 homelab: Openwrt 软路由</span></li><li class=series-item><a href=https://icyleaf.com/2023/07/how-to-homelab-part-3-storages/>如何搭建家用 homelab: 数据存储</a></li></ol></div><div id=post-gallery><div class=updated><header class="updated-header color-tip"><h4 class=updated-title>加入讨论群</h4></header><article class=updated-body>方便大家沟通交流，开通了 Discord 讨论群便于第一时间获得教程的最新更新，并提供关于 Homelab 沟通、疑惑解答专区，欢迎<a href=https://discord.gg/gdXpKyh85r>大家加入</a>。</article></div><p>路由器是猫总管（调制解调器）最得力的一把手，掌管 homelab 网络大权。对于中国玩家提到软路由肯定绕不开 OpenWrt，今天我尝试用一个全新的视角唠唠这个大家熟悉却又陌生的系统。
以下会涉及大量的基础认知、概念理解，<strong>不会涉及网络配置或高阶玩法</strong>。</p><h2 id=什么是-openwrt>什么是 OpenWrt</h2><blockquote><p>与同价位的硬路由相比，软路由硬件更好，可配置性更高，但需要一定的网络知识才能发挥作用。软硬路由的选择取决于网络环境的场景，有些人投入了软路由的怀抱，有些人经历了软路由后<a href=https://taresky.com/2019byebye>坚定的使用硬路由</a>，还有些人的硬路由之下还会接一个软路由当旁路由<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。</p></blockquote><p><a href=https://openwrt.org/>OpenWrt</a> 首先是一个开源的操作系统，能够实现硬路由器的核心功能：LAN 和 WAN 的网络转发、路由（DHCP、防火墙、DNS 解析等），在 Linux 开放的生态和社区基础上扩展出丰富的功能<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>，这个是硬件路由器没有能力达到的（钞能力或重刷魔改固件除外）。</p><figure data-pswp=1757x1080 data-size=800x><a href=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-packages-preview.png class=gallery-item target=_blank data-pswp-width=1757 data-pswp-height=1080><img src=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-packages-preview_hud400891ca261fa9e07ca732397145413_435673_800x0_resize_box_3.png alt=图片来源></a><figcaption><p class=source>图片来源<a href=https://github.com/SuLingGG/OpenWrt-Rpi>SuLingGG/OpenWrt-Rpi</a></p><p>丰富的软件包资源</p></figcaption></figure><p>它适配 x86、x86_64、arm、arm64 和 MIPS 等架构上千种硬件设备。硬件要求极低，21.02 版本最低要求 16M 闪存和 128M 内存，2023 年的今天没有人会拿老的硬路由古董去折腾它了吧，没有吧？没有吧？任意一台淘汰的 x86 设备都高于这个配置。
且在 x86/x86Z_64 平台安装它甚至比安装 Ubuntu、Debian 系统还要简单。较全的列表请查阅<a href=https://openwrt.org/supported_devices>官方硬件支持列表</a> 未列入的还可以在 <a href="https://github.com/search?q=openwrt&amp;type=repositories">Github 搜索</a>。</p><h2 id=版本分布>版本分布</h2><p>OpenWrt 虽然有一套<a href=https://openwrt.org/zh/releases/start>发布流程</a>却没有稳定的发版节奏和老版本的废弃规则。版本号类似<a href=https://semver.org/lang/zh-CN/>语义化版本规范</a>划分 <code>X</code>.<code>Y</code>.<code>Z</code> 三段。<code>X</code>.<code>Y</code> 是年和月相对固定，小功能迭代全靠更新 <code>Z</code> 的值。版本大致划分两类：</p><ul><li>稳定版：生产环境 Ready 的稳定版本。v22.03.2 是该系列的最新版本。</li><li>开发版：不稳定但会包含不断的迭代增强功能的开发版本，也称之为 snapshot 版本，完成<a href=https://openwrt.org/docs/guide-developer/releases/goals/start>里程碑</a>会进入 RC 版本。</li></ul><table><thead><tr><th>版本</th><th>状态</th><th>重大变化</th></tr></thead><tbody><tr><td><a href=https://openwrt.org/zh/releases/snapshot>snapshot</a></td><td>开发版本</td><td>-</td></tr><tr><td><a href=https://openwrt.org/zh/releases/22.03/start>22.03</a></td><td>最新版本</td><td>基于 5.10 内核、防火墙迁移 nftables、黑暗模式</td></tr><tr><td><a href=https://openwrt.org/zh/releases/21.02/start>21.02</a></td><td>可看做是 LTS 版本</td><td>基于 5.4 内核、DSA 初步支持</td></tr><tr><td><a href=https://openwrt.org/docs/guide-developer/releases/goals/19.07.4>19.07</a></td><td>不再支持</td><td>基于 4.11 内核、WPA3 支持、客户端渲染 luci</td></tr><tr><td><a href=https://openwrt.org/zh/releases/18.06/start>18.06</a></td><td>不再支持</td><td>基于 4.9 或 4.11 内核、合并 Lede 源码</td></tr><tr><td><a href=https://openwrt.org/zh/releases/17.01/start>LEDE 17.01</a></td><td>不再支持</td><td>基于 4.4 内核</td></tr></tbody></table><p>以上版本信息是截止 2023 年 4 月底。</p><h2 id=衍生及支系>衍生及支系</h2><blockquote><p>话说天下大势，分久必合，合久必分</p></blockquote><p>开源系统生态同样遵循，有些是不满原系统的管理或生态愤恨分支的支系，有些是针对特定的方面有了深化的衍生功能，列举几个我了解的支系。</p><h3 id=lede>LEDE</h3><p><a href=https://zh.wikipedia.org/wiki/LEDE>LEDE</a> 是前者的原因分支出来的一派，新增了很多关键新功能和对新设备的支持而崛起，在 2018 年 1 月 LEDE 宣布和 OpenWRT 和解正式宣布合并，合并后使用 OpenWrt 的名字和 LEDE 的代码。</p><p>早期国内知名的 <a href=https://github.com/coolsnowwolf>Lean 狼大</a>的 <a href=https://github.com/coolsnowwolf/lede>Lede 系统</a>，很多国内玩家最早接触的系统之一。</p><h3 id=immortalwrt>Immortalwrt</h3><p>基于官方分支的 <a href=https://github.com/immortalwrt>Immortalwrt</a> 是一个跟进上游速度很快又融合了 Lean 狼大版本特色的新支系。Lean 狼大<a href=https://twitter.com/icyleaf/status/1496789460473638913>也有参与其中</a>，主要是针对中国玩家定制的固件，拥有更好的本地化适配、加入了各种官方软件列表中没有但是国内环境中可能会用到的软件功能，比如网络多拨、国内镜像及<span class=spoiler>翻开也不会告诉你的功能等。</span></p><p>我从 21.02 开始跟进并使用 snapshot 开发版本没遇到什么大坑，该项目每周都会定时合并上游的代码。</p><h3 id=istoreos>iStoreOS</h3><p>同样是基于官方分支的 <a href=https://www.istoreos.com/>iStoreOS</a> 另辟蹊径，舍弃了 OpenWrt 自身的包管理机制，重新打造了一套类似 <a href=https://www.koolcenter.com/category/merlin>KoolCenter 梅林固件</a>的软件商店用于解决因为 OpenWRT 系统依赖和软件包依赖杂乱导致不同平台的插件依赖不匹配而无法安装的问题。同时提供多套 UI 操作界面和类似上面一样特色功能和 NAS 向功能：网盘、Docker、异地组网、相册备份等。</p><blockquote><p>由于个人没有实际部署和使用，按下不表。</p></blockquote><h2 id=固件构成>固件构成</h2><p>不同的硬件和软件包的搭配组合衍生出五花八门的固件版本。那有没有想过固件到底是什么，有什么组成的呢？</p><p>固件的构成主要是三类 vmlinuz、rootfs 和系统引导。</p><ul><li>vmlinux 是 ELF 文件最原始包含 Linux 内核静态链接的可执行文件；vmlinuz 是压缩后的 vmlinux 且能可启动的文件<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>。</li><li>rootfs 是 OpenWrt 的根分区的所有文件，提供 gzip 压缩后的原始文件、ext4 分区后的文件和 squashfs 分区后的文件。</li><li>系统引导是引导设备开机后正确引领到上述两个文件的 bootloader，OpenWrt 借助的是 grub2 来实现 legacy 或 EFI 分区引导。</li></ul><p>固件文件名包含的 combined 译为合并这就是上面几个文件的自由组合，组合方式会从<code>文件分区</code>和<code>封装</code>两个字段体现。</p><figure data-pswp=2115x1848 data-size=800x><a href=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-file-structure.png class=gallery-item target=_blank data-pswp-width=2115 data-pswp-height=1848><img src=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-file-structure_hu89ce50451123b48915fffad04a92e22e_139504_800x0_resize_box_3.png></a><figcaption><p>Openwrt 固件文件解构</p></figcaption></figure><p>OpenWrt 文件系统分区可选择 <a href=https://zh.wikipedia.org/wiki/Ext4>ext4</a> 或 <a href=https://en.wikipedia.org/wiki/SquashFS>squashFS</a>。ext4 是一个可读可写的分区格式，这也是 Linux 生态应用最广的文件系统；对比 squashFS 它是一个只读的分区格式，看似不好用但它却有一个非常诱人的功能，可恢复出厂设置或直刷同文件分区的固件达到升级的功能，只不过需要挂在其他可写的磁盘做扩展应用。</p><p>封装格式提供可烧录的 iso、img 镜像外，还提供了虚拟化的镜像文件，方便使用者根据各自的情况随意部署。</p><p>多提一句，官方还额外其他提供一个组合字段 <code>-factory</code> 和 <code>-sysupgrade</code> 来区分全新安装或升级的专属固件，这俩不能混用。</p><blockquote><p>本节会涉及 Linux 的启动机制，我也是略懂皮毛，如果有描述错误请指正。</p></blockquote><h2 id=安装固件>安装固件</h2><figure data-pswp=2290x750 data-size=800x><a href=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-fireware-image-files.png class=gallery-item target=_blank data-pswp-width=2290 data-pswp-height=750><img src=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-fireware-image-files_hu4f63e536e962ff43b9fa658f4c31bfb4_224192_800x0_resize_box_3.png></a><figcaption><p>Openwrt 固件镜像文件</p></figcaption></figure><p>我相信结合上面的固件构成的原理在选择什么类型的固件上会迎刃而解了吧。安装步骤略过不讲了吧，网络上有<a href="https://www.google.com.hk/search?q=openwrt+%E5%AE%89%E8%A3%85">太多的教程</a>可供参考。</p><h2 id=系统核心>系统核心</h2><h3 id=访问渠道>访问渠道</h3><p>OpenWrt 提供 Web UI 和 SSH 两种方式访问和管理，默认 Web 界面由 <a href=https://github.com/openwrt/luci>luci</a> 实现前端展示，uhttpd 负责 web 代理服务。
可通过浏览器访问 http://192.168.1.1 或 <a href=http://openwrt.lan>http://openwrt.lan</a> 打开，默认开放 80 端口；SSH 端口为 22，默认用户名为 root，没有密码。</p><figure data-pswp=1033x689 data-size=800x><a href=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-themes-preview.png class=gallery-item target=_blank data-pswp-width=1033 data-pswp-height=689><img src=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-themes-preview_hu33abb04a3fc26983cc7948708958ea73_140538_800x0_resize_box_3.png alt=图片来源></a><figcaption><p class=source>图片来源<a href=https://blog.vpngame.com/openwrt/cara-install-dan-ganti-tema-luci-di-openwrt/>3elajar OpenWrt</a></p><p>luci 丰富的主题</p></figcaption></figure><p>luci 是官方维护和默认内置开启的前端 UI 实现，其实深挖能发现还有很多的<a href=https://openwrt.org/docs/guide-user/luci/webinterface.overview>实现方案</a>。
还有社区近期还在维护的 <a href=https://github.com/zhaojh329/oui>oui</a>、<a href=https://github.com/x-wrt/x-wrt>x-wrt</a> 和很久不再更新的 <a href=https://github.com/mkschreder/juci>juci</a> 等。
这也能够看的出来 OpenWrt 在系统开放性上有很大的包容度。</p><h3 id=网络接口>网络接口</h3><p>默认使用 LAN 2（eth1） 为 WAN 口，LAN 1（eth0）为 LAN 口，如果有多个 WAN、LAN 口需要在网络接口中重新配置。</p><h3 id=配置管理>配置管理</h3><p>系统的配置文件系统层面绝大多数的配置文件都储存在 <code>/etc/config</code> 路径下面，编辑保存后是保存对于配置文件而不是实际修改对应服务，因此需要再执行提交操作，这部会完成把部分服务的中间配置更新到真正的配置文件中，再有必要的执行服务的重启操作。</p><p>我会通过“修改 LAN IP 地址”的例子分别演示 OpenWrt 配置文件的修改的几种途径。</p><h4 id=通过-web-ui>通过 Web UI</h4><p>luci 提供网页的可视化操作，比如查看配置、更新管理等配置的管理工作。</p><figure data-pswp=1910x822 data-size=800x><a href=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-luci.png class=gallery-item target=_blank data-pswp-width=1910 data-pswp-height=822><img src=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-luci_hu625591b40daa7a557058fbcbacf8b92b_94153_800x0_resize_box_3.png></a></figure><p>分别选择 &ldquo;网络&rdquo; -> &ldquo;接口&rdquo;，找到接口 lan 右侧的编辑按钮，点开后编辑 IPv4 地址，保存再应用。</p><h4 id=通过终端编辑器>通过终端编辑器</h4><p>使用 vim 或 nano 这类文本编辑器编辑 <code>/etc/config/network</code> 文件，找到 lan 分段下面的 ipaddr 修改值：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=ln> 1</span><span class=cl>config interface &#39;loopback&#39;
</span></span><span class=line><span class=ln> 2</span><span class=cl>  option device &#39;lo&#39;
</span></span><span class=line><span class=ln> 3</span><span class=cl>  option proto &#39;static&#39;
</span></span><span class=line><span class=ln> 4</span><span class=cl>  option ipaddr &#39;127.0.0.1&#39;
</span></span><span class=line><span class=ln> 5</span><span class=cl>  option netmask &#39;255.0.0.0&#39;
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl>config globals &#39;globals&#39;
</span></span><span class=line><span class=ln> 8</span><span class=cl>  option ula_prefix &#39;fdd3:af57:2ab4::/48&#39;
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>config device
</span></span><span class=line><span class=ln>11</span><span class=cl>  option name &#39;br-lan&#39;
</span></span><span class=line><span class=ln>12</span><span class=cl>  option type &#39;bridge&#39;
</span></span><span class=line><span class=ln>13</span><span class=cl>  list ports &#39;eth0&#39;
</span></span><span class=line><span class=ln>14</span><span class=cl>  option ipv6 &#39;0&#39;
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl>config interface &#39;lan&#39;
</span></span><span class=line><span class=ln>17</span><span class=cl>  option device &#39;br-lan&#39;
</span></span><span class=line><span class=ln>18</span><span class=cl>  option proto &#39;static&#39;
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=gd>-	option ipaddr &#39;192.168.1.1&#39;
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=gd></span><span class=gi>+	option ipaddr &#39;10.10.10.1&#39;
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=gi></span>  option netmask &#39;255.255.255.0&#39;
</span></span><span class=line><span class=ln>22</span><span class=cl>  option ip6assign &#39;60&#39;
</span></span><span class=line><span class=ln>23</span><span class=cl>  option gateway &#39;192.168.16.1&#39;
</span></span><span class=line><span class=ln>24</span><span class=cl>  list dns &#39;233.5.5.5&#39;
</span></span><span class=line><span class=ln>25</span><span class=cl>  list dns &#39;202.106.0.20&#39;
</span></span></code></pre></div><p>保存后在重启 network 服务。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>$ /etc/init.d/network restart
</span></span></code></pre></div><h4 id=通过终端-uci-工具>通过终端 uci 工具</h4><figure data-pswp=2650x1282 data-size=800x><a href=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-uci.png class=gallery-item target=_blank data-pswp-width=2650 data-pswp-height=1282><img src=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-uci_hue276e5c9fefad17390851e095847751d_229224_800x0_resize_box_3.png alt=图片来源></a><figcaption><p class=source>图片来源<a href=https://openwrt.org/docs/guide-user/base-system/uci>OpenWrt Wiki</a></p><p>Openwrt uci 对应关系</p></figcaption></figure><p><a href=https://openwrt.org/docs/guide-user/base-system/uci>uci</a> 是配置管理的快捷 CLI 工具，它会比网页编辑或终端找配置文件编辑都要方便。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># 设置 LAN 的 IP 地址</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>$ uci <span class=nb>set</span> network.lan.ipaddr<span class=o>=</span>10.10.10.1
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=c1># 提交应用操作</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>$ uci commit network
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=c1># 重启网络服务</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>$ /etc/init.d/network restart
</span></span></code></pre></div><h4 id=通过-json-rpc-接口>通过 JSON-RPC 接口</h4><figure data-pswp=2143x1561 data-size=800x><a href=https://icyleaf.com/tutorials/how-to-homelab/part-2/api-architecture-styles.jpeg class=gallery-item target=_blank data-pswp-width=2143 data-pswp-height=1561><img src=https://icyleaf.com/tutorials/how-to-homelab/part-2/api-architecture-styles_hu66a712dc29cc2d0893569aae05f00fac_195912_800x0_resize_q75_box.jpeg alt=图片来源></a><figcaption><p class=source>图片来源<a href=https://twitter.com/Rapid_API/status/1567656196022181891>Rapid@twitter</a></p><p>API 接口方案一览图</p></figcaption></figure><p>Openwrt 内部通信全靠的是 <a href=https://openwrt.org/docs/techref/ubus>ubus</a> 总线工具，JSON-RPC 是基于它的二次封装的接口服务。固件默认不会开启此服务，如果需要请在编译固件配置中<a href=https://github.com/openwrt/luci/wiki/JsonRpcHowTo>开启它</a>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl><span class=c1># 登录认证获得 token (返回 JSON 的 result 字段值)</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>$ curl http://&lt;hostname&gt;/cgi-bin/luci/rpc/auth --data <span class=s1>&#39;
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=s1>{
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=s1>  &#34;id&#34;: 1,
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=s1>  &#34;method&#34;: &#34;login&#34;,
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=s1>  &#34;params&#34;: [
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=s1>    &#34;user&#34;, &#34;password&#34;
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=s1>  ]
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=s1>}&#39;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=c1># 修改 LAN IP 地址</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>$ curl http://&lt;hostname&gt;/cgi-bin/luci/rpc/uci?auth<span class=o>=</span>yourtoken --data <span class=s1>&#39;
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=s1>{
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=s1>  &#34;method&#34;:&#34;set&#34;,
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=s1>  &#34;params&#34;:[
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=s1>    &#34;network&#34;, &#34;lan&#34;, &#34;ipaddr&#34;, &#34;10.10.10.1&#34;
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=s1>  ]
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=s1>}&#39;</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>
</span></span><span class=line><span class=ln>20</span><span class=cl><span class=c1># 提交 network 配置变更</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>$ curl http://&lt;hostname&gt;/cgi-bin/luci/rpc/uci?auth<span class=o>=</span>yourtoken --data <span class=s1>&#39;
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=s1>{
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=s1>  &#34;method&#34;:&#34;commit&#34;,
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=s1>  &#34;params&#34;:[
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=s1>    &#34;network&#34;
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=s1>  ]
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=s1>}&#39;</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>
</span></span><span class=line><span class=ln>29</span><span class=cl><span class=c1># 重启 network 服务 （接口请求后可能无法正常响应）</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>$ curl http://&lt;hostname&gt;/cgi-bin/luci/rpc/sys?auth<span class=o>=</span>yourtoken --data <span class=s1>&#39;
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=s1>{
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=s1>  &#34;method&#34;:&#34;call&#34;,
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=s1>  &#34;params&#34;:[
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=s1>    &#34;/etc/init.d/network restart&#34;
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=s1>  ]
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=s1>}&#39;</span>
</span></span></code></pre></div><p>更全面的接口地址和调试可前往我维护的 Postman <a href=https://documenter.getpostman.com/view/14290/SzKPUgEo>OpenWrt RPC 接口合集</a>。</p><h3 id=设备管理>设备管理</h3><p>Dnsmasq 是默认配置和管理设备 DHCP、DNS 为一体的服务，配置文件是 <code>/etc/config/dhcp</code>，应用服务 <code>/etc/init.d/dnsmasq</code>。</p><h3 id=防火墙>防火墙</h3><p>OpenWrt 22.03 版本开始不再使用 iptable 而是该用 nfstable 实现。两个同时时候存在不兼容情况需要注意。防火墙还承担接口转发的配置，
配置文件是 <code>/etc/config/firewall</code>，应用服务 <code>/etc/init.d/firewall</code>。</p><h3 id=ddns>DDNS</h3><p>动态动态域名解析，解决公网IP不固定的问题，前提是要有公网 IP 才行。可通过给客户提工单说需要用摄像头看家里的猫猫、狗狗、鱼鱼、龟龟为理由有一定概率给开通。
配置文件是 <code>/etc/config/ddns</code>，应用服务 <code>/etc/init.d/ddns</code>。注意使用不同的域名供应商需要安装对应的软件包扩展才行。</p><h3 id=包管理>包管理</h3><p><a href=https://openwrt.org/docs/guide-user/additional-software/opkg>opkg</a> 是 OpenWrt 的包管理工具，命令类似于 Debian 的 apt。
它可设置官方和第三方源。也能安装、升级和卸载包的功能。配置目录文件是 <code>/etc/opkg.conf</code> 文件和 <code>/etc/okpg</code> 目录下面的其他源配置文件构成。软件包是 <code>.ipk</code> 扩展名。网页端也有对应的功能实现。</p><h2 id=编译固件>编译固件</h2><p>国内似乎有一个偏见，任何的软件升级和新软件包都要重新编译和重刷固件，以至于流行起了利用 Github Action 白嫖资源来编译符合一万个人心中的哈姆雷特。</p><p>编译固件的教程也异常的多，在 Github 能找到很多硬件设备、很多个性化的编译固件的工具，实在懒省事也有开发者提供在线<a href=https://supes.top/>自定义构建固件工具</a>供您选择。</p><p>前期刚开始接触的时候<a href=https://github.com/icyleaf/openwrt-autobuilder>我也不例外</a>加入到了编译固件的行列，直到最近意识到编译固件只是为了升级几个软件包版本而觉得这个事情有些偏离了设计初衷，我也开始尝试自己编译所需的<a href=https://github.com/icyleaf/openwrt-packages>软件包</a>和<a href=https://github.com/icyleaf/openwrt-dist>软件源</a>。</p><h3 id=开发软件包>开发软件包</h3><p>如果你是要开发新软件包或编译软件包，你会立刻头大起来，这方面的资源可是少的可怜，我的建议是照着<a href=https://openwrt.org/docs/guide-developer/toolchain/single.package>官方文档</a>一步步来。</p><p>你需要的是理解如何准备开发环境、克隆源码、安装编译环境和了解项目的目录结构，官方也考虑到前期准备会异常辛苦和困难重重，特意提供一个三种开发包。</p><figure data-pswp=2300x912 data-size=800x><a href=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-dev-files.png class=gallery-item target=_blank data-pswp-width=2300 data-pswp-height=912><img src=https://icyleaf.com/tutorials/how-to-homelab/part-2/openwrt-dev-files_hub712545ea67e7dea7998ba1f55078d39_233471_800x0_resize_box_3.png></a><figcaption><p>Openwrt 开发包文件</p></figcaption></figure><ul><li><a href=https://openwrt.org/docs/guide-developer/toolchain/buildsystem_essentials#description>toolchain</a>: 包含了 GCC 编译器、编译必须的二进制工具和链接器（比如 tar, binutils 等）以及 C 标准库（比如 glibc、musl、uClibc 或者 dietlibc）组成的预编译环境，方便修改 OpenWrt 源码。</li><li><a href=https://openwrt.org/docs/guide-developer/toolchain/using_the_sdk>SDK</a>: 包含了预编译 toolchain 包和一个编译平台（target 或叫 platform）用于不同平台交叉 ipk 软件包的开发套件。需要注意的是仅允许 ipk 软件包交叉编译，固件本身无法交叉编译。</li><li><a href=https://openwrt.org/zh/docs/guide-user/additional-software/imagebuilder>imagebuilder</a>: 一个能够快速调整固件内容的特定平台预编译的开箱包，能够这个预设好的环境精简预装的 ipk 包、调整系统参数也能够快速生成个性化固件。需要注意的是软件包是提前预设好，只能精简无法添加新软件包。</li></ul><p>本章节只是浅浅让大家了解并没有计划全面展开，如果你想更深入如何开发一个 OpenWrt 软件包，欢迎留言跟我互动，多的话我或许会单开一个系列。</p><h2 id=最后想说的话>最后想说的话</h2><p>在我的 Homelab 网络拓扑中 OpenWrt 仅仅承担有线部分的网络转发和路由功能，主要是 DHCP、DNS、DDNS 和网络加速为主，无线网络会再通过下游的 Mesh AP 完成。
Docker、网盘等这类复杂且有风险的功能不会出现在 OpenWrt 系统。</p><p>接下来会开启存储服务和 VM 虚拟机管理系统 Proxmox 等核心基础服务。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>可参考<a href=https://blog.lishun.me/openwrt-mega-post>川叶</a>的教程查看主旁路由设置和性能对比&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://zh.wikipedia.org/wiki/OpenWrt>维基百科</a>的解释&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>vmlinuz 资料参考<a href=https://zoepla.github.io/2019/09/%E5%86%85%E6%A0%B8%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%92%8C%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/>内核环境搭建和基础知识</a>和<a href=https://blog.csdn.net/catoop/article/details/120809707>vmlinuz 文件解压缩</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></div><div class=post-nav><a href=https://icyleaf.com/2023/01/how-to-homelab-part-1-hardware-and-architecture/ class=prev rel=prev title="如何搭建家用 homelab: 硬件和架构"><i class="iconfont icon-left"></i>&nbsp;如何搭建家用 homelab: 硬件和架构</a>
<a href=https://icyleaf.com/2023/07/how-to-homelab-part-3-storages/ class=next rel=next title="如何搭建家用 homelab: 数据存储">如何搭建家用 homelab: 数据存储&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><script>var getTheme=window.localStorage&&window.localStorage.getItem("blog-dark-mode"),getTheme=getTheme??"github-light";let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","icyleaf/icyleaf.com"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.post-comment").innerHTML="",document.querySelector("div.post-comment").appendChild(s)</script></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2023</span>
<span>🍺</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script defer src=https://fastly.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js crossorigin=anonymous></script><script defer src=https://icyleaf.com/js/vendor_main.min.js></script>
<script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: () => import('\/photoswipe\/photoswipe.esm.js'),
  });
  lightbox.init();
</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TKQBZ7R259"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TKQBZ7R259")</script></div></body></html>