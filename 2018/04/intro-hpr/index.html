<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>ḫpr | icyleaf</title><link rel=prev href=https://icyleaf.com/2018/04/how-to-bind-mobile-number-to-apple-developer-account/><link rel=next href=https://icyleaf.com/2018/05/apply-for-a-motorcycle-license/><link rel=canonical href=https://icyleaf.com/2018/04/intro-hpr/><link rel=apple-touch-icon sizes=180x180 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=32x32 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=icon type=image/png sizes=16x16 href=https://icyleaf.com/images/icyleaf-icon.png><link rel=stylesheet href=https://icyleaf.com/css/main.min.css><link rel=stylesheet href=https://icyleaf.com/font/iconfont.css><link rel=stylesheet href=https://icyleaf.com/font-ali/iconfont.css><link rel=stylesheet href=https://icyleaf.com/photoswipe/photoswipe.css><meta name=title content="ḫpr | icyleaf"><meta name=author content="icyleaf"><meta name=description content="日常写代码热爱户外的梦想家"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/icyleaf.com\/"},"articleSection":"posts","name":"ḫpr","headline":"ḫpr","description":"最好用的 git 仓库镜像同步工具","inLanguage":"zh","author":"icyleaf","creator":"icyleaf","publisher":"icyleaf","accountablePerson":"icyleaf","copyrightHolder":"icyleaf","copyrightYear":"2018","datePublished":"2018-04-27 18:12:23 \u002b0800 \u002b0800","dateModified":"2018-04-27 18:12:23 \u002b0800 \u002b0800","url":"https:\/\/icyleaf.com\/2018\/04\/intro-hpr\/","wordCount":"1184","keywords":["Docker","Git","icyleaf"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><span class=menu><a class=menu-item href=https://icyleaf.com/about title>About</a>
<a class=menu-item href=https://icyleaf.com/projects title>Projects</a>
<a class=menu-item href=https://icyleaf.com/index.xml title>Feed</a>
<span class=divide></span>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://icyleaf.com/>icyleaf</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=https://icyleaf.com/about title><h3>About</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/projects title><h3>Projects</h3><div class=menu-active></div></a><a class=menu-item href=https://icyleaf.com/index.xml title><h3>Feed</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop=description>ḫpr</h1><div class=post-description>最好用的 git 仓库镜像同步工具</div><div class=post-meta><time datetime=2018-04-27 itemprop=datePublished>April 27, 2018</time>
·
<span class=tags>Docker, Git</span>
·
<span class=post-word-count>1184 words · 5 minutes</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#契子>契子</a></li><li><a href=#快速上手>快速上手</a></li><li><a href=#更多资源>更多资源</a></li></ul></nav></div></div><div class=post-content><div id=post-gallery><p><img src=https://github.com/icyleaf/hpr/raw/master/docs/_media/icon.png alt=icon></img></p><p><a href=https://icyleaf.github.io/hpr/>ḫpr</a> 是一个把任意 git 仓库的镜像到 gitlab 服务的同步工具，还支持定期同步的功能。</p><p>特性:</p><ul><li>支持 Web API 接口，可用于远程控制不仅限于终端使用</li><li>支持终端命令控制，方便临时使用</li><li>定时更新镜像的仓库，时间可调，告别不靠谱的 crontab</li><li>几乎支持所有的 git 托管的仓库</li><li>使用可独立部署的 Gitlab 作为镜像平台</li></ul><p>本工具可以用到的地方:</p><ul><li>任意 git 仓库源码的定期同步</li><li>Cocoapods 的境内加速和同步</li></ul><h2 id=契子>契子</h2><p>如果关注我博客的用户或者曾经看到过另外一篇文章<a href=http://icyleaf.com/2015/01/speed-up-cocoapods/>极速化 CocoaPods</a>的话且实践的用户会明白为什么会有它的产生。
在我发布那篇文章的时候那套体系已经在我们公司的服务器上运行且截至目前已经持续运行了 3 年多！</p><p>那个方案并不完美，除了调用必须通过脚本的蹩脚的方案外出问题最多的主要是 gitlab-mirrors
只能使用 crontab 做定时任务这样会因多个镜像在同步未完成的情况下重复开启新的同步任务，一个任务不明显一旦积攒多了起来还会慢慢的蚕食内存因此又不得不 ssh 到服务器
开始杀进程相当于重置。</p><p><del>当时想重新做一个的想法其实 2017 年就产生了用 ruby 写了个头当时项目命名为 nightwing 但 ruby 的问题在部署上面有比较麻烦需要各种依赖环境，
当时也考虑过 Go 但由于在断断续续学习没有持续，这个时候就开始将注意力转移到了类 Ruby 语法的 Crystal 语言，通过业余时间慢慢的了解和确定其性能后虽然和
Go 来比打包还没有那么高的集成度但完成核心功能已经完全足够，也就开始了封装 <a href=https://github.com/icyleaf/gitlab.cr>gitlab</a>、
<a href=https://github.com/icyleaf/halite>halite</a> 网络库直到最近基本完成了核心功能。</del></p><p><code>ḫpr</code> 就这样诞生了。项目名和 Logo 出处来源于<a href=https://zh.wikipedia.org/wiki/%E8%81%96%E7%94%B2%E8%9F%B2>圣甲虫</a>。</p><div class=updated><header class=updated-header><h4 class=updated-title>更新</h4><p class=updated-meta>4月 18, 2022</p></header><article class=updated-body>第一版确实用的 Crystal 语言发布了 hpr 后续<a href=https://github.com/icyleaf/hpr/issues/11>因为 Crystal 太多轮子和问题需要解决</a>不得已用 Ruby 重写了。</article></div><h2 id=快速上手>快速上手</h2><p>鉴于 Docker 的便利性，目前教程只提供此种方法进行安装部署，首先克隆本项目：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>$ git clone https://github.com/icyleaf/hpr.git
</span></span><span class=line><span class=ln>2</span><span class=cl>$ <span class=nb>cd</span> hpr
</span></span></code></pre></div><p>复制 <a href=config/hpr.json.example>config/hpr.json.example</a> 并改名 <code>config/config.json</code> 后可修改</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=ln> 1</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=nt>&#34;schedule_in&#34;</span><span class=p>:</span> <span class=s2>&#34;1.day&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=nt>&#34;basic_auth&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=nt>&#34;enable&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=nt>&#34;user&#34;</span><span class=p>:</span> <span class=s2>&#34;hpr&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=nt>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;p@ssw0rd&#34;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=nt>&#34;gitlab&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=nt>&#34;ssh_port&#34;</span><span class=p>:</span> <span class=mi>22</span><span class=p>,</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=nt>&#34;endpoint&#34;</span><span class=p>:</span> <span class=s2>&#34;http://gitlab.example.com/api/v3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=nt>&#34;private_token&#34;</span><span class=p>:</span> <span class=s2>&#34;abc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=nt>&#34;group_name&#34;</span><span class=p>:</span> <span class=s2>&#34;mirrors&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=nt>&#34;project_public&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=nt>&#34;project_issue&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=nt>&#34;project_wiki&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=nt>&#34;project_merge_request&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=nt>&#34;project_snippet&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>核心需要修改的参数有如下四项：</p><ul><li><code>endpoint</code>: Gitlab API 的地址，<strong>无需修改后面部分</strong></li><li><code>private_token</code>: 在个人设置的 Account 页面获得</li><li><code>group_name</code>: 项目镜像的项目都会归属到这个组内，<strong>务必确保你的账户拥有创建组的权限</strong> (如果是管理员请忽略加粗字样)</li><li><code>ssh_port</code>: 如果 SSH 不是 22 端口的话需要根据你的实际情况修改</li></ul><p>配置文件修改保存后还需要在 <code>docker-compose.yml</code> 文件中配置下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;2&#39;</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>hpr</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>icyleafcn/hpr</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>      </span>- <span class=m>8848</span><span class=p>:</span><span class=m>8848</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>      </span>- <span class=l>./config:/app/config</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>      </span>- <span class=l>./repositories:/app/repositories</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>      </span><span class=nt>REDIS_URL</span><span class=p>:</span><span class=w> </span><span class=l>tcp://redis:6379</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>      </span><span class=nt>REDIS_PROVIDER</span><span class=p>:</span><span class=w> </span><span class=l>REDIS_URL</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>      </span><span class=nt>HPR_SSH_HOST</span><span class=p>:</span><span class=w> </span><span class=l>git.example.com</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>      </span><span class=nt>HPR_SSH_PORT</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>      </span>- <span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis:alpine</span><span class=w>
</span></span></span></code></pre></div><p>其中 <code>HPR_SSH_HOST</code> 和 <code>HPR_SSH_PORT</code> 变量用于设置 Docker 实例中的 SSH 配置。如果 SSH 端口是 22 的可忽略设置这俩参数。</p><p>编辑完成后运行下面命令快完成了！</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>$ docker-compose up
</span></span><span class=line><span class=ln> 2</span><span class=cl>...
</span></span><span class=line><span class=ln> 3</span><span class=cl>hpr_1      <span class=p>|</span> Generating public/private rsa key pair ...
</span></span><span class=line><span class=ln> 4</span><span class=cl>hpr_1      <span class=p>|</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>hpr_1      <span class=p>|</span> GENERATED SSH PUBLIC KEY:
</span></span><span class=line><span class=ln> 6</span><span class=cl>hpr_1      <span class=p>|</span> <span class=c1>##################################################################</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>hpr_1      <span class=p>|</span> ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDq8O3HbLn9x8Uy8RUotlpOnxdakrmCyDpZrGBeLARmEbd6BOIBQ+UWm8NUKthQ7UOavmlsq4j8lY4kyFW2eFX2qWcbvI+s2gI+05MXax+mAukSszaNSnpAoTyJCRipilSkqiOV99V8JIJhrHPtTO0o/Ui
</span></span><span class=line><span class=ln> 8</span><span class=cl>9WiyyWsUM4M9lEKHpZ486lDGk3IM2XQW+pxAoMKb0TYzqCsrduHUtjzy0M0BqgMPe9EtVQqCbnTMzDLXmRONoTYyTV51NQ12mMwEQcDaLQ28e5gqouQJKS81JaoRpQWa7pHsOCki6Fk9TB+EQFrGz5nOrmYYM+O1MKnFkzmVHv7Fh50Sz7d2nYzzOKAkR hpr@docker
</span></span><span class=line><span class=ln> 9</span><span class=cl>hpr_1      <span class=p>|</span> <span class=c1>##################################################################</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>hpr_1      <span class=p>|</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>hpr_1      <span class=p>|</span> Configuring ssh config ...
</span></span><span class=line><span class=ln>12</span><span class=cl>hpr_1      <span class=p>|</span> Starting hpr server ...
</span></span><span class=line><span class=ln>13</span><span class=cl>hpr_1      <span class=p>|</span>   _
</span></span><span class=line><span class=ln>14</span><span class=cl>hpr_1      <span class=p>|</span>  <span class=p>|</span> <span class=p>|</span>__  _ __  _ __
</span></span><span class=line><span class=ln>15</span><span class=cl>hpr_1      <span class=p>|</span>  <span class=p>|</span> <span class=s1>&#39;_ \| &#39;</span>_ <span class=se>\|</span> <span class=err>&#39;</span>__<span class=p>|</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>hpr_1      <span class=p>|</span>  <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span>_<span class=o>)</span> <span class=p>|</span> <span class=p>|</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>hpr_1      <span class=p>|</span>  <span class=p>|</span>_<span class=p>|</span> <span class=p>|</span>_<span class=p>|</span> .__/<span class=p>|</span>_<span class=p>|</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>hpr_1      <span class=p>|</span>        <span class=p>|</span>_<span class=p>|</span>
</span></span></code></pre></div><p>最后从执行命令的输出找到生成的 SSH PUBLIC KEY（两个井号中间的部分，以 <code>ssh-rsa</code> 开头，<code>hpr@docker</code> 结尾），
复制添加到 gitlab 的账户 SSH Keys 页面中。</p><h2 id=更多资源>更多资源</h2><p>再多的内容我已经整理到文档中，欢迎移步浏览：https://icyleaf.github.io/hpr/</p></div></div><div class=post-nav><a href=https://icyleaf.com/2018/04/how-to-bind-mobile-number-to-apple-developer-account/ class=prev rel=prev title=一招解决苹果账户因忘记安全问题绑定手机号><i class="iconfont icon-left"></i>&nbsp;一招解决苹果账户因忘记安全问题绑定手机号</a>
<a href=https://icyleaf.com/2018/05/apply-for-a-motorcycle-license/ class=next rel=next title=海淀驾校增驾摩托车驾照>海淀驾校增驾摩托车驾照&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//icyleaf.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2005 - 2022</span>
<span>🍺</span>
<span class=author itemprop=copyrightHolder><a href=https://icyleaf.com/>icyleaf</a></span></div></footer><script src=https://fastly.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js crossorigin=anonymous></script>
<script defer src=https://icyleaf.com/js/vendor_main.min.js></script>
<script src=https://fastly.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script>
<script>pangu.spacingPage()</script><script type=module>
  
  import PhotoSwipeLightbox from '\/photoswipe\/photoswipe-lightbox.esm.js';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#post-gallery',
    children: 'a.gallery-item',
    pswpModule: () => import('\/photoswipe\/photoswipe.esm.js'),
  });
  lightbox.init();
</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TKQBZ7R259"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TKQBZ7R259")</script></div></body></html>